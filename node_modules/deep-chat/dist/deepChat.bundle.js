const t="classList",e="style",i=(t="div")=>document.createElement(t);class s{static render(t,e){const s=i();s.id="error-view",s.innerText=e,t.replaceChildren(s)}}class n{static onLoad(t){t.innerHTML='<div id="loading-validate-key-property"></div>'}static createElements(){const t=i();return t.id="validate-property-key-view",t}static render(t,e,i){const o=n.createElements(),r={onSuccess:e,onFail:s.render.bind(this,t,"Your 'key' has failed authentication"),onLoad:n.onLoad.bind(this,o)};i.key&&i.verifyKey(i.key,r),t.replaceChildren(o)}}const o="submit-button",r="loading-button",a="disabled-button",l="text-input-container-left-adjustment",c="text-input-container-right-adjustment",h="text-input-container-left-small-adjustment",u="text-input-container-right-small-adjustment",d="inside-left",p="inside-right",m="outside-left",v="outside-right",f="dropup-menu",g="default",b="hover",y="click";class w{static unsetStyle(t,i){const s=Object.keys(i).reduce((t,e)=>(t[e]="",t),{});Object.assign(t[e],s)}static unsetActivityCSSMouseStates(t,e){e[y]&&w.unsetStyle(t,e[y]),e[b]&&w.unsetStyle(t,e[b])}static unsetAllCSSMouseStates(t,e){w.unsetActivityCSSMouseStates(t,e),e[g]&&w.unsetStyle(t,e[g])}static processStateful(t){const e=t[g]||{},i=Object.assign(JSON.parse(JSON.stringify(e)),null==t?void 0:t[b]),s=Object.assign(JSON.parse(JSON.stringify(i)),null==t?void 0:t[y]);return{[g]:e,[b]:i,[y]:s}}static mergeStatefulStyles(t){const e={[g]:{},[b]:{},[y]:{}};return t.forEach(t=>{e[g]=Object.assign(e[g],t[g]),e[b]=Object.assign(e[b],t[b]),e[y]=Object.assign(e[y],t[y])}),e}static overwriteDefaultWithAlreadyApplied(t,i){Object.keys(t[g]||[]).forEach(s=>{var n;const o=s;i[e][o]&&null!=(n=t[g])&&n[o]&&(t[g][s]=i[e][o])})}static applyToStyleIfNotDefined(t,e){for(const i in e){const s=e[i];""===t[i]&&s&&(t[i]=s)}}}const x=class t{static attemptAppendStyleSheetToHead(e){if(e.fontFamily&&e.fontFamily!==t.DEFAULT_FONT_FAMILY)return;const s=document.getElementsByTagName("head")[0];if(!Array.from(s.getElementsByTagName("link")).some(e=>e.getAttribute("href")===t.FONT_URL)){const e=i("link");e.rel="stylesheet",e.href=t.FONT_URL,s.appendChild(e)}}};x.FONT_URL="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap",x.DEFAULT_FONT_FAMILY="'Inter', sans-serif, Avenir, Helvetica, Arial";let k=x;const S=class t{static apply(e,i){if(i)try{t.applyStyleSheet(e,i)}catch{t.addStyleElement(e,i)}}static applyStyleSheet(t,e){const i=new CSSStyleSheet;i.replaceSync(t),e.adoptedStyleSheets.push(i)}static addStyleElement(t,e){const s=i("style");s.innerHTML=t,e.appendChild(s)}static applyDefaultStyleToComponent(e,i){i&&w.applyToStyleIfNotDefined(e,i),w.applyToStyleIfNotDefined(e,t.DEFAULT_COMPONENT_STYLE)}};S.DEFAULT_COMPONENT_STYLE={height:"350px",width:"320px",borderTop:"1px solid #cacaca",borderRight:"1px solid #cacaca",borderLeft:"1px solid #cacaca",borderBottom:"1px solid #cacaca",fontFamily:k.DEFAULT_FONT_FAMILY,fontSize:"0.9rem",backgroundColor:"white",position:"relative",overflow:"hidden"};let _=S;const O="service",M="text",A="html",C="error",T="https://deepchat.dev/docs/",j="ai",E="user",N="assistant",I="error-message-text",P="deep-chat-outer-container-role-",$="empty-message",B="deep-chat-top-message",R="deep-chat-middle-message",J="deep-chat-bottom-message",F="src",L="type",q="file",z="files",D="image",U="images",H="camera",V="gifs",W="audio",G="microphone",Z="mixedFiles",K="any",X="file-message",Q=class s{static buildElement(){const e=i();e[t].add("tooltip");const s=i("span");return s[t].add("tooltip-text"),e.appendChild(s),e}static tryCreateConfig(t,i){if(i)return"boolean"==typeof i?{[M]:t}:{[M]:i[M]||t,timeout:i.timeout||0,style:i[e]}}static traverseParentUntilContainer(t){let e=t;for(;e.parentElement;)e=e.parentElement;return e}static setPosition(t,i){const n=i.getRootNode().host.getBoundingClientRect(),o=t.getBoundingClientRect(),r=i.getBoundingClientRect().width/2,a=o.left+o.width/2;i[e].left=a-r-n.left+"px",i[e].top=o.top-36-n.top+"px";const l=i.getBoundingClientRect();l.left<n.left?i[e].left=`${s.OVERFLOW_NEW_POSITION_PX}px`:l.right>n.right&&(i[e].left=n.width-l.width-s.OVERFLOW_NEW_POSITION_PX+"px")}static display(t,i,n){return n||(n=s.traverseParentUntilContainer(t).nextSibling),i[M]&&(n.children[0].textContent=i[M]),{timeout:setTimeout(()=>{n[e].visibility="visible",s.setPosition(t,n),i[e]&&Object.assign(n[e],i[e])},i.timeout||0),element:n}}static hide(t,i){clearTimeout(t.timeout),t.element[e].visibility="hidden",i[e]&&w.unsetStyle(t.element,i[e]),t.element[e].left="",t.element[e].top=""}};Q.OVERFLOW_NEW_POSITION_PX=4;let Y=Q;const tt=class{};tt.IS_SAFARI=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),tt.IS_CHROMIUM=window.chrome,tt.IS_MOBILE=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let et=tt;var it=(t=>(t.ESCAPE="Escape",t.ENTER="Enter",t.TAB="Tab",t.ARROW_UP="ArrowUp",t.ARROW_DOWN="ArrowDown",t.ARROW_RIGHT="ArrowRight",t.ARROW_LEFT="ArrowLeft",t.BACKSPACE="Backspace",t.DELETE="Delete",t.META="Meta",t.CONTROL="Control",t))(it||{});const st=class t{static add(e,i,s,n){void 0!==s&&e.addEventListener("keydown",t.onKeyDown.bind(this,s)),e.oninput=t.onInput.bind(this,s,n),e.addEventListener("paste",t=>{var e;t.preventDefault(),null!=(e=t.clipboardData)&&e[z].length&&i.addFilesToAnyType(Array.from(t.clipboardData[z]))})}static onKeyDown(e,i){const s=i.target.textContent;s&&s.length>=e&&!t.PERMITTED_KEYS.has(i.key)&&!t.isKeyCombinationPermitted(i)&&i.preventDefault()}static isKeyCombinationPermitted(t){return"a"===t.key&&(t.ctrlKey||t.metaKey)}static onInput(t,e,i){const s=i.target,n=s.textContent||"";void 0!==t&&n.length>t&&(s.textContent=n.substring(0,t),lt.focusEndOfInput(s)),null==e||e()}};st.PERMITTED_KEYS=new Set([it.BACKSPACE,it.DELETE,it.ARROW_RIGHT,it.ARROW_LEFT,it.ARROW_DOWN,it.ARROW_UP,it.META,it.CONTROL,it.ENTER]);let nt=st;class ot{static sanitizePastedTextContent(t){var e,i;t.preventDefault();const s=null==(e=t.clipboardData)?void 0:e.getData("text/plain");s&&(null==(i=document.execCommand)||i.call(document,"insertText",!1,s))}}const rt=class s{constructor(t,e,i){var n,o;this._isComposing=!1;const r=s.processConfig(e,t.textInput);this.elementRef=s.createContainerElement(null==(n=null==r?void 0:r.styles)?void 0:n.container),this._config=r,this.inputElementRef=this.createInputElement(),this.elementRef.appendChild(this.inputElementRef),t.setPlaceholderText=this.setPlaceholderText.bind(this),t.setPlaceholderText((null==(o=this._config.placeholder)?void 0:o[M])||"Ask me anything!"),setTimeout(()=>{nt.add(this.inputElementRef,i,this._config.characterLimit,t._validationHandler),this._onInput=e.onInput})}static processConfig(t,e){var i;return e??(e={}),e.disabled??(e.disabled=t.isTextInputDisabled),e.placeholder??(e.placeholder={}),(i=e.placeholder)[M]??(i[M]=t.textInputPlaceholderText),e}static createContainerElement(t){const s=i();return s.id="text-input-container",Object.assign(s[e],t),s}static preventAutomaticScrollUpOnNewLine(t){let e;t.addEventListener("keydown",()=>{e=window.scrollY}),t.addEventListener("input",()=>{e!==window.scrollY&&window.scrollTo({top:e})})}clear(){var i,s;const n=window.scrollY;this.inputElementRef[t].contains("text-input-disabled")||(Object.assign(this.inputElementRef[e],null==(i=this._config.placeholder)?void 0:i[e]),this.inputElementRef.textContent="",lt.focusEndOfInput(this.inputElementRef),null==(s=this._onInput)||s.call(this,!1)),et.IS_CHROMIUM&&window.scrollTo({top:n})}createInputElement(){var n,o,r,a;const l=i();return l.id=s.TEXT_INPUT_ID,l[t].add("text-input-styling"),l.role="textbox",et.IS_MOBILE&&l.setAttribute("tabindex","0"),et.IS_CHROMIUM&&s.preventAutomaticScrollUpOnNewLine(l),"boolean"==typeof this._config.disabled&&!0===this._config.disabled?(l.contentEditable="false",l[t].add("text-input-disabled"),l.setAttribute("aria-disabled","true")):(l.contentEditable="true",l.removeAttribute("aria-disabled"),this.addEventListeners(l)),Object.assign(l[e],null==(n=this._config.styles)?void 0:n[M]),Object.assign(l[e],null==(o=this._config.placeholder)?void 0:o[e]),null!=(a=null==(r=this._config.placeholder)?void 0:r[e])&&a.color||l.setAttribute("textcolor",""),l}removePlaceholderStyle(){var i,s,n,o;!this.inputElementRef[t].contains("text-input-disabled")&&null!=(i=this._config.placeholder)&&i[e]&&(w.unsetStyle(this.inputElementRef,null==(s=this._config.placeholder)?void 0:s[e]),Object.assign(this.inputElementRef[e],null==(o=null==(n=this._config)?void 0:n.styles)?void 0:o[M]))}addEventListeners(t){var i,s;null!=(i=this._config.styles)&&i.focus&&(t.onfocus=()=>{var t;return Object.assign(this.elementRef[e],null==(t=this._config.styles)?void 0:t.focus)},t.onblur=this.onBlur.bind(this,this._config.styles.focus,null==(s=this._config.styles)?void 0:s.container)),t.addEventListener("keydown",this.onKeydown.bind(this)),t.addEventListener("input",this.onInput.bind(this)),t.addEventListener("paste",ot.sanitizePastedTextContent),t.addEventListener("compositionstart",()=>this._isComposing=!0),t.addEventListener("compositionend",()=>this._isComposing=!1)}onBlur(t,i){w.unsetStyle(this.elementRef,t),i&&Object.assign(this.elementRef[e],i)}onKeydown(t){var e;t.key===it.ENTER&&!et.IS_MOBILE&&!this._isComposing&&!t.ctrlKey&&!t.shiftKey&&(t.preventDefault(),null==(e=this.submit)||e.call(this))}onInput(){var t,i;this.isTextInputEmpty()?Object.assign(this.inputElementRef[e],null==(t=this._config.placeholder)?void 0:t[e]):this.removePlaceholderStyle(),null==(i=this._onInput)||i.call(this,!0)}setPlaceholderText(t){this.inputElementRef.setAttribute("deep-chat-placeholder-text",t),this.inputElementRef.setAttribute("aria-label",t)}isTextInputEmpty(){return""===this.inputElementRef.textContent}};rt.TEXT_INPUT_ID="text-input";let at=rt;class lt{static focusEndOfInput(t){const e=document.createRange();e.selectNodeContents(t),e.collapse(!1);const i=window.getSelection();null==i||i.removeAllRanges(),null==i||i.addRange(e),(et.IS_MOBILE||et.IS_SAFARI)&&t.focus()}static focusFromParentElement(t){const e=t.querySelector(`#${at.TEXT_INPUT_ID}`);e&&lt.focusEndOfInput(e)}}function ct(t){return t.charAt(0).toUpperCase()+t.slice(1)}function ht(t,e,i,s){const n=`\n${ct(e)} message: ${JSON.stringify(t)} \n`,o=i?`${ct(e)} message after interceptor: ${function(t){return t&&JSON.stringify(t)}(s)} \n`:"";return n+o}const ut=function(t,e,i,s){return`${ht(t,e,i,s)}Make sure the ${e} message is using the Response format: ${T}connect/#Response \nYou can also augment it using the responseInterceptor property: ${T}interceptors#responseInterceptor`},dt=function(t,e){const i="request";return`${ht(t,i,e)}Make sure the ${i} message is using the {body: {text: string}} format, e.g: {body: {text: "Model Response"}}`},pt=function(t,e,i){const s="response";return`${ht(t,s,e,i)}Make sure the ${s} message is using the {text: string} format, e.g: {text: "Model Response"}`},mt="Invalid API Key",vt="Failed to connect",ft="Request settings have not been set up",gt="No file was added",bt="Image was not found",yt="Multi-response arrays are not supported for streaming",wt=`Make sure the events are using {text: string} or {html: string} format.\nYou can also augment them using the responseInterceptor property: ${T}interceptors#responseInterceptor`,xt=`No valid stream events were sent.\n${wt}`,kt="Please define a `function_handler` property inside the service config.",St="Function tool response must be an array or contain a text property",_t="Authentication",Ot="Authorization",Mt="authorization",At="Unauthorized",Ct="Authorization header",Tt="Invalid",jt="Incorrect",Et="authentication_error",Nt="invalid_request_error",It="Content-Type",Pt="content-type",$t="application/json",Bt="object",Rt="completed",Jt="Bearer ",Ft="GET",Lt="POST",qt="Upload an audio file",zt=class t{static addElements(t,...e){e.forEach(e=>t.appendChild(e))}static isScrollbarAtBottomOfElement(e){const i=e.scrollHeight,s=e.clientHeight;return e.scrollTop>=i-s-t.CODE_SNIPPET_GENERATION_JUMP}static cloneElement(t){const e=t.cloneNode(!0);return t.parentNode.replaceChild(e,t),e}static scrollToBottom(t,e=!1,i){i?t.scrollTo({left:0,top:i.offsetTop}):e?t.scrollTo({left:0,top:t.scrollHeight,behavior:"smooth"}):t.scrollTop=t.scrollHeight}static scrollToTop(t){t.scrollTop=0}};zt.CODE_SNIPPET_GENERATION_JUMP=.5;let Dt=zt;const Ut=class t{static speak(t,e){if(!e.audio&&window.SpeechSynthesisUtterance){const i=new SpeechSynthesisUtterance(t);Object.assign(i,e),speechSynthesis.speak(i)}}static processConfig(e,i){const s={};setTimeout(()=>{if("object"==typeof e&&(e.audio&&(s.audio=e.audio),e.lang&&(s.lang=e.lang),e.pitch&&(s.pitch=e.pitch),e.rate&&(s.rate=e.rate),e.volume&&(s.volume=e.volume),e.voiceName)){const t=window.speechSynthesis.getVoices().find(t=>{var i;return t.name.toLocaleLowerCase()===(null==(i=e.voiceName)?void 0:i.toLocaleLowerCase())});t&&(s.voice=t)}i(s)},t.LOAD_VOICES_MS)}};Ut.LOAD_VOICES_MS=200;let Ht=Ut;const Vt=class t{static colorToHex(t){const s=i();return s[e].color=t,document.body.appendChild(s),`#${window.getComputedStyle(s).color.match(/\d+/g).map(t=>parseInt(t).toString(16).padStart(2,"0")).join("")}`}static setDots(i,s){var n,o;if(null!=(o=null==(n=null==s?void 0:s.styles)?void 0:n.bubble)&&o.color){const n=t.colorToHex(s.styles.bubble.color);i[e].setProperty("--loading-message-color",n),i[e].setProperty("--loading-message-color-fade",`${n}33`)}else i[e].setProperty("--loading-message-color","#848484"),i[e].setProperty("--loading-message-color-fade","#55555533")}static setRing(i,s){const{color:n,width:o,height:r,margin:a,border:l}=s||{};if(n){const s=t.colorToHex(n);i[e].setProperty("--loading-history-color",s)}else i[e].setProperty("--loading-history-color","#dbdbdb");i[e].setProperty("--loading-history-height",r||"57px"),i[e].setProperty("--loading-history-width",o||"57px"),i[e].setProperty("--loading-history-margin",a||"7px"),i[e].setProperty("--loading-history-border",l||"6px solid")}};Vt.BUBBLE_CLASS="deep-chat-loading-message-bubble",Vt.DOTS_CONTAINER_CLASS="deep-chat-loading-message-dots-container";let Wt=Vt;class Gt{static checkForContainerStyles(t,i){const s=t.containerStyle;s&&(Object.assign(i[e],s),console[C](`The containerStyle property${Zt}1.3.14.`),console[C](`${Kt}the style property instead: ${T}styles#style`))}static handleResponseProperty(t){return console[C](`The {result: ....} response object type${Zt}1.3.0.`),console[C](`${Kt}the new response object: ${T}connect#Response`),t.result}static processHistory(t){const e=t.initialMessages;if(e)return console[C](`The initialMessages property${Zt}2.0.0.`),console[C](`${Kt}the history property instead: ${T}messages/#history`),e}static processHistoryFile(t){const e=t[q];e&&(console[C](`The file property in MessageContent${Zt}1.3.17.`),console[C](`${Kt}the files array property: ${T}messages/#MessageContent`),t[z]=[e])}static processValidateInput(t){const e=t.validateMessageBeforeSending;if(e)return console[C](`The validateMessageBeforeSending property${Zt}1.3.24.`),console[C](`${Kt}validateInput: ${T}interceptors#validateInput`),e}static processSubmitUserMessage(t){return console[C](`The submitUserMessage(text: string) argument string type${Zt}1.4.4.`),console[C](`${Kt}the new argument type: ${T}methods#submitUserMessage`),{[M]:t}}static flagHTMLUpdateClass(e){var i;null!=(i=e.children[0])&&i[t].contains("deep-chat-update-message")&&(console[C](`The "deep-chat-update-message" html class${Zt}1.4.4.`),console[C](`${Kt}using {..., overwrite: true} object: ${T}connect#Response`))}static processConnect(t){const e=t;e.request&&(e.connect?Object.assign(e.connect,e.request):e.connect=e.request,console[C](`The request property${Zt}2.0.0.`),console[C](`${Xt}connect object: ${T}connect#connect-1`))}static checkForStream(t){const e=t.stream;if(e)return console[C](`The stream property${Yt}the connect object in version 2.0.0.`),console[C](`${Xt}connect object: ${T}connect#connect-1`),e}static fireOnNewMessage(t,e){var i;const s=t;s.onNewMessage&&(console[C]("The onNewMessage event has been deprecated since version 2.0.0."),console[C](`${Xt}onMessage event: ${T}events#onMessage`),null==(i=s.onNewMessage)||i.call(s,e)),t.dispatchEvent(new CustomEvent("new-message",{detail:e}))}static processFileConfigConnect(t){const e=t;e.request&&(console[C](`The request property in file configuration${Zt}2.0.0.`),console[C](`Please use the connect property instead: ${T}files`),e.connect||(e.connect=e.request))}static processMessageStyles(t){if(!t)return;const e=JSON.parse(JSON.stringify(t)),i=e.loading;return i&&(i.outerContainer||i.innerContainer||i.bubble||i.media)&&(console[C]("The loading message styles are defined using LoadingMessageStyles interface since version 2.1.0."),console[C](`Check it out here: ${T}messages/styles#LoadingMessageStyles`),e.loading={message:{styles:i}}),e}static processDemo(t){return"boolean"==typeof t||t.displayLoadingBubble&&(console[C](`The demo displayLoadingBubble property${Zt}2.1.0.`),console[C](`Please use displayLoading instead: ${T}modes#demo`),t.displayLoading={message:!0}),t}static processCohere(t){const e=t,i=`${Xt}official documentation: ${T}directConnection/Cohere`;return e.chat&&(console[C](`Cohere chat property${Zt}2.2.3.`),console[C](i),delete e.chat),e.textGeneration?(console[C](`Cohere textGeneration${Qt}2.2.3.`),console[C](i),delete e.textGeneration,!1):!e.summarization||(console[C](`Cohere summarization${Qt}2.2.3.`),console[C](i),delete e.summarization,!1)}static processStreamHTMLWrappers(t){if(!t||typeof t!==Bt)return;const e=t.htmlWrappers;return e?(console[C](`The htmlWrappers property${Yt}Deep Chat's base since version 2.3.0.`),console[C](`Check it out here: ${T}messages/HTML#htmlWrappers`),e):void 0}static processFocusMode(t){return!t||"boolean"==typeof t||t.scroll&&(console[C]("The scroll property in focusMode has been changed to smoothScroll since version 2.3.0."),console[C](`Check it out here: ${T}modes#focusMode`),t.smoothScroll=!0),t}}const Zt=" is deprecated since version ",Kt="Please change to using ",Xt="Please see the ",Qt=" is not supported since version ",Yt=" has been moved to ";class te{static mouseUp(t,i){w.unsetAllCSSMouseStates(t,i),Object.assign(t[e],i[g]),Object.assign(t[e],i[b])}static mouseDown(t,i){Object.assign(t[e],i[y])}static mouseLeave(t,i){w.unsetAllCSSMouseStates(t,i),Object.assign(t[e],i[g])}static mouseEnter(t,i){Object.assign(t[e],i[b])}static add(t,e){t.addEventListener("mouseenter",te.mouseEnter.bind(this,t,e)),t.addEventListener("mouseleave",te.mouseLeave.bind(this,t,e)),t.addEventListener("mousedown",te.mouseDown.bind(this,t,e)),t.addEventListener("mouseup",te.mouseUp.bind(this,t,e))}}const ee={"deep-chat-button":{styles:{[g]:{backgroundColor:"white",padding:"5px",paddingLeft:"7px",paddingRight:"7px",border:"1px solid #c2c2c2",borderRadius:"6px",cursor:"pointer"},[b]:{backgroundColor:"#fafafa"},[y]:{backgroundColor:"#f1f1f1"}}}},ie=Object.keys(ee);class se{static applySuggestionEvent(t,e){setTimeout(()=>{e.addEventListener(y,()=>{var i,s;null==(s=t.submitUserMessage)||s.call(t,{[M]:(null==(i=e.textContent)?void 0:i.trim())||""})})})}static isElementTemporary(e){var i;return!!e&&(null==(i=e.bubbleElement.children[0])?void 0:i[t].contains("deep-chat-temporary-message"))}static doesElementContainDeepChatClass(e){return ie.find(i=>e[t].contains(i))}static applyEvents(t,e){const i=ee[e].events;Object.keys(i||[]).forEach(e=>{t.addEventListener(e,null==i?void 0:i[e])})}static getProcessedStyles(e,i,s){const n=Array.from(i[t]).reduce((t,i)=>{var s;const n=null==(s=e[i])?void 0:s.styles;return n&&e[i].styles&&t.push(n),t},[]),o=ee[s].styles;if(o){const t=JSON.parse(JSON.stringify(o));t[g]&&w.overwriteDefaultWithAlreadyApplied(t,i),n.unshift(t)}const r=w.mergeStatefulStyles(n);return w.processStateful(r)}static applyDeepChatUtilities(t,e,i){ie.forEach(t=>{const s=i.getElementsByClassName(t);Array.from(s||[]).forEach(i=>{const s=se.getProcessedStyles(e,i,t);oe.applyStylesToElement(i,s),se.applyEvents(i,t)})});const s=i.getElementsByClassName("deep-chat-suggestion-button");Array.from(s).forEach(e=>se.applySuggestionEvent(t,e))}}const ne=class t{static applyStylesToElement(t,i){const s=w.processStateful(i);te.add(t,s),Object.assign(t[e],s[g])}static applyEventsToElement(t,e){Object.keys(e).forEach(i=>{const s=e[i];s&&t.addEventListener(i,s)})}static applyClassUtilitiesToElement(e,i){const{events:s,styles:n}=i;s&&t.applyEventsToElement(e,s),n&&!se.doesElementContainDeepChatClass(e)&&t.applyStylesToElement(e,n)}static applyCustomClassUtilities(e,i){Object.keys(e).forEach(s=>{const n=i.getElementsByClassName(s);Array.from(n).forEach(i=>{e[s]&&t.applyClassUtilitiesToElement(i,e[s])})})}static apply(e,i){se.applyDeepChatUtilities(e,e.htmlClassUtilities,i),t.applyCustomClassUtilities(e.htmlClassUtilities,i)}static traverseNodes(e,i){e.nodeType===Node.ELEMENT_NODE&&i.push(e.outerHTML),e.childNodes.forEach(e=>{t.traverseNodes(e,i)})}static splitHTML(e){const i=(new DOMParser).parseFromString(e,"text/html"),s=[];return i.body.childNodes.forEach(e=>{t.traverseNodes(e,s)}),s}static isTemporaryBasedOnHTML(t){const e=i();return e.innerHTML=t,se.isElementTemporary({outerContainer:e,bubbleElement:e,innerContainer:e})}static replaceElementWithNewClone(t,e){var i;const s=(e||t).cloneNode(!0);return null==(i=t.parentNode)||i.replaceChild(s,t),s}static tryAddWrapper(e,i,s,n){if(i&&n){const i=(null==s?void 0:s[n])||(null==s?void 0:s[g]);if(i)return e.innerHTML=i,{contentEl:t.getTargetWrapper(e),wrapper:!0}}return{contentEl:e,wrapper:!1}}static getTargetWrapper(e){return e.getElementsByClassName(t.TARGET_WRAPPER_CLASS)[0]||e}};ne.TARGET_WRAPPER_CLASS="html-wrapper";let oe=ne;const re=class e{static addElement(t,e,i){const s=Dt.isScrollbarAtBottomOfElement(t.elementRef);t.appendOuterContainerElemet(e),!t.focusMode&&i&&s&&Dt.scrollToBottom(t.elementRef,!1,e)}static createElements(i,s,n,o,r=!1){const a=i.createMessageElementsOnOrientation("",n,o,r);a.bubbleElement[t].add(e.HTML_BUBBLE_CLASS);const{contentEl:l}=oe.tryAddWrapper(a.bubbleElement,s,i._customWrappers,n);return l.innerHTML=s,a}static overwriteElements(t,e,i){i.bubbleElement.innerHTML=e,oe.apply(t,i.outerContainer),Gt.flagHTMLUpdateClass(i.bubbleElement)}static overwrite(t,i,s,n){const{messageToElements:o}=t,r=Xi.overwriteMessage(o,n,i,s,A,e.HTML_BUBBLE_CLASS);return r&&e.overwriteElements(t,i,r),r}static create(t,i,s,n=!1){var o;const r=e.createElements(t,i,s,n);return Xi.fillEmptyMessageElement(r.bubbleElement,i),oe.apply(t,r.outerContainer),Gt.flagHTMLUpdateClass(r.bubbleElement),t.applyCustomStyles(r,s,!1,null==(o=t.messageStyles)?void 0:o[A]),r}static add(t,i,s,n,o,r=!1){if(null!=o&&o.status){const e=this.overwrite(t,i,s,t.messageElementRefs);if(e)return e;o.status=!1}if(r&&t.messageElementRefs.length>0&&oe.isTemporaryBasedOnHTML(i))return;const a=e.create(t,i,s,r);return r||e.addElement(t,a.outerContainer,n),a}};re.HTML_BUBBLE_CLASS="html-message";let ae=re;class le{static katex(t,e,i){const s=(i||{}).delimiter||"$";if(1!==s.length)throw new Error("invalid delimiter");e.inline.ruler.push("katex",(t,e)=>{const i=t.pos,n=t.posMax;let o=i;if(t.src.charAt(o)!==s)return!1;for(++o;o<n&&t.src.charAt(o)===s;)++o;const r=t.src.slice(i,o);if(r.length>2)return!1;const a=o;let l=0;for(;o<n;){const i=t.src.charAt(o);if("{"!==i||0!==o&&"\\"===t.src.charAt(o-1)){if("}"!==i||0!==o&&"\\"===t.src.charAt(o-1)){if(i===s&&0===l){const i=o;let l=o+1;for(;l<n&&t.src.charAt(l)===s;)++l;if(l-i===r.length){if(!e){const e=t.src.slice(a,i).replace(/[ \n]+/g," ").trim();t.push({type:"katex",content:e,block:r.length>1,level:t.level})}return t.pos=l,!0}}}else if(l-=1,l<0)return!1}else l+=1;o+=1}return e||(t.pending+=r),t.pos+=r.length,!0},i),e.block.ruler.push("katex",(t,e,i)=>{let n=!1,o=t.bMarks[e]+t.tShift[e],r=t.eMarks[e];if(o+1>r)return!1;const a=t.src.charAt(o);if(a!==s)return!1;let l=o;o=t.skipChars(o,a);let c=o-l;if(2!==c)return!1;let h=e;for(;++h,!(h>=i||(o=l=t.bMarks[h]+t.tShift[h],r=t.eMarks[h],o<r&&t.tShift[h]<t.blkIndent));)if(!(t.src.charAt(o)!==s||t.tShift[h]-t.blkIndent>=4||(o=t.skipChars(o,a),o-l<c||(o=t.skipSpaces(o),o<r)))){n=!0;break}c=t.tShift[e],t.line=h+(n?1:0);const u=t.getLines(e+1,h,c,!0).replace(/[ \n]+/g," ").trim();return t.tokens.push({type:"katex",params:null,content:u,lines:[e,t.line],level:t.level,block:!0}),!0},i),e.renderer.rules.katex=(e,i)=>((e,i)=>{var s;return(null==(s=window.katex)?void 0:s.renderToString(e,{displayMode:i,throwOnError:!1,output:"mathml",...t}))||""})(e[i].content,e[i].block),e.renderer.rules.katex.delimiter=s}}var ce;function he(t){return(ce=ce||document.createElement("textarea")).innerHTML="&"+t+";",ce.value}var ue=Object.prototype.hasOwnProperty;function de(t){return[].slice.call(arguments,1).forEach(function(e){if(e){if("object"!=typeof e)throw new TypeError(e+"must be object");Object.keys(e).forEach(function(i){t[i]=e[i]})}}),t}var pe=/\\([\\!"#$%&'()*+,.\/:;<=>?@[\]^_`{|}~-])/g;function me(t){return t.indexOf("\\")<0?t:t.replace(pe,"$1")}function ve(t){return!(t>=55296&&t<=57343||t>=64976&&t<=65007||!(65535&~t)||65534==(65535&t)||t>=0&&t<=8||11===t||t>=14&&t<=31||t>=127&&t<=159||t>1114111)}function fe(t){if(t>65535){var e=55296+((t-=65536)>>10),i=56320+(1023&t);return String.fromCharCode(e,i)}return String.fromCharCode(t)}var ge=/&([a-z#][a-z0-9]{1,31});/gi,be=/^#((?:x[a-f0-9]{1,8}|[0-9]{1,8}))/i;function ye(t,e){var i=0,s=he(e);return e!==s?s:35===e.charCodeAt(0)&&be.test(e)&&ve(i="x"===e[1].toLowerCase()?parseInt(e.slice(2),16):parseInt(e.slice(1),10))?fe(i):t}function we(t){return t.indexOf("&")<0?t:t.replace(ge,ye)}var xe=/[&<>"]/,ke=/[&<>"]/g,Se={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};function _e(t){return Se[t]}function Oe(t){return xe.test(t)?t.replace(ke,_e):t}var Me={};function Ae(t,e){return++e>=t.length-2?e:"paragraph_open"===t[e].type&&t[e].tight&&"inline"===t[e+1].type&&0===t[e+1].content.length&&"paragraph_close"===t[e+2].type&&t[e+2].tight?Ae(t,e+2):e}Me.blockquote_open=function(){return"<blockquote>\n"},Me.blockquote_close=function(t,e){return"</blockquote>"+Ce(t,e)},Me.code=function(t,e){return t[e].block?"<pre><code>"+Oe(t[e].content)+"</code></pre>"+Ce(t,e):"<code>"+Oe(t[e].content)+"</code>"},Me.fence=function(t,e,i,s,n){var o,r,a=t[e],l="",c=i.langPrefix;if(a.params){if(r=(o=a.params.split(/\s+/g)).join(" "),function(t,e){return!!t&&ue.call(t,e)}(n.rules.fence_custom,o[0]))return n.rules.fence_custom[o[0]](t,e,i,s,n);l=' class="'+c+Oe(we(me(r)))+'"'}return"<pre><code"+l+">"+(i.highlight&&i.highlight.apply(i.highlight,[a.content].concat(o))||Oe(a.content))+"</code></pre>"+Ce(t,e)},Me.fence_custom={},Me.heading_open=function(t,e){return"<h"+t[e].hLevel+">"},Me.heading_close=function(t,e){return"</h"+t[e].hLevel+">\n"},Me.hr=function(t,e,i){return(i.xhtmlOut?"<hr />":"<hr>")+Ce(t,e)},Me.bullet_list_open=function(){return"<ul>\n"},Me.bullet_list_close=function(t,e){return"</ul>"+Ce(t,e)},Me.list_item_open=function(){return"<li>"},Me.list_item_close=function(){return"</li>\n"},Me.ordered_list_open=function(t,e){var i=t[e];return"<ol"+(i.order>1?' start="'+i.order+'"':"")+">\n"},Me.ordered_list_close=function(t,e){return"</ol>"+Ce(t,e)},Me.paragraph_open=function(t,e){return t[e].tight?"":"<p>"},Me.paragraph_close=function(t,e){var i=!(t[e].tight&&e&&"inline"===t[e-1].type&&!t[e-1].content);return(t[e].tight?"":"</p>")+(i?Ce(t,e):"")},Me.link_open=function(t,e,i){var s=t[e].title?' title="'+Oe(we(t[e].title))+'"':"",n=i.linkTarget?' target="'+i.linkTarget+'"':"";return'<a href="'+Oe(t[e].href)+'"'+s+n+">"},Me.link_close=function(){return"</a>"},Me.image=function(t,e,i){var s=' src="'+Oe(t[e].src)+'"',n=t[e].title?' title="'+Oe(we(t[e].title))+'"':"";return"<img"+s+(' alt="'+(t[e].alt?Oe(we(me(t[e].alt))):"")+'"')+n+(i.xhtmlOut?" /":"")+">"},Me.table_open=function(){return"<table>\n"},Me.table_close=function(){return"</table>\n"},Me.thead_open=function(){return"<thead>\n"},Me.thead_close=function(){return"</thead>\n"},Me.tbody_open=function(){return"<tbody>\n"},Me.tbody_close=function(){return"</tbody>\n"},Me.tr_open=function(){return"<tr>"},Me.tr_close=function(){return"</tr>\n"},Me.th_open=function(t,e){var i=t[e];return"<th"+(i.align?' style="text-align:'+i.align+'"':"")+">"},Me.th_close=function(){return"</th>"},Me.td_open=function(t,e){var i=t[e];return"<td"+(i.align?' style="text-align:'+i.align+'"':"")+">"},Me.td_close=function(){return"</td>"},Me.strong_open=function(){return"<strong>"},Me.strong_close=function(){return"</strong>"},Me.em_open=function(){return"<em>"},Me.em_close=function(){return"</em>"},Me.del_open=function(){return"<del>"},Me.del_close=function(){return"</del>"},Me.ins_open=function(){return"<ins>"},Me.ins_close=function(){return"</ins>"},Me.mark_open=function(){return"<mark>"},Me.mark_close=function(){return"</mark>"},Me.sub=function(t,e){return"<sub>"+Oe(t[e].content)+"</sub>"},Me.sup=function(t,e){return"<sup>"+Oe(t[e].content)+"</sup>"},Me.hardbreak=function(t,e,i){return i.xhtmlOut?"<br />\n":"<br>\n"},Me.softbreak=function(t,e,i){return i.breaks?i.xhtmlOut?"<br />\n":"<br>\n":"\n"},Me.text=function(t,e){return Oe(t[e].content)},Me.htmlblock=function(t,e){return t[e].content},Me.htmltag=function(t,e){return t[e].content},Me.abbr_open=function(t,e){return'<abbr title="'+Oe(we(t[e].title))+'">'},Me.abbr_close=function(){return"</abbr>"},Me.footnote_ref=function(t,e){var i=Number(t[e].id+1).toString(),s="fnref"+i;return t[e].subId>0&&(s+=":"+t[e].subId),'<sup class="footnote-ref"><a href="#fn'+i+'" id="'+s+'">['+i+"]</a></sup>"},Me.footnote_block_open=function(t,e,i){return(i.xhtmlOut?'<hr class="footnotes-sep" />\n':'<hr class="footnotes-sep">\n')+'<section class="footnotes">\n<ol class="footnotes-list">\n'},Me.footnote_block_close=function(){return"</ol>\n</section>\n"},Me.footnote_open=function(t,e){return'<li id="fn'+Number(t[e].id+1).toString()+'"  class="footnote-item">'},Me.footnote_close=function(){return"</li>\n"},Me.footnote_anchor=function(t,e){var i="fnref"+Number(t[e].id+1).toString();return t[e].subId>0&&(i+=":"+t[e].subId),' <a href="#'+i+'" class="footnote-backref">↩</a>'},Me.dl_open=function(){return"<dl>\n"},Me.dt_open=function(){return"<dt>"},Me.dd_open=function(){return"<dd>"},Me.dl_close=function(){return"</dl>\n"},Me.dt_close=function(){return"</dt>\n"},Me.dd_close=function(){return"</dd>\n"};var Ce=Me.getBreak=function(t,e){return(e=Ae(t,e))<t.length&&"list_item_close"===t[e].type?"":"\n"};function Te(){this.rules=de({},Me),this.getBreak=Me.getBreak}function je(){this.t=[],this.i=null}function Ee(t,e,i,s,n){this.src=t,this.env=s,this.options=i,this.parser=e,this.tokens=n,this.pos=0,this.posMax=this.src.length,this.level=0,this.pending="",this.pendingLevel=0,this.cache=[],this.isInLabel=!1,this.linkLevel=0,this.linkContent="",this.labelUnmatchedScopes=0}function Ne(t,e){var i,s,n,o=-1,r=t.posMax,a=t.pos,l=t.isInLabel;if(t.isInLabel)return-1;if(t.labelUnmatchedScopes)return t.labelUnmatchedScopes--,-1;for(t.pos=e+1,t.isInLabel=!0,i=1;t.pos<r;){if(91===(n=t.src.charCodeAt(t.pos)))i++;else if(93===n&&0===--i){s=!0;break}t.parser.skipToken(t)}return s?(o=t.pos,t.labelUnmatchedScopes=0):t.labelUnmatchedScopes=i-1,t.pos=a,t.isInLabel=l,o}function Ie(t,e,i,s){var n,o,r,a,l,c;if(42!==t.charCodeAt(0)||91!==t.charCodeAt(1)||-1===t.indexOf("]:")||((o=Ne(n=new Ee(t,e,i,s,[]),1))<0||58!==t.charCodeAt(o+1)))return-1;for(a=n.posMax,r=o+2;r<a&&10!==n.src.charCodeAt(r);r++);return l=t.slice(2,o),0===(c=t.slice(o+2,r).trim()).length?-1:(s.abbreviations||(s.abbreviations={}),typeof s.abbreviations[":"+l]>"u"&&(s.abbreviations[":"+l]=c),r)}function Pe(t){var e=we(t);try{e=decodeURI(e)}catch{}return encodeURI(e)}function $e(t,e){var i,s,n,o=e,r=t.posMax;if(60===t.src.charCodeAt(e)){for(e++;e<r;){if(10===(i=t.src.charCodeAt(e)))return!1;if(62===i)return n=Pe(me(t.src.slice(o+1,e))),!!t.parser.validateLink(n)&&(t.pos=e+1,t.linkContent=n,!0);92===i&&e+1<r?e+=2:e++}return!1}for(s=0;e<r&&!(32===(i=t.src.charCodeAt(e))||i<32||127===i);)if(92===i&&e+1<r)e+=2;else{if(40===i&&++s>1||41===i&&--s<0)break;e++}return!(o===e||(n=me(t.src.slice(o,e)),!t.parser.validateLink(n)))&&(t.linkContent=n,t.pos=e,!0)}function Be(t,e){var i,s=e,n=t.posMax,o=t.src.charCodeAt(e);if(34!==o&&39!==o&&40!==o)return!1;for(e++,40===o&&(o=41);e<n;){if((i=t.src.charCodeAt(e))===o)return t.pos=e+1,t.linkContent=me(t.src.slice(s+1,e)),!0;92===i&&e+1<n?e+=2:e++}return!1}function Re(t){return t.trim().replace(/\s+/g," ").toUpperCase()}function Je(t,e,i,s){var n,o,r,a,l,c,h,u,d;if(91!==t.charCodeAt(0)||-1===t.indexOf("]:")||((o=Ne(n=new Ee(t,e,i,s,[]),0))<0||58!==t.charCodeAt(o+1)))return-1;for(a=n.posMax,r=o+2;r<a&&(32===(l=n.src.charCodeAt(r))||10===l);r++);if(!$e(n,r))return-1;for(h=n.linkContent,c=r=n.pos,r+=1;r<a&&(32===(l=n.src.charCodeAt(r))||10===l);r++);for(r<a&&c!==r&&Be(n,r)?(u=n.linkContent,r=n.pos):(u="",r=c);r<a&&32===n.src.charCodeAt(r);)r++;return r<a&&10!==n.src.charCodeAt(r)?-1:(d=Re(t.slice(1,o)),typeof s.references[d]>"u"&&(s.references[d]={title:u,href:h}),r)}Te.prototype.renderInline=function(t,e,i){for(var s=this.rules,n=t.length,o=0,r="";n--;)r+=s[t[o].type](t,o++,e,i,this);return r},Te.prototype.render=function(t,e,i){for(var s=this.rules,n=t.length,o=-1,r="";++o<n;)"inline"===t[o].type?r+=this.renderInline(t[o].children,e,i):r+=s[t[o].type](t,o,e,i,this);return r},je.prototype.o=function(t){for(var e=this.t.length,i=-1;e--;)if(this.t[++i].name===t)return i;return-1},je.prototype.l=function(){var t=this,e=[""];t.t.forEach(function(t){t.enabled&&t.alt.forEach(function(t){e.indexOf(t)<0&&e.push(t)})}),t.i={},e.forEach(function(e){t.i[e]=[],t.t.forEach(function(i){i.enabled&&(e&&i.alt.indexOf(e)<0||t.i[e].push(i.fn))})})},je.prototype.at=function(t,e,i){var s=this.o(t),n=i||{};if(-1===s)throw new Error("Parser rule not found: "+t);this.t[s].fn=e,this.t[s].alt=n.alt||[],this.i=null},je.prototype.before=function(t,e,i,s){var n=this.o(t),o=s||{};if(-1===n)throw new Error("Parser rule not found: "+t);this.t.splice(n,0,{name:e,enabled:!0,fn:i,alt:o.alt||[]}),this.i=null},je.prototype.after=function(t,e,i,s){var n=this.o(t),o=s||{};if(-1===n)throw new Error("Parser rule not found: "+t);this.t.splice(n+1,0,{name:e,enabled:!0,fn:i,alt:o.alt||[]}),this.i=null},je.prototype.push=function(t,e,i){var s=i||{};this.t.push({name:t,enabled:!0,fn:e,alt:s.alt||[]}),this.i=null},je.prototype.enable=function(t,e){t=Array.isArray(t)?t:[t],e&&this.t.forEach(function(t){t.enabled=!1}),t.forEach(function(t){var e=this.o(t);if(e<0)throw new Error("Rules manager: invalid rule name "+t);this.t[e].enabled=!0},this),this.i=null},je.prototype.disable=function(t){(t=Array.isArray(t)?t:[t]).forEach(function(t){var e=this.o(t);if(e<0)throw new Error("Rules manager: invalid rule name "+t);this.t[e].enabled=!1},this),this.i=null},je.prototype.getRules=function(t){return null===this.i&&this.l(),this.i[t]||[]},Ee.prototype.pushPending=function(){this.tokens.push({type:"text",content:this.pending,level:this.pendingLevel}),this.pending=""},Ee.prototype.push=function(t){this.pending&&this.pushPending(),this.tokens.push(t),this.pendingLevel=this.level},Ee.prototype.cacheSet=function(t,e){for(var i=this.cache.length;i<=t;i++)this.cache.push(0);this.cache[t]=e},Ee.prototype.cacheGet=function(t){return t<this.cache.length?this.cache[t]:0};var Fe=" \n()[]'\".,!?-";function Le(t){return t.replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1")}var qe=/\+-|\.\.|\?\?\?\?|!!!!|,,|--/,ze=/\((c|tm|r|p)\)/gi,De={c:"©",r:"®",p:"§",tm:"™"};function Ue(t){return t.indexOf("(")<0?t:t.replace(ze,function(t,e){return De[e.toLowerCase()]})}var He=/['"]/,Ve=/['"]/g,We=/[-\s()\[\]]/;function Ge(t,e){return!(e<0||e>=t.length)&&!We.test(t[e])}function Ze(t,e,i){return t.substr(0,e)+i+t.substr(e+1)}var Ke=[["block",function(t){t.inlineMode?t.tokens.push({type:"inline",content:t.src.replace(/\n/g," ").trim(),level:0,lines:[0,1],children:[]}):t.block.parse(t.src,t.options,t.env,t.tokens)}],["abbr",function(t){var e,i,s,n,o=t.tokens;if(!t.inlineMode)for(e=1,i=o.length-1;e<i;e++)if("paragraph_open"===o[e-1].type&&"inline"===o[e].type&&"paragraph_close"===o[e+1].type){for(s=o[e].content;s.length&&!((n=Ie(s,t.inline,t.options,t.env))<0);)s=s.slice(n).trim();o[e].content=s,s.length||(o[e-1].tight=!0,o[e+1].tight=!0)}}],["references",function(t){var e,i,s,n,o=t.tokens;if(t.env.references=t.env.references||{},!t.inlineMode)for(e=1,i=o.length-1;e<i;e++)if("inline"===o[e].type&&"paragraph_open"===o[e-1].type&&"paragraph_close"===o[e+1].type){for(s=o[e].content;s.length&&!((n=Je(s,t.inline,t.options,t.env))<0);)s=s.slice(n).trim();o[e].content=s,s.length||(o[e-1].tight=!0,o[e+1].tight=!0)}}],["inline",function(t){var e,i,s,n=t.tokens;for(i=0,s=n.length;i<s;i++)"inline"===(e=n[i]).type&&t.inline.parse(e.content,t.options,t.env,e.children)}],["footnote_tail",function(t){var e,i,s,n,o,r,a,l,c,h=0,u=!1,d={};if(t.env.footnotes&&(t.tokens=t.tokens.filter(function(t){return"footnote_reference_open"===t.type?(u=!0,l=[],c=t.label,!1):"footnote_reference_close"===t.type?(u=!1,d[":"+c]=l,!1):(u&&l.push(t),!u)}),t.env.footnotes.list)){for(r=t.env.footnotes.list,t.tokens.push({type:"footnote_block_open",level:h++}),e=0,i=r.length;e<i;e++){for(t.tokens.push({type:"footnote_open",id:e,level:h++}),r[e].tokens?((a=[]).push({type:"paragraph_open",tight:!1,level:h++}),a.push({type:"inline",content:"",level:h,children:r[e].tokens}),a.push({type:"paragraph_close",tight:!1,level:--h})):r[e].label&&(a=d[":"+r[e].label]),t.tokens=t.tokens.concat(a),o="paragraph_close"===t.tokens[t.tokens.length-1].type?t.tokens.pop():null,n=r[e].count>0?r[e].count:1,s=0;s<n;s++)t.tokens.push({type:"footnote_anchor",id:e,subId:s,level:h});o&&t.tokens.push(o),t.tokens.push({type:"footnote_close",level:--h})}t.tokens.push({type:"footnote_block_close",level:--h})}}],["abbr2",function(t){var e,i,s,n,o,r,a,l,c,h,u,d,p=t.tokens;if(t.env.abbreviations)for(t.env.abbrRegExp||(d="(^|["+Fe.split("").map(Le).join("")+"])("+Object.keys(t.env.abbreviations).map(function(t){return t.substr(1)}).sort(function(t,e){return e.length-t.length}).map(Le).join("|")+")($|["+Fe.split("").map(Le).join("")+"])",t.env.abbrRegExp=new RegExp(d,"g")),h=t.env.abbrRegExp,i=0,s=p.length;i<s;i++)if("inline"===p[i].type)for(e=(n=p[i].children).length-1;e>=0;e--)if("text"===(o=n[e]).type){for(l=0,r=o.content,h.lastIndex=0,c=o.level,a=[];u=h.exec(r);)h.lastIndex>l&&a.push({type:"text",content:r.slice(l,u.index+u[1].length),level:c}),a.push({type:"abbr_open",title:t.env.abbreviations[":"+u[2]],level:c++}),a.push({type:"text",content:u[2],level:c}),a.push({type:"abbr_close",level:--c}),l=h.lastIndex-u[3].length;a.length&&(l<r.length&&a.push({type:"text",content:r.slice(l),level:c}),p[i].children=n=[].concat(n.slice(0,e),a,n.slice(e+1)))}}],["replacements",function(t){var e,i,s,n,o;if(t.options.typographer)for(o=t.tokens.length-1;o>=0;o--)if("inline"===t.tokens[o].type)for(e=(n=t.tokens[o].children).length-1;e>=0;e--)"text"===(i=n[e]).type&&(s=Ue(s=i.content),qe.test(s)&&(s=s.replace(/\+-/g,"±").replace(/\.{2,}/g,"…").replace(/([?!])…/g,"$1..").replace(/([?!]){4,}/g,"$1$1$1").replace(/,{2,}/g,",").replace(/(^|[^-])---([^-]|$)/gm,"$1—$2").replace(/(^|\s)--(\s|$)/gm,"$1–$2").replace(/(^|[^-\s])--([^-\s]|$)/gm,"$1–$2")),i.content=s)}],["smartquotes",function(t){var e,i,s,n,o,r,a,l,c,h,u,d,p,m,v,f,g;if(t.options.typographer)for(g=[],v=t.tokens.length-1;v>=0;v--)if("inline"===t.tokens[v].type)for(f=t.tokens[v].children,g.length=0,e=0;e<f.length;e++)if("text"===(i=f[e]).type&&!He.test(i.text)){for(a=f[e].level,p=g.length-1;p>=0&&!(g[p].level<=a);p--);g.length=p+1,o=0,r=(s=i.content).length;t:for(;o<r&&(Ve.lastIndex=o,n=Ve.exec(s),n);)if(l=!Ge(s,n.index-1),o=n.index+1,m="'"===n[0],(c=!Ge(s,o))||l){if(u=!c,d=!l)for(p=g.length-1;p>=0&&(h=g[p],!(g[p].level<a));p--)if(h.single===m&&g[p].level===a){h=g[p],m?(f[h.token].content=Ze(f[h.token].content,h.pos,t.options.quotes[2]),i.content=Ze(i.content,n.index,t.options.quotes[3])):(f[h.token].content=Ze(f[h.token].content,h.pos,t.options.quotes[0]),i.content=Ze(i.content,n.index,t.options.quotes[1])),g.length=p;continue t}u?g.push({token:e,pos:n.index,single:m,level:a}):d&&m&&(i.content=Ze(i.content,n.index,"’"))}else m&&(i.content=Ze(i.content,n.index,"’"))}}]];function Xe(){this.options={},this.ruler=new je;for(var t=0;t<Ke.length;t++)this.ruler.push(Ke[t][0],Ke[t][1])}function Qe(t,e,i,s,n){var o,r,a,l,c,h,u;for(this.src=t,this.parser=e,this.options=i,this.env=s,this.tokens=n,this.bMarks=[],this.eMarks=[],this.tShift=[],this.blkIndent=0,this.line=0,this.lineMax=0,this.tight=!1,this.parentType="root",this.ddIndent=-1,this.level=0,this.result="",h=0,u=!1,a=l=h=0,c=(r=this.src).length;l<c;l++){if(o=r.charCodeAt(l),!u){if(32===o){h++;continue}u=!0}(10===o||l===c-1)&&(10!==o&&l++,this.bMarks.push(a),this.eMarks.push(l),this.tShift.push(h),u=!1,h=0,a=l+1)}this.bMarks.push(r.length),this.eMarks.push(r.length),this.tShift.push(0),this.lineMax=this.bMarks.length-1}function Ye(t,e){var i,s,n;return(s=t.bMarks[e]+t.tShift[e])>=(n=t.eMarks[e])||42!==(i=t.src.charCodeAt(s++))&&45!==i&&43!==i||s<n&&32!==t.src.charCodeAt(s)?-1:s}function ti(t,e){var i,s=t.bMarks[e]+t.tShift[e],n=t.eMarks[e];if(s+1>=n||((i=t.src.charCodeAt(s++))<48||i>57))return-1;for(;;){if(s>=n)return-1;if(!((i=t.src.charCodeAt(s++))>=48&&i<=57)){if(41===i||46===i)break;return-1}}return s<n&&32!==t.src.charCodeAt(s)?-1:s}Xe.prototype.process=function(t){var e,i,s;for(e=0,i=(s=this.ruler.getRules("")).length;e<i;e++)s[e](t)},Qe.prototype.isEmpty=function(t){return this.bMarks[t]+this.tShift[t]>=this.eMarks[t]},Qe.prototype.skipEmptyLines=function(t){for(var e=this.lineMax;t<e&&!(this.bMarks[t]+this.tShift[t]<this.eMarks[t]);t++);return t},Qe.prototype.skipSpaces=function(t){for(var e=this.src.length;t<e&&32===this.src.charCodeAt(t);t++);return t},Qe.prototype.skipChars=function(t,e){for(var i=this.src.length;t<i&&this.src.charCodeAt(t)===e;t++);return t},Qe.prototype.skipCharsBack=function(t,e,i){if(t<=i)return t;for(;t>i;)if(e!==this.src.charCodeAt(--t))return t+1;return t},Qe.prototype.getLines=function(t,e,i,s){var n,o,r,a,l,c=t;if(t>=e)return"";if(c+1===e)return o=this.bMarks[c]+Math.min(this.tShift[c],i),r=s?this.eMarks[c]+1:this.eMarks[c],this.src.slice(o,r);for(a=new Array(e-t),n=0;c<e;c++,n++)(l=this.tShift[c])>i&&(l=i),l<0&&(l=0),o=this.bMarks[c]+l,r=c+1<e||s?this.eMarks[c]+1:this.eMarks[c],a[n]=this.src.slice(o,r);return a.join("")};var ei={};["article","aside","button","blockquote","body","canvas","caption","col","colgroup","dd","div","dl","dt","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","iframe","li","map","object","ol","output","p","pre","progress","script","section","style","table","tbody","td","textarea","tfoot","th","tr","thead","ul","video"].forEach(function(t){ei[t]=!0});var ii=/^<([a-zA-Z]{1,15})[\s\/>]/,si=/^<\/([a-zA-Z]{1,15})[\s>]/;function ni(t,e){var i=t.bMarks[e]+t.blkIndent,s=t.eMarks[e];return t.src.substr(i,s-i)}function oi(t,e){var i,s,n=t.bMarks[e]+t.tShift[e],o=t.eMarks[e];return n>=o||126!==(s=t.src.charCodeAt(n++))&&58!==s||n===(i=t.skipSpaces(n))||i>=o?-1:i}var ri=[["code",function(t,e,i){var s,n;if(t.tShift[e]-t.blkIndent<4)return!1;for(n=s=e+1;s<i;)if(t.isEmpty(s))s++;else{if(!(t.tShift[s]-t.blkIndent>=4))break;n=++s}return t.line=s,t.tokens.push({type:"code",content:t.getLines(e,n,4+t.blkIndent,!0),block:!0,lines:[e,t.line],level:t.level}),!0}],["fences",function(t,e,i,s){var n,o,r,a,l,c=!1,h=t.bMarks[e]+t.tShift[e],u=t.eMarks[e];if(h+3>u||126!==(n=t.src.charCodeAt(h))&&96!==n||(l=h,(o=(h=t.skipChars(h,n))-l)<3)||(r=t.src.slice(h,u).trim()).indexOf("`")>=0)return!1;if(s)return!0;for(a=e;!(++a>=i||(h=l=t.bMarks[a]+t.tShift[a],u=t.eMarks[a],h<u&&t.tShift[a]<t.blkIndent));)if(!(t.src.charCodeAt(h)!==n||t.tShift[a]-t.blkIndent>=4||(h=t.skipChars(h,n),h-l<o||(h=t.skipSpaces(h),h<u)))){c=!0;break}return o=t.tShift[e],t.line=a+(c?1:0),t.tokens.push({type:"fence",params:r,content:t.getLines(e+1,a,o,!0),lines:[e,t.line],level:t.level}),!0},["paragraph","blockquote","list"]],["blockquote",function(t,e,i,s){var n,o,r,a,l,c,h,u,d,p,m,v=t.bMarks[e]+t.tShift[e],f=t.eMarks[e];if(v>f||62!==t.src.charCodeAt(v++)||t.level>=t.options.maxNesting)return!1;if(s)return!0;for(32===t.src.charCodeAt(v)&&v++,l=t.blkIndent,t.blkIndent=0,a=[t.bMarks[e]],t.bMarks[e]=v,o=(v=v<f?t.skipSpaces(v):v)>=f,r=[t.tShift[e]],t.tShift[e]=v-t.bMarks[e],u=t.parser.ruler.getRules("blockquote"),n=e+1;n<i&&!((v=t.bMarks[n]+t.tShift[n])>=(f=t.eMarks[n]));n++)if(62!==t.src.charCodeAt(v++)){if(o)break;for(m=!1,d=0,p=u.length;d<p;d++)if(u[d](t,n,i,!0)){m=!0;break}if(m)break;a.push(t.bMarks[n]),r.push(t.tShift[n]),t.tShift[n]=-1337}else 32===t.src.charCodeAt(v)&&v++,a.push(t.bMarks[n]),t.bMarks[n]=v,o=(v=v<f?t.skipSpaces(v):v)>=f,r.push(t.tShift[n]),t.tShift[n]=v-t.bMarks[n];for(c=t.parentType,t.parentType="blockquote",t.tokens.push({type:"blockquote_open",lines:h=[e,0],level:t.level++}),t.parser.tokenize(t,e,n),t.tokens.push({type:"blockquote_close",level:--t.level}),t.parentType=c,h[1]=t.line,d=0;d<r.length;d++)t.bMarks[d+e]=a[d],t.tShift[d+e]=r[d];return t.blkIndent=l,!0},["paragraph","blockquote","list"]],["hr",function(t,e,i,s){var n,o,r,a=t.bMarks[e],l=t.eMarks[e];if((a+=t.tShift[e])>l||42!==(n=t.src.charCodeAt(a++))&&45!==n&&95!==n)return!1;for(o=1;a<l;){if((r=t.src.charCodeAt(a++))!==n&&32!==r)return!1;r===n&&o++}return!(o<3)&&(s||(t.line=e+1,t.tokens.push({type:"hr",lines:[e,t.line],level:t.level})),!0)},["paragraph","blockquote","list"]],["list",function(t,e,i,s){var n,o,r,a,l,c,h,u,d,p,m,v,f,g,b,y,w,x,k,S,_,O=!0;if((u=ti(t,e))>=0)v=!0;else{if(!((u=Ye(t,e))>=0))return!1;v=!1}if(t.level>=t.options.maxNesting)return!1;if(m=t.src.charCodeAt(u-1),s)return!0;for(g=t.tokens.length,v?(h=t.bMarks[e]+t.tShift[e],p=Number(t.src.substr(h,u-h-1)),t.tokens.push({type:"ordered_list_open",order:p,lines:y=[e,0],level:t.level++})):t.tokens.push({type:"bullet_list_open",lines:y=[e,0],level:t.level++}),n=e,b=!1,x=t.parser.ruler.getRules("list");n<i&&((d=(f=t.skipSpaces(u))>=t.eMarks[n]?1:f-u)>4&&(d=1),d<1&&(d=1),o=u-t.bMarks[n]+d,t.tokens.push({type:"list_item_open",lines:w=[e,0],level:t.level++}),a=t.blkIndent,l=t.tight,r=t.tShift[e],c=t.parentType,t.tShift[e]=f-t.bMarks[e],t.blkIndent=o,t.tight=!0,t.parentType="list",t.parser.tokenize(t,e,i,!0),(!t.tight||b)&&(O=!1),b=t.line-e>1&&t.isEmpty(t.line-1),t.blkIndent=a,t.tShift[e]=r,t.tight=l,t.parentType=c,t.tokens.push({type:"list_item_close",level:--t.level}),n=e=t.line,w[1]=n,f=t.bMarks[e],!(n>=i||t.isEmpty(n)||t.tShift[n]<t.blkIndent));){for(_=!1,k=0,S=x.length;k<S;k++)if(x[k](t,n,i,!0)){_=!0;break}if(_)break;if(v){if((u=ti(t,n))<0)break}else if((u=Ye(t,n))<0)break;if(m!==t.src.charCodeAt(u-1))break}return t.tokens.push({type:v?"ordered_list_close":"bullet_list_close",level:--t.level}),y[1]=n,t.line=n,O&&function(t,e){var i,s,n=t.level+2;for(i=e+2,s=t.tokens.length-2;i<s;i++)t.tokens[i].level===n&&"paragraph_open"===t.tokens[i].type&&(t.tokens[i+2].tight=!0,t.tokens[i].tight=!0,i+=2)}(t,g),!0},["paragraph","blockquote"]],["footnote",function(t,e,i,s){var n,o,r,a,l,c=t.bMarks[e]+t.tShift[e],h=t.eMarks[e];if(c+4>h||91!==t.src.charCodeAt(c)||94!==t.src.charCodeAt(c+1)||t.level>=t.options.maxNesting)return!1;for(a=c+2;a<h;a++){if(32===t.src.charCodeAt(a))return!1;if(93===t.src.charCodeAt(a))break}return!(a===c+2||a+1>=h||58!==t.src.charCodeAt(++a))&&(s||(a++,t.env.footnotes||(t.env.footnotes={}),t.env.footnotes.refs||(t.env.footnotes.refs={}),l=t.src.slice(c+2,a-2),t.env.footnotes.refs[":"+l]=-1,t.tokens.push({type:"footnote_reference_open",label:l,level:t.level++}),n=t.bMarks[e],o=t.tShift[e],r=t.parentType,t.tShift[e]=t.skipSpaces(a)-a,t.bMarks[e]=a,t.blkIndent+=4,t.parentType="footnote",t.tShift[e]<t.blkIndent&&(t.tShift[e]+=t.blkIndent,t.bMarks[e]-=t.blkIndent),t.parser.tokenize(t,e,i,!0),t.parentType=r,t.blkIndent-=4,t.tShift[e]=o,t.bMarks[e]=n,t.tokens.push({type:"footnote_reference_close",level:--t.level})),!0)},["paragraph"]],["heading",function(t,e,i,s){var n,o,r,a=t.bMarks[e]+t.tShift[e],l=t.eMarks[e];if(a>=l||(35!==(n=t.src.charCodeAt(a))||a>=l))return!1;for(o=1,n=t.src.charCodeAt(++a);35===n&&a<l&&o<=6;)o++,n=t.src.charCodeAt(++a);return!(o>6||a<l&&32!==n)&&(s||(l=t.skipCharsBack(l,32,a),(r=t.skipCharsBack(l,35,a))>a&&32===t.src.charCodeAt(r-1)&&(l=r),t.line=e+1,t.tokens.push({type:"heading_open",hLevel:o,lines:[e,t.line],level:t.level}),a<l&&t.tokens.push({type:"inline",content:t.src.slice(a,l).trim(),level:t.level+1,lines:[e,t.line],children:[]}),t.tokens.push({type:"heading_close",hLevel:o,level:t.level})),!0)},["paragraph","blockquote"]],["lheading",function(t,e,i){var s,n,o,r=e+1;return!(r>=i||t.tShift[r]<t.blkIndent||t.tShift[r]-t.blkIndent>3||(n=t.bMarks[r]+t.tShift[r],o=t.eMarks[r],n>=o)||(s=t.src.charCodeAt(n),45!==s&&61!==s)||(n=t.skipChars(n,s),n=t.skipSpaces(n),n<o))&&(n=t.bMarks[e]+t.tShift[e],t.line=r+1,t.tokens.push({type:"heading_open",hLevel:61===s?1:2,lines:[e,t.line],level:t.level}),t.tokens.push({type:"inline",content:t.src.slice(n,t.eMarks[e]).trim(),level:t.level+1,lines:[e,t.line-1],children:[]}),t.tokens.push({type:"heading_close",hLevel:61===s?1:2,level:t.level}),!0)}],["htmlblock",function(t,e,i,s){var n,o,r,a=t.bMarks[e],l=t.eMarks[e],c=t.tShift[e];if(a+=c,!t.options.html||c>3||a+2>=l||60!==t.src.charCodeAt(a))return!1;if(33===(n=t.src.charCodeAt(a+1))||63===n){if(s)return!0}else{if(47!==n&&!function(t){var e=32|t;return e>=97&&e<=122}(n))return!1;if(47===n){if(!(o=t.src.slice(a,l).match(si)))return!1}else if(!(o=t.src.slice(a,l).match(ii)))return!1;if(!0!==ei[o[1].toLowerCase()])return!1;if(s)return!0}for(r=e+1;r<t.lineMax&&!t.isEmpty(r);)r++;return t.line=r,t.tokens.push({type:"htmlblock",level:t.level,lines:[e,t.line],content:t.getLines(e,r,0,!0)}),!0},["paragraph","blockquote"]],["table",function(t,e,i,s){var n,o,r,a,l,c,h,u,d,p,m;if(e+2>i||(l=e+1,t.tShift[l]<t.blkIndent)||(r=t.bMarks[l]+t.tShift[l])>=t.eMarks[l]||124!==(n=t.src.charCodeAt(r))&&45!==n&&58!==n||(o=ni(t,e+1),!/^[-:| ]+$/.test(o))||(c=o.split("|"))<=2)return!1;for(u=[],a=0;a<c.length;a++){if(!(d=c[a].trim())){if(0===a||a===c.length-1)continue;return!1}if(!/^:?-+:?$/.test(d))return!1;58===d.charCodeAt(d.length-1)?u.push(58===d.charCodeAt(0)?"center":"right"):58===d.charCodeAt(0)?u.push("left"):u.push("")}if(-1===(o=ni(t,e).trim()).indexOf("|")||(c=o.replace(/^\||\|$/g,"").split("|"),u.length!==c.length))return!1;if(s)return!0;for(t.tokens.push({type:"table_open",lines:p=[e,0],level:t.level++}),t.tokens.push({type:"thead_open",lines:[e,e+1],level:t.level++}),t.tokens.push({type:"tr_open",lines:[e,e+1],level:t.level++}),a=0;a<c.length;a++)t.tokens.push({type:"th_open",align:u[a],lines:[e,e+1],level:t.level++}),t.tokens.push({type:"inline",content:c[a].trim(),lines:[e,e+1],level:t.level,children:[]}),t.tokens.push({type:"th_close",level:--t.level});for(t.tokens.push({type:"tr_close",level:--t.level}),t.tokens.push({type:"thead_close",level:--t.level}),t.tokens.push({type:"tbody_open",lines:m=[e+2,0],level:t.level++}),l=e+2;l<i&&!(t.tShift[l]<t.blkIndent||(o=ni(t,l).trim(),-1===o.indexOf("|")));l++){for(c=o.replace(/^\||\|$/g,"").split("|"),t.tokens.push({type:"tr_open",level:t.level++}),a=0;a<c.length;a++)t.tokens.push({type:"td_open",align:u[a],level:t.level++}),h=c[a].substring(124===c[a].charCodeAt(0)?1:0,124===c[a].charCodeAt(c[a].length-1)?c[a].length-1:c[a].length).trim(),t.tokens.push({type:"inline",content:h,level:t.level,children:[]}),t.tokens.push({type:"td_close",level:--t.level});t.tokens.push({type:"tr_close",level:--t.level})}return t.tokens.push({type:"tbody_close",level:--t.level}),t.tokens.push({type:"table_close",level:--t.level}),p[1]=m[1]=l,t.line=l,!0},["paragraph"]],["deflist",function(t,e,i,s){var n,o,r,a,l,c,h,u,d,p,m,v,f,g;if(s)return!(t.ddIndent<0)&&oi(t,e)>=0;if(h=e+1,t.isEmpty(h)&&++h>i||t.tShift[h]<t.blkIndent||(n=oi(t,h))<0||t.level>=t.options.maxNesting)return!1;c=t.tokens.length,t.tokens.push({type:"dl_open",lines:l=[e,0],level:t.level++}),r=e,o=h;t:for(;;){for(g=!0,f=!1,t.tokens.push({type:"dt_open",lines:[r,r],level:t.level++}),t.tokens.push({type:"inline",content:t.getLines(r,r+1,t.blkIndent,!1).trim(),level:t.level+1,lines:[r,r],children:[]}),t.tokens.push({type:"dt_close",level:--t.level});;){if(t.tokens.push({type:"dd_open",lines:a=[h,0],level:t.level++}),v=t.tight,d=t.ddIndent,u=t.blkIndent,m=t.tShift[o],p=t.parentType,t.blkIndent=t.ddIndent=t.tShift[o]+2,t.tShift[o]=n-t.bMarks[o],t.tight=!0,t.parentType="deflist",t.parser.tokenize(t,o,i,!0),(!t.tight||f)&&(g=!1),f=t.line-o>1&&t.isEmpty(t.line-1),t.tShift[o]=m,t.tight=v,t.parentType=p,t.blkIndent=u,t.ddIndent=d,t.tokens.push({type:"dd_close",level:--t.level}),a[1]=h=t.line,h>=i||t.tShift[h]<t.blkIndent)break t;if((n=oi(t,h))<0)break;o=h}if(h>=i||(r=h,t.isEmpty(r))||t.tShift[r]<t.blkIndent||(o=r+1)>=i||(t.isEmpty(o)&&o++,o>=i)||t.tShift[o]<t.blkIndent||(n=oi(t,o))<0)break}return t.tokens.push({type:"dl_close",level:--t.level}),l[1]=h,t.line=h,g&&function(t,e){var i,s,n=t.level+2;for(i=e+2,s=t.tokens.length-2;i<s;i++)t.tokens[i].level===n&&"paragraph_open"===t.tokens[i].type&&(t.tokens[i+2].tight=!0,t.tokens[i].tight=!0,i+=2)}(t,c),!0},["paragraph"]],["paragraph",function(t,e){var i,s,n,o,r,a,l=e+1;if(l<(i=t.lineMax)&&!t.isEmpty(l))for(a=t.parser.ruler.getRules("paragraph");l<i&&!t.isEmpty(l);l++)if(!(t.tShift[l]-t.blkIndent>3)){for(n=!1,o=0,r=a.length;o<r;o++)if(a[o](t,l,i,!0)){n=!0;break}if(n)break}return s=t.getLines(e,l,t.blkIndent,!1).trim(),t.line=l,s.length&&(t.tokens.push({type:"paragraph_open",tight:!1,lines:[e,t.line],level:t.level}),t.tokens.push({type:"inline",content:s,level:t.level+1,lines:[e,t.line],children:[]}),t.tokens.push({type:"paragraph_close",tight:!1,level:t.level})),!0}]];function ai(){this.ruler=new je;for(var t=0;t<ri.length;t++)this.ruler.push(ri[t][0],ri[t][1],{alt:(ri[t][2]||[]).slice()})}ai.prototype.tokenize=function(t,e,i){for(var s,n=this.ruler.getRules(""),o=n.length,r=e,a=!1;r<i&&(t.line=r=t.skipEmptyLines(r),!(r>=i||t.tShift[r]<t.blkIndent));){for(s=0;s<o&&!n[s](t,r,i,!1);s++);if(t.tight=!a,t.isEmpty(t.line-1)&&(a=!0),(r=t.line)<i&&t.isEmpty(r)){if(a=!0,++r<i&&"list"===t.parentType&&t.isEmpty(r))break;t.line=r}}};var li=/[\n\t]/g,ci=/\r[\n\u0085]|[\u2424\u2028\u0085]/g,hi=/\u00a0/g;function ui(t){switch(t){case 10:case 92:case 96:case 42:case 95:case 94:case 91:case 93:case 33:case 38:case 60:case 62:case 123:case 125:case 36:case 37:case 64:case 126:case 43:case 61:case 58:return!0;default:return!1}}ai.prototype.parse=function(t,e,i,s){var n,o=0,r=0;if(!t)return[];(t=(t=t.replace(hi," ")).replace(ci,"\n")).indexOf("\t")>=0&&(t=t.replace(li,function(e,i){var s;return 10===t.charCodeAt(i)?(o=i+1,r=0,e):(s="    ".slice((i-o-r)%4),r=i-o+1,s)})),n=new Qe(t,this,e,i,s),this.tokenize(n,n.line,n.lineMax)};for(var di=[],pi=0;pi<256;pi++)di.push(0);function mi(t){return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122}function vi(t,e){var i,s,n,o=e,r=!0,a=!0,l=t.posMax,c=t.src.charCodeAt(e);for(i=e>0?t.src.charCodeAt(e-1):-1;o<l&&t.src.charCodeAt(o)===c;)o++;return o>=l&&(r=!1),(n=o-e)>=4?r=a=!1:((32===(s=o<l?t.src.charCodeAt(o):-1)||10===s)&&(r=!1),(32===i||10===i)&&(a=!1),95===c&&(mi(i)&&(r=!1),mi(s)&&(a=!1))),{can_open:r,can_close:a,delims:n}}"\\!\"#$%&'()*+,./:;<=>?@[]^_`{|}~-".split("").forEach(function(t){di[t.charCodeAt(0)]=1});var fi=/\\([ \\!"#$%&'()*+,.\/:;<=>?@[\]^_`{|}~-])/g;var gi=/\\([ \\!"#$%&'()*+,.\/:;<=>?@[\]^_`{|}~-])/g;var bi=["coap","doi","javascript","aaa","aaas","about","acap","cap","cid","crid","data","dav","dict","dns","file","ftp","geo","go","gopher","h323","http","https","iax","icap","im","imap","info","ipp","iris","iris.beep","iris.xpc","iris.xpcs","iris.lwz","ldap","mailto","mid","msrp","msrps","mtqp","mupdate","news","nfs","ni","nih","nntp","opaquelocktoken","pop","pres","rtsp","service","session","shttp","sieve","sip","sips","sms","snmp","soap.beep","soap.beeps","tag","tel","telnet","tftp","thismessage","tn3270","tip","tv","urn","vemmi","ws","wss","xcon","xcon-userid","xmlrpc.beep","xmlrpc.beeps","xmpp","z39.50r","z39.50s","adiumxtra","afp","afs","aim","apt","attachment","aw","beshare","bitcoin","bolo","callto","chrome","chrome-extension","com-eventbrite-attendee","content","cvs","dlna-playsingle","dlna-playcontainer","dtn","dvb","ed2k","facetime","feed","finger","fish","gg","git","gizmoproject","gtalk","hcp","icon","ipn","irc","irc6","ircs","itms","jar","jms","keyparc","lastfm","ldaps","magnet","maps","market","message","mms","ms-help","msnim","mumble","mvn","notes","oid","palm","paparazzi","platform","proxy","psyc","query","res","resource","rmi","rsync","rtmp","secondlife","sftp","sgn","skype","smb","soldat","spotify","ssh","steam","svn","teamspeak","things","udp","unreal","ut2004","ventrilo","view-source","webcal","wtai","wyciwyg","xfire","xri","ymsgr"],yi=/^<([a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)>/,wi=/^<([a-zA-Z.\-]{1,25}):([^<>\x00-\x20]*)>/;function xi(t,e){return t=t.source,e=e||"",function i(s,n){return s?(n=n.source||n,t=t.replace(s,n),i):new RegExp(t,e)}}var ki=xi(/(?:unquoted|single_quoted|double_quoted)/)("unquoted",/[^"'=<>`\x00-\x20]+/)("single_quoted",/'[^']*'/)("double_quoted",/"[^"]*"/)(),Si=xi(/(?:\s+attr_name(?:\s*=\s*attr_value)?)/)("attr_name",/[a-zA-Z_:][a-zA-Z0-9:._-]*/)("attr_value",ki)(),_i=xi(/<[A-Za-z][A-Za-z0-9]*attribute*\s*\/?>/)("attribute",Si)(),Oi=xi(/^(?:open_tag|close_tag|comment|processing|declaration|cdata)/)("open_tag",_i)("close_tag",/<\/[A-Za-z][A-Za-z0-9]*\s*>/)("comment",/<!---->|<!--(?:-?[^>-])(?:-?[^-])*-->/)("processing",/<[?].*?[?]>/)("declaration",/<![A-Z]+\s+[^>]*>/)("cdata",/<!\[CDATA\[[\s\S]*?\]\]>/)();var Mi=/^&#((?:x[a-f0-9]{1,8}|[0-9]{1,8}));/i,Ai=/^&([a-z][a-z0-9]{1,31});/i;var Ci=[["text",function(t,e){for(var i=t.pos;i<t.posMax&&!ui(t.src.charCodeAt(i));)i++;return i!==t.pos&&(e||(t.pending+=t.src.slice(t.pos,i)),t.pos=i,!0)}],["newline",function(t,e){var i,s,n=t.pos;if(10!==t.src.charCodeAt(n))return!1;if(i=t.pending.length-1,s=t.posMax,!e)if(i>=0&&32===t.pending.charCodeAt(i))if(i>=1&&32===t.pending.charCodeAt(i-1)){for(var o=i-2;o>=0;o--)if(32!==t.pending.charCodeAt(o)){t.pending=t.pending.substring(0,o+1);break}t.push({type:"hardbreak",level:t.level})}else t.pending=t.pending.slice(0,-1),t.push({type:"softbreak",level:t.level});else t.push({type:"softbreak",level:t.level});for(n++;n<s&&32===t.src.charCodeAt(n);)n++;return t.pos=n,!0}],["escape",function(t,e){var i,s=t.pos,n=t.posMax;if(92!==t.src.charCodeAt(s))return!1;if(++s<n){if((i=t.src.charCodeAt(s))<256&&0!==di[i])return e||(t.pending+=t.src[s]),t.pos+=2,!0;if(10===i){for(e||t.push({type:"hardbreak",level:t.level}),s++;s<n&&32===t.src.charCodeAt(s);)s++;return t.pos=s,!0}}return e||(t.pending+="\\"),t.pos++,!0}],["backticks",function(t,e){var i,s,n,o,r,a=t.pos;if(96!==t.src.charCodeAt(a))return!1;for(i=a,a++,s=t.posMax;a<s&&96===t.src.charCodeAt(a);)a++;for(n=t.src.slice(i,a),o=r=a;-1!==(o=t.src.indexOf("`",r));){for(r=o+1;r<s&&96===t.src.charCodeAt(r);)r++;if(r-o===n.length)return e||t.push({type:"code",content:t.src.slice(a,o).replace(/[ \n]+/g," ").trim(),block:!1,level:t.level}),t.pos=r,!0}return e||(t.pending+=n),t.pos+=n.length,!0}],["del",function(t,e){var i,s,n,o,r,a=t.posMax,l=t.pos;if(126!==t.src.charCodeAt(l)||e||l+4>=a||126!==t.src.charCodeAt(l+1)||t.level>=t.options.maxNesting||(o=l>0?t.src.charCodeAt(l-1):-1,r=t.src.charCodeAt(l+2),126===o)||126===r||32===r||10===r)return!1;for(s=l+2;s<a&&126===t.src.charCodeAt(s);)s++;if(s>l+3)return t.pos+=s-l,e||(t.pending+=t.src.slice(l,s)),!0;for(t.pos=l+2,n=1;t.pos+1<a;){if(126===t.src.charCodeAt(t.pos)&&126===t.src.charCodeAt(t.pos+1)&&(o=t.src.charCodeAt(t.pos-1),126!==(r=t.pos+2<a?t.src.charCodeAt(t.pos+2):-1)&&126!==o&&(32!==o&&10!==o?n--:32!==r&&10!==r&&n++,n<=0))){i=!0;break}t.parser.skipToken(t)}return i?(t.posMax=t.pos,t.pos=l+2,e||(t.push({type:"del_open",level:t.level++}),t.parser.tokenize(t),t.push({type:"del_close",level:--t.level})),t.pos=t.posMax+2,t.posMax=a,!0):(t.pos=l,!1)}],["ins",function(t,e){var i,s,n,o,r,a=t.posMax,l=t.pos;if(43!==t.src.charCodeAt(l)||e||l+4>=a||43!==t.src.charCodeAt(l+1)||t.level>=t.options.maxNesting||(o=l>0?t.src.charCodeAt(l-1):-1,r=t.src.charCodeAt(l+2),43===o)||43===r||32===r||10===r)return!1;for(s=l+2;s<a&&43===t.src.charCodeAt(s);)s++;if(s!==l+2)return t.pos+=s-l,e||(t.pending+=t.src.slice(l,s)),!0;for(t.pos=l+2,n=1;t.pos+1<a;){if(43===t.src.charCodeAt(t.pos)&&43===t.src.charCodeAt(t.pos+1)&&(o=t.src.charCodeAt(t.pos-1),43!==(r=t.pos+2<a?t.src.charCodeAt(t.pos+2):-1)&&43!==o&&(32!==o&&10!==o?n--:32!==r&&10!==r&&n++,n<=0))){i=!0;break}t.parser.skipToken(t)}return i?(t.posMax=t.pos,t.pos=l+2,e||(t.push({type:"ins_open",level:t.level++}),t.parser.tokenize(t),t.push({type:"ins_close",level:--t.level})),t.pos=t.posMax+2,t.posMax=a,!0):(t.pos=l,!1)}],["mark",function(t,e){var i,s,n,o,r,a=t.posMax,l=t.pos;if(61!==t.src.charCodeAt(l)||e||l+4>=a||61!==t.src.charCodeAt(l+1)||t.level>=t.options.maxNesting||(o=l>0?t.src.charCodeAt(l-1):-1,r=t.src.charCodeAt(l+2),61===o)||61===r||32===r||10===r)return!1;for(s=l+2;s<a&&61===t.src.charCodeAt(s);)s++;if(s!==l+2)return t.pos+=s-l,e||(t.pending+=t.src.slice(l,s)),!0;for(t.pos=l+2,n=1;t.pos+1<a;){if(61===t.src.charCodeAt(t.pos)&&61===t.src.charCodeAt(t.pos+1)&&(o=t.src.charCodeAt(t.pos-1),61!==(r=t.pos+2<a?t.src.charCodeAt(t.pos+2):-1)&&61!==o&&(32!==o&&10!==o?n--:32!==r&&10!==r&&n++,n<=0))){i=!0;break}t.parser.skipToken(t)}return i?(t.posMax=t.pos,t.pos=l+2,e||(t.push({type:"mark_open",level:t.level++}),t.parser.tokenize(t),t.push({type:"mark_close",level:--t.level})),t.pos=t.posMax+2,t.posMax=a,!0):(t.pos=l,!1)}],["emphasis",function(t,e){var i,s,n,o,r,a,l,c=t.posMax,h=t.pos,u=t.src.charCodeAt(h);if(95!==u&&42!==u||e)return!1;if(i=(l=vi(t,h)).delims,!l.can_open)return t.pos+=i,e||(t.pending+=t.src.slice(h,t.pos)),!0;if(t.level>=t.options.maxNesting)return!1;for(t.pos=h+i,a=[i];t.pos<c;)if(t.src.charCodeAt(t.pos)!==u)t.parser.skipToken(t);else{if(s=(l=vi(t,t.pos)).delims,l.can_close){for(o=a.pop(),r=s;o!==r;){if(r<o){a.push(o-r);break}if(r-=o,0===a.length)break;t.pos+=o,o=a.pop()}if(0===a.length){i=o,n=!0;break}t.pos+=s;continue}l.can_open&&a.push(s),t.pos+=s}return n?(t.posMax=t.pos,t.pos=h+i,e||((2===i||3===i)&&t.push({type:"strong_open",level:t.level++}),(1===i||3===i)&&t.push({type:"em_open",level:t.level++}),t.parser.tokenize(t),(1===i||3===i)&&t.push({type:"em_close",level:--t.level}),(2===i||3===i)&&t.push({type:"strong_close",level:--t.level})),t.pos=t.posMax+i,t.posMax=c,!0):(t.pos=h,!1)}],["sub",function(t,e){var i,s,n=t.posMax,o=t.pos;if(126!==t.src.charCodeAt(o)||e||o+2>=n||t.level>=t.options.maxNesting)return!1;for(t.pos=o+1;t.pos<n;){if(126===t.src.charCodeAt(t.pos)){i=!0;break}t.parser.skipToken(t)}return!i||o+1===t.pos||(s=t.src.slice(o+1,t.pos)).match(/(^|[^\\])(\\\\)*\s/)?(t.pos=o,!1):(t.posMax=t.pos,t.pos=o+1,e||t.push({type:"sub",level:t.level,content:s.replace(fi,"$1")}),t.pos=t.posMax+1,t.posMax=n,!0)}],["sup",function(t,e){var i,s,n=t.posMax,o=t.pos;if(94!==t.src.charCodeAt(o)||e||o+2>=n||t.level>=t.options.maxNesting)return!1;for(t.pos=o+1;t.pos<n;){if(94===t.src.charCodeAt(t.pos)){i=!0;break}t.parser.skipToken(t)}return!i||o+1===t.pos||(s=t.src.slice(o+1,t.pos)).match(/(^|[^\\])(\\\\)*\s/)?(t.pos=o,!1):(t.posMax=t.pos,t.pos=o+1,e||t.push({type:"sup",level:t.level,content:s.replace(gi,"$1")}),t.pos=t.posMax+1,t.posMax=n,!0)}],["links",function(t,e){var i,s,n,o,r,a,l,c,h=!1,u=t.pos,d=t.posMax,p=t.pos,m=t.src.charCodeAt(p);if(33===m&&(h=!0,m=t.src.charCodeAt(++p)),91!==m||t.level>=t.options.maxNesting||(i=p+1,(s=Ne(t,p))<0))return!1;if((a=s+1)<d&&40===t.src.charCodeAt(a)){for(a++;a<d&&(32===(c=t.src.charCodeAt(a))||10===c);a++);if(a>=d)return!1;for(p=a,$e(t,a)?(o=t.linkContent,a=t.pos):o="",p=a;a<d&&(32===(c=t.src.charCodeAt(a))||10===c);a++);if(a<d&&p!==a&&Be(t,a))for(r=t.linkContent,a=t.pos;a<d&&(32===(c=t.src.charCodeAt(a))||10===c);a++);else r="";if(a>=d||41!==t.src.charCodeAt(a))return t.pos=u,!1;a++}else{if(t.linkLevel>0)return!1;for(;a<d&&(32===(c=t.src.charCodeAt(a))||10===c);a++);if(a<d&&91===t.src.charCodeAt(a)&&(p=a+1,(a=Ne(t,a))>=0?n=t.src.slice(p,a++):a=p-1),n||(typeof n>"u"&&(a=s+1),n=t.src.slice(i,s)),!(l=t.env.references[Re(n)]))return t.pos=u,!1;o=l.href,r=l.title}return e||(t.pos=i,t.posMax=s,h?t.push({type:"image",src:o,title:r,alt:t.src.substr(i,s-i),level:t.level}):(t.push({type:"link_open",href:o,title:r,level:t.level++}),t.linkLevel++,t.parser.tokenize(t),t.linkLevel--,t.push({type:"link_close",level:--t.level}))),t.pos=a,t.posMax=d,!0}],["footnote_inline",function(t,e){var i,s,n,o,r=t.posMax,a=t.pos;return!(a+2>=r||94!==t.src.charCodeAt(a)||91!==t.src.charCodeAt(a+1)||t.level>=t.options.maxNesting||(i=a+2,s=Ne(t,a+1),s<0))&&(e||(t.env.footnotes||(t.env.footnotes={}),t.env.footnotes.list||(t.env.footnotes.list=[]),n=t.env.footnotes.list.length,t.pos=i,t.posMax=s,t.push({type:"footnote_ref",id:n,level:t.level}),t.linkLevel++,o=t.tokens.length,t.parser.tokenize(t),t.env.footnotes.list[n]={tokens:t.tokens.splice(o)},t.linkLevel--),t.pos=s+1,t.posMax=r,!0)}],["footnote_ref",function(t,e){var i,s,n,o,r=t.posMax,a=t.pos;if(a+3>r||!t.env.footnotes||!t.env.footnotes.refs||91!==t.src.charCodeAt(a)||94!==t.src.charCodeAt(a+1)||t.level>=t.options.maxNesting)return!1;for(s=a+2;s<r;s++){if(32===t.src.charCodeAt(s)||10===t.src.charCodeAt(s))return!1;if(93===t.src.charCodeAt(s))break}return!(s===a+2||s>=r||(s++,i=t.src.slice(a+2,s-1),typeof t.env.footnotes.refs[":"+i]>"u"))&&(e||(t.env.footnotes.list||(t.env.footnotes.list=[]),t.env.footnotes.refs[":"+i]<0?(n=t.env.footnotes.list.length,t.env.footnotes.list[n]={label:i,count:0},t.env.footnotes.refs[":"+i]=n):n=t.env.footnotes.refs[":"+i],o=t.env.footnotes.list[n].count,t.env.footnotes.list[n].count++,t.push({type:"footnote_ref",id:n,subId:o,level:t.level})),t.pos=s,t.posMax=r,!0)}],["autolink",function(t,e){var i,s,n,o,r,a=t.pos;return!(60!==t.src.charCodeAt(a)||(i=t.src.slice(a),i.indexOf(">")<0))&&((s=i.match(wi))?!(bi.indexOf(s[1].toLowerCase())<0||(o=s[0].slice(1,-1),r=Pe(o),!t.parser.validateLink(o)))&&(e||(t.push({type:"link_open",href:r,level:t.level}),t.push({type:"text",content:o,level:t.level+1}),t.push({type:"link_close",level:t.level})),t.pos+=s[0].length,!0):!!(n=i.match(yi))&&(r=Pe("mailto:"+(o=n[0].slice(1,-1))),!!t.parser.validateLink(r)&&(e||(t.push({type:"link_open",href:r,level:t.level}),t.push({type:"text",content:o,level:t.level+1}),t.push({type:"link_close",level:t.level})),t.pos+=n[0].length,!0)))}],["htmltag",function(t,e){var i,s,n,o=t.pos;return!(!t.options.html||(n=t.posMax,60!==t.src.charCodeAt(o)||o+2>=n)||(i=t.src.charCodeAt(o+1),33!==i&&63!==i&&47!==i&&!function(t){var e=32|t;return e>=97&&e<=122}(i))||(s=t.src.slice(o).match(Oi),!s))&&(e||t.push({type:"htmltag",content:t.src.slice(o,o+s[0].length),level:t.level}),t.pos+=s[0].length,!0)}],["entity",function(t,e){var i,s,n=t.pos,o=t.posMax;if(38!==t.src.charCodeAt(n))return!1;if(n+1<o)if(35===t.src.charCodeAt(n+1)){if(s=t.src.slice(n).match(Mi))return e||(i="x"===s[1][0].toLowerCase()?parseInt(s[1].slice(1),16):parseInt(s[1],10),t.pending+=ve(i)?fe(i):fe(65533)),t.pos+=s[0].length,!0}else if(s=t.src.slice(n).match(Ai)){var r=he(s[1]);if(s[1]!==r)return e||(t.pending+=r),t.pos+=s[0].length,!0}return e||(t.pending+="&"),t.pos++,!0}]];function Ti(){this.ruler=new je;for(var t=0;t<Ci.length;t++)this.ruler.push(Ci[t][0],Ci[t][1]);this.validateLink=ji}function ji(t){var e=t.trim().toLowerCase();return!(-1!==(e=we(e)).indexOf(":")&&-1!==["vbscript","javascript","file","data"].indexOf(e.split(":")[0]))}Ti.prototype.skipToken=function(t){var e,i,s=this.ruler.getRules(""),n=s.length,o=t.pos;if((i=t.cacheGet(o))>0)t.pos=i;else{for(e=0;e<n;e++)if(s[e](t,!0))return void t.cacheSet(o,t.pos);t.pos++,t.cacheSet(o,t.pos)}},Ti.prototype.tokenize=function(t){for(var e,i,s=this.ruler.getRules(""),n=s.length,o=t.posMax;t.pos<o;){for(i=0;i<n&&!(e=s[i](t,!1));i++);if(e){if(t.pos>=o)break}else t.pending+=t.src[t.pos++]}t.pending&&t.pushPending()},Ti.prototype.parse=function(t,e,i,s){var n=new Ee(t,this,e,i,s);this.tokenize(n)};var Ei={default:{options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkTarget:"",typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["block","inline","references","replacements","smartquotes","references","abbr2","footnote_tail"]},block:{rules:["blockquote","code","fences","footnote","heading","hr","htmlblock","lheading","list","paragraph","table"]},inline:{rules:["autolink","backticks","del","emphasis","entity","escape","footnote_ref","htmltag","links","newline","text"]}}},full:{options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkTarget:"",typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{},block:{},inline:{}}},commonmark:{options:{html:!0,xhtmlOut:!0,breaks:!1,langPrefix:"language-",linkTarget:"",typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["block","inline","references","abbr2"]},block:{rules:["blockquote","code","fences","heading","hr","htmlblock","lheading","list","paragraph"]},inline:{rules:["autolink","backticks","emphasis","entity","escape","htmltag","links","newline","text"]}}}};function Ni(t,e,i){this.src=e,this.env=i,this.options=t.options,this.tokens=[],this.inlineMode=!1,this.inline=t.inline,this.block=t.block,this.renderer=t.renderer,this.typographer=t.typographer}function Ii(t,e){"string"!=typeof t&&(e=t,t="default"),e&&null!=e.linkify&&console.warn("linkify option is removed. Use linkify plugin instead:\n\nimport Remarkable from 'remarkable';\nimport linkify from 'remarkable/linkify';\nnew Remarkable().use(linkify)\n"),this.inline=new Ti,this.block=new ai,this.core=new Xe,this.renderer=new Te,this.ruler=new je,this.options={},this.configure(Ei[t]),this.set(e||{})}Ii.prototype.set=function(t){de(this.options,t)},Ii.prototype.configure=function(t){var e=this;if(!t)throw new Error("Wrong `remarkable` preset, check name/content");t.options&&e.set(t.options),t.components&&Object.keys(t.components).forEach(function(i){t.components[i].rules&&e[i].ruler.enable(t.components[i].rules,!0)})},Ii.prototype.use=function(t,e){return t(this,e),this},Ii.prototype.parse=function(t,e){var i=new Ni(this,t,e);return this.core.process(i),i.tokens},Ii.prototype.render=function(t,e){return e=e||{},this.renderer.render(this.parse(t,e),this.options,e)},Ii.prototype.parseInline=function(t,e){var i=new Ni(this,t,e);return i.inlineMode=!0,this.core.process(i),i.tokens},Ii.prototype.renderInline=function(t,e){return e=e||{},this.renderer.render(this.parseInline(t,e),this.options,e)};const Pi=class t{static addPlugins(t,e){const i=window.remarkable_plugins;if(i&&i.forEach(e=>{t.use(e.plugin,e.options)}),null!=e&&e.math){window.katex||(console.warn("window.katex not found, use chatElementRef.refreshMessages to re-render messages"),console.warn("See https://deepchat.dev/examples/externalModules"));const i="object"==typeof e.math?e.math.delimiter:"",s="object"==typeof e.math&&e.math.options?e.math.options:{};t.use(le.katex.bind(this,s),{delimiter:i})}}static instantiate(e){if(e)return new Ii({...t.DEFAULT_PROPERTIES,...e});if(window.hljs){const t=window.hljs;return new Ii({highlight:function(e,i){if(i&&t.getLanguage(i))try{return t.highlight(e,{language:i}).value}catch{console[C]("failed to setup the highlight dependency")}try{return t.highlightAuto(e).value}catch{console[C]("failed to automatically highlight messages")}return""},html:!1,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkTarget:"_blank",typographer:!0})}return new Ii(t.DEFAULT_PROPERTIES)}static createNew(e){const i=t.instantiate(e);return t.addPlugins(i,e),i.inline.validateLink=()=>!0,i}};Pi.DEFAULT_PROPERTIES={breaks:!0,linkTarget:"_blank"};let $i=Pi;class Bi{constructor(t){this.storageKey="deep-chat-storage",this.maxMessages=1e3,"object"==typeof t&&(t.key&&(this.storageKey=t.key),t.maxMessages&&(this.maxMessages=t.maxMessages),t.clear=this.clear.bind(this))}get(){const t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):[]}addMessages(t){let e=t.length-this.maxMessages;e<0&&(e=0);const i=t.slice(e,t.length);localStorage.setItem(this.storageKey,JSON.stringify(i))}clear(){localStorage.removeItem(this.storageKey)}}class Ri{static applyCustomStylesToElements(t,i,s){if(s&&(Object.assign(t.outerContainer[e],s.outerContainer),Object.assign(t.innerContainer[e],s.innerContainer),Object.assign(t.bubbleElement[e],s.bubble),i)){const i=t.bubbleElement.children[0],n="a"!==i.tagName.toLocaleLowerCase()?i:i.children[0];Object.assign(n[e],s.media)}}static applySideStyles(t,e,i,s){s&&(Ri.applyCustomStylesToElements(t,i,s.shared),e===E?Ri.applyCustomStylesToElements(t,i,s.user):(Ri.applyCustomStylesToElements(t,i,s.ai),Ri.applyCustomStylesToElements(t,i,s[e])))}static isElementsStyles(t){return!!(t.outerContainer||t.innerContainer||t.bubble||t.media)}static applyCustomStyles(t,e,i,s,n){var o;n&&t[g]!==n?Ri.isElementsStyles(n)?(Ri.applyCustomStylesToElements(e,s,null==(o=t[g])?void 0:o.shared),Ri.applyCustomStylesToElements(e,s,n)):(Ri.applySideStyles(e,i,s,t[g]),Ri.applySideStyles(e,i,s,n)):Ri.applySideStyles(e,i,s,t[g])}static extractParticularSharedStyles(t,e){if(null==e||!e.shared)return;const i=e.shared,s={outerContainer:{},innerContainer:{},bubble:{},media:{}};return t.forEach(t=>{var e,n,o,r;s.outerContainer[t]=(null==(e=i.outerContainer)?void 0:e[t])||"",s.innerContainer[t]=(null==(n=i.innerContainer)?void 0:n[t])||"",s.bubble[t]=(null==(o=i.bubble)?void 0:o[t])||"",s.media[t]=(null==(r=i.media)?void 0:r[t])||""}),s}}class Ji{static setElementProps(e,i,s,n){var o;"loading"!==s&&(e.applyCustomStyles(i,n,!0,null==(o=e.messageStyles)?void 0:o[s]),i.bubbleElement[t].add(X))}static addMessage(t,e,i,s,n,o){Ji.setElementProps(t,e,i,s),n||(t.appendOuterContainerElemet(e.outerContainer),!t.focusMode&&o&&Dt.scrollToBottom(t.elementRef,!1,e.outerContainer))}static wrapInLink(t,e,s){const n=i("a");return n.href=e,n.download=s||q,n.target="_blank",n.appendChild(t),n}static isNonLinkableDataUrl(t,e){return!(!e.startsWith("data")||t===D)&&(t===K&&e.startsWith("data:text/javascript")||!e.startsWith("data:image")&&!e.startsWith("data:application"))}static processContent(t,e,i,s){return!i||Ji.isNonLinkableDataUrl(t,i)?e:Ji.wrapInLink(e,i,s)}static waitToLoadThenScroll(t,e){setTimeout(()=>{Dt.scrollToBottom(t,!1,e)},60)}static scrollDownOnImageLoad(t,e,i){if(t.startsWith("data"))Ji.waitToLoadThenScroll(i,e);else try{fetch(t,{mode:"no-cors"}).catch(()=>{}).finally(()=>{Ji.waitToLoadThenScroll(i,e)})}catch{Dt.scrollToBottom(e,!1,i)}}static reAddFileRefToObject(t,e){var i;null==(i=t[z])||i.forEach((t,i)=>{var s;t.ref&&null!=(s=e[z])&&s[i]&&(e[z][i].ref=t.ref)})}static removeFileRef(t){const e={...t};return delete e.ref,e}static isAudioFile(t){const{type:e,src:i}=t;return e===W||(null==i?void 0:i.startsWith("data:audio"))||i&&/\.(mp3|ogg|wav|aac|webm|4a)$/i.test(i)}static isImageFile(t){const{type:e,src:i}=t;return e===D||(null==i?void 0:i.startsWith("data:image"))||i&&Ji.isImageFileExtension(i)}static isImageFileExtension(t){return/\.(jpg|jpeg|png|gif|bmp)$/i.test(t)}}class Fi{static onMessage(t,e,i){var s;const n=JSON.parse(JSON.stringify({message:e,isHistory:i,isInitial:i}));Ji.reAddFileRefToObject(e,n.message),null==(s=t.onMessage)||s.call(t,n),t.dispatchEvent(new CustomEvent("message",{detail:n})),Gt.fireOnNewMessage(t,n)}static onClearMessages(t){var e;null==(e=t.onClearMessages)||e.call(t),t.dispatchEvent(new CustomEvent("clear-messages"))}static onRender(t){var e;null==(e=t.onComponentRender)||e.call(t,t),t.dispatchEvent(new CustomEvent("render",{detail:t}))}static onInput(t,e,i){var s,n;const o=JSON.parse(JSON.stringify({content:e,isUser:i}));e[z]&&Ji.reAddFileRefToObject({[z]:null==(s=e[z])?void 0:s.map(t=>({ref:t}))},o.content),null==(n=t.onInput)||n.call(t,o),t.dispatchEvent(new CustomEvent("input",{detail:o}))}static onError(t,e){var i;null==(i=t.onError)||i.call(t,e),t.dispatchEvent(new CustomEvent(C,{detail:e}))}}const Li=class e{static generateLoadingRingElement(){const e=i();return e[t].add("loading-history"),e.appendChild(i()),e.appendChild(i()),e.appendChild(i()),e.appendChild(i()),e}static apply(t,e,i){Wt.setRing(e.bubbleElement,null==i?void 0:i.bubble),null!=i&&i.bubble&&delete(i=JSON.parse(JSON.stringify(i))).bubble,t.applyCustomStyles(e,"history",!1,i)}static addLoadHistoryMessage(i,s,n=!0){var o,r,a,l,c,h,u,d;i.bubbleElement[t].add(e.CLASS);const p=n?e.FULL_VIEW_CLASS:e.SMALL_CLASS;i.outerContainer[t].add(p);const m=n?null==(l=null==(a=null==(r=null==(o=s.messageStyles)?void 0:o.loading)?void 0:r.history)?void 0:a.full)?void 0:l.styles:null==(d=null==(u=null==(h=null==(c=s.messageStyles)?void 0:c.loading)?void 0:h.history)?void 0:u.small)?void 0:d.styles;e.apply(s,i,m),s.elementRef.prepend(i.outerContainer)}static createDefaultElements(t){const i=t.createMessageElements("",j),{bubbleElement:s}=i,n=e.generateLoadingRingElement();return s.appendChild(n),i}static addMessage(t,i=!0){var s,n,o,r;const a=null==(r=null==(o=null==(n=null==(s=t.messageStyles)?void 0:s.loading)?void 0:n.history)?void 0:o.full)?void 0:r[A],l=a?ae.createElements(t,a,j,!0,!0):e.createDefaultElements(t);return e.addLoadHistoryMessage(l,t,i),Xi.softRemRoleElements(l.innerContainer,t.avatar,t.name),l}static tryChangeViewToSmall(i,s){var n,o,r,a,l,c,h,u;if(null!=s&&s.outerContainer[t].contains(e.FULL_VIEW_CLASS)){s.outerContainer[t].replace(e.FULL_VIEW_CLASS,e.SMALL_CLASS);const d=null==(a=null==(r=null==(o=null==(n=i.messageStyles)?void 0:n.loading)?void 0:o.history)?void 0:r.small)?void 0:a.styles;d&&e.apply(i,s,d);const p=null==(u=null==(h=null==(c=null==(l=i.messageStyles)?void 0:l.loading)?void 0:c.history)?void 0:h.small)?void 0:u[A];return p&&(s.bubbleElement.innerHTML=p),!0}return!1}static changeFullViewToSmall(t){const i=t.messageElementRefs[t.messageElementRefs.length-1];e.tryChangeViewToSmall(t,i)||e.tryChangeViewToSmall(t,t.messageElementRefs[0])}};Li.CLASS="loading-history-message",Li.FULL_VIEW_CLASS="loading-history-message-full-view",Li.SMALL_CLASS="loading-history-message-small";let qi=Li;const zi=class t{static setFade(i,s){i[e].transitionDuration="number"==typeof s?`${s}ms`:`${t.DEFAULT_FADE_MS}ms`}static async fadeAnimation(i,s){i[e].opacity="0";const n="number"==typeof s?s:t.DEFAULT_FADE_MS;await new Promise(t=>{setTimeout(()=>t(),n)}),i[e].opacity="1"}};zi.DEFAULT_FADE_MS=500;let Di=zi;const Ui="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='iso-8859-1'?%3e%3csvg%20fill='%23000000'%20version='1.1'%20id='Layer_1'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20viewBox='0%200%2032%2032'%20xml:space='preserve'%3e%3cpath%20d='M23,30.36H9c-2.404,0-4.36-1.956-4.36-4.36V15c0-2.404,1.956-4.36,4.36-4.36h3.659%20c0.167-1.566,1.415-2.813,2.981-2.981V5.333c-1.131-0.174-2-1.154-2-2.333c0-1.301,1.059-2.36,2.36-2.36%20c1.302,0,2.36,1.059,2.36,2.36c0,1.179-0.869,2.159-2,2.333V7.66c1.566,0.167,2.814,1.415,2.981,2.981H23%20c2.404,0,4.36,1.956,4.36,4.36v11C27.36,28.404,25.404,30.36,23,30.36z%20M9,11.36c-2.007,0-3.64,1.633-3.64,3.64v11%20c0,2.007,1.633,3.64,3.64,3.64h14c2.007,0,3.64-1.633,3.64-3.64V15c0-2.007-1.633-3.64-3.64-3.64H9z%20M13.384,10.64h5.231%20C18.439,9.354,17.334,8.36,16,8.36C14.667,8.36,13.561,9.354,13.384,10.64z%20M16,1.36c-0.904,0-1.64,0.736-1.64,1.64%20S15.096,4.64,16,4.64c0.904,0,1.64-0.736,1.64-1.64S16.904,1.36,16,1.36z%20M20,27.36h-8c-1.301,0-2.36-1.059-2.36-2.36%20s1.059-2.36,2.36-2.36h8c1.302,0,2.36,1.059,2.36,2.36S21.302,27.36,20,27.36z%20M12,23.36c-0.904,0-1.64,0.735-1.64,1.64%20s0.736,1.64,1.64,1.64h8c0.904,0,1.64-0.735,1.64-1.64s-0.735-1.64-1.64-1.64H12z%20M31,23.86h-2c-0.199,0-0.36-0.161-0.36-0.36V15%20c0-0.199,0.161-0.36,0.36-0.36h2c0.199,0,0.36,0.161,0.36,0.36v8.5C31.36,23.699,31.199,23.86,31,23.86z%20M29.36,23.14h1.279v-7.78%20H29.36V23.14z%20M3,23.86H1c-0.199,0-0.36-0.161-0.36-0.36V15c0-0.199,0.161-0.36,0.36-0.36h2c0.199,0,0.36,0.161,0.36,0.36v8.5%20C3.36,23.699,3.199,23.86,3,23.86z%20M1.36,23.14h1.28v-7.78H1.36V23.14z%20M20,20.36c-1.302,0-2.36-1.059-2.36-2.36%20s1.059-2.36,2.36-2.36s2.36,1.059,2.36,2.36C22.36,19.302,21.302,20.36,20,20.36z%20M20,16.36c-0.904,0-1.64,0.736-1.64,1.64%20s0.735,1.64,1.64,1.64s1.64-0.735,1.64-1.64S20.904,16.36,20,16.36z%20M12,20.36c-1.301,0-2.36-1.059-2.36-2.36s1.059-2.36,2.36-2.36%20s2.36,1.059,2.36,2.36C14.36,19.302,13.301,20.36,12,20.36z%20M12,16.36c-0.904,0-1.64,0.736-1.64,1.64s0.736,1.64,1.64,1.64%20s1.64-0.735,1.64-1.64S12.904,16.36,12,16.36z'/%3e%3crect%20style='fill:none;'%20width='32'%20height='32'/%3e%3c/svg%3e",Hi="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAAD6CAMAAAC/MqoPAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAADNQTFRF////9vX18vLy/Pz86enp4+Li2tnZ1tbWzczM+fn57Ozs4N/f09LS0M/P5uXl7+/v3dzcwtncCAAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAAEgAAABIAEbJaz4AAAZNSURBVHja7d3bdtsqEABQYABZSLH9/3+ZpnUsIcF5iOM6PfElNoMHMfPQdq3GmL0GkLhEUqLaUExnOtOZznSmM53pTGc605nOdKYznelMZzrTmV4LXSqllKyJDkob26xWq8Zae/iH0QoWTm9d1xur4WuypQJtTd+5dqn0VjcxzNO5/57mEBvdLo8Oron6aseWOjYOFkVvjQs3DmgyONMuht52EfztP+4hdu0i6LCO808/M8c1lE/fuPGej41uUzgdtoO/75N+2ELJ9I3b3//hPXbiMenm3pR/Jt4USgcLBIp4Bh10gqKVhvLo0klCxeSky96nKcj3siw6pJIL4XsoiQ7apyvMY/V3HHrSRioLopvEhSpTCn2TPEuwKYMOIX0tAxRBf/Hpa+lfSqBv9gi1FPsNfTrMAiVmIE/vJhz61FGnQxRIEYE4vfNYdN8Rp6MlHaHotHTn8ejekaZPAjEmyvQWdZFTtYTpXqCGJ0zvcek9Yfoel76nS0ffv1NMp1ca+pkgyfRCGind4L7OWWc605l+cxjsyhqy9AGbPpClc1/nvl5VX0c/3Alk6RU3+Am7shNZ+h6bvidLr7jBB+zKBrL0irOOudmIUDzTmf5gIP+iEuXtRuTVaEmY/oZLfyNMrzjryPc0gerMTdpVg0tvjJUU6bLPcGOoUv46SLL6Wi8yhLf06C7TUyekI0efRaaYqdFltkeNpPumRPSMDxgBYvSM035FrKAmH72hRW99PrpvSdEHkTEGUvSsK3yKVDkuJ92RohcZaehzzirPpOg+J92Tolfc4Cumx5xVXpGiZ34+ICX6W84qv5GiR5NPbiIpOv6BCoSvSkTX+eiaGP092zINvBOj4x8mSf9FqejvNo/cvpOji19ZbmviL0GPLsYMFzgzCor0+Bv/ePDvSJKOb9dJ5UlnbnEHiHgzv6cdTpJOWuc/u3FEucLDOL75xGtBiefrcwgoC9NDSH/jkH6pAuXmBqPQ9HSUPVdZBH1GGOrMXAQdYxcKZfxAoK+KKBKFLosoEoX+u4giUehz8jlcnAuhp78I46yDYNAd+QLR6K+pr+yvxdBTHyVDubQh0UfSxaHSd0lbvNkVRE87JGOtc+PQd2QLQ6fHhJkKsSh6yg13tO08JPprsgrrXWH0dJd2vH1MLPprot4eXoujpzrdhngiD40ek2y92lggPcnWa8qN1Yz0BFuvZhRl0uOfR0v4Ewuli/Bg4Qr3lArqGdndQ3UPO1EunXYwnelMZzrTmc50pjOd6UxnOtOZznSmM53pTGf6kuj6oedFKV0s3fX6sX1S3bsi6a4PD7+/YAqYeBw6pIB/4qEgOqxdSPbGiim4NRRCbzs3Jj0L4UfXtQXQVRfn5IdA/Bw7RZzurEV6EtdsLeGXkIPuA+K1UoVeA0l62zmN/LqfSSft9KkepmoRuvi3nd5uKNFB9zbbXEANqdr941XO0NJx2v2jdJenpf+/3bvn0ts16ph+sd6hX7dPo2+2cZzE02Ia43bzDHqr+2Evnhz74ZHU30ffbKOeng1/NPV30Ns1gYQnSP2P6e65Pfxc6h02XZqXQCjhJ6kPL6bFo4NrGvAU4UII4SE2P1vQuZkuOxckVfehisF1MjUddN/MZBN+kvq5uf0O/xa66gyNS9ktMWlz44rO1Z8C19i5FPdHzPamXn+F3hryPfxMr78+4F+kq22kO6Rf6fUQt+puuustyWv4rbG3l/duztFB96GYoe1cTBdXMr+nw9qVM6ZfxOvzezff0nXi/ZOndvrR6Zvpm0c3h6nhdb+5iS7tsIim/qXZD9+97/Jf+rpZ5BET1ayv0GUzLhEuhBBjIy/RdVPgndutIRt9nt7p5cKFEEJ3Z+jQFDZL+XnMDXxHB73gxn5s9Kc3d3/pFciFkN/QTSXHJpX5l66gDrkQoP6hL3xsPw39la4qOiV8tH78XeSbue6N9mvWa6J/ybpc1CT1Wnh5Qq9meP8IOKH3ddH7E/ri1iYux/SXDrXR4UiPdck/wUpU+FtPf6/orja6O9KL3l56LOvVxe5Ib2qjN0d6Vbex4ghWlU3bPqI90If66MNng680FNpbJijH6kCvaF3uMzQ3+IrpFerV4Y9dffQdN3im10ivbuImhD3Qq5u4HdZkua8znelMZ/pS4z9CPVKkxowNxgAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNy0wMy0yN1QxNTo0NToxNSswMDowMN1xSg4AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTctMDMtMjdUMTU6NDU6MTUrMDA6MDCsLPKyAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAABJRU5ErkJggg==";class Vi{constructor(t){this.className=t}getAvatarContainer(t){return t.getElementsByClassName(this.className)[0]}tryHide(t){var i;(i=this.getAvatarContainer(t)[e]).visibility||(i.visibility="hidden")}tryReveal(t){this.getAvatarContainer(t)[e].visibility=""}trySoftRem(e){this.getAvatarContainer(e)[t].add("role-hidden")}}class Wi extends Vi{constructor(t){super("avatar-container"),this._avatars=t}addBesideBubble(e,i){const s="boolean"==typeof this._avatars?void 0:this._avatars,n=this.createAvatar(i,s),o=this.getPosition(i,s);n[t].add("left"===o?"left-item-position":"right-item-position"),e.insertAdjacentElement("left"===o?"beforebegin":"afterend",n)}createAvatar(e,s){var n,o,r,a,l;const c=i("img");e===E?(c.src=(null==(n=null==s?void 0:s[E])?void 0:n.src)||(null==(o=null==s?void 0:s[g])?void 0:o.src)||Hi,c.onerror=Wi.errorFallback.bind(this,Hi)):(c.src=(null==(r=null==s?void 0:s[e])?void 0:r.src)||(null==(a=null==s?void 0:s[j])?void 0:a.src)||(null==(l=null==s?void 0:s[g])?void 0:l.src)||Ui,c.onerror=Wi.errorFallback.bind(this,Ui)),c[t].add("avatar"),c.alt=`${e} avatar`;const h=i();return h[t].add(this.className),h.appendChild(c),s&&Wi.applyCustomStyles(h,c,s,e),h}getPosition(t,e){var i,s,n,o,r,a;let l=null==(s=null==(i=null==e?void 0:e[t])?void 0:i.styles)?void 0:s.position;return t!==E&&(l??(l=null==(o=null==(n=null==e?void 0:e.ai)?void 0:n.styles)?void 0:o.position)),l??(l=null==(a=null==(r=null==e?void 0:e[g])?void 0:r.styles)?void 0:a.position),l??(l=t===E?"right":"left"),l}static errorFallback(t,e){const i=e.target;i.onerror=null,i.src=t}static applyCustomStylesToElements(t,i,s){Object.assign(t[e],s.container),Object.assign(i[e],s.avatar)}static applyCustomStyles(t,e,i,s){var n,o,r,a;if(null!=(n=i[g])&&n.styles&&Wi.applyCustomStylesToElements(t,e,i[g].styles),s===E)null!=(o=i.user)&&o.styles&&Wi.applyCustomStylesToElements(t,e,i.user.styles);else{null!=(r=i.ai)&&r.styles&&Wi.applyCustomStylesToElements(t,e,i.ai.styles);const n=null==(a=i[s])?void 0:a.styles;n&&Wi.applyCustomStylesToElements(t,e,n)}}}class Gi extends Vi{constructor(t){super("name"),this._names=t}addBesideBubble(e,i){const s="boolean"==typeof this._names?{}:this._names,n=this.createName(i,s),o=Gi.getPosition(i,s);n[t].add("left"===o?"left-item-position":"right-item-position"),e.insertAdjacentElement("left"===o?"beforebegin":"afterend",n)}createName(e,s){const n=i();return n[t].add(this.className),n.textContent=Gi.getNameText(e,s),Gi.applyStyle(n,e,s),n}static getPosition(t,e){var i,s,n;let o=null==(i=null==e?void 0:e[t])?void 0:i.position;return t!==E&&(o??(o=null==(s=null==e?void 0:e[j])?void 0:s.position)),o??(o=null==(n=null==e?void 0:e[g])?void 0:n.position),o??(o=t===E?"right":"left"),o}static applyStyle(t,i,s){var n,o,r,a;Object.assign(t[e],null==(n=s[g])?void 0:n[e]),i===E?Object.assign(t[e],null==(o=s[E])?void 0:o[e]):(Object.assign(t[e],null==(r=s[j])?void 0:r[e]),Object.assign(t[e],null==(a=s[i])?void 0:a[e]))}static getNameText(t,e){var i,s,n,o,r,a;return t===E?(null==(i=e[E])?void 0:i[M])||(null==(s=e[g])?void 0:s[M])||"User":t===j?(null==(n=e[j])?void 0:n[M])||(null==(o=e[g])?void 0:o[M])||"AI":(null==(r=e[t])?void 0:r[M])||(null==(a=e[g])?void 0:a[M])||t}}const Zi=class e{constructor(t){var s,n,o;this.messageElementRefs=[],this.htmlClassUtilities={},this.messageToElements=[],this.elementRef=e.createContainerElement(),this.messageStyles=Gt.processMessageStyles(t.messageStyles),this._remarkable=$i.createNew(t.remarkable),this._applyHTMLToRemarkable=null==(s=t.remarkable)?void 0:s.applyHTML,t.avatars&&(this.avatar=new Wi(t.avatars)),t.names&&(this.name=new Gi(t.names)),t.browserStorage&&(this.browserStorage=new Bi(t.browserStorage)),this._onMessage=Fi.onMessage.bind(this,t),t.htmlClassUtilities&&(this.htmlClassUtilities=t.htmlClassUtilities),this.focusMode=Gt.processFocusMode(t.focusMode),this.focusMode||(this._lastGroupMessagesElement=i()),"boolean"!=typeof this.focusMode&&null!=(n=this.focusMode)&&n.fade&&Di.setFade(this.elementRef,this.focusMode.fade),this._customWrappers=t.htmlWrappers||Gt.processStreamHTMLWrappers(null==(o=t.connect)?void 0:o.stream),setTimeout(()=>{this.submitUserMessage=t.submitUserMessage})}static createContainerElement(){const t=i();return t.id="messages",t}addNewTextMessage(i,s,n,o=!1){if(null!=n&&n.status){const t=this.overwriteText(s,i,this.messageElementRefs);if(t)return t;n.status=!1}const r=o?this.createAndPrependNewMessageElement(i,s,o):this.createAndAppendNewMessageElement(i,s);return r.bubbleElement[t].add(e.TEXT_BUBBLE_CLASS),this.applyCustomStyles(r,s,!1),Xi.fillEmptyMessageElement(r.bubbleElement,i),r}overwriteText(t,i,s){const n=Xi.overwriteMessage(this.messageToElements,s,i,t,"text",e.TEXT_BUBBLE_CLASS);return n&&this.renderText(n.bubbleElement,i,t),n}createAndAppendNewMessageElement(t,e){return this.focusMode?this.appendNewMessageElementFocusMode(t,e):this.createAndAppendNewMessageElementDefault(t,e)}appendNewMessageElementFocusMode(t,e){var i;const s=this.createNewMessageElement(t,e);if(this.appendOuterContainerElemet(s.outerContainer,e),e===E){const t="boolean"!=typeof this.focusMode&&(null==(i=this.focusMode)?void 0:i.smoothScroll);t?setTimeout(()=>{Dt.scrollToBottom(this.elementRef,t)}):Dt.scrollToBottom(this.elementRef)}return s}createNewGroupElementFocusMode(){var s;null==(s=this._lastGroupMessagesElement)||s[t].remove(e.LAST_GROUP_MESSAGES_ACTIVE);const n=i();this._lastGroupMessagesElement&&n[t].add(e.LAST_GROUP_MESSAGES_ACTIVE),this._lastGroupMessagesElement=n}createAndAppendNewMessageElementDefault(t,e){const i=this.createNewMessageElement(t,e),s=Dt.isScrollbarAtBottomOfElement(this.elementRef);return this.appendOuterContainerElemet(i.outerContainer),setTimeout(()=>{e===E?Dt.scrollToBottom(this.elementRef):s&&Dt.scrollToBottom(this.elementRef,!1,i.outerContainer)}),i}appendOuterContainerElemet(t,e){var i;this.focusMode&&(e===E||!this._lastGroupMessagesElement)&&this.createNewGroupElementFocusMode(),null==(i=this._lastGroupMessagesElement)||i.appendChild(t),this.elementRef.appendChild(this._lastGroupMessagesElement)}createAndPrependNewMessageElement(i,s,n,o=!1){var r;const a=this.createNewMessageElement(i,s,n,o);if(n&&null!=(r=this.elementRef.firstChild)&&r[t].contains(e.INTRO_CLASS)){this.elementRef.firstChild.insertAdjacentElement("afterend",a.outerContainer);const t=this.messageElementRefs[0];this.messageElementRefs[0]=this.messageElementRefs[1],this.messageElementRefs[1]=t}else this.elementRef.insertBefore(a.outerContainer,this.elementRef.firstChild);return a}createMessageElementsOnOrientation(t,e,i,s=!1){return i?this.createAndPrependNewMessageElement(t,e,i,s):this.createNewMessageElement(t,e,i,s)}createNewMessageElement(t,i,s=!1,n=!1){var o;n||null==(o=this._introPanel)||o.hide();const r=this.messageElementRefs[this.messageElementRefs.length-1];return qi.changeFullViewToSmall(this),!s&&e.isTemporaryElement(r)&&(this.revealRoleElementsIfTempRemoved(r,i),this.removeLastMessage()),this.createMessageElements(t,i,s)}revealRoleElementsIfTempRemoved(e,i){if((this.avatar||this.name)&&se.isElementTemporary(e)){const s=this.messageElementRefs[this.messageElementRefs.length-2];s&&this.messageToElements.length>0&&!e.bubbleElement[t].contains(Xi.getRoleClass(i))&&Xi.revealRoleElements(s.innerContainer,this.avatar,this.name)}}static isTemporaryElement(t){return e.isLoadingMessage(t)||se.isElementTemporary(t)}createElements(t,i){const s=e.createBaseElements(i),{outerContainer:n,innerContainer:o,bubbleElement:r}=s;return n.appendChild(o),this.addInnerContainerElements(r,t,i),s}createMessageElements(t,e,i=!1){const s=this.createElements(t,e);return Xi.updateRefArr(this.messageElementRefs,s,i),Xi.classifyRoleMessages(this.messageElementRefs,e),s}static createBaseElements(e){const s=i(),n=i();n[t].add("inner-message-container"),s.appendChild(n),s[t].add("outer-message-container"),s[t].add(Xi.buildRoleOuterContainerClass(e));const o=i();return o[t].add("message-bubble"),n.appendChild(o),{outerContainer:s,innerContainer:n,bubbleElement:o}}addInnerContainerElements(e,i,s){const n=this.messageElementRefs[this.messageElementRefs.length-1];return Xi.areOuterContainerClassRolesSame(s,n)&&!this.isLastMessageError()&&Xi.hideRoleElements(n.innerContainer,this.avatar,this.name),e[t].add("message-bubble",Xi.getRoleClass(s),s===E?"user-message-text":"ai-message-text"),this.renderText(e,i,s),Xi.addRoleElements(e,s,this.avatar,this.name),{bubbleElement:e}}applyCustomStyles(t,e,i,s){t&&this.messageStyles&&Ri.applyCustomStyles(this.messageStyles,t,e,i,s)}static createMessageContent(t){const{text:e,files:i,html:s,custom:n,_sessionId:o,role:r}=t,a={role:r||j};return e&&(a[M]=e),i&&(a[z]=i),s&&(a[A]=s),!e&&!i&&!s&&(a[M]=""),n&&(a.custom=n),o&&(a._sessionId=o),a}removeMessage(t){t.outerContainer.remove();const e=this.messageElementRefs.findIndex(e=>e===t);this.messageElementRefs.splice(e,1)}removeLastMessage(){this.messageElementRefs[this.messageElementRefs.length-1].outerContainer.remove(),this.messageElementRefs.pop()}isLastMessageError(){var e;return null==(e=Xi.getLastMessageBubbleElement(this.elementRef))?void 0:e[t].contains(I)}static isLoadingMessage(e){return null==e?void 0:e.bubbleElement[t].contains(Wt.BUBBLE_CLASS)}sendClientUpdate(t,e=!1){var i;null==(i=this._onMessage)||i.call(this,t,e)}renderText(t,e,i){const{contentEl:s,wrapper:n}=oe.tryAddWrapper(t,e,this._customWrappers,i);n&&oe.apply(this,t),s.innerHTML=this._remarkable.render(e),this._applyHTMLToRemarkable&&oe.apply(this,s),0===s.innerText.trim().length&&s.children.length>0&&"P"!==s.children[0].tagName&&(s.innerText=e)}refreshTextMessages(t){this._remarkable=$i.createNew(t),this.messageToElements.forEach(t=>{t[1][M]&&t[0][M]&&this.renderText(t[1][M].bubbleElement,t[0][M],t[0].role)})}};Zi.TEXT_BUBBLE_CLASS="text-message",Zi.INTRO_CLASS="deep-chat-intro",Zi.LAST_GROUP_MESSAGES_ACTIVE="deep-chat-last-group-messages-active";let Ki=Zi;class Xi{static getLastElementsByClass(e,i,s){for(let n=e.length-1;n>=0;n-=1){const o=e[n];if(o.bubbleElement[t].contains(i[0])&&!i.slice(1).find(e=>!o.bubbleElement[t].contains(e))){if(!s)return o;if(!s.find(e=>o.bubbleElement[t].contains(e)))return o}}}static getLastMessage(t,e,i){for(let s=t.length-1;s>=0;s-=1)if(t[s][0].role===e){if(!i)return t[s][0];if(t[s][0][i])return t[s][0]}}static getLastTextToElement(t,e){for(let i=t.length-1;i>=0;i-=1)if(t[i][0]===e)return t[i]}static overwriteMessage(t,e,i,s,n,o){const r=Xi.getLastElementsByClass(e,[Xi.getRoleClass(s),o],[Wt.BUBBLE_CLASS]),a=Xi.getLastMessage(t,s,n);return a&&(a[n]=i),r}static getRoleClass(t){return`${t}-message`}static fillEmptyMessageElement(e,i){0===i.trim().length&&(e[t].add($),e.innerHTML='<div style="color:#00000000">.</div>')}static unfillEmptyMessageElement(e,i){e[t].contains($)&&i.trim().length>0&&e.replaceChildren()}static getLastMessageBubbleElement(e){var i,s,n;return Array.from((null==(n=null==(s=null==(i=Xi.getLastMessageElement(e))?void 0:i.children)?void 0:s[0])?void 0:n.children)||[]).find(e=>e[t].contains("message-bubble"))}static getLastMessageElement(t){var e;const i=null==(e=t.children[t.children.length-1])?void 0:e.children;return null==i?void 0:i[i.length-1]}static addRoleElements(t,e,i,s){null==i||i.addBesideBubble(t,e),null==s||s.addBesideBubble(t,e)}static hideRoleElements(t,e,i){null==e||e.tryHide(t),null==i||i.tryHide(t)}static revealRoleElements(t,e,i){null==e||e.tryReveal(t),null==i||i.tryReveal(t)}static softRemRoleElements(t,e,i){null==e||e.trySoftRem(t),null==i||i.trySoftRem(t)}static updateRefArr(t,e,i){i?t.unshift(e):t.push(e)}static buildRoleOuterContainerClass(t){return`${P}${t}`}static addNewPositionClasses(e,i){e.outerContainer[t].remove(B,R,J),e.outerContainer[t].add(...i)}static getNumberOfElements(t){let e=0;return void 0!==t[M]&&(e+=1),void 0!==t[A]&&(e+=1),t[z]&&(e+=t[z].length),e}static filterdMessageElements(e,i){return e.filter(e=>e.bubbleElement[t].contains(i))}static findMessageElements(e,i){return e.find(e=>e.bubbleElement[t].contains(i))}static generateMessageBodyElements(t,e){const i={};return t[M]&&(i[M]=Xi.findMessageElements(e,Ki.TEXT_BUBBLE_CLASS)),t[A]&&(i[A]=Xi.findMessageElements(e,ae.HTML_BUBBLE_CLASS)),t[z]&&(i[z]=Xi.filterdMessageElements(e,X)),i}static generateMessageBody(t,e,i=!1){const s=Xi.getNumberOfElements(t),n=i?e.slice(0,s):e.slice(e.length-s);return Xi.generateMessageBodyElements(t,n)}static classifyRoleMessages(e,i){let s=i?Xi.buildRoleOuterContainerClass(i):void 0;for(let n=e.length-1;n>=0;n-=1){if(i||(s=Array.from(e[n].outerContainer[t]).find(t=>t.startsWith(P))),!s)continue;const o=e[n],r=o.outerContainer[t].contains(s),a=e[n-1],l=e[n+1],c=null==a?void 0:a.outerContainer[t].contains(s),h=null==l?void 0:l.outerContainer[t].contains(s);if(r)!c&&h?Xi.addNewPositionClasses(o,[B]):c&&h?Xi.addNewPositionClasses(o,[R]):c&&!h?Xi.addNewPositionClasses(o,[J]):!c&&!h&&Xi.addNewPositionClasses(o,[B,J]);else if(i)break}}static areOuterContainerClassRolesSame(e,i){return!!i&&Array.from(i.outerContainer[t]).find(t=>t.startsWith(P))===Xi.buildRoleOuterContainerClass(e)}static resetAllRoleElements(e,i,s){if(!i&&!s)return;let n="";e.forEach((o,r)=>{o.bubbleElement[t].contains(I)||Xi.revealRoleElements(o.innerContainer,i,s);const a=Array.from(o.outerContainer[t]).find(t=>t.startsWith(P));n===a&&Xi.hideRoleElements(e[r-1].innerContainer,i,s),n=a})}static deepCloneMessagesWithReferences(t){return t.map(t=>Xi.processMessageContent(t))}static processMessageContent(t){if(null==t||typeof t!==Bt)return t;if(Array.isArray(t))return t.map(t=>Xi.processMessageContent(t));const e={};return Object.entries(t).forEach(([t,i])=>{"ref"===t&&i instanceof File||"custom"===t?e[t]=i:e[t]=null!==i&&typeof i===Bt?Xi.processMessageContent(i):i}),e}}const Qi=class e{constructor(t,i){this.allowScroll=!0,this._fileAdded=!1,this._streamType="",this._hasStreamEnded=!1,this._partialText="",this._messages=t,e.isFocusModeScrollAllowed(this._messages.focusMode)&&(this.allowScroll=!1),"object"==typeof i&&(this._partialRender=i.partialRender)}static isFocusModeScrollAllowed(t){return"object"==typeof t&&"boolean"==typeof t.streamAutoScroll&&!t.streamAutoScroll}upsertStreamedMessage(t){if(this._hasStreamEnded)return;if(void 0===(null==t?void 0:t[M])&&void 0===(null==t?void 0:t[A]))return console[C](wt);null!=t&&t.custom&&this._message&&(this._message.custom=t.custom);const e=(null==t?void 0:t[M])||(null==t?void 0:t[A])||"",i=Dt.isScrollbarAtBottomOfElement(this._messages.elementRef),s=void 0!==(null==t?void 0:t[M])?M:A;if(this._elements||this._message){if(this._streamType!==s)return console[C]("Cannot mix {text: string} and {html: string} responses.");this.updateBasedOnType(e,s,null==t?void 0:t.overwrite)}else this.setInitialState(s,e,null==t?void 0:t.role);i&&this.allowScroll&&Dt.scrollToBottom(this._messages.elementRef)}setInitialState(i,s,n){var o,r;this._streamType=i,n??(n=j);const a=(null==(o=this._messages._customWrappers)?void 0:o[n])||(null==(r=this._messages._customWrappers)?void 0:r[g]),l=a?"":s;this._elements=i===M?this._messages.addNewTextMessage(l,n):ae.add(this._messages,l,n,!0),this._elements&&(this._elements.bubbleElement[t].add(e.MESSAGE_CLASS),this._activeMessageRole=n,this._message={role:this._activeMessageRole,[i]:l},this._messages.messageToElements.push([this._message,{[i]:this._elements}]),a&&this.setTargetWrapperIfNeeded(this._elements,s,this._streamType,a))}setTargetWrapperIfNeeded(t,e,i,s){t.bubbleElement.innerHTML=s,this._targetWrapper=oe.getTargetWrapper(t.bubbleElement),this._elements&&oe.apply(this._messages,this._elements.bubbleElement),this.updateBasedOnType(e,i)}updateBasedOnType(t,e,i=!1){var s;const n=this._targetWrapper||(null==(s=this._elements)?void 0:s.bubbleElement);this._partialRender||Xi.unfillEmptyMessageElement(n,t),(e===M?this.updateText:this.updateHTML).bind(this)(t,n,i)}updateText(t,e,i){this._message&&(this._message[M]=i?t:this._message[M]+t,this._partialRender&&this.isNewPartialRenderParagraph(e,i)&&this.partialRenderNewParagraph(e),this._partialBubble?this.partialRenderBubbleUpdate(t):this._messages.renderText(e,this._message[M]))}isNewPartialRenderParagraph(t,e){var i;return e?(t.innerHTML="",!0):this._partialBubble?this._partialText&&this.shouldCreateNewParagraph(this._partialText):(null==(i=this._message)?void 0:i[M])&&this.shouldCreateNewParagraph(this._message[M])}shouldCreateNewParagraph(t){const i=t.indexOf(e.PARTIAL_RENDER_TEXT_MARK);return-1!==i&&!t.substring(i+e.PARTIAL_RENDER_TEXT_MARK.length).startsWith("---")}partialRenderNewParagraph(e){this._partialText="",this._partialBubble=i(),this._partialBubble[t].add("partial-render-message"),e.appendChild(this._partialBubble)}partialRenderBubbleUpdate(t){this._partialText+=t,this._messages.renderText(this._partialBubble,this._partialText)}updateHTML(t,e,s){if(this._message)if(s)this._message[A]=t,e.innerHTML=t;else{const s=i("span");s.innerHTML=t,e.appendChild(s),this._message[A]=(null==e?void 0:e.innerHTML)||""}}finaliseStreamedMessage(){var i,s;if(!this._endStreamAfterOperation&&this._message&&(!this._fileAdded||this._elements)){if(!this._elements)throw Error(xt);null!=(i=this._elements.bubbleElement)&&i[t].contains(e.MESSAGE_CLASS)&&(this._streamType===M?this._messages.textToSpeech&&Ht.speak(this._message[M]||"",this._messages.textToSpeech):this._streamType===A&&this._elements&&oe.apply(this._messages,this._elements.outerContainer),this._elements.bubbleElement[t].remove(e.MESSAGE_CLASS),this._message&&(this._messages.sendClientUpdate(Ki.createMessageContent(this._message),!1),null==(s=this._messages.browserStorage)||s.addMessages(this._messages.messageToElements.map(([t])=>t))),this._hasStreamEnded=!0)}}markFileAdded(){this._fileAdded=!0}async endStreamAfterFileDownloaded(t,e){this._endStreamAfterOperation=!0;const{text:i,files:s}=await e();i&&this.updateBasedOnType(i,M,!0),this._endStreamAfterOperation=!1,this.finaliseStreamedMessage(),s&&t.addNewMessage({[z]:s})}};Qi.MESSAGE_CLASS="streamed-message",Qi.PARTIAL_RENDER_TEXT_MARK="\n\n";let Yi=Qi;class ts{static async tempRemoveContentHeader(t,e,i){if(null==t||!t.headers)throw new Error(ft);const s=t.headers[It];let n;delete t.headers[It];try{n=await e(i)}catch(e){throw t.headers[It]=s,e}return t.headers[It]=s,n}static displayError(t,e,i="Service error, please try again."){if(console[C](e),typeof e===Bt)return e instanceof Error?t.addNewErrorMessage(O,e.message):Array.isArray(e)||"string"==typeof e[C]?t.addNewErrorMessage(O,e):0===Object.keys(e).length?t.addNewErrorMessage(O,i):t.addNewErrorMessage(O,JSON.stringify(e));t.addNewErrorMessage(O,e)}static fetch(t,e,i,s){var n,o;const r={method:(null==(n=t.connectSettings)?void 0:n.method)||Lt,headers:e};return r.method!==Ft&&(r.body=i?JSON.stringify(s):s),t.connectSettings.credentials&&(r.credentials=t.connectSettings.credentials),fetch((null==(o=t.connectSettings)?void 0:o.url)||t.url||"",r)}static processResponseByType(t){const e=t.headers.get("content-type");return null!=e&&e.includes($t)?t.json():null!=e&&e.includes("text/plain")||!e?t:t.blob()}static async processRequestInterceptor(t,e){var i;const s=await(null==(i=t.requestInterceptor)?void 0:i.call(t,e))||e,n=s,o=s;return{body:n.body,headers:n.headers,error:o[C]}}static validateResponseFormat(t,e){if(!t)return!1;const i=Array.isArray(t)?t:[t];return e&&i.length>1?(console[C](yt),!1):!i.find(t=>"object"!=typeof t||!("string"==typeof t[C]||"string"==typeof t[M]||"string"==typeof t[A]||Array.isArray(t[z])))}static onInterceptorError(t,e,i){t.addNewErrorMessage(O,e),null==i||i()}static async basicResponseProcessing(t,e,i={}){const{io:s,displayError:n=!0,useRI:o=!0}=i;if(null==s||!s.extractResultData)return e;const r=o?s.deepChat.responseInterceptor:void 0,a=await(null==r?void 0:r(e))||e,l=await s.extractResultData(a);if(l&&("object"==typeof l||Array.isArray(l)))return l;if(n){const i=ut(e,"response",!!r,a);ts.displayError(t,i)}}}function es(t){let e,i,s,n=!1;return function(o){void 0===e?(e=o,i=0,s=-1):e=function(t,e){const i=new Uint8Array(t.length+e.length);return i.set(t),i.set(e,t.length),i}(e,o);const r=e.length;let a=0;for(;i<r;){n&&(10===e[i]&&(a=++i),n=!1);let o=-1;for(;i<r&&-1===o;++i)switch(e[i]){case 58:-1===s&&(s=i-a);break;case 13:n=!0;case 10:o=i}if(-1===o)break;t(e.subarray(a,o),s),a=i,s=-1}a===r?e=void 0:0!==a&&(e=e.subarray(a),i-=a)}}const is="text/event-stream",ss="last-event-id";function ns(t,e){var{signal:i,headers:s,onopen:n,onmessage:o,onclose:r,onerror:a,openWhenHidden:l,fetch:c}=e,h=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(e,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((e,u)=>{const d=Object.assign({},s);let p;function m(){p.abort(),document.hidden||w()}d.accept||(d.accept=is),l||document.addEventListener("visibilitychange",m);let v=1e3,f=0;function g(){document.removeEventListener("visibilitychange",m),window.clearTimeout(f),p.abort()}null==i||i.addEventListener("abort",()=>{g(),e()});const b=c??window.fetch,y=n??os;async function w(){var i;p=new AbortController;try{const i=await b(t,Object.assign(Object.assign({},h),{headers:d,signal:p.signal}));await y(i),await async function(t,e){const i=t.getReader();let s;for(;!(s=await i.read()).done;)e(s.value)}(i.body,es(function(t,e,i){let s={data:"",event:"",id:"",retry:void 0};const n=new TextDecoder;return function(o,r){if(0===o.length)null==i||i(s),s={data:"",event:"",id:"",retry:void 0};else if(r>0){const i=n.decode(o.subarray(0,r)),a=r+(32===o[r+1]?2:1),l=n.decode(o.subarray(a));switch(i){case"data":s.data=s.data?s.data+"\n"+l:l;break;case"event":s.event=l;break;case"id":t(s.id=l);break;case"retry":const i=parseInt(l,10);isNaN(i)||e(s.retry=i)}}}}(t=>{t?d[ss]=t:delete d[ss]},t=>{v=t},o))),null==r||r(),g(),e()}catch(t){if(!p.signal.aborted)try{const e=null!==(i=null==a?void 0:a(t))&&void 0!==i?i:v;window.clearTimeout(f),f=window.setTimeout(w,e)}catch(t){g(),u(t)}}}w()})}function os(t){const e=t.headers.get("content-type");if(null==e||!e.startsWith(is))throw new Error(`Expected content-type to be ${is}, Actual: ${e}`)}class rs{static async request(t,e,i,s=!0,n=!1){var o,r,a,l,c;const h={body:e,headers:null==(o=t.connectSettings)?void 0:o.headers},{body:u,headers:d,error:p}=await ts.processRequestInterceptor(t.deepChat,h);if(p)return ts.onInterceptorError(i,p,t.streamHandlers.onClose);if(null!=(r=t.connectSettings)&&r.handler)return hs.stream(t,u,i);if((null==(a=t.connectSettings)?void 0:a.url)===ls.URL)return ls.requestStream(i,t);const m=new Yi(i,t.stream),v={method:(null==(l=t.connectSettings)?void 0:l.method)||Lt,headers:d,credentials:null==(c=t.connectSettings)?void 0:c.credentials,body:s?JSON.stringify(u):u};return"object"==typeof t.stream&&t.stream.readable?rs.handleReadableStream(t,i,m,v,n,u):rs.handleEventStream(t,i,m,v,n,u),m}static handleReadableStream(t,e,i,s,n,o){var r;const{onOpen:a,onClose:l}=t.streamHandlers;let c=!1;fetch((null==(r=t.connectSettings)?void 0:r.url)||t.url||"",s).then(async s=>{var r,h;if(!s.body)throw new Error("Readable Stream connection error.");const u=s.body.getReader(),d=new TextDecoder;a();let p=!1;for(;!p&&!c;){const{value:s,done:a}=await u.read();if(p=a,p)rs.handleClose(t,i,l,n);else{const n=d.decode(s,{stream:!0}),a=await(null==(h=(r=t.deepChat).responseInterceptor)?void 0:h.call(r,n))||n,l="object"==typeof a?a:{[M]:n};rs.handleMessage(t,e,i,l,o)}}}).catch(i=>{rs.handleError(t,e,i)}),t.streamHandlers.onAbort=()=>{i.finaliseStreamedMessage(),t.streamHandlers.onClose(),c=!0}}static handleEventStream(t,e,i,s,n,o){var r;const{onOpen:a,onClose:l}=t.streamHandlers,c=new AbortController;t.streamHandlers.onAbort=()=>{i.finaliseStreamedMessage(),t.streamHandlers.onClose(),c.abort()},ns((null==(r=t.connectSettings)?void 0:r.url)||t.url||"",{...s,openWhenHidden:!0,async onopen(t){if(t.ok)return a();throw await ts.processResponseByType(t)},async onmessage(s){var n,r;if(JSON.stringify(s.data)!==JSON.stringify("[DONE]")){let a;try{a=JSON.parse(s.data)}catch{a={}}const l=await(null==(r=(n=t.deepChat).responseInterceptor)?void 0:r.call(n,a))||a;rs.handleMessage(t,e,i,l,o)}},onerror(t){throw l(),t},onclose(){rs.handleClose(t,i,l,n)},signal:c.signal}).catch(i=>{rs.handleError(t,e,i)})}static handleMessage(t,e,i,s,n){var o;null==(o=t.extractResultData)||o.call(t,s,n).then(t=>{rs.upsertContent(e,i.upsertStreamedMessage.bind(i),i,t),e.removeError()}).catch(t=>{e.isLastMessageError()||ts.displayError(e,t)})}static handleError(t,e,i){var s;e.isLastMessageError()||null==(s=t.extractResultData)||s.call(t,i).then(()=>{ts.displayError(e,i)}).catch(t=>{ts.displayError(e,t)})}static handleClose(t,e,i,s){if(t.asyncCallInProgress)t.asyncCallInProgress=!1;else try{e.finaliseStreamedMessage(),i()}catch(t){if(!s)throw t}}static async simulate(t,e,i,s){if(!await ts.basicResponseProcessing(t,i,{io:s,useRI:!1}))return e.onClose();if(Array.isArray(i)&&(i=i[0]),i[A]){e.onOpen();let n=oe.splitHTML(i[A]);0===n.length&&(n=i[A].split(""));const o=new Yi(t,null==s?void 0:s.stream);rs.populateMessages(t,n,o,e,A,0,s)}if(i[z]){const n=await ts.basicResponseProcessing(t,{[z]:i[z]},{io:s});t.addNewMessage({sendUpdate:!1,...n},!1),!i[A]&&!i[M]&&(new Yi(t,null==s?void 0:s.stream).finaliseStreamedMessage(),e.onClose())}if(i[M]){e.onOpen();const n=i[M].split(""),o=new Yi(t,null==s?void 0:s.stream);rs.populateMessages(t,n,o,e,M,0,s)}i[C]&&(ts.displayError(t,i[C]),e.onClose()),e.onAbort=()=>{e.onClose()}}static async populateMessages(t,e,i,s,n,o,r){const a=e[o];if(a){try{const e=await ts.basicResponseProcessing(t,{[n]:a},{io:r});rs.upsertContent(t,i.upsertStreamedMessage.bind(i),i,e),t.removeError()}catch(e){t.isLastMessageError()||ts.displayError(t,e)}const l=setTimeout(()=>{rs.populateMessages(t,e,i,s,n,o+1,r)},s.simulationInterim||6);s.onAbort=()=>{rs.abort(l,i,s.onClose)}}else i.finaliseStreamedMessage(),s.onClose()}static isSimulation(t){return"object"==typeof t&&!!t.simulation}static isSimulatable(t,e){return rs.isSimulation(t)&&e&&(e[M]||e[A])}static abort(t,e,i){clearTimeout(t),e.finaliseStreamedMessage(),i()}static upsertContent(t,e,i,s){if(s&&Array.isArray(s)&&(s=s[0]),null!=s&&s[M]||null!=s&&s[A]){const t=e(s);i??(i=t||void 0)}if(null!=s&&s[z]&&(t.addNewMessage({[z]:s[z]}),null==i||i.markFileAdded()),null!=s&&s[C])throw s[C]}}const as=class t{static generateResponse(t){const e=t[t.length-1][0];if(e[z]&&e[z].length>0){if(e[z].length>1)return"These are interesting files!";const t=e[z][0];return t.src&&t.src.startsWith("data:image/gif")?"That is a nice gif!":t.type===D?"That is a nice image!":t.type===W?"I like the sound of that!":"That is an interesting file!"}if(e[M]){if("?"===e[M].charAt(e[M].length-1))return"I'm sorry but I can't answer that question...";if(e[M].includes("updog"))return"What's updog?"}return"Hi there! This is a demo response!"}static getCustomResponse(t,e){return"function"==typeof t?t(e):t}static getResponse({customDemoResponse:e,messageToElements:i}){return e?t.getCustomResponse(e,i[i.length-1][0]):{[M]:t.generateResponse(i)}}static request(e,i){const s=t.getResponse(i);setTimeout(async()=>{const t=await ts.basicResponseProcessing(i,s,{io:e});if(!t)return e.completionsHandlers.onFinish();const n=Array.isArray(t)?t:[t],o=n.find(t=>"string"==typeof t[C]);o?(i.addNewErrorMessage(O,o[C]),e.completionsHandlers.onFinish()):rs.isSimulatable(e.stream,t)?rs.simulate(i,e.streamHandlers,t):(n.forEach(t=>i.addNewMessage(t)),e.completionsHandlers.onFinish())},400)}static requestStream(e,i){setTimeout(()=>{const s=t.getResponse(e);rs.simulate(e,i.streamHandlers,s,i)},400)}};as.URL="deep-chat-demo";let ls=as;class cs{static setup(t){t.permittedErrorPrefixes=["Connection error","Error in server message"],t.websocket="pending"}static isElementPresentInDOM(t){return t.getRootNode({composed:!0})instanceof Document}static createConnection(t,e){if(!cs.isElementPresentInDOM(t.deepChat))return;const i=t.connectSettings.websocket;if(i){if(t.connectSettings.handler)return hs.websocket(t,e);try{const s="boolean"!=typeof i?i:void 0,n=new WebSocket(t.connectSettings.url||"",s);t.websocket=n,t.websocket.onopen=()=>{var i,s;e.removeError(),t.websocket&&typeof t.websocket===Bt&&cs.assignListeners(t,n,e),null==(s=(i=t.deepChat)._validationHandler)||s.call(i)},t.websocket.onerror=i=>{console[C](i),cs.retryConnection(t,e)}}catch(i){console[C](i),cs.retryConnection(t,e)}}}static retryConnection(t,e){var i,s;null==(s=(i=t.deepChat)._validationHandler)||s.call(i),cs.isElementPresentInDOM(t.deepChat)&&(t.websocket="pending",e.isLastMessageError()||e.addNewErrorMessage(O,"Connection error"),setTimeout(()=>{cs.createConnection(t,e)},5e3))}static assignListeners(t,e,i){const s={};e.onmessage=async e=>{if(t.extractResultData)try{const n=JSON.parse(e.data),o=await ts.basicResponseProcessing(i,n,{io:t,displayError:!1});if(!o)throw Error(ut(n,"server",!!t.deepChat.responseInterceptor,o));if(rs.isSimulation(t.stream)){const e=cs.stream.bind(this,t,i,s),r=s[n.role||j];rs.upsertContent(i,e,r,o)}else{const t=Array.isArray(o)?o:[o],e=t.find(t=>"string"==typeof t[C]);if(e)throw e[C];t.forEach(t=>i.addNewMessage(t))}}catch(t){ts.displayError(i,t,"Error in server message")}},e.onclose=()=>{var e,s;console[C]("Connection closed"),i.isLastMessageError()||i.addNewErrorMessage(O,"Connection error"),t.stream&&(null==(s=(e=t.streamHandlers).onAbort)||s.call(e)),cs.createConnection(t,i)}}static async sendWebsocket(t,e,i,s=!0){var n,o;if((null==(n=t.connectSettings)?void 0:n.url)===ls.URL)return ls.request(t,i);const r=t.websocket;if(!r||"pending"===r)return;const a={body:e,headers:null==(o=t.connectSettings)?void 0:o.headers},{body:l,error:c}=await ts.processRequestInterceptor(t.deepChat,a);if(c)return i.addNewErrorMessage(O,c);if(!cs.isWebSocket(r))return r.newUserMessage.listener(l);const h=s?JSON.stringify(l):l;void 0===r.readyState||r.readyState!==r.OPEN?(console[C]("Connection is not open"),i.isLastMessageError()||i.addNewErrorMessage(O,"Connection error")):(r.send(JSON.stringify(h)),t.completionsHandlers.onFinish())}static canSendMessage(t){return!t||"pending"!==t&&(cs.isWebSocket(t)?void 0!==t.readyState&&t.readyState===t.OPEN:t.isOpen)}static isWebSocket(t){return void 0!==t.send}static stream(t,e,i,s){if(!s)return;const n=t.stream.simulation;if("string"==typeof n){const o=s.role||j,r=i[o];s[M]===n||s[A]===n?(null==r||r.finaliseStreamedMessage(),delete i[o]):(i[o]??(i[o]=new Yi(e,t.stream)),i[o].upsertStreamedMessage(s))}else rs.simulate(e,t.streamHandlers,s)}}class hs{static async request(t,e,i){var s,n;let o=!0;const r=hs.generateOptionalSignals();null==(n=(s=t.connectSettings).handler)||n.call(s,e,{...r,onResponse:async e=>{if(!o)return;o=!1;const s=await ts.basicResponseProcessing(i,e,{io:t,displayError:!1});if(s){const e=Array.isArray(s)?s:[s],n=e.find(t=>"string"==typeof t[C]);n?(console[C](n[C]),i.addNewErrorMessage(O,n[C]),t.completionsHandlers.onFinish()):rs.isSimulatable(t.stream,s)?rs.simulate(i,t.streamHandlers,s):(e.forEach(t=>i.addNewMessage(t)),t.completionsHandlers.onFinish())}else console[C](ut(e,"server",!!t.deepChat.responseInterceptor,s)),i.addNewErrorMessage(O,"Error in server message"),t.completionsHandlers.onFinish()}})}static attemptToFinaliseStream(t,e){try{const i=e.messageElementRefs[e.messageElementRefs.length-1];Ki.isLoadingMessage(i)?e.removeLastMessage():t.finaliseStreamedMessage()}catch(t){console[C](t),e.addNewErrorMessage(O,t)}}static stream(t,e,i){var s,n;let o=!0,r=!1;const a=new Yi(i,t.stream);t.streamHandlers.onAbort=()=>{hs.attemptToFinaliseStream(a,i),t.streamHandlers.onClose(),o=!1};const l=hs.generateOptionalSignals();null==(n=(s=t.connectSettings).handler)||n.call(s,e,{...l,onOpen:()=>{r||!o||(t.streamHandlers.onOpen(),r=!0)},onResponse:async e=>{if(!o)return;const s=await ts.basicResponseProcessing(i,e,{io:t,displayError:!1});if(s)s[C]?(hs.streamError(s[C],a,t,i),o=!1):rs.upsertContent(i,a.upsertStreamedMessage.bind(a),a,s);else{const n=ut(e,"server",!!t.deepChat.responseInterceptor,s);hs.streamError(n,a,t,i),o=!1}},onClose:()=>{o&&(hs.attemptToFinaliseStream(a,i),t.streamHandlers.onClose(),o=!1)},stopClicked:t.streamHandlers.stopClicked})}static streamError(t,e,i,s){console[C](t),e.finaliseStreamedMessage(),s.addNewErrorMessage(O,t),i.streamHandlers.onClose()}static websocket(t,e){var i,s;const n={isOpen:!1,newUserMessage:{listener:()=>{}},roleToStream:{}};t.websocket=n;const o=hs.generateOptionalSignals();null==(s=(i=t.connectSettings).handler)||s.call(i,void 0,{...o,onOpen:()=>{e.removeError(),n.isOpen=!0},onResponse:async i=>{const s=await ts.basicResponseProcessing(e,i,{io:t,displayError:!1});if(s){const i=Array.isArray(s)?s:[s],o=i.find(t=>"string"==typeof t[C]);if(o)console[C](o[C]),e.isLastMessageError()||e.addNewErrorMessage(O,o[C]);else if(rs.isSimulation(t.stream)){const i=s,o=cs.stream.bind(this,t,e,n.roleToStream),r=n.roleToStream[i.role||j];rs.upsertContent(e,o,r,i)}else i.forEach(t=>e.addNewMessage(t))}else console[C](ut(i,"server",!!t.deepChat.responseInterceptor,s)),e.addNewErrorMessage(O,"Error in server message")},onClose:()=>{n.isOpen=!1},newUserMessage:n.newUserMessage})}static generateOptionalSignals(){return{onClose:()=>{},onOpen:()=>{},stopClicked:{listener:()=>{}},newUserMessage:{listener:()=>{}}}}}class us{static async request(t,e,i,s=!0){var n,o,r;const a={body:e,headers:null==(n=t.connectSettings)?void 0:n.headers},{body:l,headers:c,error:h}=await ts.processRequestInterceptor(t.deepChat,a),{onFinish:u}=t.completionsHandlers;if(h)return ts.onInterceptorError(i,h,u);if(null!=(o=t.connectSettings)&&o.handler)return hs.request(t,l,i);if((null==(r=t.connectSettings)?void 0:r.url)===ls.URL)return ls.request(t,i);let d=!0;ts.fetch(t,c,s,l).then(t=>(d=!!t.ok,t)).then(t=>ts.processResponseByType(t)).then(async e=>{var s,n;if(!t.extractResultData)return;const o=await(null==(n=(s=t.deepChat).responseInterceptor)?void 0:n.call(s,e))||e,r=await t.extractResultData(o,l);if(!d)throw e;if(!r||typeof r!==Bt&&!Array.isArray(r))throw Error(ut(e,"response",!!t.deepChat.responseInterceptor,o));if(r[C])throw r[C];t.asyncCallInProgress?t.asyncCallInProgress=!1:rs.isSimulatable(t.stream,r)?rs.simulate(i,t.streamHandlers,r):((Array.isArray(r)?r:[r]).forEach(t=>i.addNewMessage(t)),u())}).catch(t=>{ts.displayError(i,t),u()})}static executePollRequest(t,e,i,s){const{onFinish:n}=t.completionsHandlers;fetch(e,i).then(t=>t.json()).then(async o=>{var r,a;if(!t.extractPollResultData)return;const l=await t.extractPollResultData(await(null==(a=(r=t.deepChat).responseInterceptor)?void 0:a.call(r,o))||o);l.timeoutMS?setTimeout(()=>{us.executePollRequest(t,e,i,s)},l.timeoutMS):rs.isSimulatable(t.stream,l)?rs.simulate(s,t.streamHandlers,l):(s.addNewMessage(l),n())}).catch(t=>{ts.displayError(s,t),n()})}static async poll(t,e,i,s=!0){var n,o,r;const a={body:e,headers:null==(n=t.connectSettings)?void 0:n.headers},{body:l,headers:c,error:h}=await ts.processRequestInterceptor(t.deepChat,a);if(h)return ts.onInterceptorError(i,h);const u=(null==(o=t.connectSettings)?void 0:o.url)||t.url||"",d={method:(null==(r=t.connectSettings)?void 0:r.method)||Lt,body:s?JSON.stringify(l):l,headers:c};t.connectSettings.credentials&&(d.credentials=t.connectSettings.credentials),us.executePollRequest(t,u,d,i)}static verifyKey(t,e,i,s,n,o,r,a,l){if(""===t)return o(mt);r(),fetch(e,{method:s,headers:i,body:l||null}).then(t=>ts.processResponseByType(t)).then(e=>{a(e,t,n,o)}).catch(t=>{o(vt),console[C](t)})}}class ds{static getCharacterLimitMessages(t,e){var i;if(-1===e)return t;let s=0,n=t.length-1;for(;n>=0;n-=1){const o=null==(i=t[n])?void 0:i[M];if(void 0!==o&&(s+=o.length,s>e)){t[n][M]=o.substring(0,o.length-(s-e));break}}return t.slice(Math.max(n,0))}static getMaxMessages(t,e){return t.slice(Math.max(t.length-e,0))}static processMessages(t,e,i){return void 0!==e?e>0&&(t=ds.getMaxMessages(t,e)):t=[t[t.length-1]],t=JSON.parse(JSON.stringify(t)),void 0===i?t:ds.getCharacterLimitMessages(t,i)}}const ps=class i{constructor(t,e,i){this._isLoading=!1,this._isPaginationComplete=!1,this._index=0,this._messages=e,i.fetchHistory&&this.fetchHistory(i.fetchHistory),t.loadHistory&&this.setupLoadHistoryOnScroll(t.loadHistory),this.setupInitialHistory(t)}async fetchHistory(t){const e=qi.addMessage(this._messages),s=await t();this._messages.removeMessage(e),i.displayIntroMessages(this._messages.messageElementRefs),s.forEach(t=>this._messages.addAnyMessage(t,!0)),setTimeout(()=>Dt.scrollToBottom(this._messages.elementRef),0)}processLoadedHistory(e){var i;const{messageElementRefs:s,messageToElements:n,elementRef:o}=this._messages,r=null==(i=s.find(e=>!e.outerContainer[t].contains(Ki.INTRO_CLASS)))?void 0:i.outerContainer,a=o.scrollTop;null==e||e.reverse().map(t=>{const e=this._messages.addAnyMessage({...t,sendUpdate:!0},!0,!0);if(e){const t=Xi.generateMessageBody(e,s,!0);n.unshift([e,t])}return e}).filter(t=>!!t).reverse().forEach(t=>this._messages.sendClientUpdate(t,!0)),r&&(o.scrollTop=a+r.offsetTop-40)}populateMessages(t,e){this._messages.removeMessage(t),this._isPaginationComplete=e.findIndex(t=>!t)<0;const i=e.filter(t=>!!t);this.processLoadedHistory(i);const{messageElementRefs:s,avatar:n,name:o}=this._messages;Xi.resetAllRoleElements(s,n,o)}async setupLoadHistoryOnScroll(t){this._messages.elementRef.onscroll=async()=>{if(!this._isLoading&&!this._isPaginationComplete&&0===this._messages.elementRef.scrollTop){this._isLoading=!0;const e=qi.addMessage(this._messages,!1);try{const i=await t(this._index++);this.populateMessages(e,i),this._isLoading=!1}catch(t){this._messages.removeMessage(e),this._isPaginationComplete=!0,this._messages.addNewErrorMessage(O,i.FAILED_ERROR_MESSAGE,!0),console[C](t)}}}}populateInitialHistory(t){t.forEach(t=>{Gt.processHistoryFile(t),this._messages.addAnyMessage(t,!0)})}async loadInitialHistory(t){this._isLoading=!0;const e=qi.addMessage(this._messages);try{const i=await t(this._index++),s=this._messages.elementRef.scrollTop;this.populateMessages(e,i),0===s&&setTimeout(()=>Dt.scrollToBottom(this._messages.elementRef),0)}catch(t){this._messages.removeMessage(e),this._isPaginationComplete=!0,this._messages.addNewErrorMessage(O,i.FAILED_ERROR_MESSAGE,!0),console[C](t)}i.displayIntroMessages(this._messages.messageElementRefs),this._isLoading=!1}async setupInitialHistory(t){var e;t.loadHistory&&this.loadInitialHistory(t.loadHistory);const i=t.history||Gt.processHistory(t)||(null==(e=this._messages.browserStorage)?void 0:e.get());i&&(this.populateInitialHistory(i),this._index+=1)}static addErrorPrefix(t){t.permittedErrorPrefixes??(t.permittedErrorPrefixes=[]),t.permittedErrorPrefixes.push(i.FAILED_ERROR_MESSAGE)}static displayIntroMessages(i){for(let s=0;s<i.length;s+=1){const s=i[0];if(!s.outerContainer[t].contains(Ki.INTRO_CLASS))break;s.outerContainer[e].display=""}}};ps.FAILED_ERROR_MESSAGE="Failed to load history";let ms=ps;class vs{static parseConfig(t,e,i,s){var n;const o={files:e};if("object"==typeof s){Gt.processFileConfigConnect(s);const{files:e,connect:r,button:a}=s;e&&(e.infoModal&&(o[z].infoModal=e.infoModal,null!=(n=e.infoModal)&&n.textMarkDown&&(o.infoModalTextMarkUp=i.render(e.infoModal.textMarkDown))),e.acceptedFormats&&(o[z].acceptedFormats=e.acceptedFormats),e.maxNumberOfFiles&&(o[z].maxNumberOfFiles=e.maxNumberOfFiles)),o.button=a,r&&(r.headers||r.method||r.url||r.credentials||t.headers||t.method||t.url||t.credentials)&&(o.connect={url:(null==r?void 0:r.url)||t.url,method:(null==r?void 0:r.method)||t.method,headers:(null==r?void 0:r.headers)||t.headers,credentials:(null==r?void 0:r.credentials)||t.credentials})}return o}static processMixedFiles(t,e,i){if(i){const s={acceptedFormats:""};t.fileTypes.mixedFiles=vs.parseConfig(t.connectSettings,s,e,i)}}static processMicrophone(t,e,i,s){var n,o,r,a,l,c;const h={acceptedFormats:"audio/*",...(null==(n=t.fileTypes[W])?void 0:n[z])||{}};i&&(void 0!==navigator.mediaDevices.getUserMedia?(t.recordAudio=vs.parseConfig(t.connectSettings,h,e,i),"object"==typeof i&&i[z]&&((o=t.recordAudio)[z]??(o[z]={}),t.recordAudio[z].format=null==(r=i[z])?void 0:r.format,t.recordAudio[z].maxDurationSeconds=null==(a=i[z])?void 0:a.maxDurationSeconds,null!=(l=t.fileTypes[W])&&l[z]&&((c=t.fileTypes[W][z]).maxNumberOfFiles??(c.maxNumberOfFiles=i[z].maxNumberOfFiles)))):s||(t.fileTypes[W]=vs.parseConfig(t.connectSettings,h,e,i)))}static processAudioConfig(t,e,i,s){if(!i&&!s)return;const n={acceptedFormats:"audio/*",...(null==s?void 0:s[z])||{}};t.fileTypes[W]=vs.parseConfig(t.connectSettings,n,e,i)}static processGifConfig(t,e,i,s){if(!i&&!s)return;const n={acceptedFormats:"image/gif",...(null==s?void 0:s[z])||{}};t.fileTypes[V]=vs.parseConfig(t.connectSettings,n,e,i)}static processCamera(t,e,i,s){var n,o,r,a;const l={acceptedFormats:"image/*",...(null==(n=t.fileTypes[U])?void 0:n[z])||{}};i&&(void 0!==navigator.mediaDevices.getUserMedia?(t[H]=vs.parseConfig(t.connectSettings,l,e,i),"object"==typeof i&&(t[H].modalContainerStyle=i.modalContainerStyle,i[z]&&((o=t[H])[z]??(o[z]={}),t[H][z].format=null==(r=i[z])?void 0:r.format,t[H][z].dimensions=null==(a=i[z])?void 0:a.dimensions))):s||(t.fileTypes[U]=vs.parseConfig(t.connectSettings,l,e,i)))}static processImagesConfig(t,e,i,s){if(!i&&!s)return;const n={acceptedFormats:"image/*",...(null==s?void 0:s[z])||{}};t.fileTypes[U]=vs.parseConfig(t.connectSettings,n,e,i)}static populateDefaultFileIO(t,e){var i,s;t&&(t[z]??(t[z]={}),(i=t[z]).acceptedFormats??(i.acceptedFormats=e),(s=t[z]).maxNumberOfFiles??(s.maxNumberOfFiles=1))}static set(t,e,i){vs.populateDefaultFileIO(null==i?void 0:i[W],".4a,.mp3,.webm,.mp4,.mpga,.wav,.mpeg,.m4a"),vs.populateDefaultFileIO(null==i?void 0:i[U],".png,.jpg");const s=$i.createNew(t.remarkable);vs.processImagesConfig(e,s,t[U],null==i?void 0:i[U]),vs.processCamera(e,s,t[H],t[U]),vs.processGifConfig(e,s,t[V],null==i?void 0:i[V]),vs.processAudioConfig(e,s,t[W],null==i?void 0:i[W]),vs.processMicrophone(e,s,t[G],t[W]),vs.processMixedFiles(e,s,t[Z])}}class fs{constructor(t,e,i){var s,n,o,r,a;this.rawBody={},this.validateKeyProperty=!1,this.canSendMessage=fs.canSendMessage,this.connectSettings={},this.fileTypes={},this.completionsHandlers={},this.streamHandlers={},this.deepChat=t,this.demo=i,Object.assign(this.rawBody,null==(s=t.connect)?void 0:s.additionalBodyProps),this.totalMessagesMaxCharLength=null==(n=null==t?void 0:t.requestBodyLimits)?void 0:n.totalMessagesMaxCharLength,this.maxMessages=null==(o=null==t?void 0:t.requestBodyLimits)?void 0:o.maxMessages,vs.set(t,this,e),t.connect&&(this.connectSettings=t.connect),this.demo&&((r=this.connectSettings).url??(r.url=ls.URL)),this.connectSettings.websocket&&cs.setup(this),this.stream=(null==(a=this.deepChat.connect)?void 0:a.stream)||Gt.checkForStream(this.deepChat),t.loadHistory&&ms.addErrorPrefix(this)}static canSendMessage(t,e,i){return!!i||(!(!t||""===t.trim())||!!(e&&e.length>0))}verifyKey(t,e){}static createCustomFormDataBody(t,e,i){const s=new FormData;i.forEach(t=>s.append("files",t)),Object.keys(t).forEach(e=>s.append(e,String(t[e])));let n=0;e.slice(0,e.length-1).forEach(t=>{s.append(`message${n+=1}`,JSON.stringify(t))});const o=e[e.length-1];return o[M]&&(delete o[z],s.append(`message${n+=1}`,JSON.stringify(o))),s}getServiceIOByType(t){if(t.type.startsWith(W)&&this.fileTypes[W])return this.fileTypes[W];if(t.type.startsWith(D)){if(this.fileTypes[V]&&t.type.endsWith("/gif"))return this.fileTypes[V];if(this.fileTypes[U])return this.fileTypes[U];if(this[H])return this[H]}return this.fileTypes[Z]}async request(t,e,i=!0){return this.stream&&!rs.isSimulation(this.stream)?rs.request(this,t,e,i):us.request(this,t,e,i)}async callAPIWithText(t,e){var i,s,n,o;const r={messages:e,...this.rawBody};let a=!1;null!=(i=this.connectSettings.headers)&&i[It]||((s=this.connectSettings).headers??(s.headers={}),(n=this.connectSettings.headers)[It]??(n[It]=$t),a=!0),await this.request(r,t),a&&(null==(o=this.connectSettings.headers)||delete o[It])}async callApiWithFiles(t,e,i){const s=fs.createCustomFormDataBody(this.rawBody,e,i),n=this.connectSettings,o=this.getServiceIOByType(i[0]);this.connectSettings=(null==o?void 0:o.connect)||this.connectSettings,await this.request(s,t,!1),this.connectSettings=n}async callServiceAPI(t,e,i){i?this.callApiWithFiles(t,e,i):this.callAPIWithText(t,e)}async callAPI(t,e){var i;if(!this.connectSettings)throw new Error(ft);const s=ds.processMessages(e.messageToElements.map(([t])=>t),this.maxMessages,this.totalMessagesMaxCharLength);if(!this.connectSettings.websocket||this.connectSettings.handler&&this.connectSettings.url===ls.URL)this.callServiceAPI(e,s,t[z]);else{const n={messages:s,...this.rawBody};t[z]&&null!=(i=this.getServiceIOByType(t[z][0]))&&i.connect?this.callApiWithFiles(e,s,t[z]):cs.sendWebsocket(this,n,e,!1)}}async extractResultData(t){return t.result?Gt.handleResponseProperty(t):ts.validateResponseFormat(t,!!this.stream)?t:void 0}isDirectConnection(){return!1}isWebModel(){return!1}isCustomView(){return!1}}class gs extends fs{constructor(t,e,i,s,n){var o;super(t,n),this.insertKeyPlaceholderText="API Key",this.keyHelpUrl="",this.asyncCallInProgress=!1,this.systemMessage="",Object.assign(this.rawBody,null==(o=t.connect)?void 0:o.additionalBodyProps),this._keyVerificationDetails=e,this._buildHeadersFunc=i,s&&this.setApiKeyProperties(s),this.connectSettings=this.buildConnectSettings(this.key||"",t.connect)}setApiKeyProperties(t){this.key=t.key,t.validateKeyProperty&&(this.validateKeyProperty=t.validateKeyProperty)}buildConnectSettings(t,e){const i=e??{};return i.headers??(i.headers={}),Object.assign(i.headers,this._buildHeadersFunc(t)),i}completeConfig(t,e){t.system_prompt&&(this.systemMessage=t.system_prompt),e&&(this.functionHandler=e),delete t.system_prompt,delete t.key,delete t.function_handler,Object.assign(this.rawBody,t)}keyAuthenticated(t,e){this.connectSettings=this.buildConnectSettings(e,this.connectSettings),this.key=e,t()}verifyKey(t,e){const{url:i,method:s,handleVerificationResult:n,createHeaders:o,body:r,augmentUrl:a}=this._keyVerificationDetails,l=(null==o?void 0:o(t))||this._buildHeadersFunc(t),c=(null==a?void 0:a(t))||i;us.verifyKey(t,c,l,s,this.keyAuthenticated.bind(this,e.onSuccess),e.onFail,e.onLoad,n,r)}isDirectConnection(){return!0}static getRoleViaUser(t){return t===E?E:N}static getRoleViaAI(t){return t===j?N:E}processMessages(t){return ds.getCharacterLimitMessages(t,this.totalMessagesMaxCharLength?this.totalMessagesMaxCharLength-this.systemMessage.length:-1)}addSystemMessage(t){this.systemMessage&&t.unshift({role:"system",content:this.systemMessage})}async callDirectServiceServiceAPI(t,e,i,s,n){if(!this.connectSettings)throw new Error(ft);const o=i(this.rawBody,e),r=!!s&&this.stream;if((!r||typeof r===Bt&&r.simulation)&&!o.stream)return await us.request(this,o,t,n);o.stream=!0,null!=s&&s.readable&&(this.stream={readable:!0}),rs.request(this,o,t)}async callToolFunction(t,e){var i,s;this.asyncCallInProgress=!0;const n=await t(e);if(!Array.isArray(n)){if(n[M]){const t={[M]:n[M]},e=await(null==(s=(i=this.deepChat).responseInterceptor)?void 0:s.call(i,t))||t;if(Array.isArray(e))throw Error("Function tool response interceptor cannot return an array");return{processedResponse:e}}throw Error(St)}return{responses:await Promise.all(n)}}makeAnotherRequest(t,e){try{return e&&(this.stream?rs.request(this,t,e):us.request(this,t,e)),{[M]:""}}catch(t){throw this.asyncCallInProgress=!1,t}}genereteAPIKeyName(t){return`${t} API Key`}static getImageContent(t){return t.filter(t=>t.type===D).map(t=>({[L]:"image_url",image_url:{url:t.src||""}})).filter(t=>t.image_url.url.length>0)}static getTextWImagesContent(t){if(t[z]&&t[z].length>0){const e=this.getImageContent(t[z]);return t[M]&&t[M].trim().length>0&&e.unshift({[L]:M,[M]:t[M]}),e.length>0?e:t[M]||""}return t[M]||""}static getTextWFilesContent(t,e){if(t[z]&&t[z].length>0){const i=e(t[z]);return t[M]&&t[M].trim().length>0&&i.unshift({[L]:M,[M]:t[M]}),i}return t[M]||""}async extractStreamResultWToolsGeneric(t,e,i,s,n){const{delta:o,finish_reason:r}=e;if("tool_calls"===r){const e={tool_calls:t._streamToolCalls};return t._streamToolCalls=void 0,this.handleToolsGeneric(e,i,t.messages,s,n)}return null!=o&&o.tool_calls&&(t._streamToolCalls?o.tool_calls.forEach((e,i)=>{t._streamToolCalls&&(t._streamToolCalls[i].function.arguments+=e.function.arguments)}):t._streamToolCalls=o.tool_calls),{[M]:(null==o?void 0:o.content)||""}}async handleToolsGeneric(t,e,i,s,n){if(!t.tool_calls||!s||!e)throw Error(kt);const o=JSON.parse(JSON.stringify(s)),r=t.tool_calls.map(t=>({name:t.function.name,arguments:t.function.arguments})),{responses:a,processedResponse:l}=await this.callToolFunction(e,r);if(l)return l;if(n&&(o.messages=o.messages.slice(o.messages.length-1),n.message&&o.messages.unshift({role:"system",content:n.message})),o.messages.push({tool_calls:t.tool_calls,role:N,content:null}),!a.find(({response:t})=>"string"!=typeof t)&&r.length===a.length)return a.forEach((e,i)=>{var s;const n=null==(s=t.tool_calls)?void 0:s[i];null==o||o.messages.push({role:"tool",tool_call_id:null==n?void 0:n.id,name:null==n?void 0:n.function.name,content:e.response})}),this.makeAnotherRequest(o,i);throw Error(St)}}class bs{static waitForPropertiesToBeUpdatedBeforeRender(t){t._propUpdated_=!1,setTimeout(()=>{t._propUpdated_?bs.waitForPropertiesToBeUpdatedBeforeRender(t):(t._waitingToRender_=!1,t.onRender())})}static attemptRender(t){t._propUpdated_=!0,t._waitingToRender_||(t._waitingToRender_=!0,bs.waitForPropertiesToBeUpdatedBeforeRender(t))}}const ys=class t extends HTMLElement{constructor(){super(),this._waitingToRender_=!1,this._propUpdated_=!1,Object.keys(t._attributeToProperty_).forEach(e=>{const i=t._attributeToProperty_[e];this.constructPropertyAccessors(i),this.hasOwnProperty(e)||this.constructPropertyAccessors(i,e)})}static get observedAttributes(){return Object.keys(t._attributes_)||[]}constructPropertyAccessors(t,e){let i;Object.defineProperty(this,e||t,{get:function(){return i},set:function(s){i=s,e?this[t]=s:bs.attemptRender(this)}})}attributeChangedCallback(e,i,s){if(i===s)return;const n=t._attributes_[e](s);this[t._attributeToProperty_[e]]=n}onRender(){}};ys._attributes_={},ys._attributeToProperty_={};let ws=ys;class xs{static createSVGElement(t){return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement}}const ks=class s{static changeVisibility(t,i,n,o){o.target.id===s.VISIBLE_ICON_ID?(i[e].display="none",n[e].display="block",t.type="password"):(i[e].display="block",n[e].display="none",t.type=M)}static createIconElement(e,i){const s=xs.createSVGElement(e);return s.id=i,s[t].add("visibility-icon"),s}static create(t){const n=i();n.id="visibility-icon-container";const o=s.createIconElement('<?xml version="1.0" standalone="no"?>\n<svg version="1.1"\n\txmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n\txmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="0.9em" height="0.9em"\n\tviewBox="0 0 1200 1200" enable-background="new 0 0 1200 1200">\n\t\t<path id="path6686" inkscape:connector-curvature="0" d="M779.843,599.925c0,95.331-80.664,172.612-180.169,172.612\n\t\t\tc-99.504,0-180.168-77.281-180.168-172.612c0-95.332,80.664-172.612,180.168-172.612\n\t\t\tC699.179,427.312,779.843,504.594,779.843,599.925z M600,240.521c-103.025,0.457-209.814,25.538-310.904,73.557\n\t\t\tc-75.058,37.122-148.206,89.496-211.702,154.141C46.208,501.218,6.431,549,0,599.981c0.76,44.161,48.13,98.669,77.394,131.763\n\t\t\tc59.543,62.106,130.786,113.018,211.702,154.179c94.271,45.751,198.616,72.092,310.904,73.557\n\t\t\tc103.123-0.464,209.888-25.834,310.866-73.557c75.058-37.122,148.243-89.534,211.74-154.179\n\t\t\tc31.185-32.999,70.962-80.782,77.394-131.763c-0.76-44.161-48.13-98.671-77.394-131.764\n\t\t\tc-59.543-62.106-130.824-112.979-211.74-154.141C816.644,268.36,712.042,242.2,600,240.521z M599.924,329.769\n\t\t\tc156.119,0,282.675,120.994,282.675,270.251c0,149.256-126.556,270.25-282.675,270.25S317.249,749.275,317.249,600.02\n\t\t\tC317.249,450.763,443.805,329.769,599.924,329.769L599.924,329.769z"/>\n</svg>\n',s.VISIBLE_ICON_ID);o[e].display="none",n.appendChild(o);const r=s.createIconElement('<?xml version="1.0" standalone="no"?>\n<svg version="1.1"\n\txmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n\txmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="0.9em" height="0.9em"\n\tviewBox="0 0 1200 1200" enable-background="new 0 0 1200 1200">\n\t\t<path d="\n\t\t\tM669.727,273.516c-22.891-2.476-46.15-3.895-69.727-4.248c-103.025,0.457-209.823,25.517-310.913,73.536\n\t\t\tc-75.058,37.122-148.173,89.529-211.67,154.174C46.232,529.978,6.431,577.76,0,628.74c0.76,44.162,48.153,98.67,77.417,131.764\n\t\t\tc59.543,62.106,130.754,113.013,211.67,154.174c2.75,1.335,5.51,2.654,8.276,3.955l-75.072,131.102l102.005,60.286l551.416-960.033\n\t\t\tl-98.186-60.008L669.727,273.516z M902.563,338.995l-74.927,129.857c34.47,44.782,54.932,100.006,54.932,159.888\n\t\t\tc0,149.257-126.522,270.264-282.642,270.264c-6.749,0-13.29-0.728-19.922-1.172l-49.585,85.84c22.868,2.449,45.99,4.233,69.58,4.541\n\t\t\tc103.123-0.463,209.861-25.812,310.84-73.535c75.058-37.122,148.246-89.529,211.743-154.174\n\t\t\tc31.186-32.999,70.985-80.782,77.417-131.764c-0.76-44.161-48.153-98.669-77.417-131.763\n\t\t\tc-59.543-62.106-130.827-113.013-211.743-154.175C908.108,341.478,905.312,340.287,902.563,338.995L902.563,338.995z\n\t\t\tM599.927,358.478c6.846,0,13.638,0.274,20.361,0.732l-58.081,100.561c-81.514,16.526-142.676,85.88-142.676,168.897\n\t\t\tc0,20.854,3.841,40.819,10.913,59.325c0.008,0.021-0.008,0.053,0,0.074l-58.228,100.854\n\t\t\tc-34.551-44.823-54.932-100.229-54.932-160.182C317.285,479.484,443.808,358.477,599.927,358.478L599.927,358.478z M768.896,570.513\n\t\t\tL638.013,797.271c81.076-16.837,141.797-85.875,141.797-168.603C779.81,608.194,775.724,588.729,768.896,570.513L768.896,570.513z"\n\t\t\t/>\n</svg>\n',"not-visible-icon");return n.appendChild(r),n.onclick=s.changeVisibility.bind(this,t,o,r),n}};ks.VISIBLE_ICON_ID="visible-icon";let Ss=ks;class _s{static createCautionText(){const e=i("a");return e[t].add("insert-key-input-help-text"),e.innerText="Please exercise CAUTION when inserting your API key outside of deepchat.dev or localhost!!",e}static createHelpLink(e){const s=i("a");return s[t].add("insert-key-input-help-text"),s.href=e,s.innerText="Find more info here",s.target="_blank",s}static createFailText(){const t=i();return t.id="insert-key-input-invalid-text",t[e].display="none",t}static createHelpTextContainer(t,e=!0){const s=i();s.id="insert-key-help-text-container";const n=i();n.id="insert-key-help-text-contents";const o=_s.createFailText();if(n.appendChild(o),t){const e=_s.createHelpLink(t);n.appendChild(e)}if(!0===e){const t=_s.createCautionText();n.appendChild(t)}return s.appendChild(n),{helpTextContainerElement:s,failTextElement:o}}static onFail(i,s,n,o){i[t].replace("insert-key-input-valid","insert-key-input-invalid"),n.innerText=o,n[e].display="block",s.innerText="Start",i[t].remove("loading")}static onLoad(e,i){e[t].add("loading"),i.innerHTML='<div id="loading-key"></div>'}static verifyKey(t,e,i){const s=t.value.trim();i.verifyKey(s,e)}static addVerificationEvents(e,i,s,n,o){const r={onSuccess:n,onFail:_s.onFail.bind(this,e,i,s),onLoad:_s.onLoad.bind(this,e,i)},a=_s.verifyKey.bind(this,e,r,o);i.onclick=a,e.onkeydown=i=>{!e[t].contains("loading")&&i.key===it.ENTER&&a()}}static createStartButton(){const t=i();return t.id="start-button",t.innerText="Start",t}static onInputFocus(e){e.target[t].replace("insert-key-input-invalid","insert-key-input-valid")}static createInput(e){const s=i();s.id="insert-key-input-container";const n=i("input");return n.id="insert-key-input",n.placeholder=e||"API Key",n.type="password",n[t].add("insert-key-input-valid"),n.onfocus=_s.onInputFocus,s.appendChild(n),s}static createContents(t,e){var s;const n=i();n.id="insert-key-contents";const o=_s.createInput(e.insertKeyPlaceholderText),r=o.children[0],a=Ss.create(r);o.appendChild(a),n.appendChild(o);const l=_s.createStartButton(),{helpTextContainerElement:c,failTextElement:h}=_s.createHelpTextContainer(e.keyHelpUrl,null==(s=e.deepChat._insertKeyViewStyles)?void 0:s.displayCautionText);return n.appendChild(l),n.appendChild(c),_s.addVerificationEvents(r,l,h,t,e),n}static createElements(t,e){const s=i();s.id="insert-key-view";const n=_s.createContents(t,e);return s.appendChild(n),s}static render(t,e,i){const s=_s.createElements(e,i);t.replaceChildren(s)}}const Os=class t{static enableButtons(e,i,s=0){window.webLLM?(e&&(e.disabled=!1),i&&(i.disabled=!1)):s<4*Ts.MODULE_SEARCH_LIMIT_S&&setTimeout(()=>t.enableButtons(e,i,s+1),250)}static setUpInitial(e,i,s,n){const o=(null==i?void 0:i.downloadClass)||t.DOWNLOAD_BUTTON_CLASS,r=(null==i?void 0:i.uploadClass)||t.UPLOAD_BUTTON_CLASS,a=(null==i?void 0:i.fileInputClass)||t.FILE_INPUT_CLASS;return setTimeout(()=>{const i=null==s?void 0:s.getElementsByClassName(o)[0],n=null==s?void 0:s.getElementsByClassName(a)[0],l=null==s?void 0:s.getElementsByClassName(r)[0];i&&(i.onclick=()=>e()),n&&(n.onchange=()=>{n[z]&&n[z].length>0&&e(n[z])}),l&&(l.onclick=()=>n[y]()),(i||l)&&t.enableButtons(i,l)}),(null==i?void 0:i.initialHtml)||`<div>\n        Download or upload a web model that will run entirely on your browser: <br/> \n        <button disabled class="${o} deep-chat-button deep-chat-web-model-button">Download</button>\n        ${n?"":`<input type="file" class="${a}" hidden multiple />\n          <button disabled class="${r} deep-chat-button deep-chat-web-model-button">Upload</button>`}\n      </div>`}static exportFile(t){const e=i("a");for(let i=0;i<t.length/4;i+=1)setTimeout(()=>{const s=4*i;for(let i=s;i<Math.min(s+4,t.length);i+=1){const s=URL.createObjectURL(t[i]);e.href=s,e.download=t[i].name,document.body.appendChild(e),e[y](),URL.revokeObjectURL(s)}},500*i)}static setUpAfterLoad(e,i,s,n){const o=(null==i?void 0:i.exportFilesClass)||t.EXPORT_BUTTON_CLASS;return setTimeout(()=>{const i=null==s?void 0:s.getElementsByClassName(o)[0];i&&(i.onclick=()=>t.exportFile(e))}),(null==i?void 0:i.afterLoadHtml)||`<div>\n        Model loaded successfully and has been cached for future requests.\n        ${n?"":`<br/> <button style="margin-top: 5px" class="${o} deep-chat-button">Export</button>`}\n      </div>`}};Os.DOWNLOAD_BUTTON_CLASS="deep-chat-download-button",Os.UPLOAD_BUTTON_CLASS="deep-chat-upload-button",Os.FILE_INPUT_CLASS="deep-chat-file-input",Os.EXPORT_BUTTON_CLASS="deep-chat-export-button";let Ms=Os;const As={model_list:[{model_url:"https://huggingface.co/mlc-ai/Llama-2-7b-chat-hf-q4f32_1-MLC/resolve/main/",local_id:"Llama-2-7b-chat-hf-q4f32_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Llama-2-7b-chat-hf/Llama-2-7b-chat-hf-q4f32_1-ctx4k_cs1k-webgpu.wasm",vram_required_MB:9109.03,low_resource_required:!1},{model_url:"https://huggingface.co/mlc-ai/Llama-2-7b-chat-hf-q4f16_1-MLC/resolve/main/",local_id:"Llama-2-7b-chat-hf-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Llama-2-7b-chat-hf/Llama-2-7b-chat-hf-q4f16_1-ctx4k_cs1k-webgpu.wasm",vram_required_MB:6749.02,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/Llama-2-7b-chat-hf-q4f16_1-MLC/resolve/main/",local_id:"Llama-2-7b-chat-hf-q4f16_1-1k",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Llama-2-7b-chat-hf/Llama-2-7b-chat-hf-q4f16_1-ctx1k-webgpu.wasm",vram_required_MB:4618.52,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/Llama-2-13b-chat-hf-q4f16_1-MLC/resolve/main/",local_id:"Llama-2-13b-chat-hf-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Llama-2-13b-chat-hf/Llama-2-13b-chat-hf-q4f16_1-ctx4k_cs1k-webgpu.wasm",vram_required_MB:11814.09,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/Llama-2-70b-chat-hf-q4f16_1-MLC/resolve/main/",local_id:"Llama-2-70b-chat-hf-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Llama-2-70b-chat-hf/Llama-2-70b-chat-hf-q4f16_1-ctx4k_cs1k-webgpu.wasm",vram_required_MB:43729.05,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/RedPajama-INCITE-Chat-3B-v1-q4f16_1-MLC/resolve/main/",local_id:"RedPajama-INCITE-Chat-3B-v1-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/RedPajama-INCITE-Chat-3B-v1/RedPajama-INCITE-Chat-3B-v1-q4f16_1-ctx2k-webgpu.wasm",vram_required_MB:2972.09,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/RedPajama-INCITE-Chat-3B-v1-q4f32_1-MLC/resolve/main/",local_id:"RedPajama-INCITE-Chat-3B-v1-q4f32_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/RedPajama-INCITE-Chat-3B-v1/RedPajama-INCITE-Chat-3B-v1-q4f32_1-ctx2k-webgpu.wasm",vram_required_MB:3928.09,low_resource_required:!1},{model_url:"https://huggingface.co/mlc-ai/RedPajama-INCITE-Chat-3B-v1-q4f16_1-MLC/resolve/main/",local_id:"RedPajama-INCITE-Chat-3B-v1-q4f16_1-1k",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/RedPajama-INCITE-Chat-3B-v1/RedPajama-INCITE-Chat-3B-v1-q4f16_1-ctx1k-webgpu.wasm",vram_required_MB:2041.09,low_resource_required:!0,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/RedPajama-INCITE-Chat-3B-v1-q4f32_1-MLC/resolve/main/",local_id:"RedPajama-INCITE-Chat-3B-v1-q4f32_1-1k",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/RedPajama-INCITE-Chat-3B-v1/RedPajama-INCITE-Chat-3B-v1-q4f32_1-ctx1k-webgpu.wasm",vram_required_MB:2558.09,low_resource_required:!0},{model_url:"https://huggingface.co/mlc-ai/WizardMath-7B-V1.1-q4f16_1-MLC/resolve/main/",local_id:"WizardMath-7B-V1.1-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Mistral-7B-Instruct-v0.2/Mistral-7B-Instruct-v0.2-q4f16_1-sw4k_cs1k-webgpu.wasm",vram_required_MB:6079.02,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/Mistral-7B-Instruct-v0.2-q4f16_1-MLC/resolve/main/",local_id:"Mistral-7B-Instruct-v0.2-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Mistral-7B-Instruct-v0.2/Mistral-7B-Instruct-v0.2-q4f16_1-sw4k_cs1k-webgpu.wasm",vram_required_MB:6079.02,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/OpenHermes-2.5-Mistral-7B-q4f16_1-MLC/resolve/main/",local_id:"OpenHermes-2.5-Mistral-7B-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Mistral-7B-Instruct-v0.2/Mistral-7B-Instruct-v0.2-q4f16_1-sw4k_cs1k-webgpu.wasm",vram_required_MB:6079.02,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/NeuralHermes-2.5-Mistral-7B-q4f16_1-MLC/resolve/main/",local_id:"NeuralHermes-2.5-Mistral-7B-q4f16_1",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/Mistral-7B-Instruct-v0.2/Mistral-7B-Instruct-v0.2-q4f16_1-sw4k_cs1k-webgpu.wasm",vram_required_MB:6079.02,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/TinyLlama-1.1B-Chat-v0.4-q0f16-MLC/resolve/main/",local_id:"TinyLlama-1.1B-Chat-v0.4-q0f16",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/TinyLlama-1.1B-Chat-v0.4/TinyLlama-1.1B-Chat-v0.4-q0f16-ctx2k-webgpu.wasm",vram_required_MB:5063.52,low_resource_required:!1,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/TinyLlama-1.1B-Chat-v0.4-q0f32-MLC/resolve/main/",local_id:"TinyLlama-1.1B-Chat-v0.4-q0f32",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/TinyLlama-1.1B-Chat-v0.4/TinyLlama-1.1B-Chat-v0.4-q0f32-ctx2k-webgpu.wasm",vram_required_MB:5394.53,low_resource_required:!1},{model_url:"https://huggingface.co/mlc-ai/TinyLlama-1.1B-Chat-v0.4-q4f16_1-MLC/resolve/main/",local_id:"TinyLlama-1.1B-Chat-v0.4-q4f16_1-1k",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/TinyLlama-1.1B-Chat-v0.4/TinyLlama-1.1B-Chat-v0.4-q4f16_1-ctx1k-webgpu.wasm",vram_required_MB:899.11,low_resource_required:!0,required_features:["shader-f16"]},{model_url:"https://huggingface.co/mlc-ai/TinyLlama-1.1B-Chat-v0.4-q4f32_1-MLC/resolve/main/",local_id:"TinyLlama-1.1B-Chat-v0.4-q4f32_1-1k",model_lib_url:"https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/TinyLlama-1.1B-Chat-v0.4/TinyLlama-1.1B-Chat-v0.4-q4f32_1-ctx1k-webgpu.wasm",vram_required_MB:992.11,low_resource_required:!0}],use_web_worker:!0},Cs=class t extends fs{constructor(e){var i,s;super(e),this._isModelLoaded=!1,this._isModelLoading=!1,this._loadOnFirstMessage=!1,this._webModel={},this.permittedErrorPrefixes=[t.MULTIPLE_MODELS_ERROR,t.WEB_LLM_NOT_FOUND_ERROR,t.GENERIC_ERROR],this._conversationHistory=[],"object"==typeof e.webModel&&(this._webModel=e.webModel),null!=(i=this._webModel.load)&&i.clearCache&&t.clearAllCache(),this.findModelInWindow(e),this.canSendMessage=this.canSubmit.bind(this),this._chatEl=null==(s=e.shadowRoot)?void 0:s.children[0],e.history&&t.setUpHistory(this._conversationHistory,e.history)}setUpMessages(t){this._messages=t,this._removeIntro=()=>{t.removeIntroductoryMessage(),this._removeIntro=void 0}}static setUpHistory(t,e){e.forEach((i,s)=>{if(i.role===E&&i[M]){const n=e[s+1];null!=n&&n[M]&&n.role!==E&&t.push([i[M],n[M]])}})}findModelInWindow(e,i=0){var s;window.webLLM?this.configureInit(this.shouldAddIntroMessage(e.introMessage)):i>t.MODULE_SEARCH_LIMIT_S?(null==(s=this._messages)||s.addNewErrorMessage(O,t.WEB_LLM_NOT_FOUND_ERROR),console[C]("The deep-chat-web-llm module has not been attached to the window object. Please see the following guide:"),console[C]("https://deepchat.dev/examples/externalModules")):setTimeout(()=>this.findModelInWindow(e,i+1),1e3)}shouldAddIntroMessage(t){var e;return!t&&this._webModel&&!1!==(null==(e=this._webModel.introMessage)?void 0:e.displayed)}scrollToTop(t){var e;!1!==(null==(e=this._webModel.introMessage)?void 0:e.autoScroll)&&setTimeout(()=>{var t,e;null!=(t=this._messages)&&t.elementRef&&Dt.scrollToTop(null==(e=this._messages)?void 0:e.elementRef)},t)}getIntroMessage(t){if(!this.shouldAddIntroMessage(t)||!this._chatEl)return;const e=Ms.setUpInitial(this.init.bind(this),this._webModel.introMessage,this._chatEl,!!this._webModel.worker);return this.scrollToTop(1),{role:j,html:e,sendUpdate:!1}}async configureInit(t){const{load:e}=this._webModel;if(e){if(e.onInit)return void this.init();if(e.onMessage)return void(this._loadOnFirstMessage=!0)}t||this.init()}async init(t){var e;null==(e=this._messages)||e.removeError();const i=this.attemptToCreateChat();i&&await this.loadModel(i,t)}attemptToCreateChat(){var e;if(t.chat)return null==(e=this._messages)||e.addNewErrorMessage(O,t.MULTIPLE_MODELS_ERROR),void console[C](t.MULTIPLE_MODELS_ERROR);if(this._isModelLoaded||this._isModelLoading)return;const{worker:i}=this._webModel;return As.use_web_worker&&i?new window.webLLM.ChatWorkerClient(i):new window.webLLM.ChatModule}getConfig(){var e;let i=t.DEFAULT_MODEL;this._webModel.model&&(i=this._webModel.model);const s=JSON.parse(JSON.stringify(As));if(this._webModel.urls){const t=s.model_list.find(t=>t.local_id=i);t&&(this._webModel.urls.model&&(t.model_url=this._webModel.urls.model),this._webModel.urls.wasm&&(t.model_lib_url=this._webModel.urls.wasm))}return null!=(e=this._webModel.load)&&e.skipCache&&(s.use_cache=!1),{model:i,appConfig:s}}async loadModel(e,i){var s,n,o,r,a,l,c;this.scrollToTop(),t.chat=e,this._isModelLoading=!0;let h=!1===(null==(s=this._webModel.introMessage)?void 0:s.displayed);let u;t.chat.setInitProgressCallback(t=>{var e;null==(e=this._messages)||e.addNewMessage({html:`<div>${t[M]}</div>`,overwrite:!0,sendUpdate:!1}),h&&(setTimeout(()=>{var t;return Dt.scrollToBottom(null==(t=this._messages)?void 0:t.elementRef)}),h=!1)});try{const{model:e,appConfig:s}=this.getConfig(),n={};this._webModel.instruction&&(n.conv_config={system:this._webModel.instruction}),this._conversationHistory.length>0&&(n.conversation_history=this._conversationHistory),u=await t.chat.reload(e,n,s,i)}catch(t){return this.unloadChat(t)}if(null==(o=(n=this.deepChat)._validationHandler)||o.call(n),null!=(r=this._webModel.introMessage)&&r.removeAfterLoad)!1===this._webModel.introMessage.displayed?null==(l=this._messages)||l.removeLastMessage():null==(c=this._removeIntro)||c.call(this);else{const t=Ms.setUpAfterLoad(u,this._webModel.introMessage,this._chatEl,!!this._webModel.worker);null==(a=this._messages)||a.addNewMessage({html:t,overwrite:!0,sendUpdate:!1})}this._isModelLoaded=!0,this._isModelLoading=!1}async unloadChat(e){var i;null==(i=this._messages)||i.addNewErrorMessage(O,t.GENERIC_ERROR),console[C](e),this._isModelLoaded=!1,this._isModelLoading=!1,t.chat&&(await t.chat.unload(),t.chat=void 0)}async immediateResp(e,i,s){const n={[M]:await s.generate(i,void 0,0)},o=await t.processResponse(this.deepChat,e,n);o&&o.forEach(t=>e.addNewMessage(t)),this.completionsHandlers.onFinish()}async streamResp(e,i,s){this.streamHandlers.onAbort=()=>{s.interruptGenerate()},this.streamHandlers.onOpen();const n=new Yi(e);await s.generate(i,async(i,s)=>{const o=await t.processResponse(this.deepChat,e,{[M]:s});o&&n.upsertStreamedMessage({[M]:o[0][M],overwrite:!0})}),n.finaliseStreamedMessage(),this.streamHandlers.onClose()}async generateRespByType(t,e,i,s){var n;try{i?await this.streamResp(t,e,s):await this.immediateResp(t,e,s)}catch(t){null==(n=this._messages)||n.addNewErrorMessage(O),console.log(t)}}async generateResp(t,e,i){const s=e[e.length-1][M],{body:n,error:o}=await ts.processRequestInterceptor(this.deepChat,{body:{[M]:s}}),r=!!this.stream;try{if(o)ts.displayError(t,new Error(o)),(r?this.streamHandlers.onClose:this.completionsHandlers.onFinish)();else if(n&&n[M])this.generateRespByType(t,n[M],!!this.stream,i);else{const e=dt({body:n},!1);console[C](e);const i=r?this.streamHandlers.onClose:this.completionsHandlers.onFinish;ts.onInterceptorError(t,e,i)}}catch(t){this.unloadChat(t)}}async callServiceAPI(e,i){var s,n;if(!this._isModelLoaded){if(!this._loadOnFirstMessage)return;await this.init()}!t.chat||this._isModelLoading||(null!=(s=this._webModel.introMessage)&&s.removeAfterMessage&&(null==(n=this._removeIntro)||n.call(this)),e.addLoadingMessage(),this.generateResp(e,i,t.chat))}canSubmit(t){return!(null==t||!t.trim()||this._isModelLoading)&&(!!this._loadOnFirstMessage||!!this._isModelLoaded)}static async processResponse(t,e,i){var s,n;const o=await(null==(s=t.responseInterceptor)?void 0:s.call(t,i))||i;if(null!=(n=t.connect)&&n.stream&&Array.isArray(o)&&o.length>1)return void console[C](yt);const r=Array.isArray(o)?o:[o],a=r.find(t=>"string"==typeof t[C]);if(!a){if(r.find(t=>!t||!t[M])){const s=pt(i,!!t.responseInterceptor,o);return void ts.displayError(e,new Error(s))}return r}ts.displayError(e,new Error(a[C]))}isWebModel(){return!0}static clearAllCache(){t.clearCache("webllm/model"),t.clearCache("webllm/wasm")}static clearCache(t){caches.open(t).then(t=>{t.keys().then(e=>{e.forEach(e=>{t.delete(e)})})})}};Cs.GENERIC_ERROR=`Error, please check the [troubleshooting](${T}webModel#troubleshooting) section of documentation for help.`,Cs.MULTIPLE_MODELS_ERROR="Cannot run multiple web models",Cs.WEB_LLM_NOT_FOUND_ERROR="WebLLM module not found",Cs.DEFAULT_MODEL="Llama-2-7b-chat-hf-q4f32_1",Cs.MODULE_SEARCH_LIMIT_S=5;let Ts=Cs;const js=(t,e,i,s)=>({url:t,method:e,handleVerificationResult:i,augmentUrl:s}),Es=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),Ns=(t,e,i,s)=>{const n=t;Array.isArray(n[C])&&"Error in `parameters`: field required"===n[C][0]?i(e):s(mt)},Is=class t extends gs{constructor(e,i,s,n,o,r){super(e,js("https://api-inference.huggingface.co/models/gpt2",Lt,Ns),Es,o,r),this.insertKeyPlaceholderText="Hugging Face Token",this.keyHelpUrl="https://huggingface.co/settings/tokens",this.permittedErrorPrefixes=[Ct],this.url=`${t.URL_PREFIX}${s}`,this.textInputPlaceholderText=i,"object"==typeof n&&(n.model&&(this.url=`${t.URL_PREFIX}${n.model}`),n.options&&(this.rawBody.options=n.options),n.parameters&&(this.rawBody.parameters=n.parameters))}preprocessBody(t,e,i){const s=JSON.parse(JSON.stringify(t)),n=e[e.length-1][M];if(n)return s.options??(s.options={}),s.options.wait_for_model=!0,{inputs:n,...s}}async callServiceAPI(t,e,i){if(!this.connectSettings)throw new Error(ft);const s=this.preprocessBody(this.rawBody,e,i);us.request(this,s,t)}};Is.URL_PREFIX="https://api-inference.huggingface.co/models/";let Ps=Is;class $s extends Ps{constructor(t,e,i,s,n,o){super(t,e,i,s,n,o),this.isTextInputDisabled=!0,this.canSendMessage=$s.canSendFile}static canSendFile(t,e){return!(null==e||!e[0])}preprocessBody(t,e,i){return i[0]}async callServiceAPI(t,e,i){if(!this.connectSettings)throw new Error(ft);if(null==i||!i[0])throw new Error(gt);us.poll(this,i[0],t,!1)}}class Bs extends $s{constructor(t){var e,i,s;super(t,"Attach an audio file","ehcalabres/wav2vec2-lg-xlsr-en-speech-emotion-recognition",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.audioClassification,null==(s=t.directConnection)?void 0:s.huggingFace,{audio:{}})}async extractPollResultData(t){var e;if(t.estimated_time)return{timeoutMS:1e3*(t.estimated_time+1)};if(t[C])throw t[C];return{[M]:(null==(e=t[0])?void 0:e.label)||""}}}class Rs extends $s{constructor(t){var e,i,s;super(t,"Attach an image file","google/vit-base-patch16-224",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.imageClassification,null==(s=t.directConnection)?void 0:s.huggingFace,{images:{}})}async extractPollResultData(t){var e;if(t.estimated_time)return{timeoutMS:1e3*(t.estimated_time+1)};if(t[C])throw t[C];return{[M]:(null==(e=t[0])?void 0:e.label)||""}}}const Js=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),Fs=(t,e,i,s)=>{t.message?s(mt):i(e)},Ls=()=>js("https://api.stability.ai/v1/engines/list",Ft,Fs),qs="data:image/png;base64,";class zs extends gs{constructor(t,e,i,s,n){super(t,e,i,s,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Stability AI"),this.keyHelpUrl="https://platform.stability.ai/docs/getting-started/authentication",this.permittedErrorPrefixes=[jt,"invalid_"]}}class Ds extends zs{constructor(t){var e;const i=JSON.parse(JSON.stringify(t.directConnection)),s=null==i?void 0:i.stabilityAI;super(t,Ls(),Js,s,{images:{files:{acceptedFormats:".png",maxNumberOfFiles:1}}}),this.url="https://api.stability.ai/v1/generation/esrgan-v1-x2plus/image-to-image/upscale",this.textInputPlaceholderText="Describe image changes";const n=null==(e=null==i?void 0:i.stabilityAI)?void 0:e.imageToImageUpscale;"object"==typeof n&&(n.engine_id&&(this.url=`https://api.stability.ai/v1/generation/${n.engine_id}/image-to-image/upscale`),Ds.cleanConfig(n),Object.assign(this.rawBody,n)),this.canSendMessage=Ds.canSendFileMessage}static cleanConfig(t){delete t.engine_id}static canSendFileMessage(t,e){return!(null==e||!e[0])}createFormDataBody(t,e){const i=new FormData;return i.append(D,e),Object.keys(t).forEach(e=>{i.append(e,String(t[e]))}),i}async callServiceAPI(t,e,i){if(!this.connectSettings)throw new Error(ft);if(!i)throw new Error(bt);const s=this.createFormDataBody(this.rawBody,i[0]);ts.tempRemoveContentHeader(this.connectSettings,us.request.bind(this,this,s,t),!1)}async extractResultData(t){if(t.message)throw t.message;const e=t.artifacts.map(t=>({[F]:`${qs}${t.base64}`,[L]:D}));return{[z]:e}}}class Us extends zs{constructor(t){var e;const i=JSON.parse(JSON.stringify(t.directConnection)),s=null==i?void 0:i.stabilityAI,n={[U]:{[z]:{acceptedFormats:".png",maxNumberOfFiles:2}}};super(t,Ls(),Js,s,n),this.url="https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/image-to-image/masking",this._maskSource="MASK_IMAGE_WHITE",this.textInputPlaceholderText="Describe image changes";const o=null==(e=null==i?void 0:i.stabilityAI)?void 0:e.imageToImageMasking;"object"==typeof o&&(o.engine_id&&(this.url=`https://api.stability.ai/v1/generation/${o.engine_id}/image-to-image/masking`),void 0!==o.weight&&null!==o.weight&&(this._imageWeight=o.weight),void 0!==o.mask_source&&null!==o.mask_source&&(this._maskSource=o.mask_source),Us.cleanConfig(o),Object.assign(this.rawBody,o)),this.canSendMessage=Us.canSendFileTextMessage}static cleanConfig(t){delete t.engine_id,delete t.weight}static canSendFileTextMessage(t,e){return!(null==e||!e[0]||!t||""===t.trim())}createFormDataBody(t,e,i,s){const n=new FormData;return n.append("init_image",e),n.append("mask_source",String(this._maskSource)),n.append("mask_image",i),s&&""!==s&&n.append("text_prompts[0][text]",s),void 0!==this._imageWeight&&null!==this._imageWeight&&n.append("text_prompts[0][weight]",String(this._imageWeight)),Object.keys(t).forEach(e=>{n.append(e,String(t[e]))}),void 0===n.get("weight")&&n.append("weight",String(1)),n}async callServiceAPI(t,e,i){var s,n;if(!this.connectSettings)throw new Error(ft);if(!i||!i[0]||!i[1])throw new Error(bt);const o=null==(n=null==(s=e[e.length-1])?void 0:s[M])?void 0:n.trim(),r=this.createFormDataBody(this.rawBody,i[0],i[1],o);ts.tempRemoveContentHeader(this.connectSettings,us.request.bind(this,this,r,t),!1)}async extractResultData(t){if(t.message)throw t.message;const e=t.artifacts.map(t=>({[F]:`${qs}${t.base64}`,[L]:D}));return{[z]:e}}}class Hs extends $s{constructor(t){var e,i,s;super(t,"Attach an audio file","facebook/wav2vec2-large-960h-lv60-self",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.audioSpeechRecognition,null==(s=t.directConnection)?void 0:s.huggingFace,{audio:{}})}async extractPollResultData(t){if(t.estimated_time)return{timeoutMS:1e3*(t.estimated_time+1)};if(t[C])throw t[C];return{[M]:t[M]||""}}}class Vs extends Ps{constructor(t){var e,i,s;super(t,"Once upon a time","gpt2",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.textGeneration,null==(s=t.directConnection)?void 0:s.huggingFace)}async extractResultData(t){var e;if(t[C])throw t[C];return{[M]:(null==(e=t[0])?void 0:e.generated_text)||""}}}class Ws extends Ps{constructor(t){var e,i,s;const n=null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.questionAnswer;super(t,"Ask a question","bert-large-uncased-whole-word-masking-finetuned-squad",n,null==(s=t.directConnection)?void 0:s.huggingFace),this.permittedErrorPrefixes=[Ct,"Error in"],this._context=n.context}preprocessBody(t,e){const i=e[e.length-1][M];if(i)return{inputs:{question:i,context:this._context,options:{wait_for_model:!0}}}}async extractResultData(t){if(t[C])throw t[C];return{[M]:t.answer||""}}}class Gs extends Ps{constructor(t){var e,i,s;super(t,"Insert text to summarize","facebook/bart-large-cnn",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.summarization,null==(s=t.directConnection)?void 0:s.huggingFace)}async extractResultData(t){var e;if(t[C])throw t[C];return{[M]:(null==(e=t[0])?void 0:e.summary_text)||""}}}class Zs extends Ps{constructor(t){var e,i,s;super(t,"Ask me anything!","facebook/blenderbot-400M-distill",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.conversation,null==(s=t.directConnection)?void 0:s.huggingFace),this.maxMessages??(this.maxMessages=-1)}processMessagesI(t){const e=t.filter(t=>t[M]),i=e[e.length-1][M],s=e.slice(0,e.length-1);if(!i)return;return{past_user_inputs:s.filter(t=>t.role===E).map(t=>t[M]),generated_responses:s.filter(t=>t.role===j).map(t=>t[M]),mostRecentMessageText:i}}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessagesI(e);if(s)return i.options??(i.options={}),i.options.wait_for_model=!0,{inputs:{past_user_inputs:s.past_user_inputs,generated_responses:s.generated_responses,[M]:s.mostRecentMessageText},...i}}async extractResultData(t){if(t[C])throw t[C];return{[M]:t.generated_text||""}}}class Ks extends zs{constructor(t){var e;const i=JSON.parse(JSON.stringify(t.directConnection)),s=i.stabilityAI,n={[U]:{[z]:{acceptedFormats:".png",maxNumberOfFiles:1}}};super(t,Ls(),Js,s,n),this.url="https://api.stability.ai/v1/generation/stable-diffusion-v1-6/image-to-image",this.textInputPlaceholderText="Describe image changes";const o=null==(e=i.stabilityAI)?void 0:e.imageToImage;"object"==typeof o&&(o.engine_id&&(this.url=`https://api.stability.ai/v1/generation/${o.engine_id}/text-to-image`),void 0!==o.weight&&null!==o.weight&&(this._imageWeight=o.weight),Ks.cleanConfig(o),Object.assign(this.rawBody,o)),this.canSendMessage=Ks.canSendFileTextMessage}static cleanConfig(t){delete t.engine_id,delete t.weight}static canSendFileTextMessage(t,e){return!(null==e||!e[0]||!t||""===t.trim())}createFormDataBody(t,e,i){const s=new FormData;return s.append("init_image",e),i&&""!==i&&s.append("text_prompts[0][text]",i),void 0!==this._imageWeight&&null!==this._imageWeight&&s.append("text_prompts[0][weight]",String(this._imageWeight)),Object.keys(t).forEach(e=>{s.append(e,String(t[e]))}),void 0===s.get("weight")&&s.append("weight",String(1)),s}async callServiceAPI(t,e,i){var s,n;if(!this.connectSettings)throw new Error(ft);if(!i)throw new Error(bt);const o=null==(n=null==(s=e[e.length-1])?void 0:s[M])?void 0:n.trim(),r=this.createFormDataBody(this.rawBody,i[0],o);ts.tempRemoveContentHeader(this.connectSettings,us.request.bind(this,this,r,t),!1)}async extractResultData(t){if(t.message)throw t.message;const e=t.artifacts.map(t=>({[F]:`${qs}${t.base64}`,[L]:D}));return{[z]:e}}}class Xs extends Ps{constructor(t){var e,i,s;super(t,"Insert text to translate","Helsinki-NLP/opus-tatoeba-en-ja",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.translation,null==(s=t.directConnection)?void 0:s.huggingFace)}async extractResultData(t){var e;if(t[C])throw t[C];return{[M]:(null==(e=t[0])?void 0:e.translation_text)||""}}}class Qs extends zs{constructor(t){var e;const i=JSON.parse(JSON.stringify(t.directConnection)),s=i.stabilityAI;super(t,Ls(),Js,s),this.url="https://api.stability.ai/v1/generation/stable-diffusion-v1-6/text-to-image",this.textInputPlaceholderText="Describe an image";const n=null==(e=i.stabilityAI)?void 0:e.textToImage;"object"==typeof n&&(n.engine_id&&(this.url=`https://api.stability.ai/v1/generation/${n.engine_id}/text-to-image`),void 0!==n.weight&&null!==n.weight&&(this._imageWeight=n.weight),Qs.cleanConfig(n),Object.assign(this.rawBody,n)),this.canSendMessage=Qs.canSendTextMessage}static cleanConfig(t){delete t.engine_id,delete t.weight}static canSendTextMessage(t){return!(!t||""===t.trim())}preprocessBody(t,e){const i=e[e.length-1][M],s=JSON.parse(JSON.stringify(t)),n={[M]:i};return this._imageWeight&&(n.weight=this._imageWeight),s.text_prompts=[n],s}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){if(t.message)throw t.message;const e=t.artifacts.map(t=>({[F]:`${qs}${t.base64}`,[L]:D}));return{[z]:e}}}class Ys extends Ps{constructor(t){var e,i,s;super(t,"The goal of life is [MASK].","bert-base-uncased",null==(i=null==(e=t.directConnection)?void 0:e.huggingFace)?void 0:i.fillMask,null==(s=t.directConnection)?void 0:s.huggingFace),this.permittedErrorPrefixes=[Ct,"No mask_token"]}async extractResultData(t){var e;if(t[C])throw t[C];return{[M]:(null==(e=t[0])?void 0:e.sequence)||""}}}const tn=t=>({[It]:$t,[Ot]:`${Jt}${t}`}),en=(t,e,i,s)=>{const n=t;n[C]?n[C].message===At?s(mt):s(vt):i(e)},sn=()=>js("https://open.bigmodel.cn/api/paas/v4/models",Ft,en);class nn extends gs{constructor(t){var e,i,s;const n=JSON.parse(JSON.stringify(t.directConnection)),o=n.bigModel;super(t,sn(),tn,o),this.insertKeyPlaceholderText=this.genereteAPIKeyName("BigModel"),this.keyHelpUrl="https://open.bigmodel.cn/usercenter/apikeys",this.url="https://open.bigmodel.cn/api/paas/v4/audio/speech",this.permittedErrorPrefixes=[Ot,Et];const r=null==(e=n.bigModel)?void 0:e.textToSpeech;typeof r===Bt&&(this.cleanConfig(r),Object.assign(this.rawBody,r)),(i=this.rawBody).model??(i.model="cogtts"),(s=this.rawBody).voice??(s.voice="tongtong")}cleanConfig(t){delete t.key}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=e[e.length-1];return i.input=(null==s?void 0:s[M])||"",i}async callServiceAPI(t,e){return this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){const e=new Blob([t],{[L]:"audio/mpeg"}),i=URL.createObjectURL(e);return{[z]:[{[F]:i,[L]:W}]}}}const on=t=>({[It]:$t,[Ot]:`${Jt}${t}`}),rn=(t,e,i,s)=>{const n=t;n[C]?n[C].message===At?s(mt):s(vt):i(e)},an=()=>js("https://api.together.xyz/v1/models",Ft,rn);class ln extends gs{constructor(t){var e,i,s;const n=JSON.parse(JSON.stringify(t.directConnection)),o=n.together;super(t,an(),on,o),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Together AI"),this.keyHelpUrl="https://api.together.xyz/settings/api-keys",this.url="https://api.together.xyz/v1/audio/speech",this.permittedErrorPrefixes=[Nt,Et];const r=null==(e=n.together)?void 0:e.textToSpeech;typeof r===Bt&&this.completeConfig(r),(i=this.rawBody).model??(i.model="cartesia/sonic"),(s=this.rawBody).voice??(s.voice="laidback woman")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=e[e.length-1];return i.input=(null==s?void 0:s[M])||"",i}async callServiceAPI(t,e){return this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){const e=new Blob([t],{[L]:"audio/mpeg"}),i=URL.createObjectURL(e);return{[z]:[{[F]:i,[L]:W}]}}}const cn=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),hn=(t,e,i,s)=>{const n=t;n[C]?"invalid_api_key"===n[C].code?s(mt):s(vt):i(e)},un=()=>js("https://api.openai.com/v1/models",Ft,hn),dn=async(t,e,i,s=!0)=>{const{connectSettings:n,deepChat:o,completionsHandlers:r,messages:a}=t;n.method=i;const l={body:e,headers:n.headers},{body:c,headers:h,error:u}=await ts.processRequestInterceptor(o,l),{onFinish:d}=r;if(u&&a)return ts.onInterceptorError(a,u,d);const p=await ts.fetch(t,h,s,c).then(t=>ts.processResponseByType(t));if(p[C])throw p[C].message;return p},pn=class t{static async storeFiles(t,e,i,s){const n=t.connectSettings.headers;if(!n)return;t.url=s;const o=n[It];delete n[It];const r=i.map(async e=>{const i=new FormData;return i.append("purpose","assistants"),i.append("file",e),new Promise(e=>{e(dn(t,i,Lt,!1))})});try{const t=(await Promise.all(r)).map(t=>({id:t.id,name:t.filename}));return n[It]=o,t}catch(i){throw n[It]=o,ts.displayError(e,i),t.completionsHandlers.onFinish(),i}}static getType(t,e){const{path:i}=t[e];return!i||i.endsWith("png")?D:K}static async getFiles(e,i,s,n){const o=i.map(({fileId:t})=>(e.url=`${s}${t}${n}`,new Promise(t=>{t(dn(e,void 0,"GET",!1))}))),r=(await Promise.all(o)).map((e,s)=>new Promise(n=>{const o=new FileReader;o.readAsDataURL(e),o.onload=e=>{n({[F]:e.target.result,name:i[s].name,[L]:t.getType(i,s)})}}));return await Promise.all(r)}static getFileName(t){const e=t.split("/");return e[e.length-1]}static async getFilesAndNewText(e,i,s,n,o){var r,a;let l;const{getFilesPrefix:c,getFilesPostfix:h}=s;return i.length>0&&(l=await t.getFiles(e,i,c,h),null!=(r=null==o?void 0:o[M])&&r.value&&l.forEach((t,e)=>{var s;if(!t.src)return;const n=i[e].path;null!=(s=null==o?void 0:o[M])&&s.value&&n&&(o[M].value=o[M].value.replace(n,t.src))})),null!=(a=null==o?void 0:o[M])&&a.value?{[M]:o[M].value,role:n}:{[z]:l,role:n}}static getFileDetails(e,i){var s;const n=[];return null!=(s=null==i?void 0:i[M])&&s.value&&e.content.forEach(e=>{var i,s;null==(s=null==(i=e[M])?void 0:i.annotations)||s.forEach(e=>{var i;e[M]&&e[M].startsWith("sandbox:")&&null!=(i=e.file_path)&&i.file_id&&n.push({path:e[M],fileId:e.file_path.file_id,name:t.getFileName(e[M])})})}),null!=i&&i.image_file&&n.push({fileId:i.image_file.file_id}),n}static async getFilesAndText(e,i,s,n){const o=t.getFileDetails(i,n);return await t.getFilesAndNewText(e,o,s,i.role,n)}static parseResult(t,e){let i=[];if(e)i=t.data;else for(let e=0;e<t.data.length;e+=1){const s=t.data[e];if(s.role!==N)break;i.push(s)}return i.reverse()}static parseMessages(e,i,s){const n=[];return i.forEach(async i=>{i.content.filter(t=>!!t[M]||!!t.image_file).sort(t=>t[M]?-1:t.image_file?1:0).forEach(async o=>{n.push(t.getFilesAndText(e,i,s,o))})}),Promise.all(n)}static async processStreamMessages(e,i,s){return t.parseMessages(e,[{content:i,role:N}],s)}static async processAPIMessages(e,i,s,n){const o=t.parseResult(i,s);return t.parseMessages(e,o,n)}};pn.FILES_WITH_TEXT_ERROR="content with type `text` must have `text` values",pn.FUNCTION_TOOL_RESP_ERROR=`Response must contain an array of strings for each individual function/tool_call, see ${T}directConnection/OpenAI/#assistant-functions.`;let mn=pn;const vn=class t extends gs{constructor(t,e,i,s,n,o){if(super(t,s,n,o),this.insertKeyPlaceholderText=this.genereteAPIKeyName("OpenAI"),this.keyHelpUrl="https://platform.openai.com/account/api-keys",this.url="",this.permittedErrorPrefixes=[jt,"Please send text",ms.FAILED_ERROR_MESSAGE],this.shouldFetchHistory=!1,this._searchedForThreadId=!1,this._config={},this._newAssistantDetails={model:"gpt-4"},this._waitingForStreamResponse=!1,this._isSSEStream=!1,this.urlSegments=i,"object"==typeof e){this._config=e;const{new_assistant:t,thread_id:i,load_thread_history:s}=this._config;Object.assign(this._newAssistantDetails,t),i&&(this.sessionId=i),s&&(this.shouldFetchHistory=!0)}this.maxMessages=1,this._isSSEStream=!(!this.stream||"object"==typeof this.stream&&this.stream.simulation)}async fetchHistoryFunc(){setTimeout(()=>this.deepChat.disableSubmitButton(),2);try{const t=await this.getThreadMessages(this.sessionId,!0);return this.deepChat.disableSubmitButton(!1),t}catch{return[{[C]:"Failed to fetch history"}]}}static processImageMessage(t,e){const i=null==e?void 0:e.filter(t=>Ji.isImageFileExtension(t.name)).map(t=>({[L]:"image_file",image_file:{file_id:t.id}}));if(i&&i.length>0)return t[M]&&t[M].length>0&&i.push({[L]:M,[M]:t[M]}),{content:i,role:E}}static processAttachmentsMessage(t,e,i){return{attachments:e.map(t=>({tools:[{[L]:i}],file_id:t.id})),content:[{[L]:M,[M]:t[M]}],role:E}}processMessage(e,i){const s=this.totalMessagesMaxCharLength||-1,n=ds.getCharacterLimitMessages(e,s)[0];if(i&&i.length>0){let e=this.filesToolType;if("function"==typeof this.filesToolType){const t=this.filesToolType(i.map(({name:t})=>t));"code_interpreter"===t||"file_search"===t||t===U?e=t:(console[C](`Tool type "${t}" is not valid`),console[C]('Expected "code_interpreter" or "file_search" or "images". Going to default to "images"'))}if("file_search"===e)return t.processAttachmentsMessage(n,i,"file_search");if("code_interpreter"===e)return t.processAttachmentsMessage(n,i,"code_interpreter");if(i.find(({name:t})=>!Ji.isImageFileExtension(t)))console[C]("The uploaded files contained a non-image file"),console[C]('Make sure only images can be uploaded or define a "code_interpreter" or "file_search" value in the "files_tool_type" property'),console.warn('Make sure your existing assistant supports these "tools" or specify them in the "new_assistant" property');else{const e=t.processImageMessage(n,i);if(e)return e}}return{content:n[M]||"",role:E}}createNewThreadMessages(t,e,i){const s=JSON.parse(JSON.stringify(t)),n=this.processMessage(e,i);return s.thread={messages:[n]},s}callService(t,e,i){if(this.messages=t,this.sessionId){this.url=`${this.urlSegments.threadsPrefix}/${this.sessionId}/messages${this.urlSegments.createMessagePostfix}`;const s=this.processMessage(e,i);us.request(this,s,t)}else{this.url=`${this.urlSegments.threadsPrefix}/runs${this.urlSegments.threadsPosfix}`;const s=this.createNewThreadMessages(this.rawBody,e,i);this._isSSEStream?this.createStreamRun(s):us.request(this,s,t)}}async callServiceAPI(t,e,i){var s;if(this._waitingForStreamResponse=!1,!this.connectSettings)throw new Error(ft);(s=this.rawBody).assistant_id??(s.assistant_id=this._config.assistant_id||await this.createNewAssistant()),this._searchedForThreadId||this.searchPreviousMessagesForThreadId(t.messageToElements);const n=i?await mn.storeFiles(this,t,i,this.urlSegments.storeFiles):void 0;this.connectSettings.method=Lt,this.callService(t,e,n)}async createNewAssistant(){try{this.url=this.urlSegments.newAssistantUrl;const t=await dn(this,JSON.parse(JSON.stringify(this._newAssistantDetails)),Lt);return this._config.assistant_id=t.id,this._config.assistant_id}catch(t){console[C](t),console[C]("Failed to create a new assistant")}}searchPreviousMessagesForThreadId(t){const e=t.find(([t])=>t._sessionId);e&&(this.sessionId=e[0]._sessionId),this._searchedForThreadId=!0}async extractResultData(t){var e;if(this._waitingForStreamResponse||this._isSSEStream&&this.sessionId)return await this.handleStream(t);if(t[C])throw t[C].message.startsWith(mn.FILES_WITH_TEXT_ERROR)?Error("Please send text with your file(s)"):t[C].message;this.asyncCallInProgress=!0,await this.assignThreadAndRun(t);const i=`${this.urlSegments.threadsPrefix}/${this.sessionId}/runs/${this.run_id}${this.urlSegments.threadsPosfix}`,s={method:Ft,headers:null==(e=this.connectSettings)?void 0:e.headers};return us.executePollRequest(this,i,s,this.messages),{[M]:""}}async assignThreadAndRun(t){if(this.sessionId){this.url=`${this.urlSegments.threadsPrefix}/${this.sessionId}/runs${this.urlSegments.threadsPosfix}`;const t=await dn(this,JSON.parse(JSON.stringify(this.rawBody)),Lt);this.run_id=t.id}else this.sessionId=t.thread_id,this.run_id=t.id,this.messages&&this.messages.messageToElements.length>0&&(this.messages.messageToElements[this.messages.messageToElements.length-1][0]._sessionId=this.sessionId)}async getThreadMessages(t,e=!1){var i,s;this.url=`${this.urlSegments.threadsPrefix}/${t}/messages?${this.urlSegments.listMessagesPostfix}`;let n=await dn(this,{},Ft);return!e&&this.deepChat.responseInterceptor&&(n=await(null==(s=(i=this.deepChat).responseInterceptor)?void 0:s.call(i,n))),mn.processAPIMessages(this,n,e,this.urlSegments)}async extractPollResultData(e){var i;const{status:s,required_action:n}=e;if("queued"===s||"in_progress"===s)return{timeoutMS:t.POLLING_TIMEOUT_MS};if(s===Rt&&this.messages){const t=await this.getThreadMessages(e.thread_id),{text:i,files:s}=t.shift();return setTimeout(()=>{t.forEach(t=>this.deepChat.addMessage(t))}),{text:i,_sessionId:this.sessionId,[z]:s}}const o=null==(i=null==n?void 0:n.submit_tool_outputs)?void 0:i.tool_calls;if("requires_action"===s&&o)return await this.handleTools(o);throw Error(`Thread run status: ${s}`)}async handleTools(e){if(!this.functionHandler)throw Error(kt);const i=e.map(t=>({name:t.function.name,arguments:t.function.arguments})),s=await this.functionHandler(i);if(!Array.isArray(s)||e.length!==s.length)throw Error(mn.FUNCTION_TOOL_RESP_ERROR);const n=await Promise.all(s);if(n.find(t=>"string"!=typeof t))throw Error(mn.FUNCTION_TOOL_RESP_ERROR);const o=n.map((t,i)=>({tool_call_id:e[i].id,output:t})),r=`${this.urlSegments.threadsPrefix}/${this.sessionId}`,a=`/runs/${this.run_id}/submit_tool_outputs${this.urlSegments.threadsPosfix}`;return this.url=`${r}${a}`,this._isSSEStream?await this.createStreamRun({tool_outputs:o}):await dn(this,{tool_outputs:o},Lt),{timeoutMS:t.POLLING_TIMEOUT_MS}}async handleStream(t){var e,i;const s=null==(i=null==(e=t.required_action)?void 0:e.submit_tool_outputs)?void 0:i.tool_calls;if("requires_action"===t.status&&s)return this.run_id=t.id,await this.handleTools(s);if(this._waitingForStreamResponse)return this.parseStreamResult(t);if(this._isSSEStream&&this.sessionId){this.asyncCallInProgress=!0,this.url=`${this.urlSegments.threadsPrefix}/${this.sessionId}/runs${this.urlSegments.threadsPosfix}`;const t=JSON.parse(JSON.stringify(this.rawBody));this.createStreamRun(t)}return{[M]:""}}async parseStreamResult(t){var e,i,s,n,o;if(t.content&&t.content.length>0&&this.messages){const s=t.content.find(t=>t[M]);if(null!=(e=null==s?void 0:s[M])&&e.annotations&&s[M].annotations.length>0){const e=t.content.find(t=>!!t[M])||t.content[0],s=mn.getFilesAndText.bind(this,this,{role:N,content:t.content},this.urlSegments,e);return null==(i=this._messageStream)||i.endStreamAfterFileDownloaded(this.messages,s),{[M]:""}}}if(null!=(s=t.delta)&&s.content){if(t.delta.content.length>1){const e=t.delta.content.find(t=>t[M]);if(null!=(n=null==e?void 0:e[M])&&n.annotations&&0===e[M].annotations.length){const e=await mn.processStreamMessages(this,t.delta.content,this.urlSegments);return{[M]:e[0][M],[z]:e[1][z]}}}return{[M]:null==(o=t.delta.content[0][M])?void 0:o.value}}return!this.sessionId&&t.thread_id&&(this.sessionId=t.thread_id),{[M]:""}}async createStreamRun(t){t.stream=!0,this._waitingForStreamResponse=!0,this._messageStream=await rs.request(this,t,this.messages,!0,!0)}};vn.POLLING_TIMEOUT_MS=500;let fn=vn;class gn extends fn{constructor(t){var e,i,s,n,o;const r=JSON.parse(JSON.stringify(t.directConnection)),a=r.openAI,l=null==(e=r.openAI)?void 0:e.assistant;if(super(t,l,gn.buildUrlSegments(l),un(),cn,a),(i=this.connectSettings).headers??(i.headers={}),(s=this.connectSettings.headers)["OpenAI-Beta"]??(s["OpenAI-Beta"]="assistants=v2"),this.shouldFetchHistory&&this.sessionId&&(this.fetchHistory=this.fetchHistoryFunc.bind(this)),typeof l===Bt){const{function_handler:e,files_tool_type:i}=null==(o=null==(n=t.directConnection)?void 0:n.openAI)?void 0:o.assistant;e&&(this._functionHandlerI=e),i&&(this.filesToolType=i)}}static buildUrlSegments(t){const e="object"==typeof t&&t.custom_base_url||"https://api.openai.com/v1";return{threadsPrefix:`${e}/threads`,threadsPosfix:"",newAssistantUrl:`${e}/assistants`,createMessagePostfix:"",listMessagesPostfix:"order=desc",storeFiles:`${e}/files`,getFilesPrefix:`${e}/files/`,getFilesPostfix:"/content"}}}const bn=`Please define the Azure URL Details. [More Information](${T}directConnection/Azure)`,yn=t=>({"api-key":t,[It]:$t}),wn=t=>js(`${t.endpoint}/openai/models?api-version=${t.version}`,Ft,hn),xn=t=>{const{endpoint:e,version:i,deploymentId:s}=t;return e&&i&&s},kn=class t extends fn{constructor(e){var i,s,n,o,r,a,l,c;const h=JSON.parse(JSON.stringify(e.directConnection)),u=h.azure,d=null==(i=h.azure)?void 0:i.openAI,p=(null==d?void 0:d.urlDetails)||{},m=`${null==(s=null==d?void 0:d.urlDetails)?void 0:s.endpoint}/openai/`,v=`?api-version=${null==(n=null==d?void 0:d.urlDetails)?void 0:n.version}`,f={threadsPrefix:`${m}${t.THREAD_RESOURCE}`,threadsPosfix:v,newAssistantUrl:`${m}${t.NEW_ASSISTANT_RESOURCE}${v}`,createMessagePostfix:v,listMessagesPostfix:`order=desc&api-version=${null==(o=null==d?void 0:d.urlDetails)?void 0:o.version}`,storeFiles:`${m}files${v}`,getFilesPrefix:`${m}files/`,getFilesPostfix:`/content${v}`};if(super(e,null==d?void 0:d.assistant,f,wn(p),yn,u),this.permittedErrorPrefixes=[bn],this.insertKeyPlaceholderText=this.genereteAPIKeyName("Azure OpenAI"),this.keyHelpUrl="https://learn.microsoft.com/en-us/answers/questions/1193991/how-to-get-the-value-of-openai-api-key",this.isTextInputDisabled=!1,typeof(null==d?void 0:d.assistant)===Bt){const{function_handler:t,files_tool_type:i}=null==(l=null==(a=null==(r=e.directConnection)?void 0:r.azure)?void 0:a.openAI)?void 0:l.assistant;t&&(this._functionHandlerI=t),i&&(this.filesToolType=i)}xn(p)?(c=this.connectSettings).headers??(c.headers={}):(this.isTextInputDisabled=!0,this.canSendMessage=()=>!1,setTimeout(()=>{e.addMessage({[C]:bn})}))}};kn.THREAD_RESOURCE="threads",kn.NEW_ASSISTANT_RESOURCE="assistants";let Sn=kn;class _n{static addAttributes(t){t.role="button",t.setAttribute("tabindex","0")}static addAriaBusy(t){t.setAttribute("aria-busy","true")}static removeAriaBusy(t){t.removeAttribute("aria-busy")}static addAriaDisabled(t){t.setAttribute("aria-disabled","true")}static removeAriaDisabled(t){t.removeAttribute("aria-disabled")}static removeAriaAttributes(t){_n.removeAriaBusy(t),_n.removeAriaDisabled(t)}}const On='<?xml version="1.0" encoding="iso-8859-1"?>\n<svg height="1.4em" width="1.4em" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"\n\t viewBox="0 0 490.9 490.9" xml:space="preserve">\n\t<g>\n\t\t<g>\n\t\t\t<path d="M245.5,322.9c53,0,96.2-43.2,96.2-96.2V96.2c0-53-43.2-96.2-96.2-96.2s-96.2,43.2-96.2,96.2v130.5\n\t\t\t\tC149.3,279.8,192.5,322.9,245.5,322.9z M173.8,96.2c0-39.5,32.2-71.7,71.7-71.7s71.7,32.2,71.7,71.7v130.5\n\t\t\t\tc0,39.5-32.2,71.7-71.7,71.7s-71.7-32.2-71.7-71.7V96.2z"/>\n\t\t\t<path d="M94.4,214.5c-6.8,0-12.3,5.5-12.3,12.3c0,85.9,66.7,156.6,151.1,162.8v76.7h-63.9c-6.8,0-12.3,5.5-12.3,12.3\n\t\t\t\ts5.5,12.3,12.3,12.3h152.3c6.8,0,12.3-5.5,12.3-12.3s-5.5-12.3-12.3-12.3h-63.9v-76.7c84.4-6.3,151.1-76.9,151.1-162.8\n\t\t\t\tc0-6.8-5.5-12.3-12.3-12.3s-12.3,5.5-12.3,12.3c0,76.6-62.3,138.9-138.9,138.9s-138.9-62.3-138.9-138.9\n\t\t\t\tC106.6,220,101.2,214.5,94.4,214.5z"/>\n\t\t</g>\n\t</g>\n</svg>\n',Mn=class e{static createTextElement(s){const n=i();return n[t].add(e.INPUT_BUTTON_INNER_TEXT_CLASS),n.innerText=s,n}static tryAddSVGElement(t,e,i,s){i?t.push(xs.createSVGElement(i)):""!==i&&s&&t.push(e)}static createCustomElements(t,i,s){var n,o;const r=null==s?void 0:s[t],a=null==(n=null==r?void 0:r[M])?void 0:n.content,l=null==(o=null==r?void 0:r.svg)?void 0:o.content,c=[];return e.tryAddSVGElement(c,i,l,a),a&&c.push(e.createTextElement(a)),c.length>0?c:void 0}static reassignClassBasedOnChildren(i,s){i[t].remove(e.INPUT_BUTTON_SVG_CLASS,e.INPUT_BUTTON_SVG_TEXT_CLASS),s.find(i=>i[t].contains(e.INPUT_BUTTON_INNER_TEXT_CLASS))?s.length>1&&i[t].add(e.INPUT_BUTTON_SVG_TEXT_CLASS):i[t].add(e.INPUT_BUTTON_SVG_CLASS)}};Mn.INPUT_BUTTON_SVG_TEXT_CLASS="input-button-svg-text",Mn.INPUT_BUTTON_INNER_TEXT_CLASS="text-button",Mn.INPUT_BUTTON_SVG_CLASS="input-button-svg";let An=Mn;class Cn{static parseSVGTextElements(t){return{svg:t.find(t=>"svg"===t.tagName.toLowerCase()),[M]:t.find(t=>"div"===t.tagName.toLowerCase())}}}class Tn{static unsetAllCSS(t,e){var i,s;e.container&&w.unsetAllCSSMouseStates(t,e.container);const{svg:n,text:o}=Cn.parseSVGTextElements(Array.from(t.children));null!=(i=e.svg)&&i.styles&&n&&w.unsetAllCSSMouseStates(n,e.svg.styles),null!=(s=e[M])&&s.styles&&o&&w.unsetAllCSSMouseStates(o,e[M].styles)}static unsetActionCSS(t,e){var i,s;e.container&&w.unsetActivityCSSMouseStates(t,e.container);const{svg:n,text:o}=Cn.parseSVGTextElements(Array.from(t.children));null!=(i=e.svg)&&i.styles&&n&&w.unsetActivityCSSMouseStates(n,e.svg.styles),null!=(s=e[M])&&s.styles&&o&&w.unsetActivityCSSMouseStates(o,e[M].styles)}static setElementsCSS(t,i,s){var n,o,r,a,l;Object.assign(t[e],null==(n=i.container)?void 0:n[s]);const{svg:c,text:h}=Cn.parseSVGTextElements(Array.from(t.children));c&&Object.assign(c[e],null==(r=null==(o=i.svg)?void 0:o.styles)?void 0:r[s]),h&&Object.assign(h[e],null==(l=null==(a=i[M])?void 0:a.styles)?void 0:l[s])}static setElementCssUpToState(t,e,i){Tn.setElementsCSS(t,e,g),i!==g&&(Tn.setElementsCSS(t,e,b),i!==b&&Tn.setElementsCSS(t,e,y))}}class jn{constructor(t,e,i,s,n,o){this._mouseState={state:"default"},this.isCustom=!1,_n.addAttributes(t),this.elementRef=t,this.svg=xs.createSVGElement(e),this.customStyles=n,this.position=i,this._tooltipSettings=s,this.dropupText=o}buttonMouseLeave(t){var i;this._mouseState.state=g,"visible"===(null==(i=this._activeTooltip)?void 0:i.element[e].visibility)&&this._tooltipSettings&&Y.hide(this._activeTooltip,this._tooltipSettings),t&&(Tn.unsetAllCSS(this.elementRef,t),Tn.setElementsCSS(this.elementRef,t,g))}buttonMouseEnter(t){var e;this._mouseState.state=b,this._tooltipSettings&&(this._activeTooltip=Y.display(this.elementRef,this._tooltipSettings,null==(e=this._activeTooltip)?void 0:e.element)),t&&Tn.setElementsCSS(this.elementRef,t,b)}buttonMouseUp(t){t&&Tn.unsetActionCSS(this.elementRef,t),this.buttonMouseEnter(t)}buttonMouseDown(t){this._mouseState.state=y,t&&Tn.setElementsCSS(this.elementRef,t,y)}setEvents(t){this.elementRef.onmousedown=this.buttonMouseDown.bind(this,t),this.elementRef.onmouseup=this.buttonMouseUp.bind(this,t),this.elementRef.onmouseenter=this.buttonMouseEnter.bind(this,t),this.elementRef.onmouseleave=this.buttonMouseLeave.bind(this,t)}unsetCustomStateStyles(t){if(this.customStyles)for(let e=0;e<t.length;e+=1){const i=t[e],s=i&&this.customStyles[i];s&&Tn.unsetActionCSS(this.elementRef,s)}}reapplyStateStyle(t,e){if(!this.customStyles)return;e&&this.unsetCustomStateStyles(e);const i=this.customStyles[t];i&&Tn.setElementCssUpToState(this.elementRef,i,this._mouseState.state),this.setEvents(i)}changeElementsByState(t){this.elementRef.replaceChildren(...t),An.reassignClassBasedOnChildren(this.elementRef,t)}buildDefaultIconElement(t){const e=this.svg.cloneNode(!0);return e.id=t,[e]}createInnerElements(t,e,i){const s=An.createCustomElements(e,this.svg,i);if(s&&s.length>0){if(this.position===f){const e=this.svg.cloneNode(!0);e.id=s[0]===this.svg?t:"dropup-menu-item-icon-element-custom",s[0]=e}return s}return this.buildDefaultIconElement(t)}}const En=class e extends jn{constructor(t){var s,n;const o=(null==(n=null==(s=null==t?void 0:t[g])?void 0:s.svg)?void 0:n.content)||e.EMPTY_SVG;super(i(),o,void 0,void 0,t),this.isActive=!1,this._innerElements=this.createInnerElementsForStates(this.customStyles),this.changeToDefault()}createInnerElementsForStates(t){return{[g]:this.createInnerButtonElements(g,t),active:this.createInnerButtonElements("active",t),unavailable:this.createInnerButtonElements("unavailable",t)}}createInnerButtonElements(t,e){return An.createCustomElements(t,this.svg,e)||[this.svg]}changeState(e){this.changeElementsByState(e),this.elementRef[t].replace(An.INPUT_BUTTON_SVG_CLASS,"deep-chat-openai-realtime-button")}changeToActive(){this.changeState(this._innerElements.active),this.reapplyStateStyle("active",["unavailable",g]),this.isActive=!0}changeToDefault(){var t,e,i,s;this.changeState(this._innerElements[g]),null!=(t=this.customStyles)&&t.active&&Tn.unsetAllCSS(this.elementRef,null==(e=this.customStyles)?void 0:e.active),null!=(i=this.customStyles)&&i.unavailable&&Tn.unsetAllCSS(this.elementRef,null==(s=this.customStyles)?void 0:s.unavailable),this.reapplyStateStyle(g,["active","unavailable"]),this.isActive=!1}changeToUnavailable(){var t,e,i,s;this.changeState(this._innerElements.unavailable),null!=(t=this.customStyles)&&t.active&&Tn.unsetAllCSS(this.elementRef,null==(e=this.customStyles)?void 0:e.active),null!=(i=this.customStyles)&&i[g]&&Tn.unsetAllCSS(this.elementRef,null==(s=this.customStyles)?void 0:s[g]),this.reapplyStateStyle("unavailable",[g,"active"]),this.isActive=!1}};En.EMPTY_SVG='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"></svg>';let Nn=En;class In{static setPropertyValueIfDoesNotExist(t,e,i){const s=e[0];1===e.length?t[s]??(t[s]=i):(t[s]??(t[s]={}),e.shift(),In.setPropertyValueIfDoesNotExist(t[s],e,i))}static setPropertyValue(t,e,i){const s=e[0];1===e.length?t[s]=i:(t[s]??(t[s]={}),e.shift(),In.setPropertyValue(t[s],e,i))}static getObjectValue(t,e){const i=t[e[0]];return void 0===i||1===e.length?i:In.getObjectValue(i,e.slice(1))}static overwritePropertyObjectFromAnother(t,e,i){const s=In.getObjectValue(e,i);if(s){const e={...s,...In.getObjectValue(t,i)||{}};In.setPropertyValue(t,i,e)}}static isJson(t){try{return JSON.stringify(t),!0}catch{return!1}}static assignPropertyFromOneToAnother(t,e,i){e[t]??(e[t]={}),Object.assign(e[t],null==i?void 0:i[t])}}const Pn='<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">\n  <path d="M5.92 24.096q0 1.088 0.928 1.728 0.512 0.288 1.088 0.288 0.448 0 0.896-0.224l16.16-8.064q0.48-0.256 0.8-0.736t0.288-1.088-0.288-1.056-0.8-0.736l-16.16-8.064q-0.448-0.224-0.896-0.224-0.544 0-1.088 0.288-0.928 0.608-0.928 1.728v16.16z"></path>\n</svg>',$n='<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">\n<path d="M5.92 24.096q0 0.832 0.576 1.408t1.44 0.608h16.128q0.832 0 1.44-0.608t0.576-1.408v-16.16q0-0.832-0.576-1.44t-1.44-0.576h-16.128q-0.832 0-1.44 0.576t-0.576 1.44v16.16z"></path>\n</svg>',Bn=class s extends gs{constructor(t){var e,i,n,o,r;const a=JSON.parse(JSON.stringify(t.directConnection)),l=s.getKey(t);super(t,un(),cn,{key:l}),this.insertKeyPlaceholderText=this.genereteAPIKeyName("OpenAI"),this.keyHelpUrl="https://platform.openai.com/account/api-keys",this._microphoneButton=null,this._toggleButton=null,this._errorElement=null,this._loadingElement=null,this._pc=null,this._mediaStream=null,this._isMuted=!1;const c=null==(e=a.openAI)?void 0:e.realtime;if(typeof c===Bt){this._avatarConfig=c.avatar,this._ephemeralKey=c.ephemeralKey,this._errorConfig=c[C],this._loadingConfig=c.loading,Object.assign(this.rawBody,c.config);const e=null==(n=null==(i=t.directConnection)?void 0:i.openAI)?void 0:n.realtime,{function_handler:s}=e.config||{};s&&(this._functionHandlerI=s),this._events=c.events,e.methods=this.generateMethods(),this.setInputAudioTranscribe(t,null==(o=e.config)?void 0:o.input_audio_transcription)}(r=this.rawBody).model??(r.model="gpt-4o-realtime-preview-2025-06-03"),this._avatarConfig=s.buildAvatarConfig(c),this._buttonsConfig=s.buildButtonsConfig(c),this._avatarEl=s.createAvatar(this._avatarConfig),this._containerEl=this.createContainer(),this._deepChat=t}static getKey(t){const e=t.directConnection.openAI;if(null!=e&&e.key)return e.key;const i=null==e?void 0:e.realtime;return"object"==typeof i&&(i.ephemeralKey||i.fetchEphemeralKey)?"placeholder":void 0}setInputAudioTranscribe(t,e){if(e){const t="whisper-1";this.rawBody.input_audio_transcription="object"==typeof e?{model:e.model||t,language:e.language,prompt:e.prompt}:{model:t}}else t.onMessage&&(console.warn("To get user audio transcription, set `input_audio_transcription` in the `realtime` config."),console.warn(`See: ${T}directConnection/OpenAI/OpenAIRealtime#OpenAIRealtimeConfig`))}setUpView(t,i){t[e].display="none",i.appendChild(this._containerEl),this.setup()}async setup(){var t;const e=null==(t=this._deepChat.directConnection)?void 0:t.openAI;if(!e)return;const i=null==e?void 0:e.realtime;if("object"!=typeof i||!i.autoStart&&!i.autoFetchEphemeralKey)return;const s=this.key||e.key;(i.fetchEphemeralKey||s)&&i.autoStart&&(this.changeToUnavailable(),this.displayLoading()),this.fetchEphemeralKey(i.autoStart)}async fetchEphemeralKey(t){var e;const i=null==(e=this._deepChat.directConnection)?void 0:e.openAI,s="object"==typeof(null==i?void 0:i.realtime)?null==i?void 0:i.realtime.fetchEphemeralKey:void 0,n=null==i?void 0:i.realtime,o=this.key||i.key;if("object"==typeof n){if(!this._ephemeralKey)try{if(s){const t=s();t.then&&(this._retrievingEphemeralKey=t),this._ephemeralKey=await t}else o&&(this._retrievingEphemeralKey=this.getEphemeralKey(o),this._ephemeralKey=await this._retrievingEphemeralKey)}catch(t){this.displayFailedToRetrieveEphemeralKey(t)}this._ephemeralKey&&(t?this.init(this._ephemeralKey):this.changeToAvailable())}else if(o)try{this._retrievingEphemeralKey=this.getEphemeralKey(o),this._ephemeralKey=await this._retrievingEphemeralKey,t&&this.init(this._ephemeralKey)}catch(t){this.displayFailedToRetrieveEphemeralKey(t)}}async getEphemeralKey(t){return(await(await fetch("https://api.openai.com/v1/realtime/sessions",{method:Lt,body:JSON.stringify(this.rawBody),headers:{[It]:$t,[Ot]:`${Jt}${t}`}})).json()).client_secret.value}generateMethods(){return{updateConfig:t=>{var e;null==(e=this._dc)||e.send(JSON.stringify({[L]:"session.update",session:t}))},sendMessage:(t,e)=>{const i=e||"system",s=[{[L]:"system"===i||i===E?"input_text":M,text:t}],n={role:i,[L]:"message",content:s};this.sendMessage(n)}}}static buildAvatarConfig(t){const e="object"==typeof t&&t.avatar?JSON.parse(JSON.stringify(t.avatar)):{};return e.maxScale=e.maxScale&&e.maxScale>=1?e.maxScale:2.5,e}static buildButtonsConfig(t){var e,i,s,n,o,r,a,l,c,h,u,d,p,m,v;const f="object"==typeof t&&t.buttons?JSON.parse(JSON.stringify(t.buttons)):{};return null!=(s=null==(i=null==(e=f[G])?void 0:e[g])?void 0:i[M])&&s.content||(f[G]??(f[G]={}),(n=f[G])[g]??(n[g]={}),(o=f[G][g]).svg??(o.svg={}),(r=f[G][g].svg).content??(r.content=On)),null!=(c=null==(l=null==(a=f.toggle)?void 0:a[g])?void 0:l[M])&&c.content||(f.toggle??(f.toggle={}),(h=f.toggle)[g]??(h[g]={}),(u=f.toggle[g]).svg??(u.svg={}),(d=f.toggle[g].svg).content??(d.content=Pn),(p=f.toggle).active??(p.active={}),(m=f.toggle.active).svg??(m.svg={}),(v=f.toggle.active.svg).content??(v.content=$n)),f}createContainer(){const t=i();return t.id="deep-chat-openai-realtime-container",t.appendChild(this.createAvatarContainer()),t.appendChild(this.createButtonsContainer()),t.appendChild(this.createError()),t}createAvatarContainer(){var t,s;const n=i();return n.id="deep-chat-openai-realtime-avatar-container",Object.assign(n[e],null==(s=null==(t=this._avatarConfig)?void 0:t.styles)?void 0:s.container),n.appendChild(this._avatarEl),n}static createAvatar(t){var s;const n=i("img");return n.id="deep-chat-openai-realtime-avatar",Object.assign(n[e],null==(s=null==t?void 0:t.styles)?void 0:s[D]),n.src=(null==t?void 0:t.src)||Hi,n}createButtonsContainer(){var t;const n=i();n.id="deep-chat-openai-realtime-buttons-container",Object.assign(n[e],null==(t=this._buttonsConfig)?void 0:t.container),this._microphoneButton=this.createMicophoneButton();const o=s.createButtonContainer(this._microphoneButton.elementRef);this._toggleButton=this.createToggleButton();const r=s.createButtonContainer(this._toggleButton.elementRef);return n.appendChild(o),n.appendChild(r),n.appendChild(this.createLoading()),n}static createButtonContainer(e){const s=i();return s[t].add("deep-chat-openai-realtime-button-container"),s.appendChild(e),s}createMicophoneButton(){var e;const i=new Nn(null==(e=this._buttonsConfig)?void 0:e[G]);return i.elementRef[t].add(s.BUTTON_DEFAULT,"deep-chat-openai-realtime-microphone"),i.elementRef.onclick=()=>{i.isActive?(this.toggleMicorphone(!0),i.elementRef[t].replace(s.MICROPHONE_ACTIVE,s.BUTTON_DEFAULT),i.changeToDefault(),this._isMuted=!1):(this.toggleMicorphone(!1),i.elementRef[t].replace(s.BUTTON_DEFAULT,s.MICROPHONE_ACTIVE),_n.removeAriaAttributes(i.elementRef),i.changeToActive(),this._isMuted=!0)},i}toggleMicorphone(t){var e;null==(e=this._mediaStream)||e.getAudioTracks().forEach(e=>e.enabled=t)}createToggleButton(){var e;const i=new Nn(null==(e=this._buttonsConfig)?void 0:e.toggle);return i.elementRef[t].add(s.BUTTON_DEFAULT,"deep-chat-openai-realtime-toggle"),i.elementRef.onclick=async()=>{var t;if(i.isActive)i.changeToDefault(),this.stop();else try{if(this._ephemeralKey)this.displayLoading(),await this.init(this._ephemeralKey);else if(this._retrievingEphemeralKey){this.displayLoading();const e=await this._retrievingEphemeralKey;null!=(t=this._toggleButton)&&t.isActive&&await this.init(e)}else this.displayLoading(),await this.fetchEphemeralKey(!0)}catch(t){console[C]("Failed to start conversation:",t),this.displayError(),this.hideLoading()}},i}async init(t){const e=new RTCPeerConnection;this._pc=e;const s=i(W);s.autoplay=!0;const n=new AudioContext,o=n.createAnalyser();o.fftSize=256;const r=new Uint8Array(o.frequencyBinCount);this._pc.ontrack=async t=>{if(t.streams[0]){s.srcObject=t.streams[0];const e=n.createMediaStreamSource(t.streams[0]);"suspended"===n.state&&await n.resume(),e.connect(o),this.monitorFrequencies(o,r)}else console[C]("No streams found in the ontrack event."),this.displayError()},await navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{var i;e===this._pc&&(this._mediaStream=t,null==(i=this._pc)||i.addTrack(this._mediaStream.getTracks()[0]),this._isMuted&&this.toggleMicorphone(!1))}).catch(t=>{console[C]("Error accessing microphone:",t),this.displayError()}),this._dc=this._pc.createDataChannel("oai-events"),this._dc.addEventListener("message",async t=>{var e,i,s;const n=JSON.parse(t.data);if("session.created"===n.type)this.removeUnavailable(),this._toggleButton&&(_n.removeAriaAttributes(this._toggleButton.elementRef),this._toggleButton.changeToActive()),null==(i=null==(e=this._events)?void 0:e.started)||i.call(e),this._deepChat.dispatchEvent(new CustomEvent("sts-session-started")),this.hideLoading();else if("response.done"===n.type){const e=null==(s=JSON.parse(t.data).response.output)?void 0:s[0];if("function_call"===(null==e?void 0:e.type)){const{name:t,call_id:i}=e;try{await this.handleTool(t,e.arguments,i)}catch(t){this.stopOnError(t)}}}else n.type===C?this.stopOnError(n[C].message):n.type===Nt?this.stopOnError(n.message):"response.audio_transcript.delta"===n.type||("response.audio_transcript.done"===n.type?n.transcript&&Fi.onMessage(this._deepChat,{role:j,[M]:n.transcript},!1):"conversation.item.input_audio_transcription.completed"===n.type&&n.transcript&&Fi.onMessage(this._deepChat,{role:E,[M]:n.transcript},!1))});try{const i=await this._pc.createOffer();if(e!==this._pc||(await this._pc.setLocalDescription(i),e!==this._pc))return;const s=await fetch("https://api.openai.com/v1/realtime",{method:Lt,body:i.sdp,headers:{[Ot]:`${Jt}${t}`,[It]:"application/sdp"}});if(e!==this._pc)return;const n={[L]:"answer",sdp:await s[M]()};if(e!==this._pc||(await this._pc.setRemoteDescription(n),e!==this._pc))return}catch(t){console[C](t),this.displayError()}}monitorFrequencies(t,i){const s=()=>{var n;t.getByteFrequencyData(i);const o=1+i.reduce((t,e)=>t+e,0)/(255*i.length)*100/100*((null==(n=this._avatarConfig)?void 0:n.maxScale)-1);this._avatarEl[e].transform=`scale(${o})`,requestAnimationFrame(s)};s()}stopOnError(t){this.stop(),console[C](t),this.displayError()}stop(){var t,e,i;null==(t=this._mediaStream)||t.getTracks().forEach(t=>t.stop()),this._mediaStream=null,this._pc&&(this._pc.close(),this._pc=null,null==(i=null==(e=this._events)?void 0:e.stopped)||i.call(e),this._deepChat.dispatchEvent(new CustomEvent("sts-session-stopped")),this._dc=void 0)}changeToUnavailable(){this._microphoneButton&&s.changeButtonToUnavailable(this._microphoneButton),this._toggleButton&&s.changeButtonToUnavailable(this._toggleButton)}static changeButtonToUnavailable(e){e.elementRef[t].add(s.UNAVAILABLE),_n.removeAriaBusy(e.elementRef),_n.addAriaDisabled(e.elementRef),e.changeToUnavailable()}changeToAvailable(){this._microphoneButton&&s.changeButtonToAvailable(this._microphoneButton),this._toggleButton&&s.changeButtonToAvailable(this._toggleButton)}static changeButtonToAvailable(t){s.removeButtonUnavailable(t),t.changeToDefault()}removeUnavailable(){this._microphoneButton&&s.removeButtonUnavailable(this._microphoneButton),this._toggleButton&&s.removeButtonUnavailable(this._toggleButton)}static removeButtonUnavailable(e){_n.removeAriaDisabled(e.elementRef),e.elementRef[t].remove(s.UNAVAILABLE)}createError(){var t;const s=i();return s.id="deep-chat-openai-realtime-error",Object.assign(s[e],null==(t=this._errorConfig)?void 0:t[e]),this._errorElement=s,s}displayFailedToRetrieveEphemeralKey(t){console[C]("Failed to retrieve ephemeral key"),console[C](t),this.displayError()}displayError(){var t;this._errorElement&&(this._errorElement[e].display="block",this._errorElement.textContent=(null==(t=this._errorConfig)?void 0:t[M])||"Error",this.changeToUnavailable()),this.hideLoading()}createLoading(){var t,s;const n=i();return n.id="deep-chat-openai-realtime-loading",this._loadingElement=n,null!=(t=this._loadingConfig)&&t[A]&&(this._loadingElement.innerHTML=this._loadingConfig[A]),Object.assign(n[e],null==(s=this._loadingConfig)?void 0:s[e]),n[e].display="none",n}displayLoading(){var i,n,o;this._toggleButton&&(this._toggleButton.changeToActive(),this._toggleButton.elementRef[t].add(s.BUTTON_LOADING),_n.removeAriaDisabled(this._toggleButton.elementRef),_n.addAriaBusy(this._toggleButton.elementRef)),("boolean"!=typeof(null==(i=this._loadingConfig)?void 0:i.display)||this._loadingConfig.display)&&this._loadingElement&&(this._loadingElement[e].display="block",null!=(n=this._loadingConfig)&&n[A]||(this._loadingElement.textContent=(null==(o=this._loadingConfig)?void 0:o[M])||"Loading"))}hideLoading(){this._toggleButton&&(this._toggleButton.elementRef[t].remove(s.BUTTON_LOADING),_n.removeAriaBusy(this._toggleButton.elementRef)),this._loadingElement&&(this._loadingElement[e].display="none")}async handleTool(t,e,i){if(!this._functionHandlerI)throw Error(kt);const s=await this._functionHandlerI({name:t,arguments:e});if("object"!=typeof s||!In.isJson(s))throw Error('The `function_handler` response must be a JSON object, e.g. {response: "My response"}');const n={[L]:"function_call_output",call_id:i,output:JSON.stringify(s)};this.sendMessage(n)}sendMessage(t){if(!this._dc)return;const e=JSON.stringify({[L]:"conversation.item.create",item:t});this._dc.send(e);const i={[L]:"response.create"};this._dc.send(JSON.stringify(i))}isCustomView(){return!0}};Bn.BUTTON_DEFAULT="deep-chat-openai-realtime-button-default",Bn.BUTTON_LOADING="deep-chat-openai-realtime-button-loading",Bn.MICROPHONE_ACTIVE="deep-chat-openai-realtime-microphone-active",Bn.UNAVAILABLE="deep-chat-openai-realtime-button-unavailable";let Rn=Bn;const Jn=class t extends gs{constructor(e){var i,s,n;const o=JSON.parse(JSON.stringify(e.directConnection)),r=null==o?void 0:o.openAI;super(e,un(),cn,r),this.insertKeyPlaceholderText=this.genereteAPIKeyName("OpenAI"),this.keyHelpUrl="https://platform.openai.com/account/api-keys",this.url="https://api.openai.com/v1/audio/speech",this.permittedErrorPrefixes=[Tt];const a=null==(i=null==o?void 0:o.openAI)?void 0:i.textToSpeech;typeof a===Bt&&Object.assign(this.rawBody,a),(s=this.rawBody).model??(s.model=t.DEFAULT_MODEL),(n=this.rawBody).voice??(n.voice=t.DEFAULT_VOIDE),this.textInputPlaceholderText="Insert text to generate audio",this.rawBody.response_format="mp3"}preprocessBody(t,e){var i,s;const n=JSON.parse(JSON.stringify(t)),o=null==(s=null==(i=e[e.length-1])?void 0:i[M])?void 0:s.trim();return o&&""!==o&&(n.input=o),n}async callServiceAPI(t,e){this.url=this.connectSettings.url||this.url,this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){if(t instanceof Blob)return new Promise(e=>{const i=new FileReader;i.readAsDataURL(t),i.onload=t=>{e({[z]:[{[F]:t.target.result,[L]:W}]})}});if(t[C])throw t[C].message;return{[C]:C}}};Jn.DEFAULT_MODEL="tts-1",Jn.DEFAULT_VOIDE="alloy";let Fn=Jn;const Ln=class t extends gs{constructor(e){var i,s;const n=JSON.parse(JSON.stringify(e.directConnection)),o=null==n?void 0:n.openAI;super(e,un(),cn,o,{audio:{}}),this.insertKeyPlaceholderText=this.genereteAPIKeyName("OpenAI"),this.keyHelpUrl="https://platform.openai.com/account/api-keys",this.url="",this.permittedErrorPrefixes=[Tt],this.textInputPlaceholderText=qt,this._service_url=t.AUDIO_TRANSCRIPTIONS_URL;const r=null==(i=null==n?void 0:n.openAI)?void 0:i[W];"object"==typeof r&&(this.processConfig(r),t.cleanConfig(r),Object.assign(this.rawBody,r)),(s=this.rawBody).model??(s.model=t.DEFAULT_MODEL),this.rawBody.response_format="json",this.canSendMessage=t.canSendFileMessage}static canSendFileMessage(t,e){return!(null==e||!e[0])}processConfig(e){null!=e&&e.type&&"translation"===e.type&&(this._service_url=t.AUDIO_TRANSLATIONS_URL,delete e.language)}static cleanConfig(t){delete t.type}static createFormDataBody(t,e){const i=new FormData;return i.append("file",e),Object.keys(t).forEach(e=>{i.append(e,String(t[e]))}),i}preprocessBody(t,e){var i,s;const n=JSON.parse(JSON.stringify(t)),o=null==(s=null==(i=e[e.length-1])?void 0:i[M])?void 0:s.trim();return o&&""!==o&&(n.prompt=o),n}async callServiceAPI(e,i,s){var n;if(null==(n=this.connectSettings)||!n.headers)throw new Error(ft);if(null==s||!s[0])throw new Error(gt);this.url=this.connectSettings.url||this._service_url;const o=this.preprocessBody(this.rawBody,i),r=t.createFormDataBody(o,s[0]);ts.tempRemoveContentHeader(this.connectSettings,us.request.bind(this,this,r,e),!1)}async extractResultData(t){if(t[C])throw t[C].message;return{[M]:t[M]}}};Ln.AUDIO_TRANSCRIPTIONS_URL="https://api.openai.com/v1/audio/transcriptions",Ln.AUDIO_TRANSLATIONS_URL="https://api.openai.com/v1/audio/translations",Ln.DEFAULT_MODEL="whisper-1";let qn=Ln;const zn="Ocp-Apim-Subscription-Key",Dn="https://learn.microsoft.com/en-us/azure/api-management/api-management-subscriptions#create-and-manage-subscriptions-in-azure-portal",Un=(t,e)=>({[zn]:e,[It]:"application/ssml+xml","X-Microsoft-OutputFormat":t}),Hn=t=>({[zn]:t,Accept:$t}),Vn=(t,e,i,s)=>{t[C]?s(mt):i(e)},Wn=t=>({[zn]:t,[It]:$t}),Gn=(t,e,i,s)=>{var n;"401"===(null==(n=t[C])?void 0:n.code)?s(mt):i(e)},Zn=(t,e,i,s)=>{t.json().then(t=>{Array.isArray(t)||401e3!==t[C].code?i(e):s(mt)})},Kn=(t,e)=>{const i={[zn]:e,[It]:$t};return t&&(i["Ocp-Apim-Subscription-Region"]=t),i};class Xn extends gs{constructor(t,e,i,s,n){super(t,{url:`${i}/language/analyze-text/jobs?api-version=2022-10-01-preview`,method:Lt,createHeaders:t=>({[zn]:`${t}`}),handleVerificationResult:Gn},e,s,n),this.insertKeyPlaceholderText="Azure Language Subscription Key",this.keyHelpUrl=Dn,this.permittedErrorPrefixes=["Access"]}}const Qn=class t extends Xn{constructor(e){var i,s,n,o;const r=null==(s=null==(i=e.directConnection)?void 0:i.azure)?void 0:s.summarization,a=null==(n=e.directConnection)?void 0:n.azure;super(e,Wn,r.endpoint,a),this.permittedErrorPrefixes=[t.ENDPOINT_ERROR_MESSAGE],this.url="",this.textInputPlaceholderText="Insert text to summarize",this.isTextInputDisabled=!1,r.endpoint?((o=this.rawBody).language??(o.language="en"),Object.assign(this.rawBody,r),this.url=`${r.endpoint}/language/analyze-text/jobs?api-version=2022-10-01-preview`):(this.isTextInputDisabled=!0,this.canSendMessage=()=>!1,setTimeout(()=>{e.addMessage({[C]:t.ENDPOINT_ERROR_MESSAGE})}))}preprocessBody(t,e){const i=e[e.length-1][M];if(i)return{analysisInput:{documents:[{id:"1",language:t.language,[M]:i}]},tasks:[{kind:"ExtractiveSummarization"}]}}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this)),this.messages=t}async extractResultData(t){var e;if(t[C])throw t[C].message;if(this.messages&&this.completionsHandlers){this.asyncCallInProgress=!0;const i=t.headers.get("operation-location"),s={method:Ft,headers:null==(e=this.connectSettings)?void 0:e.headers};us.executePollRequest(this,i,s,this.messages)}return{[M]:""}}async extractPollResultData(t){if(t[C])throw t[C];if("running"===t.status||"notStarted"===t.status)return{timeoutMS:2e3};if(t.errors.length>0)throw t.errors[0];if(t.tasks.items[0].results.errors.length>0)throw t.tasks.items[0].results.errors[0];let e="";for(const i of t.tasks.items[0].results.documents[0].sentences)e+=i[M];return{[M]:e||""}}};Qn.ENDPOINT_ERROR_MESSAGE=`Please define the azure endpoint. [More Information](${T}directConnection/Azure#Summarization)`;let Yn=Qn;const to=t=>({[Ot]:t,[It]:"application/octet-stream"}),eo=(t,e,i,s)=>{const n=t;n[C]?"invalid_api_key"===n[C].code?s(mt):s(vt):i(e)};class io extends gs{constructor(t){var e;const i=null==(e=t.directConnection)?void 0:e.assemblyAI;super(t,js("https://api.assemblyai.com/v2/upload",Lt,eo),to,i,{audio:{}}),this.insertKeyPlaceholderText=this.genereteAPIKeyName("AssemblyAI"),this.keyHelpUrl="https://www.assemblyai.com/app/account",this.url="https://api.assemblyai.com/v2/upload",this.isTextInputDisabled=!0,this.textInputPlaceholderText=qt,this.permittedErrorPrefixes=[_t,Tt],this.canSendMessage=io.canFileSendMessage}static canFileSendMessage(t,e){return!(null==e||!e[0])}async callServiceAPI(t,e,i){var s;if(null==(s=this.connectSettings)||!s.headers)throw new Error(ft);if(null==i||!i[0])throw new Error(gt);us.request(this,i[0],t,!1)}async extractResultData(t){var e,i;if(t[C])throw t[C];const s=null==(i=null==(e=this.connectSettings)?void 0:e.headers)?void 0:i[Ot],n=await(async(t,e)=>{const i={[Mt]:t,[Pt]:$t},s=`https://api.assemblyai.com/v2/transcript/${(await(await fetch("https://api.assemblyai.com/v2/transcript",{method:Lt,body:JSON.stringify({audio_url:e}),headers:i})).json()).id}`;let n;for(;!n;){const t=await(await fetch(s,{headers:i})).json();if(t.status===Rt)n=t;else{if(t.status===C)throw new Error(`Transcription failed: ${t[C]}`);await new Promise(t=>setTimeout(t,3e3))}}return n})(s,t.upload_url);return{[M]:n[M]}}}const so=class extends gs{constructor(t,e,i,s,n){super(t,{url:`https://${i}.api.cognitive.microsoft.com/sts/v1.0/issuetoken`,method:Lt,createHeaders:t=>({[zn]:`${t}`}),handleVerificationResult:Vn},e,s,n),this.insertKeyPlaceholderText="Azure Speech Subscription Key",this.keyHelpUrl=Dn}};so.REGION_ERROR_PREFIX=`Please define a region config property. [More Information](${T}directConnection/Azure#`;let no=so;const oo=class t extends no{constructor(e){var i,s,n,o,r,a;const l=null==(s=null==(i=e.directConnection)?void 0:i.azure)?void 0:s.textToSpeech,c=null==(n=e.directConnection)?void 0:n.azure;super(e,Un.bind({},(null==l?void 0:l.outputFormat)||"audio-16khz-128kbitrate-mono-mp3"),l.region,c),this.permittedErrorPrefixes=[t.REGION_ERROR_MESSAGE],this.isTextInputDisabled=!1,this.url="",l.region?(Object.assign(this.rawBody,l),(o=this.rawBody).lang??(o.lang="en-US"),(r=this.rawBody).name??(r.name="en-US-JennyNeural"),(a=this.rawBody).gender??(a.gender="Female"),this.url=`https://${l.region}.tts.speech.microsoft.com/cognitiveservices/v1`):(this.isTextInputDisabled=!0,this.canSendMessage=()=>!1,setTimeout(()=>{e.addMessage({[C]:t.REGION_ERROR_MESSAGE})}))}preprocessBody(t,e){const i=e[e.length-1][M];if(i)return`<speak version='1.0' xml:lang='${t.lang}'>\n      <voice xml:lang='${t.lang}' xml:gender='${t.gender}' name='${t.name}'>\n        ${i}\n      </voice>\n    </speak>`}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),void 0,!1)}async extractResultData(t){return new Promise(e=>{const i=new FileReader;i.readAsDataURL(t),i.onload=t=>{e({[z]:[{[F]:t.target.result,[L]:W}]})}})}};oo.REGION_ERROR_MESSAGE=`${no.REGION_ERROR_PREFIX}TextToSpeech)`;let ro=oo;const ao=class t extends no{constructor(e){var i,s,n;const o=null==(s=null==(i=e.directConnection)?void 0:i.azure)?void 0:s.speechToText,r=null==(n=e.directConnection)?void 0:n.azure,a={audio:{[z]:{acceptedFormats:".wav,.ogg"}}};if(super(e,Hn,o.region,r,a),this.permittedErrorPrefixes=[t.REGION_ERROR_MESSAGE],this.url="",this.isTextInputDisabled=!0,this.textInputPlaceholderText=qt,o.region){this.canSendMessage=t.canFileSendMessage;const e=o.lang||"en-US";this.url=`https://${o.region}.stt.speech.microsoft.com/speech/recognition/conversation/cognitiveservices/v1?language=${e}&format=detailed`,this.recordAudio=void 0}else this.isTextInputDisabled=!0,this.canSendMessage=()=>!1,setTimeout(()=>{e.addMessage({[C]:t.REGION_ERROR_MESSAGE})})}static canFileSendMessage(t,e){return!(null==e||!e[0])}async callServiceAPI(t,e,i){var s,n;if(null==(s=this.connectSettings)||!s.headers)throw new Error(ft);if(null==i||!i[0])throw new Error(gt);null!=(n=this.connectSettings)&&n.headers&&(this.connectSettings.headers[It]=i[0].name.toLocaleLowerCase().endsWith(".wav")?"audio/wav; codecs=audio/pcm; samplerate=16000":"audio/ogg; codecs=opus"),us.request(this,i[0],t,!1)}async extractResultData(t){if(t[C])throw t[C];return{[M]:t.DisplayText||""}}};ao.REGION_ERROR_MESSAGE=`${no.REGION_ERROR_PREFIX}SpeechToText)`;let lo=ao;class co extends gs{constructor(t){var e,i,s;const n=null==(i=null==(e=t.directConnection)?void 0:e.azure)?void 0:i.translation,o=null==(s=t.directConnection)?void 0:s.azure;var r;super(t,(r=n.region,{url:"https://api.cognitive.microsofttranslator.com/translate?api-version=3.0&to=es",method:Lt,createHeaders:t=>Kn(r,t),handleVerificationResult:Zn}),Kn.bind({},null==n?void 0:n.region),o),this.insertKeyPlaceholderText="Azure Translate Subscription Key",this.keyHelpUrl="https://learn.microsoft.com/en-us/azure/api-management/api-management-subscriptions#create-and-manage-subscriptions-in-azure-portal",this.url="",this.url=`https://api.cognitive.microsofttranslator.com/translate?api-version=3.0&to=${n.language||"es"}`}preprocessBody(t){const e=t[t.length-1][M];if(e)return[{Text:e}]}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){var e;if(Array.isArray(t))return{[M]:(null==(e=t[0].translations)?void 0:e[0][M])||""};throw t[C]}}class ho extends gs{constructor(t){var e,i;const s=JSON.parse(JSON.stringify(t.directConnection)),n=s.bigModel;super(t,sn(),tn,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("BigModel"),this.keyHelpUrl="https://open.bigmodel.cn/usercenter/apikeys",this.url="https://open.bigmodel.cn/api/paas/v4/images/generations",this.permittedErrorPrefixes=[Ot,Et];const o=null==(e=s.bigModel)?void 0:e[U];typeof o===Bt&&(this.cleanConfig(o),Object.assign(this.rawBody,o)),(i=this.rawBody).model??(i.model="cogview-4-250304")}cleanConfig(t){delete t.key}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=e[e.length-1];return i.prompt=(null==s?void 0:s[M])||"",i}async callServiceAPI(t,e){return this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){const e=t.data.map(t=>null!=t&&t.url?{[F]:t.url,[L]:D}:{[F]:"",[L]:D});return{[z]:e}}}const uo=t=>({[It]:$t,[Ot]:`${Jt}${t}`}),po=(t,e,i,s)=>{const n=t;n[C]?n[C].message===At?s(mt):s(vt):i(e)},mo=()=>js("https://api.groq.com/openai/v1/models",Ft,po);class vo extends gs{constructor(t){var e,i,s,n;const o=JSON.parse(JSON.stringify(t.directConnection)),r=o.groq;super(t,mo(),uo,r),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Groq"),this.keyHelpUrl="https://console.groq.com/keys",this.url="https://api.groq.com/openai/v1/audio/speech",this.permittedErrorPrefixes=[Tt,"property"];const a=null==(e=o.groq)?void 0:e.textToSpeech;typeof a===Bt&&this.completeConfig(a),(i=this.rawBody).model??(i.model="playai-tts"),(s=this.rawBody).voice??(s.voice="Fritz-PlayAI"),(n=this.rawBody).response_format??(n.response_format="mp3")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=e[e.length-1];return i.input=(null==s?void 0:s[M])||"",i}async callServiceAPI(t,e){return this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){const e=this.rawBody.response_format||"mp3",i=new Blob([t],{[L]:`audio/${e}`}),s=URL.createObjectURL(i);return{files:[{[F]:s,[L]:W}]}}}class fo extends gs{constructor(t){var e,i;const s=JSON.parse(JSON.stringify(t.directConnection)),n=s.together;super(t,an(),on,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Together AI"),this.keyHelpUrl="https://api.together.xyz/settings/api-keys",this.url="https://api.together.xyz/v1/images/generations",this.permittedErrorPrefixes=[Nt,Et];const o=null==(e=s.together)?void 0:e[U];typeof o===Bt&&this.completeConfig(o),(i=this.rawBody).model??(i.model="black-forest-labs/FLUX.1-schnell-Free")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=e[e.length-1];return i.prompt=(null==s?void 0:s[M])||"",i}async callServiceAPI(t,e){return this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){const e=t.data.map(t=>null!=t&&t.url?{[F]:t.url,[L]:D}:null!=t&&t.b64_json?{[F]:`data:image/png;base64,${t.b64_json}`,[L]:D}:{[F]:"",[L]:D});return{[z]:e}}}class go extends gs{constructor(t,e,i,s,n){var o,r,a,l,c;const h=JSON.parse(JSON.stringify(t.directConnection));super(t,e||un(),i||cn,s||h.openAI),this.insertKeyPlaceholderText=this.genereteAPIKeyName("OpenAI"),this.keyHelpUrl="https://platform.openai.com/account/api-keys",this.url="https://api.openai.com/v1/chat/completions",this.permittedErrorPrefixes=[jt,"Invalid value"];const u=n||(null==(o=h.openAI)?void 0:o.chat);typeof u===Bt&&this.completeConfig(u,null==(l=null==(a=null==(r=t.directConnection)?void 0:r.openAI)?void 0:a.chat)?void 0:l.function_handler),this.maxMessages??(this.maxMessages=-1),(c=this.rawBody).model??(c.model="gpt-4o")}static getFileContent(t){return t.map(t=>{var e,i,s;if(t.type===W){const n=null==(e=t.src)?void 0:e.split(",")[1],o=(null==(s=null==(i=t.name)?void 0:i.split(".").pop())?void 0:s.toLowerCase())||"wav";return{[L]:"input_audio",input_audio:{data:n,format:o}}}return{[L]:"image_url",image_url:{url:t.src}}})}static getContent(t){if(t[z]&&t[z].length>0){const e=go.getFileContent(t[z]);return t[M]&&t[M].trim().length>0&&e.unshift({[L]:M,[M]:t[M]}),e}return t[M]}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:go.getContent(t),role:gs.getRoleViaUser(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){var i,s,n,o,r,a;if(t[C])throw t[C].message;if(null!=(s=null==(i=t.choices)?void 0:i[0])&&s.delta)return this.extractStreamResult(t.choices[0],e);if(null!=(o=null==(n=t.choices)?void 0:n[0])&&o.message){if(t.choices[0].message.tool_calls)return this.handleToolsGeneric(t.choices[0].message,this.functionHandler,this.messages,e);if(null!=(r=t.choices[0].message)&&r[W]){const e=this.deepChat.textToSpeech,i="object"==typeof e&&"boolean"==typeof(null==(a=null==e?void 0:e[W])?void 0:a.displayText);return{[z]:[{[F]:`data:audio/wav;base64,${t.choices[0].message[W].data}`,[L]:W}],[M]:i?t.choices[0].message[W].transcript:void 0}}return{[M]:t.choices[0].message.content}}return{[M]:""}}async extractStreamResult(t,e){return this.extractStreamResultWToolsGeneric(this,t,this.functionHandler,e)}}class bo extends go{constructor(t){var e,i,s,n,o,r,a;const l=JSON.parse(JSON.stringify(t.directConnection)),c=l.azure,h=(null==(i=null==(e=l.azure)?void 0:e.openAI)?void 0:i.urlDetails)||{},u=null==(n=null==(s=l.azure)?void 0:s.openAI)?void 0:n.chat;if(super(t,wn(h),yn,c,u),this.permittedErrorPrefixes=[bn],this.isTextInputDisabled=!1,typeof u===Bt){const{function_handler:e}=null==(a=null==(r=null==(o=t.directConnection)?void 0:o.azure)?void 0:r.openAI)?void 0:a.chat;e&&(this.functionHandler=e)}xn(h)?this.url=bo.buildURL(h):(this.isTextInputDisabled=!0,this.canSendMessage=()=>!1,setTimeout(()=>{t.addMessage({[C]:bn})}))}static buildURL(t){const{endpoint:e,deploymentId:i,version:s}=t;return`${e}/openai/deployments/${i}/chat/completions?api-version=${s}`}}class yo extends gs{constructor(t){var e,i,s,n,o;const r=JSON.parse(JSON.stringify(t.directConnection)),a=r.bigModel;super(t,sn(),tn,a),this.insertKeyPlaceholderText=this.genereteAPIKeyName("BigModel"),this.keyHelpUrl="https://open.bigmodel.cn/usercenter/apikeys",this.url="https://open.bigmodel.cn/api/paas/v4/chat/completions",this.permittedErrorPrefixes=[Ot,Et];const l=null==(e=r.bigModel)?void 0:e.chat;typeof l===Bt&&this.completeConfig(l,null==(n=null==(s=null==(i=t.directConnection)?void 0:i.bigModel)?void 0:s.chat)?void 0:n.function_handler),this.maxMessages??(this.maxMessages=-1),(o=this.rawBody).model??(o.model="glm-4.5")}static getFileContent(t){return t.map(t=>t.type===D?{[L]:"image_url",image_url:{url:t.src||""}}:{[L]:q,file_url:{url:t.src||""}})}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:yo.getTextWFilesContent(t,yo.getFileContent),role:gs.getRoleViaAI(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){if(t[C])throw t[C].message;if(t.choices.length>0){if(void 0!==t.choices[0].delta)return this.extractStreamResult(t.choices[0],e);if(void 0!==t.choices[0].message){const i=t.choices[0].message;return i.tool_calls?this.handleToolsGeneric({tool_calls:i.tool_calls},this.functionHandler,this.messages,e):{[M]:i.content}}}return{[M]:""}}async extractStreamResult(t,e){var i,s,n,o;const{delta:r,finish_reason:a}=t,l=null==(i=this.messages)?void 0:i.messageToElements[this.messages.messageToElements.length-2];if((null==l?void 0:l[0].role)===j&&0===(null==(s=null==l?void 0:l[0][M])?void 0:s.replace(/\n/g,"").trim().length)&&(null==(n=this.messages)||n.removeMessage(l[1][M]),null==(o=this.messages)||o.messageToElements.splice(this.messages.messageToElements.length-2,1)),"tool_calls"===a){if(r.tool_calls){const t={tool_calls:r.tool_calls};return this.handleToolsGeneric(t,this.functionHandler,this.messages,e)}return{[M]:(null==r?void 0:r.content)||""}}return{[M]:(null==r?void 0:r.content)||""}}}class wo extends gs{constructor(t){var e,i;const s=JSON.parse(JSON.stringify(t.directConnection)),n=s.together;super(t,an(),on,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Together AI"),this.keyHelpUrl="https://api.together.xyz/settings/api-keys",this.url="https://api.together.xyz/v1/chat/completions",this.permittedErrorPrefixes=[Nt,Et];const o=null==(e=s.together)?void 0:e.chat;typeof o===Bt&&this.completeConfig(o),this.maxMessages??(this.maxMessages=-1),(i=this.rawBody).model??(i.model="meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:t[M]||"",role:t.role===j?N:t.role}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t){if(t[C])throw t[C].message;if(t.choices.length>0){if(void 0!==t.choices[0].message)return{[M]:t.choices[0].message.content};if(void 0!==t.choices[0].delta)return{[M]:t.choices[0].delta.content}}return{[M]:""}}}const xo=class t extends gs{constructor(e){var i;const{directConnection:s}=e,n=null==s?void 0:s.openAI,o={images:{[z]:{acceptedFormats:".png",maxNumberOfFiles:2}}};super(e,un(),cn,n,o),this.insertKeyPlaceholderText=this.genereteAPIKeyName("OpenAI"),this.keyHelpUrl="https://platform.openai.com/account/api-keys",this.url="",this.permittedErrorPrefixes=[jt,"Invalid input image"];const r=null==(i=null==s?void 0:s.openAI)?void 0:i[U];if(this[H]){const t="object"==typeof r&&r.size?Number.parseInt(r.size):1024;this[H][z]={dimensions:{width:t,height:t}}}typeof r===Bt&&Object.assign(this.rawBody,r),this.canSendMessage=t.canFileSendMessage}static canFileSendMessage(t,e){return!(null==e||!e[0])||!(!t||""===t.trim())}static createFormDataBody(t,e,i){const s=new FormData;return s.append(D,e),i&&s.append("mask",i),Object.keys(t).forEach(e=>{s.append(e,String(t[e]))}),s}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t));return e&&""!==e&&(i.prompt=e),i}callApiWithImage(e,i,s){var n,o;let r;const a=null==(o=null==(n=i[i.length-1])?void 0:n[M])?void 0:o.trim();if(s[1]||a&&""!==a){this.url=t.IMAGE_EDIT_URL;const e=this.preprocessBody(this.rawBody,a);r=t.createFormDataBody(e,s[0],s[1])}else this.url=t.IMAGE_VARIATIONS_URL,r=t.createFormDataBody(this.rawBody,s[0]);ts.tempRemoveContentHeader(this.connectSettings,us.request.bind(this,this,r,e),!1)}async callServiceAPI(e,i,s){var n;if(null==(n=this.connectSettings)||!n.headers)throw new Error(ft);if(null!=s&&s[0])this.callApiWithImage(e,i,s);else{if(!this.connectSettings)throw new Error(ft);this.url=t.IMAGE_GENERATION_URL;const s=this.preprocessBody(this.rawBody,i[i.length-1][M]);us.request(this,s,e)}}async extractResultData(t){if(t[C])throw t[C].message;const e=t.data.map(t=>t.url?{[F]:t.url,[L]:D}:{[F]:`${qs}${t.b64_json}`,[L]:D});return{[z]:e}}};xo.IMAGE_GENERATION_URL="https://api.openai.com/v1/images/generations",xo.IMAGE_VARIATIONS_URL="https://api.openai.com/v1/images/variations",xo.IMAGE_EDIT_URL="https://api.openai.com/v1/images/edits";let ko=xo;const So=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),_o=(t,e,i,s)=>{const n=t;n[C]?n[C].type===Et?s(mt):s(vt):i(e)};class Oo extends gs{constructor(t){var e,i,s,n;const o=JSON.parse(JSON.stringify(t.directConnection)).openRouter;super(t,js("https://openrouter.ai/api/v1/key",Ft,_o),So,o),this.insertKeyPlaceholderText=this.genereteAPIKeyName("OpenRouter"),this.keyHelpUrl="https://openrouter.ai/keys",this.url="https://openrouter.ai/api/v1/chat/completions",this.permittedErrorPrefixes=[Nt,Et],typeof o===Bt&&this.completeConfig(o,null==(i=null==(e=t.directConnection)?void 0:e.openRouter)?void 0:i.function_handler),this.maxMessages??(this.maxMessages=-1),(s=this.rawBody).model??(s.model="openai/gpt-4o"),(n=this.rawBody).max_tokens??(n.max_tokens=1e3)}static getAudioContent(t){return t.filter(t=>t.type===W).map(t=>{var e,i,s;const n=null==(e=t.src)?void 0:e.split(",")[1],o=null==(s=null==(i=t.src)?void 0:i.match(/data:audio\/([^;]+)/))?void 0:s[1];return{[L]:"input_audio",input_audio:{data:n||"",format:"wav"===o||"mp3"===o?o:"mp3"}}}).filter(t=>t.input_audio.data.length>0)}static getContent(t){if(t[z]&&t[z].length>0){const e=[...Oo.getImageContent(t[z]),...Oo.getAudioContent(t[z])];return t[M]&&t[M].trim().length>0&&e.unshift({[L]:M,[M]:t[M]}),e.length>0?e:t[M]||""}return t[M]||""}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:Oo.getContent(t),role:gs.getRoleViaUser(t.role)})),n=[];return this.systemMessage&&n.push({role:"system",content:this.systemMessage}),n.push(...s),i.messages=n,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){var i,s,n,o;if(t[C])throw t[C].message;if("chat.completion.chunk"===t.object){const n=null==(i=t.choices)?void 0:i[0];if(null!=n&&n.delta)return this.extractStreamResult(n,e);if(null!=(s=t.message)&&s[U]){const e=t.message[U].map(t=>({[F]:t.image_url.url}));return{[M]:t.message.content||"",[z]:e}}return{[M]:""}}if("chat.completion"===t.object){const i=null==(n=t.choices)?void 0:n[0];if(null!=i&&i.message){if(i.message.tool_calls)return this.handleToolsGeneric({tool_calls:i.message.tool_calls},this.functionHandler,this.messages,e);const t=(null==(o=i.message[U])?void 0:o.map(t=>({[F]:t.image_url.url})))||[];return{[M]:i.message.content||"",files:t}}}return{[M]:""}}async extractStreamResult(t,e){const{delta:i}=t;if(null!=i&&i[U]){const t=i[U].map(t=>({[F]:t.image_url.url}));return{[M]:i.content||"",[z]:t}}return this.extractStreamResultWToolsGeneric(this,t,this.functionHandler,e)}}const Mo=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),Ao=(t,e,i,s)=>{t[C]?s(mt):i(e)};class Co extends gs{constructor(t){var e;const i=JSON.parse(JSON.stringify(t.directConnection)).perplexity;super(t,js("https://api.perplexity.ai/chat/completions",Lt,Ao),Mo,i),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Perplexity"),this.keyHelpUrl="https://www.perplexity.ai/settings/api",this.url="https://api.perplexity.ai/chat/completions",this.permittedErrorPrefixes=[Tt,_t,"Permission denied"],typeof i===Bt&&this.completeConfig(i),this.maxMessages??(this.maxMessages=-1),(e=this.rawBody).model??(e.model="sonar")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:t[M]||"",role:gs.getRoleViaUser(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t){if(t[C])throw t[C].message;if(t.choices&&t.choices.length>0){const e=t.choices[0];if(e.delta&&e.delta.content)return{[M]:e.delta.content};if(e.message&&e.message.content)return{[M]:e.message.content}}return{[M]:""}}}const To=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),jo=(t,e,i,s)=>{const n=t;n[C]?n[C].type===Et?s(mt):s(vt):i(e)};class Eo extends gs{constructor(t){var e,i,s;const n=JSON.parse(JSON.stringify(t.directConnection)).deepSeek;super(t,js("https://api.deepseek.com/models",Ft,jo),To,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("DeepSeek"),this.keyHelpUrl="https://platform.deepseek.com/api_keys",this.url="https://api.deepseek.com/v1/chat/completions",this.permittedErrorPrefixes=[Nt,Et],typeof n===Bt&&this.completeConfig(n),this.maxMessages??(this.maxMessages=-1),(e=this.rawBody).model??(e.model="deepseek-chat"),(i=this.rawBody).temperature??(i.temperature=1),(s=this.rawBody).max_tokens??(s.max_tokens=4096)}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:t[M]||"",role:gs.getRoleViaUser(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t){if(t[C])throw t[C].message;if(t.choices&&t.choices.length>0){const e=t.choices[0];if(e.delta&&e.delta.content)return{[M]:e.delta.content};if(e.message&&e.message.content)return{[M]:e.message.content}}return{[M]:""}}}const No=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),Io=(t,e,i,s)=>{var n;1004===(null==(n=t.base_resp)?void 0:n.status_code)?s(mt):i(e)};class Po extends gs{constructor(t){var e;const i=JSON.parse(JSON.stringify(t.directConnection)).miniMax;super(t,js("https://api.minimax.io/v1/files/delete",Lt,Io),No,i),this.insertKeyPlaceholderText=this.genereteAPIKeyName("MiniMax"),this.keyHelpUrl="https://www.minimaxi.com",this.url="https://api.minimax.io/v1/text/chatcompletion_v2",this.permittedErrorPrefixes=[Nt,Et,"insufficient balance"],typeof i===Bt&&this.completeConfig(i),this.maxMessages??(this.maxMessages=-1),(e=this.rawBody).model??(e.model="MiniMax-M1")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:t[M]||"",role:gs.getRoleViaUser(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t){var e;if(t[C])throw t[C].message;if(t.choices&&t.choices.length>0){const e=t.choices[0];if(e.delta&&e.delta.content)return{[M]:e.delta.content};if(e.message&&e.message.content)return{[M]:e.message.content}}if("number"==typeof(null==(e=t.base_resp)?void 0:e.status_code)&&t.base_resp.status_code>0)throw t.base_resp.status_msg;return{[M]:""}}}const $o=t=>({[Ot]:`${Jt}${t}`,[It]:$t,accept:$t}),Bo=(t,e,i,s)=>{t.detail?s(mt):i(e)};class Ro extends gs{constructor(t){var e,i,s;const n=JSON.parse(JSON.stringify(t.directConnection)).mistral;super(t,js("https://api.mistral.ai/v1/models",Ft,Bo),$o,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Mistral"),this.keyHelpUrl="https://console.mistral.ai/api-keys/",this.url="https://api.mistral.ai/v1/chat/completions",this.permittedErrorPrefixes=[Tt],typeof n===Bt&&this.completeConfig(n,null==(i=null==(e=t.directConnection)?void 0:e.mistral)?void 0:i.function_handler),this.maxMessages??(this.maxMessages=-1),(s=this.rawBody).model??(s.model="mistral-small-latest")}static getFileContent(t){return t.map(t=>t.type===D?{[L]:"image_url",image_url:t.src||""}:{[L]:M,[M]:`[Unsupported file type: ${t.type}]`})}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({role:gs.getRoleViaAI(t.role),content:gs.getTextWFilesContent(t,Ro.getFileContent)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){if(t.message)throw t.message;if(t[C])throw t[C].message;if(t.choices&&t.choices.length>0){const i=t.choices[0];if(i.delta)return this.extractStreamResult(i,e);if(i.message)return i.message.tool_calls?this.handleToolsGeneric({tool_calls:i.message.tool_calls},this.functionHandler,this.messages,e):{[M]:i.message.content||""}}return{[M]:""}}async extractStreamResult(t,e){const{delta:i,finish_reason:s}=t;if("tool_calls"===s&&null!=i&&i.tool_calls){const t={tool_calls:i.tool_calls};return this.handleToolsGeneric(t,this.functionHandler,this.messages,e)}return{[M]:(null==i?void 0:i.content)||""}}}class Jo extends gs{constructor(t){var e,i,s,n,o;const r=JSON.parse(JSON.stringify(t.directConnection)),a=r.groq;super(t,mo(),uo,a),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Groq"),this.keyHelpUrl="https://console.groq.com/keys",this.url="https://api.groq.com/openai/v1/chat/completions",this.permittedErrorPrefixes=[Tt,"property"];const l=null==(e=r.groq)?void 0:e.chat;typeof l===Bt&&this.completeConfig(l,null==(n=null==(s=null==(i=t.directConnection)?void 0:i.groq)?void 0:s.chat)?void 0:n.function_handler),this.maxMessages??(this.maxMessages=-1),(o=this.rawBody).model??(o.model="llama-3.3-70b-versatile")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:Jo.getTextWImagesContent(t),role:t.role===j?N:t.role}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){var i,s,n,o;if(t[C])throw t[C].message;return null!=(s=null==(i=t.choices)?void 0:i[0])&&s.delta?this.extractStreamResult(t.choices[0],e):null!=(o=null==(n=t.choices)?void 0:n[0])&&o.message?t.choices[0].message.tool_calls?this.handleToolsGeneric(t.choices[0].message,this.functionHandler,this.messages,e,{message:this.systemMessage}):{[M]:t.choices[0].message.content||""}:{[M]:""}}async extractStreamResult(t,e){return this.extractStreamResultWToolsGeneric(this,t,this.functionHandler,e)}}const Fo=t=>({[Ot]:`${Jt}${t}`,[It]:$t,accept:$t}),Lo=(t,e,i,s)=>{"string"==typeof t.message?s(mt):i(e)};class qo extends gs{constructor(t){var e;const i=JSON.parse(JSON.stringify(t.directConnection)).cohere;if(super(t,js("https://api.cohere.ai/v1/models",Ft,Lo),Fo,i),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Cohere"),this.keyHelpUrl="https://dashboard.cohere.ai/api-keys",this.permittedErrorPrefixes=["invalid"],this.url="https://api.cohere.com/v2/chat",typeof i===Bt){const t=Gt.processCohere(i);this.canSendMessage=()=>t,this.cleanConfig(i),Object.assign(this.rawBody,i)}this.maxMessages??(this.maxMessages=-1),(e=this.rawBody).model??(e.model="command-a-03-2025")}cleanConfig(t){delete t.key}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=e.filter(t=>t[M]);return i.messages=s.map(t=>({role:gs.getRoleViaAI(t.role),content:t[M]})),i}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{readable:!0})}async extractResultData(t){var e,i,s;if("string"==typeof t.message)throw t.message;if(this.stream&&t[M]){const e=qo.parseBundledEvents(t[M]);return{text:qo.aggregateBundledEventsText(e)}}if("message"in t&&null!=(s=null==(i=null==(e=t.message)?void 0:e.content)?void 0:i[0])&&s[M])return{[M]:t.message.content[0][M]};throw new Error("Invalid response format from Cohere API")}static parseBundledEvents(t){const e=t.trim().split("\n"),i=[];for(const t of e)if(t.trim())try{const e=JSON.parse(t);i.push(e)}catch(e){console[C]("Failed to parse line:",t,e)}return i}static aggregateBundledEventsText(t){return t.filter(t=>{var e,i,s;return"content-delta"===t.type&&(null==(s=null==(i=null==(e=t.delta)?void 0:e.message)?void 0:i.content)?void 0:s[M])}).map(t=>{var e,i,s;return null==(s=null==(i=null==(e=t.delta)?void 0:e.message)?void 0:i.content)?void 0:s[M]}).join("")}}const zo=()=>({[It]:$t}),Do=(t,e,i,s)=>{var n;const o=t;o[C]?403===o[C].code||null!=(n=o[C].message)&&n.includes("API key")?s(mt):s(vt):i(e)};class Uo extends gs{constructor(t){var e,i;const s=JSON.parse(JSON.stringify(t.directConnection)).gemini;super(t,(()=>{const t="https://generativelanguage.googleapis.com/v1beta/models?key=";return js(t,Ft,Do,e=>`${t}${e}`)})(),zo,s),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Gemini"),this.keyHelpUrl="https://aistudio.google.com/app/apikey",this.urlPrefix="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",this.url="",this.permittedErrorPrefixes=["API_KEY_INVALID"],typeof s===Bt&&(s.model&&(this.urlPrefix=`https://generativelanguage.googleapis.com/v1beta/models/${s.model}:generateContent`),this.cleanConfig(s),this.completeConfig(s,null==(i=null==(e=t.directConnection)?void 0:e.gemini)?void 0:i.function_handler)),this.maxMessages??(this.maxMessages=-1)}cleanConfig(t){delete t.model}static getContent(t){const e=[];return t[M]&&t[M].trim().length>0&&e.push({[M]:t[M]}),t[z]&&t[z].length>0&&t[z].forEach(t=>{if(t.src&&t.src.includes("data:")){const[i,s]=t.src.split(",");e.push({inlineData:{mimeType:i.replace("data:","").replace(";base64",""),data:s}})}}),{parts:e,role:t.role===E?E:"model"}}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>Uo.getContent(t));return i.contents=s,this.systemMessage&&(i.systemInstruction={parts:[{[M]:this.systemMessage}]}),i}async callServiceAPI(t,e){if(!this.connectSettings)throw new Error(ft);this.messages??(this.messages=t);const i=this.preprocessBody(this.rawBody,e),s=this.stream;s&&(typeof s!==Bt||!s.simulation)||i.stream?(this.url=`${this.urlPrefix.replace(":generateContent",":streamGenerateContent")}?alt=sse&key=${this.key}`,rs.request(this,i,t)):(this.url=`${this.urlPrefix}?key=${this.key}`,us.request(this,i,t))}async extractResultData(t,e){var i,s,n,o;if(t[C])throw t[C].message||"Gemini API Error";if(null!=(n=null==(s=null==(i=t.candidates)?void 0:i[0])?void 0:s.content)&&n.parts){const i=t.candidates[0].content.parts,s=i.find(t=>t.functionCall);if(null!=s&&s.functionCall)return this.handleTools([s.functionCall],e);const n=i.find(t=>t[M]),r=i.find(t=>{var e;return"image/png"===(null==(e=t.inlineData)?void 0:e.mimeType)});return{[M]:(null==n?void 0:n[M])||"",[z]:null!=(o=null==r?void 0:r.inlineData)&&o.data?[{[F]:`data:image/png;base64,${r.inlineData.data}`}]:[]}}return{[M]:""}}async handleTools(t,e){if(!t||!e||!this.functionHandler)throw Error(kt);const i=JSON.parse(JSON.stringify(e)),s=t.map(t=>({name:t.name,arguments:JSON.stringify(t.args)})),{responses:n,processedResponse:o}=await this.callToolFunction(this.functionHandler,s);if(o)return o;const r={parts:t.map(t=>({functionCall:{name:t.name,args:t.args}})),role:"model"};if(i.contents.push(r),!n.find(({response:t})=>"string"!=typeof t)&&s.length===n.length){const e={parts:n.map((e,i)=>({functionResponse:{name:t[i].name,response:{result:e.response}}})),role:E};return i.contents.push(e),this.makeAnotherRequest(i,this.messages)}throw Error(St)}}const Ho=t=>({"x-api-key":t,[It]:$t,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"}),Vo=(t,e,i,s)=>{const n=t;n[C]?n[C].type===Et?s(mt):s(vt):i(e)};class Wo extends gs{constructor(t){var e,i,s,n;const o=JSON.parse(JSON.stringify(t.directConnection)).claude;super(t,js("https://api.anthropic.com/v1/models",Ft,Vo),Ho,o),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Claude"),this.keyHelpUrl="https://console.anthropic.com/settings/keys",this.url="https://api.anthropic.com/v1/messages",this.permittedErrorPrefixes=[Et,Nt],this._streamToolCalls={[L]:"tool_use",id:"",name:"",input:""},typeof o===Bt&&this.completeConfig(o,null==(i=null==(e=t.directConnection)?void 0:e.claude)?void 0:i.function_handler),this.maxMessages??(this.maxMessages=-1),(s=this.rawBody).model??(s.model="claude-3-5-sonnet-20241022"),(n=this.rawBody).max_tokens??(n.max_tokens=4096)}static getFileContent(t){return t.map(t=>{var e,i,s;if(t.type===D){const n=null==(e=t.src)?void 0:e.split(",")[1],o=(null==(s=null==(i=t.src)?void 0:i.match(/data:([^;]+)/))?void 0:s[1])||"image/jpeg";return{[L]:D,source:{[L]:"base64",media_type:o,data:n||""}}}return{[L]:M,[M]:`[Unsupported file type: ${t.type}]`}})}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:Wo.getTextWFilesContent(t,Wo.getFileContent),role:gs.getRoleViaUser(t.role)}));return i.messages=s,this.systemMessage&&(i.system=this.systemMessage),i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){var i,s,n;if(t[C])throw t[C].message;if(t.content&&t.content.length>0){const i=t.content.find(t=>"tool_use"===t.type);if(i)return this.handleTools([i],e);const s=t.content.find(t=>t.type===M);if(s)return{[M]:s[M]}}if("content_block_delta"===t.type&&t.delta&&"text_delta"===t.delta.type)return{[M]:t.delta[M]||""};if("content_block_start"===t.type&&"tool_use"===(null==(i=t.content_block)?void 0:i.type))this._streamToolCalls=t.content_block,this._streamToolCalls.input="";else if("content_block_delta"===t.type&&"input_json_delta"===(null==(s=t.delta)?void 0:s.type))this._streamToolCalls.input+=t.delta.partial_json||"";else if("message_delta"===t.type&&"tool_use"===(null==(n=t.delta)?void 0:n.stop_reason))return this._streamToolCalls.input=JSON.parse(this._streamToolCalls.input),this.handleTools([this._streamToolCalls],e);return{[M]:""}}async handleTools(t,e){if(!t||!e||!this.functionHandler)throw Error(kt);const i=JSON.parse(JSON.stringify(e)),s=t.map(t=>({name:t.name,arguments:JSON.stringify(t.input)})),{responses:n,processedResponse:o}=await this.callToolFunction(this.functionHandler,s);if(o)return o;const r=t.map(t=>({[L]:"tool_use",id:t.id,name:t.name,input:t.input}));if(i.messages.push({role:"assistant",content:r}),!n.find(({response:t})=>"string"!=typeof t)&&s.length===n.length){const e=n.map((e,i)=>({[L]:"tool_result",tool_use_id:t[i].id,content:e.response}));return i.messages.push({role:E,content:e}),this.makeAnotherRequest(i,this.messages)}throw Error(St)}}const Go=()=>({}),Zo=()=>{};class Ko extends gs{constructor(t){var e,i,s,n;const o=JSON.parse(JSON.stringify(t.directConnection));super(t,js("",Ft,Zo),Go,{key:"placeholder"}),this.insertKeyPlaceholderText="",this.keyHelpUrl="",this.validateKeyProperty=!1,this.url="http://localhost:11434/api/chat",this.permittedErrorPrefixes=["Error"];const r=o.ollama;typeof r===Bt&&this.completeConfig(r,null==(i=null==(e=t.directConnection)?void 0:e.ollama)?void 0:i.function_handler),this.maxMessages??(this.maxMessages=-1),(s=this.rawBody).model??(s.model="llama3.2"),(n=this.rawBody).stream??(n.stream=!1)}static getImageData(t){return t.filter(t=>t.type===D).map(t=>{var e;return(null==(e=t.src)?void 0:e.split(",")[1])||""}).filter(t=>t.length>0)}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>{const e={content:t[M]||"",role:gs.getRoleViaUser(t.role)};if(t[z]&&t[z].length>0){const i=Ko.getImageData(t[z]);i.length>0&&(e[U]=i)}return e});return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{readable:!0})}async extractResultData(t,e){var i,s;if(t[C])throw t[C].message;if(t[M]){const n=JSON.parse(t[M]);return null!=(i=n.message)&&i.tool_calls?this.handleTools({tool_calls:n.message.tool_calls},e):{[M]:(null==(s=n.message)?void 0:s.content)||""}}return t.message?t.message.tool_calls?this.handleTools({tool_calls:t.message.tool_calls},e):{[M]:t.message.content||""}:{[M]:""}}async handleTools(t,e){if(!t.tool_calls||!e||!this.functionHandler)throw Error(kt);const i=JSON.parse(JSON.stringify(e)),s=t.tool_calls.map(t=>({name:t.function.name,arguments:JSON.stringify(t.function.arguments)})),{responses:n,processedResponse:o}=await this.callToolFunction(this.functionHandler,s);if(o)return o;if(i.messages.push({tool_calls:t.tool_calls,role:N,content:""}),!n.find(({response:t})=>"string"!=typeof t)&&s.length===n.length)return n.forEach((e,s)=>{var n;const o=null==(n=t.tool_calls)?void 0:n[s];null==i||i.messages.push({role:"tool",tool_name:null==o?void 0:o.function.name,content:e.response})}),this.makeAnotherRequest(i,this.messages);throw Error(St)}}const Xo=t=>({Authorization:`${Jt}${t}`,[It]:$t}),Qo=(t,e,i,s)=>{const n=t;n[C]?n[C].type===Et||n[C].type===Nt?s(mt):s(vt):i(e)},Yo=()=>js("https://api.x.ai/v1/models",Ft,Qo),tr=class t extends gs{constructor(e){var i,s;const{directConnection:n}=e,o=null==n?void 0:n.x;super(e,Yo(),Xo,o),this.insertKeyPlaceholderText=this.genereteAPIKeyName("X"),this.keyHelpUrl="https://console.x.ai/team/default/api-keys",this.url=t.IMAGE_GENERATION_URL,this.permittedErrorPrefixes=[Nt,Et];const r=null==(i=null==n?void 0:n.x)?void 0:i[U];typeof r===Bt&&Object.assign(this.rawBody,r),(s=this.rawBody).model??(s.model="grok-2-image")}preprocessBody(t,e){const i=e[e.length-1][M],s=JSON.parse(JSON.stringify(t));return i&&""!==i&&(s.prompt=i),s}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this))}async extractResultData(t){if(t[C])throw t[C].message;const e=t.data.map(t=>t.url?{[F]:t.url,[L]:D}:{[F]:`${qs}${t.b64_json}`,[L]:D});return{[z]:e}}};tr.IMAGE_GENERATION_URL="https://api.x.ai/v1/images/generations";let er=tr;const ir=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),sr=(t,e,i,s)=>{const n=t;n[C]?n[C].type===Nt?s(mt):s(vt):i(e)};class nr extends gs{constructor(t){var e,i,s;const n=JSON.parse(JSON.stringify(t.directConnection)).qwen;super(t,js("https://dashscope-intl.aliyuncs.com/compatible-mode/v1/models",Ft,sr),ir,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Qwen"),this.keyHelpUrl="https://www.alibabacloud.com/help/en/model-studio/get-api-key",this.url="https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions",this.permittedErrorPrefixes=["No static","The model",jt],typeof n===Bt&&this.completeConfig(n,null==(i=null==(e=t.directConnection)?void 0:e.qwen)?void 0:i.function_handler),this.maxMessages??(this.maxMessages=-1),(s=this.rawBody).model??(s.model="qwen-plus")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:nr.getTextWImagesContent(t),role:gs.getRoleViaUser(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){if(t[C])throw t[C].message;if(t.choices&&t.choices.length>0){const i=t.choices[0];if(i.delta)return this.extractStreamResult(i,e);if(i.message)return i.message.tool_calls?this.handleToolsGeneric({tool_calls:i.message.tool_calls},this.functionHandler,this.messages,e):{[M]:i.message.content||""}}return{[M]:""}}async extractStreamResult(t,e){return this.extractStreamResultWToolsGeneric(this,t,this.functionHandler,e)}}const or=t=>({[Ot]:`${Jt}${t}`,[It]:$t}),rr=(t,e,i,s)=>{const n=t;n[C]?n[C].type===Et?s(mt):s(vt):i(e)};class ar extends gs{constructor(t){var e,i,s;const n=JSON.parse(JSON.stringify(t.directConnection)).kimi;super(t,js("https://api.moonshot.ai/v1/models",Ft,rr),or,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("Kimi"),this.keyHelpUrl="https://platform.moonshot.ai/console/api-keys",this.url="https://api.moonshot.ai/v1/chat/completions",this.permittedErrorPrefixes=[Tt,"Not found"],typeof n===Bt&&this.completeConfig(n,null==(i=null==(e=t.directConnection)?void 0:e.kimi)?void 0:i.function_handler),this.maxMessages??(this.maxMessages=-1),(s=this.rawBody).model??(s.model="moonshot-v1-8k")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:ar.getTextWImagesContent(t),role:gs.getRoleViaUser(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.messages??(this.messages=t),this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t,e){if(t[C])throw t[C].message;if(t.choices&&t.choices.length>0){const i=t.choices[0];if(i.delta)return this.extractStreamResult(i,e);if(i.message)return i.message.tool_calls?this.handleToolsGeneric({tool_calls:i.message.tool_calls},this.functionHandler,this.messages,e):{[M]:i.message.content||""}}return{[M]:""}}async extractStreamResult(t,e){return this.extractStreamResultWToolsGeneric(this,t,this.functionHandler,e)}}class lr extends gs{constructor(t){var e,i;const s=JSON.parse(JSON.stringify(t.directConnection)),n=s.x;super(t,Yo(),Xo,n),this.insertKeyPlaceholderText=this.genereteAPIKeyName("X"),this.keyHelpUrl="https://console.x.ai/team/default/api-keys",this.url="https://api.x.ai/v1/chat/completions",this.permittedErrorPrefixes=[Nt,Et];const o=null==(e=s.x)?void 0:e.chat;typeof o===Bt&&this.completeConfig(o),this.maxMessages??(this.maxMessages=-1),(i=this.rawBody).model??(i.model="grok-3-latest")}preprocessBody(t,e){const i=JSON.parse(JSON.stringify(t)),s=this.processMessages(e).map(t=>({content:t[M]||"",role:gs.getRoleViaUser(t.role)}));return this.addSystemMessage(s),i.messages=s,i}async callServiceAPI(t,e){this.callDirectServiceServiceAPI(t,e,this.preprocessBody.bind(this),{})}async extractResultData(t){var e,i,s,n;if(t[C])throw t[C].message;if("chat.completion.chunk"===t.object){const s=null==(e=t.choices)?void 0:e[0];return null!=(i=null==s?void 0:s.delta)&&i.content?{[M]:s.delta.content}:{[M]:""}}return"chat.completion"===t.object&&null!=(n=null==(s=t.choices)?void 0:s[0])&&n.message?{[M]:t.choices[0].message.content||""}:{[M]:""}}}class cr{static create(t){const{directConnection:e,connect:i,demo:s,webModel:n}=t;if(n)return new Ts(t);if(e){if(e.openAI)return e.openAI[U]?new ko(t):e.openAI.speechToText?new qn(t):e.openAI.textToSpeech?new Fn(t):e.openAI.assistant?new gn(t):e.openAI.realtime?new Rn(t):new go(t);if(e.assemblyAI)return new io(t);if(e.cohere)return new qo(t);if(e.huggingFace)return e.huggingFace.textGeneration?new Vs(t):e.huggingFace.summarization?new Gs(t):e.huggingFace.translation?new Xs(t):e.huggingFace.fillMask?new Ys(t):e.huggingFace.questionAnswer?new Ws(t):e.huggingFace.audioSpeechRecognition?new Hs(t):e.huggingFace.audioClassification?new Bs(t):e.huggingFace.imageClassification?new Rs(t):new Zs(t);if(e.azure){if(e.azure.openAI){if(e.azure.openAI.chat)return new bo(t);if(e.azure.openAI.assistant)return new Sn(t)}if(e.azure.speechToText)return new lo(t);if(e.azure.textToSpeech)return new ro(t);if(e.azure.summarization)return new Yn(t);if(e.azure.translation)return new co(t)}if(e.stabilityAI)return e.stabilityAI.imageToImage?new Ks(t):e.stabilityAI.imageToImageUpscale?new Ds(t):e.stabilityAI.imageToImageMasking?new Us(t):new Qs(t);if(e.mistral)return new Ro(t);if(e.gemini)return new Uo(t);if(e.claude)return new Wo(t);if(e.deepSeek)return new Eo(t);if(e.miniMax)return new Po(t);if(e.openRouter)return new Oo(t);if(e.kimi)return new ar(t);if(e.x)return e.x[U]?new er(t):new lr(t);if(e.qwen)return new nr(t);if(e.together)return e.together[U]?new fo(t):e.together.textToSpeech?new ln(t):new wo(t);if(e.bigModel)return e.bigModel[U]?new ho(t):e.bigModel.textToSpeech?new nn(t):new yo(t);if(e.groq)return e.groq.textToSpeech?new vo(t):new Jo(t);if(e.perplexity)return new Co(t);if(e.ollama)return new Ko(t)}return i&&Object.keys(i).length>0&&!s?new fs(t):new fs(t,void 0,s||!0)}}const hr=class{};hr.attibutes={string:t=>t,number:t=>parseFloat(t),boolean:t=>"true"===t,object:t=>JSON.parse(t),array:t=>JSON.parse(t),function:t=>new Function(`return ${t}`)()};let ur=hr;function dr(t){return function(e,i){Object.defineProperty(e,i,{});const s=e.constructor,n=i.toLocaleLowerCase();s._attributes_[n]=ur.attibutes[t],s._attributeToProperty_[n]=i}}class pr{constructor(t){this._isDisplayed=!1,this._elementRef=this.createIntroPanelWithChild(t),this._isDisplayed=!0}static createIntroPanel(){const s=i();return s[t].add("intro-panel"),Object.assign(s[e]),s}createIntroPanelWithChild(t){const i=pr.createIntroPanel();return"none"===t[e].display&&(t[e].display="block"),i.appendChild(t),i}hide(){this._isDisplayed&&(this._elementRef[e].display="none",this._isDisplayed=!1)}display(){this._isDisplayed||(this._elementRef[e].display="",this._isDisplayed=!0)}}const mr=class e{static createImage(t,e,i,s){const n=new Image;return n.src=t.src,s&&Ji.scrollDownOnImageLoad(n.src,e,i),Ji.processContent(D,n,n.src,t.name)}static createImageMessage(i,s,n,o,r){const a=i.createNewMessageElement("",n),l=!o&&!i.focusMode&&r,c=e.createImage(s,i.elementRef,a.outerContainer,l);return a.bubbleElement.appendChild(c),a.bubbleElement[t].add(e.IMAGE_BUBBLE_CLASS),{type:D,elements:a}}static createAudioElement(e,s){const n=i(W);return n.src=e.src,n[t].add("audio-player"),n.controls=!0,et.IS_SAFARI&&(n[t].add("audio-player-safari"),n[t].add(s===E?"audio-player-safari-right":"audio-player-safari-left")),n}static autoPlayAudio(t){t.addEventListener("loadeddata",()=>{t.play().catch(t=>{console.warn("Auto-play failed:",t)})})}static createNewAudioMessage(i,s,n,o){const r=e.createAudioElement(s,n),a=i.createMessageElementsOnOrientation("",n,o);return a.bubbleElement.appendChild(r),a.bubbleElement[t].add(e.AUDIO_BUBBLE_CLASS),{type:W,elements:a,audioElement:r}}static createAnyFile(e){const s=i();s[t].add("any-file-message-contents");const n=i();n[t].add("any-file-message-icon-container");const o=xs.createSVGElement('<?xml version="1.0" encoding="iso-8859-1"?>\n<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" \n\t viewBox="50 30 420 450" xml:space="preserve">\n<g filter="brightness(0) saturate(100%) invert(16%) sepia(0%) saturate(1942%) hue-rotate(215deg) brightness(99%) contrast(93%)">\n\t<g>\n\t\t<path d="M447.933,103.629c-0.034-3.076-1.224-6.09-3.485-8.352L352.683,3.511c-0.004-0.004-0.007-0.005-0.011-0.008\n\t\t\tC350.505,1.338,347.511,0,344.206,0H89.278C75.361,0,64.04,11.32,64.04,25.237v461.525c0,13.916,11.32,25.237,25.237,25.237\n\t\t\th333.444c13.916,0,25.237-11.32,25.237-25.237V103.753C447.96,103.709,447.937,103.672,447.933,103.629z M356.194,40.931\n\t\t\tl50.834,50.834h-49.572c-0.695,0-1.262-0.567-1.262-1.262V40.931z M423.983,486.763c0,0.695-0.566,1.261-1.261,1.261H89.278\n\t\t\tc-0.695,0-1.261-0.566-1.261-1.261V25.237c0-0.695,0.566-1.261,1.261-1.261h242.94v66.527c0,13.916,11.322,25.239,25.239,25.239\n\t\t\th66.527V486.763z"/>\n\t</g>\n</g>\n<g>\n\t<g>\n\t\t<path d="M362.088,164.014H149.912c-6.62,0-11.988,5.367-11.988,11.988c0,6.62,5.368,11.988,11.988,11.988h212.175\n\t\t\tc6.62,0,11.988-5.368,11.988-11.988C374.076,169.381,368.707,164.014,362.088,164.014z"/>\n\t</g>\n</g>\n<g>\n\t<g>\n\t\t<path d="M362.088,236.353H149.912c-6.62,0-11.988,5.368-11.988,11.988c0,6.62,5.368,11.988,11.988,11.988h212.175\n\t\t\tc6.62,0,11.988-5.368,11.988-11.988C374.076,241.721,368.707,236.353,362.088,236.353z"/>\n\t</g>\n</g>\n<g>\n\t<g>\n\t\t<path d="M362.088,308.691H149.912c-6.62,0-11.988,5.368-11.988,11.988c0,6.621,5.368,11.988,11.988,11.988h212.175\n\t\t\tc6.62,0,11.988-5.367,11.988-11.988C374.076,314.06,368.707,308.691,362.088,308.691z"/>\n\t</g>\n</g>\n<g>\n\t<g>\n\t\t<path d="M256,381.031H149.912c-6.62,0-11.988,5.368-11.988,11.988c0,6.621,5.368,11.988,11.988,11.988H256\n\t\t\tc6.62,0,11.988-5.367,11.988-11.988C267.988,386.398,262.62,381.031,256,381.031z"/>\n\t</g>\n</g>\n</svg>');o[t].add("any-file-message-icon"),n.appendChild(o);const r=i();return r[t].add("any-file-message-text"),r.textContent=e.name||q,s.appendChild(n),s.appendChild(r),Ji.processContent(K,s,e.src,r.textContent)}static createNewAnyFileMessage(i,s,n,o){const r=i.createMessageElementsOnOrientation("",n,o),a=e.createAnyFile(s);return r.bubbleElement[t].add(e.ANY_FILE_BUBBLE_CLASS),r.bubbleElement.appendChild(a),{type:q,elements:r}}static createMessages(t,i,s,n,o=!1){return i.map((i,r)=>{var a;if(i.ref&&(i=Ji.removeFileRef(i)),Ji.isAudioFile(i)){const n=e.createNewAudioMessage(t,i,s,o),r=null==(a=t.textToSpeech)?void 0:a.audio;return r&&(r.autoPlay&&e.autoPlayAudio(n.audioElement),"boolean"==typeof r.displayAudio&&!r.displayAudio)?void 0:n}return Ji.isImageFile(i)?e.createImageMessage(t,i,s,o,n&&0===r):e.createNewAnyFileMessage(t,i,s,o)}).filter(t=>void 0!==t)}static addMessages(t,i,s,n,o){const r=!n&&Dt.isScrollbarAtBottomOfElement(t.elementRef);e.createMessages(t,i,s,r,o).filter(t=>void 0!==t).forEach(({type:e,elements:i},n)=>{const a=0===n&&r;Ji.addMessage(t,i,e,s,o,a)})}};mr.IMAGE_BUBBLE_CLASS="image-message",mr.AUDIO_BUBBLE_CLASS="audio-message",mr.ANY_FILE_BUBBLE_CLASS="any-file-message";let vr=mr;class fr{static removeElements(t,e){if(!e)return;const i=t.findIndex(t=>t===e);t.splice(i,1),null==e||e.outerContainer.remove()}static removeFilesMessages(t,e){var i;null==(i=e[1][z])||i.forEach(e=>{fr.removeElements(t.messageElementRefs,e)}),delete e[0][z],delete e[1][z]}static removeTextHTMLMessage(t,e,i){const s=e[1][i];fr.removeElements(t.messageElementRefs,s),delete e[0][i],delete e[1][i]}static updateHTMLMessage(t,e,i){var s,n,o;if(e[1][A])ae.overwriteElements(t,i,e[1][A]);else{const r=ae.create(t,i,e[0].role),a=(null==(n=e[1][z])?void 0:n[(null==(s=e[1][z])?void 0:s.length)-1])||e[1][M],{nextSibling:l}=a.outerContainer;null==(o=null==l?void 0:l.parentElement)||o.insertBefore(r.outerContainer,l),t.messageElementRefs.splice(t.messageElementRefs.length-1,1);const c=t.messageElementRefs.findIndex(t=>t===a);t.messageElementRefs.splice(c+1,0,r),e[1][A]=r}e[0][A]=i}static updateFileMessages(t,e,i){var s,n;const o=e[0].role,r=vr.createMessages(t,i,o,!!e[1][M]),a=e[1][A],l=(null==(n=e[1][z])?void 0:n[(null==(s=e[1][z])?void 0:s.length)-1])||e[1][M],c=a||l;let h=t.messageElementRefs.findIndex(t=>t===c);l&&(h+=1);const u=(null==a?void 0:a.outerContainer)||(null==l?void 0:l.outerContainer.nextSibling);r.forEach(({type:e,elements:i},s)=>{var n;Ji.setElementProps(t,i,e,o),null==(n=u.parentElement)||n.insertBefore(i.outerContainer,u),t.messageElementRefs.splice(t.messageElementRefs.length-1,1),t.messageElementRefs.splice(h+s,0,i)}),fr.removeFilesMessages(t,e),e[1][z]=r.map(({elements:t})=>t),e[0][z]=i}static updateTextMessage(t,e,i){var s,n;if(e[1][M])t.renderText(e[1][M].bubbleElement,i,e[0].role);else{const o=t.createElements(i,e[0].role),r=(null==(s=e[1][z])?void 0:s[0])||e[1][A];null==(n=r.outerContainer.parentElement)||n.insertBefore(o.outerContainer,r.outerContainer);const a=t.messageElementRefs.findIndex(t=>t===r);t.messageElementRefs.splice(a,0,o),e[1][M]=o}e[0][M]=i}static isElementActive(e){var i,s;return br.isActiveElement(null==(i=e[M])?void 0:i.bubbleElement[t])||br.isActiveElement(null==(s=e[A])?void 0:s.bubbleElement[t])}static update(t,e,i){const s=t.messageToElements[i];if(s){if(fr.isElementActive(s[1]))return console[C]("Cannot update a message that is being streamed");e[M]&&fr.updateTextMessage(t,s,e[M]),e[z]?fr.updateFileMessages(t,s,e[z]):fr.removeFilesMessages(t,s),e[A]&&fr.updateHTMLMessage(t,s,e[A]),!e[M]&&s[1][M]&&fr.removeTextHTMLMessage(t,s,M),!e[A]&&s[1][A]&&fr.removeTextHTMLMessage(t,s,A);const{messageElementRefs:i,avatar:n,name:o}=t;Xi.classifyRoleMessages(i),Xi.resetAllRoleElements(i,n,o)}else console[C]("Message index not found. Please use the `getMessages` method to find the correct index")}}class gr{static getText(t,e){var i;if(!(t.directConnection||t.connect||t.webModel||t.demo))return`Connect to any API using the [connect](${T}connect#connect-1) property or a popular service via [directConnection](${T}directConnection/#directConnection).\n Host AI entirely on your browser via a [webModel](${T}webModel).\n To get started checkout the [Start](https://deepchat.dev/start) page and live code [examples](https://deepchat.dev/examples/frameworks).\n To remove this message set the [demo](${T}modes#demo) property to true.`;if(t.directConnection){if(!e.isDirectConnection())return`Please define a valid service inside\n          the [directConnection](${T}directConnection/#directConnection) object.`;const s=null==(i=t.directConnection.openAI)?void 0:i.chat;if("object"==typeof s&&s.tools&&!s.function_handler)return`Please define the \`function_handler\` property inside the openAI [chat](${T}directConnection/openAI#Chat) object.`}else if(t.connect&&!t.connect.url&&!t.connect.handler)return`Please define a \`url\` or a \`handler\` property inside the [connect](${T}connect#connect-1) object.`;return null}}class br extends Ki{constructor(t,e,i){var s,n;super(t);const{permittedErrorPrefixes:o,demo:r}=e;this._errorMessageOverrides=null==(s=t.errorMessages)?void 0:s.overrides,this._onClearMessages=Fi.onClearMessages.bind(this,t),this._onError=Fi.onError.bind(this,t),this._isLoadingMessageAllowed=br.getDefaultDisplayLoadingMessage(t,e),"object"==typeof t.displayLoadingBubble&&t.displayLoadingBubble.toggle&&(t.displayLoadingBubble.toggle=this.setLoadingToggle.bind(this)),this._permittedErrorPrefixes=o,this.addSetupMessageIfNeeded(t,e)||this.populateIntroPanel(i),r&&this.prepareDemo(Gt.processDemo(r),t.loadHistory),this.addIntroductoryMessages(t,e),new ms(t,this,e),this._displayServiceErrorMessages=null==(n=t.errorMessages)?void 0:n.displayServiceErrorMessages,t.getMessages=()=>Xi.deepCloneMessagesWithReferences(this.messageToElements.map(([t])=>t)),t.clearMessages=this.clearMessages.bind(this,e),t.refreshMessages=this.refreshTextMessages.bind(this,t.remarkable),t.scrollToBottom=Dt.scrollToBottom.bind(this,this.elementRef),t.addMessage=(t,e)=>{this.addAnyMessage({...t,sendUpdate:!!e},!e)},t.updateMessage=(t,e)=>fr.update(this,t,e),e.isWebModel()&&e.setUpMessages(this),t.textToSpeech&&Ht.processConfig(t.textToSpeech,t=>{this.textToSpeech=t})}static getDefaultDisplayLoadingMessage(t,e){return("object"!=typeof t.displayLoadingBubble||!t.displayLoadingBubble.toggle)&&(e.websocket?typeof t.displayLoadingBubble!==Bt&&!!t.displayLoadingBubble:(typeof t.displayLoadingBubble===Bt||t.displayLoadingBubble)??!0)}setLoadingToggle(t){const e=this.messageElementRefs[this.messageElementRefs.length-1];!t&&Ki.isLoadingMessage(e)?(this.removeLastMessage(),delete this._activeLoadingConfig):(this._activeLoadingConfig&&this.removeLastMessage(),this._activeLoadingConfig=t||{},this.addLoadingMessage(!0))}prepareDemo(t,e){var i;if("object"==typeof t){if(!e&&t.displayLoading){const{history:e}=t.displayLoading;null!=e&&e.small&&qi.addMessage(this,!1),null!=e&&e.full&&qi.addMessage(this)}t.displayErrors&&(t.displayErrors[g]&&this.addNewErrorMessage("",""),t.displayErrors.service&&this.addNewErrorMessage(O,""),t.displayErrors.speechToText&&this.addNewErrorMessage("speechToText","")),null!=(i=t.displayLoading)&&i.message&&this.addLoadingMessage(),t.response&&(this.customDemoResponse=t.response)}}addSetupMessageIfNeeded(t,e){const i=gr.getText(t,e);if(i){const t=this.createAndAppendNewMessageElement(i,j);this.applyCustomStyles(t,j,!1)}return!!i}addIntroductoryMessages(t,e){null!=t&&t.shadowRoot&&(this._introMessage=t.introMessage);let i=this._introMessage;null!=e&&e.isWebModel()&&(i??(i=e.getIntroMessage(i)));const s=!(null!=t&&t.history||!(null!=t&&t.loadHistory||null!=e&&e.fetchHistory));i&&(Array.isArray(i)?i.forEach((t,e)=>{if(0!==e){const t=this.messageElementRefs[this.messageElementRefs.length-1].innerContainer;Xi.hideRoleElements(t,this.avatar,this.name)}this.addIntroductoryMessage(t,s)}):this.addIntroductoryMessage(i,s))}addIntroductoryMessage(i,s){var n;let o;return null!=i&&i[M]?o=this.createAndAppendNewMessageElement(i[M],j):null!=i&&i[A]&&(o=ae.add(this,i[A],j,!1)),o&&(this.applyCustomStyles(o,j,!1,null==(n=this.messageStyles)?void 0:n.intro),o.outerContainer[t].add(Ki.INTRO_CLASS),s&&(o.outerContainer[e].display="none")),o}removeIntroductoryMessage(){const e=this.messageElementRefs[0];e.outerContainer[t].contains(Ki.INTRO_CLASS)&&(e.outerContainer.remove(),this.messageElementRefs.shift())}addAnyMessage(t,e=!1,i=!1){return t[C]?this.addNewErrorMessage(O,t[C],i):this.addNewMessage(t,e,i)}tryAddTextMessage(t,e,i,s=!1,n=!1){void 0!==t[M]&&null!==i[M]&&(this.addNewTextMessage(t[M],t.role,e,n),!s&&this.textToSpeech&&t.role!==E&&Ht.speak(t[M],this.textToSpeech))}tryAddFileMessages(t,e=!1){t[z]&&Array.isArray(t[z])&&vr.addMessages(this,t[z],t.role,!!t[M],e)}tryAddHTMLMessage(t,e,i=!1){if(void 0!==t[A]&&null!==t[A]){const s=!(t[M]||t[z]&&0!==t[z].length),n=ae.add(this,t[A],t.role,s,e,i);!i&&se.isElementTemporary(n)&&delete t[A]}}addNewMessage(t,e=!1,i=!1){var s,n,o,r;t.role!==E&&(null==(s=this._hiddenAttachments)||s.removeHiddenFiles());const a=br.createMessageContent(t),l=null==(o=null==(n=this.textToSpeech)?void 0:n.audio)?void 0:o.displayText;"boolean"==typeof l&&!l&&delete a[M];const c={status:t.overwrite};return i?(this.tryAddHTMLMessage(a,c,i),this.tryAddFileMessages(a,i),this.tryAddTextMessage(a,c,t,e,i)):(this.tryAddTextMessage(a,c,t,e,i),this.tryAddFileMessages(a,i),this.tryAddHTMLMessage(a,c,i)),this.isValidMessageContent(a)&&!i&&(this.updateStateOnMessage(a,t.overwrite,t.sendUpdate,e),e||null==(r=this.browserStorage)||r.addMessages(this.messageToElements.map(([t])=>t))),this._activeLoadingConfig&&this.addLoadingMessage(!1),a}isValidMessageContent(t){return t[M]||t[A]||t[z]&&t[z].length>0}updateStateOnMessage(t,e,i=!0,s=!1){if(!e){const e=Xi.generateMessageBody(t,this.messageElementRefs);this.messageToElements.push([t,e])}i&&this.sendClientUpdate(t,s)}removeMessageOnError(){const e=this.messageElementRefs[this.messageElementRefs.length-1],i=null==e?void 0:e.bubbleElement;(null!=i&&i[t].contains(Yi.MESSAGE_CLASS)&&""===i.textContent||br.isTemporaryElement(e))&&this.removeLastMessage()}addNewErrorMessage(e,i,s=!1){var n,o,r,a,l,c;null==(n=this._hiddenAttachments)||n.readdHiddenFiles(),this.removeMessageOnError();const h=this.getPermittedMessage(i)||(null==(o=this._errorMessageOverrides)?void 0:o[e])||(null==(r=this._errorMessageOverrides)?void 0:r[g])||"Error, please try again.",u=this.createMessageElementsOnOrientation(h,C,s);Xi.hideRoleElements(u.innerContainer,this.avatar,this.name);const{bubbleElement:d,outerContainer:p}=u;d[t].add(I),this.renderText(d,h);const m=Ri.extractParticularSharedStyles(["fontSize","fontFamily"],null==(a=this.messageStyles)?void 0:a[g]);Ri.applyCustomStylesToElements(u,!1,m),Ri.applyCustomStylesToElements(u,!1,null==(l=this.messageStyles)?void 0:l[C]),s||this.appendOuterContainerElemet(p),this.textToSpeech&&Ht.speak(h,this.textToSpeech),null==(c=this._onError)||c.call(this,h),setTimeout(()=>Dt.scrollToBottom(this.elementRef))}static checkPermittedErrorPrefixes(t,e){for(let i=0;i<t.length;i+=1)if(e.startsWith(t[i]))return e}static extractErrorMessages(t){return Array.isArray(t)?t:t instanceof Error?[t.message]:"string"==typeof t?[t]:"object"==typeof t&&t[C]?[t[C]]:[]}getPermittedMessage(t){if(t){const e=br.extractErrorMessages(t);for(let t=0;t<e.length;t+=1){const i=e[t];if("string"==typeof i){if(this._displayServiceErrorMessages)return i;if(this._permittedErrorPrefixes){const t=br.checkPermittedErrorPrefixes(this._permittedErrorPrefixes,i);if(t)return t}}}}}removeError(){this.isLastMessageError()&&Xi.getLastMessageElement(this.elementRef).remove()}addDefaultLoadingMessage(e,s=j){const n=this.createMessageElements("",s),{bubbleElement:o}=n;n.bubbleElement[t].add(Wt.DOTS_CONTAINER_CLASS);const r=i();return r[t].add("loading-message-dots"),o.appendChild(r),Wt.setDots(o,e),n}addLoadingMessage(i=!1){var s,n,o,r,a,l;if(Ki.isLoadingMessage(this.messageElementRefs[this.messageElementRefs.length-1])||!this._activeLoadingConfig&&!i&&!this._isLoadingMessageAllowed)return;const c=(null==(s=this._activeLoadingConfig)?void 0:s.role)||j,h=(null==(n=this._activeLoadingConfig)?void 0:n[e])||(null==(r=null==(o=this.messageStyles)?void 0:o.loading)?void 0:r.message),u=null==h?void 0:h[A],d=u?ae.createElements(this,u,c,!1):this.addDefaultLoadingMessage(h,c);this.appendOuterContainerElemet(d.outerContainer),d.bubbleElement[t].add(Wt.BUBBLE_CLASS),this.applyCustomStyles(d,c,!1,null==h?void 0:h.styles),null==(l=null==(a=this.avatar)?void 0:a.getAvatarContainer(d.innerContainer))||l[t].add("loading-avatar-container"),!this.focusMode&&Dt.isScrollbarAtBottomOfElement(this.elementRef)&&Dt.scrollToBottom(this.elementRef)}populateIntroPanel(t){t&&(this._introPanel=new pr(t),oe.apply(this,this._introPanel._elementRef),this.elementRef.appendChild(this._introPanel._elementRef))}async addMultipleFiles(t,e){return this._hiddenAttachments=e,Promise.all((t||[]).map(t=>new Promise(e=>{if(t.type&&t.type!==K){const i=new FileReader;i.readAsDataURL(t[q]),i.onload=()=>{const s=t[q].name;e({[F]:i.result,name:s,type:t.type,ref:t[q]})}}else{const i=t[q].name||q;e({name:i,type:K,ref:t[q]})}})))}static isActiveElement(t){return!!t&&(t.contains(Wt.BUBBLE_CLASS)||t.contains(qi.CLASS)||t.contains(Yi.MESSAGE_CLASS))}clearMessages(e,i){var s,n,o;const r=[];this.messageElementRefs.forEach(e=>{br.isActiveElement(e.bubbleElement[t])?r.push(e):e.outerContainer.remove()}),Array.from(this.elementRef.children).forEach(e=>{var i;const s=null==(i=e.children[0])?void 0:i.children[0];null!=s&&s[t].contains(I)&&e.remove()}),this.messageElementRefs=r;const a=this.messageToElements.filter(e=>e[1][M]&&br.isActiveElement(e[1][M].bubbleElement[t])||e[1][A]&&br.isActiveElement(e[1][A].bubbleElement[t]));this.messageToElements.splice(0,this.messageToElements.length,...a),!1!==i&&(null!=(s=this._introPanel)&&s._elementRef&&this._introPanel.display(),this.addIntroductoryMessages()),null==(n=this.browserStorage)||n.clear(),null==(o=this._onClearMessages)||o.call(this),delete e.sessionId}}class yr{static adjustInputPadding(e,i){i[d].length>0&&e[t].add("text-input-inner-left-adjustment"),i[p].length>0&&e[t].add("text-input-inner-right-adjustment")}static adjustForOutsideButton(e,i,s){0===s[v].length&&s[m].length>0?(e[0][t].add(h),i[t].add(h)):0===s[m].length&&s[v].length>0&&(e[3][t].add(u),i[t].add(u))}static adjustOutsideSubmit(e,i,s){if(!(s[d].length>0||s[p].length>0)){if(0===s[v].length&&s[m].length>0)return e[0][t].add(l),i[t].add(l),s[m].map(e=>e.button.elementRef[t].add("submit-button-enlarged"));if(0===s[m].length&&s[v].length>0)return e[3][t].add(c),i[t].add(c),s[v].map(e=>e.button.elementRef[t].add("submit-button-enlarged"))}}static set(t,e,i,s){!!yr.adjustOutsideSubmit(e,i,s)||yr.adjustForOutsideButton(e,i,s),yr.adjustInputPadding(t,s)}}class wr{static create(){return Array.from({length:4}).map((e,s)=>{const n=i();return n[t].add("input-button-container"),(0===s||3===s)&&n[t].add("outer-button-container"),(1===s||2===s)&&n[t].add("inner-button-container"),n})}static add(t,e){t.insertBefore(e[1],t.firstChild),t.insertBefore(e[0],t.firstChild),t.appendChild(e[2]),t.appendChild(e[3])}static getContainerIndex(t){return t===m?0:t===d?1:t===p?2:3}static addButton(e,i,s){i[t].add(s);const n=wr.getContainerIndex(s);e[n].appendChild(i),3===n&&i[t].add(v)}}const xr=["camera","gifs","images","audio","mixedFiles","submit","microphone"],kr=class s{static addItemEvents(t,e,i,s){te.add(e,s),e.addEventListener(y,()=>{i[y]()}),e.addEventListener("mouseenter",e=>{t.highlightedItem=e.target}),e.addEventListener("mouseleave",()=>{t.highlightedItem=void 0})}static createItemText(n,o){const r=i();return Object.assign(r[e],o),r[t].add(s.TEXT_CLASS),r.textContent=n||"File",r}static createItemIcon(n,o){const r=i();return Object.assign(r[e],o),r[t].add(s.ICON_CLASS),r.appendChild(n),r}static populateItem(e,i,n){const{elementRef:o,dropupText:r,svg:a,customStyles:l}=e,c=o.children[0],h=l&&Object.values(l).find(t=>{var e;return""===(null==(e=t.svg)?void 0:e.content)});c[t].contains(An.INPUT_BUTTON_INNER_TEXT_CLASS)?(h||i.appendChild(s.createItemIcon(a,null==n?void 0:n.iconContainer)),i.appendChild(s.createItemText(c.textContent,null==n?void 0:n[M]))):(h||i.appendChild(s.createItemIcon(o.children[0],null==n?void 0:n.iconContainer)),i.appendChild(s.createItemText(r,null==n?void 0:n[M])))}static createItem(n,o,r){var a;const l=i();Object.assign(l[e],null==(a=null==r?void 0:r.item)?void 0:a[g]),s.populateItem(o,l,r),l[t].add(s.MENU_ITEM_CLASS);const{elementRef:c}=o;if(o.isCustom)o.setDropupItem(l);else{const t=w.processStateful((null==r?void 0:r.item)||{});s.addItemEvents(n,l,c,t)}return l}};kr.MENU_ITEM_CLASS="dropup-menu-item",kr.TEXT_CLASS="dropup-menu-item-text",kr.ICON_CLASS="dropup-menu-item-icon";let Sr=kr;const _r=class s extends jn{constructor(t,e,i,n){var o,r,a,l,c,h;const u=(null==(l=null==(a=null==(r=null==(o=null==t?void 0:t.styles)?void 0:o.button)?void 0:r[g])?void 0:a[M])?void 0:l.content)||`Custom ${e}`,d=Y.tryCreateConfig(`Custom ${e}`,null==t?void 0:t.tooltip);super(s.createButtonElement(),'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22" fill="none">\n  <rect x="2.5" y="2.5" width="17" height="17" rx="2" stroke="#000000" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>\n</svg>\n',null==t?void 0:t.position,d,(null==(c=null==t?void 0:t.styles)?void 0:c.button)||d&&{},u),this._state=g,this.isCustom=!0,this._innerElements=this.createInnerElementsForStates(this.customStyles),this._menuStyles=n,this._onClick=t.onClick,this._dropupStyles=null==(h=t.styles)?void 0:h.dropup,this.setSetState(t),this.addClickListener(i),this.changeState(t.initialState,!0)}static createButtonElement(){const e=i();return e[t].add("input-button",s.BUTTON_CLASS),e}createInnerElementsForStates(t){const e="custom-icon",i=this.createInnerElements(e,g,t);return{[g]:i,active:this.genStateInnerElements(e,"active",i,t),disabled:this.genStateInnerElements(e,"disabled",i,t)}}setSetState(t){t.setState=t=>{t===g&&this.changeToDefault(),"active"===t&&this.changeToActive(),"disabled"===t&&this.changeToDisabled()}}addClickListener(t){this.elementRef.addEventListener(y,()=>{var e;const i=null==(e=this._onClick)?void 0:e.call(this,this._state);null==t||t(),(i===g||"active"===i||"disabled"===i)&&this.changeState(i)})}changeState(t,e){"disabled"===t?this.changeToDisabled(e):"active"===t?this.changeToActive(e):this.changeToDefault(e)}applyDropupContentStyles(i){const s=Array.from(this.elementRef.children);if(null!=i&&i[M]){const n=s.find(e=>e[t].contains(Sr.TEXT_CLASS));n&&Object.assign(n[e],i[M])}if(null!=i&&i.iconContainer){const n=s.find(e=>e[t].contains(Sr.ICON_CLASS));n&&Object.assign(n[e],i.iconContainer)}}resetDropupItem(t){var e,i,s;this.elementRef=oe.replaceElementWithNewClone(this.elementRef,this._originalElementRef),this.elementRef.innerHTML="",""===(null==(e=null==t?void 0:t.svg)?void 0:e.content)||this.elementRef.appendChild(Sr.createItemIcon(this.svg,null==(i=this._menuStyles)?void 0:i.iconContainer)),this.elementRef.appendChild(Sr.createItemText(this.dropupText,null==(s=this._menuStyles)?void 0:s[M]))}assignDropupItemStyle(t,i){var s;this.elementRef.parentElement&&this._originalElementRef&&this.resetDropupItem(i),this.applyDropupContentStyles(t),Object.assign(this.elementRef[e],null==(s=null==t?void 0:t.item)?void 0:s[g]);const n=w.processStateful((null==t?void 0:t.item)||{});te.add(this.elementRef,n),this.addClickListener()}changeToDefault(e){var i,n,o,r,a,l;!e&&this._state===g||(this.elementRef[t].contains(Sr.MENU_ITEM_CLASS)?this.assignDropupItemStyle(null==(i=this._dropupStyles)?void 0:i[g],null==(n=this.customStyles)?void 0:n[g]):(this.changeElementsByState(this._innerElements[g]),null!=(o=this.customStyles)&&o.active&&Tn.unsetAllCSS(this.elementRef,null==(r=this.customStyles)?void 0:r.active),null!=(a=this.customStyles)&&a.disabled&&Tn.unsetAllCSS(this.elementRef,null==(l=this.customStyles)?void 0:l.disabled),this.reapplyStateStyle(g,["active","disabled"])),this.elementRef[t].remove(s.DISABLED_CONTAINER_CLASS,s.ACTIVE_CONTAINER_CLASS),this.elementRef[t].add(s.DEFAULT_CONTAINER_CLASS),_n.removeAriaDisabled(this.elementRef),this._state=g)}changeToActive(e){var i,n;!e&&"active"===this._state||(this.elementRef[t].contains(Sr.MENU_ITEM_CLASS)?this.assignDropupItemStyle(null==(i=this._dropupStyles)?void 0:i.active,null==(n=this.customStyles)?void 0:n.active):(this.changeElementsByState(this._innerElements.active),this.reapplyStateStyle("active",["disabled",g])),this.elementRef[t].remove(s.DISABLED_CONTAINER_CLASS,s.DEFAULT_CONTAINER_CLASS),this.elementRef[t].add(s.ACTIVE_CONTAINER_CLASS),_n.removeAriaDisabled(this.elementRef),this._state="active")}changeToDisabled(e){var i,n,o,r,a,l;!e&&"disabled"===this._state||(this.elementRef[t].contains(Sr.MENU_ITEM_CLASS)?this.assignDropupItemStyle(null==(i=this._dropupStyles)?void 0:i.disabled,null==(n=this.customStyles)?void 0:n.disabled):(this.changeElementsByState(this._innerElements.disabled),null!=(o=this.customStyles)&&o.active&&Tn.unsetAllCSS(this.elementRef,null==(r=this.customStyles)?void 0:r.active),null!=(a=this.customStyles)&&a[g]&&Tn.unsetAllCSS(this.elementRef,null==(l=this.customStyles)?void 0:l[g]),this.reapplyStateStyle("disabled",[g,"active"])),this.elementRef[t].remove(s.ACTIVE_CONTAINER_CLASS,s.DEFAULT_CONTAINER_CLASS),this.elementRef[t].add(s.DISABLED_CONTAINER_CLASS),_n.addAriaDisabled(this.elementRef),this._state="disabled")}setDropupItem(t){this.elementRef=t,this._originalElementRef=t.cloneNode(!0),this.changeState(this._state,!0)}genStateInnerElements(t,e,i,n){var o,r,a,l;let c=this.createInnerElements(t,e,n);const h=null==(r=null==(o=null==n?void 0:n[e])?void 0:o.svg)?void 0:r.content,u=null==(l=null==(a=null==n?void 0:n[e])?void 0:a[M])?void 0:l.content;if(void 0===h||void 0===u){const{svg:t,[M]:e}=Cn.parseSVGTextElements(i),{svg:n,[M]:o}=Cn.parseSVGTextElements(c),r=[];s.addToInnerElements(r,h,t,n),s.addToInnerElements(r,u,e,o),c=r}return c}static addToInnerElements(t,e,i,s){void 0===e&&i?t.push(i.cloneNode(!0)):s&&t.push(s)}static add(t,e){const{customButtons:i,focusInput:n,dropupStyles:o}=t;null==i||i.forEach((t,i)=>{const r={button:new s(t,i+1,n,null==o?void 0:o.menu)};e[`${s.INDICATOR_PREFIX}${i+1}`]=r})}};_r.INDICATOR_PREFIX="custom",_r.BUTTON_CLASS="custom-button",_r.DISABLED_CONTAINER_CLASS="custom-button-container-disabled",_r.DEFAULT_CONTAINER_CLASS="custom-button-container-default",_r.ACTIVE_CONTAINER_CLASS="custom-button-container-active";let Or=_r;class Mr{static focusItemWhenOnEdge(t,e){const i=e?t.children[0]:t.children[t.children.length-1];Mr.focusSiblingItem(i,t,e,!0)}static focusSiblingItem(t,e,i,s=!1){const n=s?t:t[i?"nextSibling":"previousSibling"];n?(t.dispatchEvent(new MouseEvent("mouseleave")),n.dispatchEvent(new MouseEvent("mouseenter"))):(t.dispatchEvent(new MouseEvent("mouseleave")),Mr.focusItemWhenOnEdge(e,i))}}class Ar{constructor(t,e){var i;this._isOpen=!0,this._styles=e,this.elementRef=Ar.createElement(null==(i=this._styles)?void 0:i.container),this.close(),setTimeout(()=>this.addWindowEvents(t))}static createElement(t){const s=i();return s.id=f,Object.assign(s[e],t),s}open(){this.elementRef[e].display="block",this._isOpen=!0}close(){this._isOpen&&(this.elementRef[e].display="none",this._isOpen=!1)}toggle(){this._isOpen?this.close():this.open()}addItem(t){const e=Sr.createItem(this,t,this._styles);this.elementRef.appendChild(e)}addWindowEvents(t){this.clickEvent=this.windowClick.bind(this,t),window.addEventListener(y,this.clickEvent),this.keyDownEvent=this.windowKeyDown.bind(this,t),window.addEventListener("keydown",this.keyDownEvent)}windowClick(t,e){var i;!t.isConnected&&this.clickEvent?window.removeEventListener(y,this.clickEvent):t.parentElement!==(null==(i=e.target.shadowRoot)?void 0:i.children[0])&&this.close()}windowKeyDown(t,e){var i,s,n;!t.isConnected&&this.keyDownEvent?window.removeEventListener("keydown",this.keyDownEvent):this._isOpen&&(e.key===it.ESCAPE?(this.close(),null==(i=this.highlightedItem)||i.dispatchEvent(new MouseEvent("mouseleave"))):e.key===it.ENTER?(null==(s=this.highlightedItem)||s[y](),null==(n=this.highlightedItem)||n.dispatchEvent(new MouseEvent("mouseleave"))):e.key===it.ARROW_DOWN?Mr.focusSiblingItem(this.highlightedItem||this.elementRef.children[this.elementRef.children.length-1],this.elementRef,!0):e.key===it.ARROW_UP&&Mr.focusSiblingItem(this.highlightedItem||this.elementRef.children[0],this.elementRef,!1))}}const Cr=class e extends jn{constructor(i,s){var n,o;const r=Y.tryCreateConfig("Options",null==(n=null==s?void 0:s.button)?void 0:n.tooltip);super(e.createButtonElement(),'<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">\n    <path d="M16 0c-8.836 0-16 7.163-16 16s7.163 16 16 16c8.837 0 16-7.163 16-16s-7.163-16-16-16zM16 30.032c-7.72 0-14-6.312-14-14.032s6.28-14 14-14 14 6.28 14 14-6.28 14.032-14 14.032zM23 15h-6v-6c0-0.552-0.448-1-1-1s-1 0.448-1 1v6h-6c-0.552 0-1 0.448-1 1s0.448 1 1 1h6v6c0 0.552 0.448 1 1 1s1-0.448 1-1v-6h6c0.552 0 1-0.448 1-1s-0.448-1-1-1z"></path>\n</svg>',void 0,r,{styles:null==(o=null==s?void 0:s.button)?void 0:o.styles});const a=this.createInnerElementsForStates(this.customStyles);this._menu=new Ar(i,null==s?void 0:s.menu),this.addClickEvent(),this.buttonContainer=e.createButtonContainer(),this.changeElementsByState(a.styles),this.buttonContainer.appendChild(this.elementRef),this.elementRef[t].add(e.BUTTON_ICON_CLASS),this.buttonContainer.appendChild(this._menu.elementRef),this.reapplyStateStyle("styles"),this.addContainerEvents(i)}static createButtonElement(){const e=i();return e[t].add("input-button"),e}createInnerElementsForStates(t){return{styles:this.createInnerElements("dropup-icon","styles",t)}}addClickEvent(){this.elementRef.onclick=this._menu.toggle.bind(this._menu)}static createButtonContainer(){const t=i();return t.id="dropup-container",t}addItem(t){this._menu.addItem(t)}addContainerEvents(i){i.addEventListener(y,i=>{const s=i.target[t];!s.contains(e.BUTTON_ICON_CLASS)&&!s.contains(Or.DISABLED_CONTAINER_CLASS)&&this._menu.close()})}static getPosition(t,e){var i,s;return null!=(i=null==e?void 0:e.button)&&i.position?null==(s=null==e?void 0:e.button)?void 0:s.position:t[m].length>0&&0===t[v].length?v:m}};Cr.BUTTON_ICON_CLASS="dropup-button";let Tr=Cr;class jr{static addToDropup(t,e,i,s){const n=new Tr(i,s);xr.forEach(t=>{const i=e[f].findIndex(e=>e.buttonType===t),s=e[f][i];s&&(n.addItem(s.button),e[f].splice(i,1))}),e[f].forEach(({button:t})=>n.addItem(t));const o=Tr.getPosition(e,s);wr.addButton(t,n.buttonContainer,o),e[o].push({})}static addToSideContainer(t,e){[d,p,m,v].forEach(i=>{const s=i;e[s].forEach(e=>{wr.addButton(t,e.button.elementRef,s)})})}static setPosition(t,e,i){const s={...t[e],buttonType:e};i.push(s),delete t[e]}static createPositionsToButtonsObj(){return{[f]:[],[m]:[],[d]:[],[p]:[],[v]:[]}}static generatePositionToButtons(t){const e=jr.createPositionsToButtonsObj();Object.keys(t).forEach(i=>{var s;const n=null==(s=t[i])?void 0:s.button.position;n&&jr.setPosition(t,i,e[n])}),0===e[p].length&&t.submit&&jr.setPosition(t,"submit",e[p]),0===e[v].length&&(t.submit?jr.setPosition(t,"submit",e[v]):t.microphone?jr.setPosition(t,G,e[v]):t.camera?jr.setPosition(t,H,e[v]):t[`${Or.INDICATOR_PREFIX}1`]&&jr.setPosition(t,`${Or.INDICATOR_PREFIX}1`,e[v])),t.submit&&jr.setPosition(t,"submit",0===e[m].length?e[m]:e[p]),t.microphone&&jr.setPosition(t,G,0===e[m].length?e[m]:e[p]);const i=Object.keys(t);return i.length>1||e[f].length>0?(xr.forEach(i=>{t[i]&&e[f].push({...t[i],buttonType:i})}),i.forEach(i=>{const s=i;s.startsWith(Or.INDICATOR_PREFIX)&&t[s]&&e[f].push({...t[s],customType:s})})):1===i.length&&jr.setPosition(t,i[0],0===e[v].length?e[v]:e[m]),e}static addButtons(t,e,i,s){const n=jr.generatePositionToButtons(e);return jr.addToSideContainer(t,n),n[f].length>0&&jr.addToDropup(t,n,i,s),n}}const Er={[U]:{id:"upload-images-icon",svgString:'<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <path d="M20,15.2928932 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,12.2928932 L7.14644661,9.14644661 C7.34170876,8.95118446 7.65829124,8.95118446 7.85355339,9.14644661 L13.5,14.7928932 L16.1464466,12.1464466 C16.3417088,11.9511845 16.6582912,11.9511845 16.8535534,12.1464466 L20,15.2928932 Z M20,16.7071068 L16.5,13.2071068 L13.8535534,15.8535534 C13.6582912,16.0488155 13.3417088,16.0488155 13.1464466,15.8535534 L7.5,10.2071068 L4,13.7071068 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.7071068 Z M3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,5.5 Z M15,6 L17,6 C17.5522847,6 18,6.44771525 18,7 L18,9 C18,9.55228475 17.5522847,10 17,10 L15,10 C14.4477153,10 14,9.55228475 14,9 L14,7 C14,6.44771525 14.4477153,6 15,6 Z M15,7 L15,9 L17,9 L17,7 L15,7 Z"/>\n</svg>\n',dropupText:"Image"},[V]:{id:"upload-gifs-icon",svgString:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 5.9266752 5.6408391" height="21.31971" width="22.4">\n  <g>\n    <path d="m 5.2564627,1.548212 c -3.1136005,-0.4796804 -1.5568006,-0.2398402 0,0 z M 2.0001198,2.0922063 c 0.1556781,0 0.2657489,0.020893 0.3917849,0.080366 0.081154,0.038347 0.1153492,0.134065 0.076377,0.2138602 -0.038973,0.07979 -0.1363527,0.1134129 -0.2175069,0.075091 -0.078199,-0.036919 -0.1407455,-0.048792 -0.250655,-0.048792 -0.2260486,0 -0.3921482,0.2042182 -0.3921482,0.4801409 0,0.2761822 0.1663188,0.4810688 0.3921482,0.4810688 0.1117901,0 0.2064255,-0.046133 0.255659,-0.1284198 l 0.00162,-0.00389 V 3.0534032 l -0.098011,1.75e-4 c -0.081844,0 -0.1495979,-0.059305 -0.1612403,-0.1365887 l -0.00175,-0.023683 c 0,-0.08047 0.060311,-0.1470874 0.1389194,-0.1585331 l 0.024085,-0.00195 h 0.2612303 c 0.081842,0 0.149598,0.059305 0.1612404,0.1365891 l 0.00175,0.023683 -3.398e-4,0.3968809 v 0 l -0.00168,0.014211 v 0 l -0.00553,0.023034 v 0 l -0.00532,0.014145 c -0.098178,0.22826 -0.3236506,0.3528713 -0.5706303,0.3528713 -0.4240855,0 -0.7181621,-0.3622714 -0.7181621,-0.8016063 0,-0.4391857 0.2940275,-0.8006848 0.7181621,-0.8006848 z m 1.2034759,0.031275 c 0.081843,0 0.1495977,0.059305 0.1612403,0.1365891 l 0.00175,0.023683 v 1.2211775 c 0,0.088516 -0.07298,0.1602721 -0.1630073,0.1602721 -0.081841,0 -0.1495972,-0.059305 -0.1612397,-0.1365892 L 3.040589,3.5049308 V 2.2837527 c 0,-0.088516 0.07298,-0.1602721 0.1630067,-0.1602714 z m 0.7813442,0 0.5209469,0.00195 c 0.090025,3.048e-4 0.1627543,0.072306 0.1624458,0.1608234 -2.809e-4,0.08047 -0.06083,0.1468798 -0.1394772,0.158066 l -0.024092,0.00195 -0.3575326,-0.0013 v 0.4497782 l 0.2928918,2.27e-4 c 0.081842,0 0.1495979,0.059305 0.1612403,0.136589 l 0.00175,0.023683 c 0,0.080469 -0.06031,0.1470871 -0.1389193,0.1585393 l -0.024092,0.00195 -0.2928919,-2.336e-4 1.563e-4,0.2860316 c 0,0.080471 -0.06031,0.1470873 -0.1389193,0.1585395 l -0.024085,0.00195 c -0.081843,0 -0.1495979,-0.059305 -0.1612403,-0.1365826 l -0.00175,-0.023691 V 2.2841354 c 2.798e-4,-0.08047 0.060829,-0.1468797 0.1394758,-0.1580594 z"/>\n    <path d="m 5.0894191,1.0943261 c 0,-0.21918999 -0.177687,-0.39686999 -0.396876,-0.39686999 h -3.43959 c -0.2191879,0 -0.391262,0.1777519 -0.3968759,0.39686999 l -0.027082,3.4379266 c 0.040152,0.2939927 0.4235456,0.409415 0.4235456,0.409415 l 3.4785583,-0.00851 c 0,0 0.3008506,-0.1402998 0.3236271,-0.4201576 0.042911,-0.5272495 0.034693,-1.6106146 0.034693,-3.4186761 z m -4.49792494,0 c 0,-0.36530999 0.29614504,-0.66145999 0.66145894,-0.66145999 h 3.43959 c 0.365314,0 0.66146,0.29615 0.66146,0.66145999 v 3.43959 c 0,0.36532 -0.296146,0.66146 -0.66146,0.66146 h -3.43959 c -0.3653139,0 -0.66145894,-0.29614 -0.66145894,-0.66146 z"/>\n  </g>\n</svg>\n',dropupText:"GIF"},[W]:{id:"upload-audio-icon",svgString:'<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-49.49 -49.49 593.87 593.87" stroke-width="3.95908" transform="rotate(0)">\n  <g stroke-width="0"></g>\n  <g stroke-linecap="round" stroke-linejoin="round" stroke-width="0.98977"></g>\n  <g>\n    <g>\n      <g>\n        <path d="M163.205,76.413v293.301c-3.434-3.058-7.241-5.867-11.486-8.339c-21.38-12.452-49.663-15.298-77.567-7.846 c-49.038,13.096-80.904,54.519-71.038,92.337c4.019,15.404,14.188,28.221,29.404,37.087c13.553,7.894,29.87,11.933,47.115,11.933 c9.962,0,20.231-1.356,30.447-4.087c42.74-11.406,72.411-44.344,72.807-77.654h0.011v-0.162c0.002-0.166,0-0.331,0-0.496V187.072 l290.971-67.3v178.082c-3.433-3.055-7.238-5.863-11.481-8.334c-21.385-12.452-49.654-15.308-77.567-7.846 c-49.038,13.087-80.904,54.519-71.038,92.356c4.019,15.385,14.183,28.212,29.404,37.067c13.548,7.894,29.875,11.933,47.115,11.933 c9.962,0,20.231-1.356,30.452-4.087c42.74-11.413,72.411-44.346,72.804-77.654h0.004v-0.065c0.003-0.236,0.001-0.469,0-0.704V0 L163.205,76.413z M104.999,471.779c-22.543,6.038-45.942,3.846-62.572-5.846c-10.587-6.163-17.591-14.817-20.255-25.038 c-7.144-27.375,18.452-58.029,57.062-68.346c8.409-2.25,16.938-3.346,25.188-3.346c13.87,0,26.962,3.115,37.389,9.192 c10.587,6.163,17.591,14.817,20.255,25.029c0.809,3.102,1.142,6.248,1.139,9.4v0.321h0.014 C162.99,437.714,139.082,462.678,104.999,471.779z M182.898,166.853V92.067l290.971-67.298v74.784L182.898,166.853z M415.677,399.923c-22.558,6.038-45.942,3.837-62.587-5.846c-10.587-6.163-17.587-14.817-20.25-25.019 c-7.144-27.385,18.452-58.058,57.058-68.365c8.414-2.25,16.942-3.346,25.192-3.346c13.875,0,26.962,3.115,37.385,9.192 c10.596,6.163,17.596,14.817,20.26,25.029v0.01c0.796,3.05,1.124,6.144,1.135,9.244v0.468h0.02 C473.668,365.851,449.763,390.814,415.677,399.923z">\n        </path>\n      </g>\n    </g>\n  </g>\n</svg>',dropupText:"Audio"},mixedFiles:{id:"upload-mixed-files-icon",svgString:'<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M20 10.9696L11.9628 18.5497C10.9782 19.4783 9.64274 20 8.25028 20C6.85782 20 5.52239 19.4783 4.53777 18.5497C3.55315 17.6211 3 16.3616 3 15.0483C3 13.7351 3.55315 12.4756 4.53777 11.547L12.575 3.96687C13.2314 3.34779 14.1217 3 15.05 3C15.9783 3 16.8686 3.34779 17.525 3.96687C18.1814 4.58595 18.5502 5.4256 18.5502 6.30111C18.5502 7.17662 18.1814 8.01628 17.525 8.63535L9.47904 16.2154C9.15083 16.525 8.70569 16.6989 8.24154 16.6989C7.77738 16.6989 7.33224 16.525 7.00403 16.2154C6.67583 15.9059 6.49144 15.4861 6.49144 15.0483C6.49144 14.6106 6.67583 14.1907 7.00403 13.8812L14.429 6.88674" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n</svg>',dropupText:"File"}};class Nr extends jn{constructor(t){(null==t?void 0:t.position)===f&&(t.position=v);const e=Y.tryCreateConfig("Microphone",null==t?void 0:t.tooltip);super(Nr.createMicrophoneElement(),On,null==t?void 0:t.position,e,t),this.isActive=!1,this._innerElements=this.createInnerElementsForStates(this.customStyles),this.changeToDefault()}createInnerElementsForStates(t){const e="microphone-icon";return{[g]:this.createInnerElements(e,g,t),active:this.createInnerElements(e,"active",t),unsupported:this.createInnerElements(e,"unsupported",t),commandMode:this.createInnerElements(e,"commandMode",t)}}static createMicrophoneElement(){const e=i();return e.id="microphone-button",e[t].add("input-button"),e}changeToActive(){this.changeElementsByState(this._innerElements.active),this.toggleIconFilter("active"),this.reapplyStateStyle("active",[g,"commandMode"]),this.isActive=!0}changeToDefault(){this.changeElementsByState(this._innerElements[g]),this.toggleIconFilter(g),this.reapplyStateStyle(g,["active","commandMode"]),this.isActive=!1}changeToCommandMode(){this.changeElementsByState(this._innerElements.commandMode),this.toggleIconFilter("command"),this.reapplyStateStyle("commandMode",["active"])}changeToUnsupported(){this.changeElementsByState(this._innerElements.unsupported),this.elementRef[t].add("unsupported-microphone"),this.reapplyStateStyle("unsupported",["active"])}toggleIconFilter(e){const i=this.elementRef.children[0];if("svg"===i.tagName.toLocaleLowerCase())switch(e){case g:i[t].remove("active-microphone-icon","command-microphone-icon"),i[t].add("default-microphone-icon");break;case"active":i[t].remove("default-microphone-icon","command-microphone-icon"),i[t].add("active-microphone-icon");break;case"command":i[t].remove("active-microphone-icon","default-microphone-icon"),i[t].add("command-microphone-icon")}}}function Ir(t){return t&&t.h&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Pr,$r,Br,Rr={},Jr={},Fr={},Lr={},qr={};function zr(){if(Pr)return qr;Pr=1,Object.defineProperty(qr,"h",{value:!0}),qr.Text=void 0;class t{static capitalize(e){return e.replace(t.FIRST_CHAR_REGEX,t=>t.toUpperCase())}static lineBreak(e){return e.replace(t.DOUBLE_LINE,"<p></p>").replace(t.ONE_LINE,"<br>")}static isCharDefined(t){return void 0!==t&&" "!==t&&" "!==t&&"\n"!==t&&""!==t}static breakupIntoWordsArr(t){return t.split(/(\W+)/)}}return qr.Text=t,t.FIRST_CHAR_REGEX=/\S/,t.DOUBLE_LINE=/\n\n/g,t.ONE_LINE=/\n/g,qr}function Dr(){if($r)return Lr;$r=1,Object.defineProperty(Lr,"h",{value:!0}),Lr.Translate=void 0;const t=zr();return Lr.Translate=class{static translate(e,i){const s=t.Text.breakupIntoWordsArr(e);for(let t=0;t<s.length;t+=1)i[s[t]]&&(s[t]=i[s[t]]);return s.join("")}},Lr}var Ur,Hr={};function Vr(){if(Ur)return Hr;Ur=1,Object.defineProperty(Hr,"h",{value:!0}),Hr.Browser=void 0;class t{}return Hr.Browser=t,t.IS_SAFARI=()=>(void 0===t._IS_SAFARI&&(t._IS_SAFARI=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),t._IS_SAFARI),Hr}var Wr,Gr={},Zr={};var Kr,Xr={};var Qr,Yr={},ta={};function ea(){if(Qr)return ta;Qr=1,Object.defineProperty(ta,"h",{value:!0}),ta.AutoScroll=void 0;class t{static changeStateIfNeeded(t,e){e&&!t.isCursorAtEnd&&(t.endPadding="",t.scrollingSpan.innerHTML="&nbsp;")}static scrollGeneric(t,e){t.isCursorAtEnd?e.scrollTop=e.scrollHeight:t.scrollingSpan.scrollIntoView({block:"nearest"})}static scrollSafariPrimitiveToEnd(t){t.scrollLeft=t.scrollWidth,t.scrollTop=t.scrollHeight}static isElementOverflown(t){return t.scrollHeight>t.clientHeight||t.scrollWidth>t.clientWidth}static isRequired(e,i){return e&&t.isElementOverflown(i)}}return ta.AutoScroll=t,ta}var ia,sa={};function na(){if(ia)return sa;ia=1,Object.defineProperty(sa,"h",{value:!0}),sa.Elements=void 0;return sa.Elements=class{static isPrimitiveElement(t){return"INPUT"===t.tagName||"TEXTAREA"===t.tagName}static createInterimSpan(){const t=document.createElement("span");return t.style.color="grey",t.style.pointerEvents="none",t}static createGenericSpan(){const t=document.createElement("span");return t.style.pointerEvents="none",t}static appendSpans(t,e){if(t.spansPopulated=!0,t.insertInCursorLocation&&document.activeElement===e){const e=window.getSelection();if(null!=e&&e.focusNode){const i=e.getRangeAt(0);return i.insertNode(t.scrollingSpan),i.insertNode(t.interimSpan),i.insertNode(t.finalSpan),i.collapse(!1),e.removeAllRanges(),void e.addRange(i)}}e.appendChild(t.finalSpan),e.appendChild(t.interimSpan),e.appendChild(t.scrollingSpan)}static applyCustomColors(t,e){e.interim&&(t.interimSpan.style.color=e.interim),e.final&&(t.finalSpan.style.color=e.final)}static isInsideShadowDOM(t){return t.getRootNode()instanceof ShadowRoot}},sa}var oa,ra,aa={};function la(){if(oa)return aa;oa=1,Object.defineProperty(aa,"h",{value:!0}),aa.Cursor=void 0;class t{static setOffsetForGeneric(e,i,s=0){let n=0;for(let o=0;o<e.childNodes.length;o+=1){const r=e.childNodes[o];if(r.childNodes.length>0){const e=t.setOffsetForGeneric(r,i,s);if(-1===e)return-1;s+=e}else if(null!==r.textContent){if(s+r.textContent.length>i){const t=document.createRange();t.setStart(r,i-s),t.collapse(!0);const n=window.getSelection();return null==n||n.removeAllRanges(),null==n||n.addRange(t),e.focus(),-1}s+=r.textContent.length,n+=r.textContent.length}}return n}static focusEndOfGeneric(t){const e=document.createRange();e.selectNodeContents(t),e.collapse(!1);const i=window.getSelection();i&&(i.removeAllRanges(),i.addRange(e))}static setOffsetForSafariGeneric(e,i){const s=window.getSelection();if(s){const n=t.getGenericElementCursorOffset(e,s,!0);t.setOffsetForGeneric(e,n+i)}}static setOffsetForPrimitive(t,e,i){i&&t.blur(),t.setSelectionRange(e,e),t.focus()}static getGenericElementCursorOffset(t,e,i){let s=0;if(e.rangeCount>0){const n=e.getRangeAt(0),o=n.cloneRange();o.selectNodeContents(t),i?o.setEnd(n.startContainer,n.startOffset):o.setEnd(n.endContainer,n.endOffset),s=o.toString().length}return s}}return aa.Cursor=t,aa}function ca(){if(ra)return Yr;ra=1,Object.defineProperty(Yr,"h",{value:!0}),Yr.CommandUtils=void 0;const t=ea(),e=na(),i=Vr(),s=la(),n=zr();class o{static processCommand(t,e){return(!e||!e.caseSensitive)&&(t=t.toLowerCase()),!1===(null==e?void 0:e.substrings)?n.Text.breakupIntoWordsArr(t):t}static process(t){var e;return!0===(null===(e=t.settings)||void 0===e?void 0:e.caseSensitive)?t:Object.keys(t).reduce((e,i)=>{const s=t[i];return e[i]="string"==typeof s?o.processCommand(s,t.settings):s,e},{})}static toggleCommandModeOn(t){var e;t.isWaitingForCommand=!0,null===(e=t.onCommandModeTrigger)||void 0===e||e.call(t,!0)}static toggleCommandModeOff(t){var e;t.isWaitingForCommand&&(null===(e=t.onCommandModeTrigger)||void 0===e||e.call(t,!1),t.isWaitingForCommand=!1)}static setText(n,r,a,l){o.toggleCommandModeOff(n),e.Elements.isPrimitiveElement(l)?(l.value=a,n.isTargetInShadow||s.Cursor.setOffsetForPrimitive(l,a.length,!0),i.Browser.IS_SAFARI()&&n.autoScroll&&t.AutoScroll.scrollSafariPrimitiveToEnd(l)):(l.textContent=a,n.isTargetInShadow||s.Cursor.focusEndOfGeneric(l),setTimeout(()=>t.AutoScroll.scrollGeneric(n,l))),n.resetRecording(r)}static checkIfMatchesSubstring(t,e){return e.includes(t)}static checkIfMatchesWord(t,e,i){const s=t;for(let t=i.length-1;t>=0;t-=1){let e=t,n=s.length-1;for(;i[e]===s[n]&&n>=0;)e-=1,n-=1;if(n<0)return!0}return!1}static execCommand(t,e,i,s,r){var a,l,c;const h=t.commands;if(!h||!s||!i)return;const u=!0===(null===(a=h.settings)||void 0===a?void 0:a.caseSensitive)?e:e.toLowerCase(),d=n.Text.breakupIntoWordsArr(u),p=!1===(null===(l=h.settings)||void 0===l?void 0:l.substrings)?o.checkIfMatchesWord:o.checkIfMatchesSubstring;if(h.commandMode&&p(h.commandMode,u,d))return t.setInterimColorToFinal(),setTimeout(()=>o.toggleCommandModeOn(t)),{doNotProcessTranscription:!1};if(!h.commandMode||t.isWaitingForCommand){if(h.stop&&p(h.stop,u,d))return o.toggleCommandModeOff(t),setTimeout(()=>t.stop()),{doNotProcessTranscription:!1};if(h.pause&&p(h.pause,u,d))return o.toggleCommandModeOff(t),t.setInterimColorToFinal(),setTimeout(()=>{var e;t.isPaused=!0,null===(e=t.onPauseTrigger)||void 0===e||e.call(t,!0)}),{doNotProcessTranscription:!1};if(h.resume&&p(h.resume,u,d))return t.isPaused=!1,null===(c=t.onPauseTrigger)||void 0===c||c.call(t,!1),o.toggleCommandModeOff(t),t.resetRecording(i),{doNotProcessTranscription:!0};if(h.reset&&p(h.reset,u,d))return void 0!==r&&o.setText(t,i,r,s),{doNotProcessTranscription:!0};if(h.removeAllText&&p(h.removeAllText,u,d))return o.setText(t,i,"",s),{doNotProcessTranscription:!0}}}}return Yr.CommandUtils=o,Yr}var ha,ua={};var da,pa,ma,va={};function fa(){if(pa)return Gr;pa=1,Object.defineProperty(Gr,"h",{value:!0}),Gr.Speech=void 0;const t=function(){if(Wr)return Zr;Wr=1,Object.defineProperty(Zr,"h",{value:!0}),Zr.EventListeners=void 0;class t{static getElementIfFocusedOnAvailable(t,e){return Array.isArray(t)?t.find(t=>e===t):e===t?t:void 0}static keyDownWindow(e){e.element&&t.getElementIfFocusedOnAvailable(e.element,document.activeElement)&&(null!==t.KEY_DOWN_TIMEOUT&&clearTimeout(t.KEY_DOWN_TIMEOUT),t.KEY_DOWN_TIMEOUT=setTimeout(()=>{t.KEY_DOWN_TIMEOUT=null,this.resetRecording(e)},500))}static mouseDownWindow(e,i){this.mouseDownElement=t.getElementIfFocusedOnAvailable(e,i.target)}static mouseUpWindow(t){this.mouseDownElement&&this.resetRecording(t),this.mouseDownElement=void 0}static add(e,i){const s=void 0===(null==i?void 0:i.insertInCursorLocation)||(null==i?void 0:i.insertInCursorLocation);null!=i&&i.element&&s&&(e.mouseDownEvent=t.mouseDownWindow.bind(e,i.element),document.addEventListener("mousedown",e.mouseDownEvent),e.mouseUpEvent=t.mouseUpWindow.bind(e,i),document.addEventListener("mouseup",e.mouseUpEvent),e.keyDownEvent=t.keyDownWindow.bind(e,i),document.addEventListener("keydown",e.keyDownEvent))}static remove(t){document.removeEventListener("mousedown",t.mouseDownEvent),document.removeEventListener("mouseup",t.mouseUpEvent),document.removeEventListener("keydown",t.keyDownEvent)}}return Zr.EventListeners=t,t.KEY_DOWN_TIMEOUT=null,Zr}(),e=(Kr||(Kr=1,Object.defineProperty(Xr,"h",{value:!0}),Xr.PreResultUtils=void 0,Xr.PreResultUtils=class{static process(t,e,i,s,n){const o=null==s?void 0:s(e,i);return!!o&&(setTimeout(()=>{o.restart?t.resetRecording(n):o.stop&&t.stop()}),(o.stop||o.restart)&&o.removeNewText)}}),Xr),i=ca(),s=ea(),n=function(){if(ha)return ua;ha=1,Object.defineProperty(ua,"h",{value:!0}),ua.Highlight=void 0;const t=na(),e=la();class i{static setStateForPrimitive(t,e){let i,s;null!==e.selectionStart&&(i=e.selectionStart),null!==e.selectionEnd&&(s=e.selectionEnd),t.isHighlighted=i!==s}static setStateForGeneric(t,i){const s=window.getSelection();if(null!=s&&s.focusNode){const n=e.Cursor.getGenericElementCursorOffset(i,s,!0),o=e.Cursor.getGenericElementCursorOffset(i,s,!1);t.isHighlighted=n!==o}}static setState(e,s){document.activeElement===s&&(t.Elements.isPrimitiveElement(s)?i.setStateForPrimitive(e,s):i.setStateForGeneric(e,s))}static removeForGeneric(t,i){const s=window.getSelection();if(s){const n=e.Cursor.getGenericElementCursorOffset(i,s,!0);s.deleteFromDocument(),e.Cursor.setOffsetForGeneric(i,n),t.isHighlighted=!1}}static removeForPrimitive(t,i){const s=i.selectionStart,n=i.selectionEnd,o=i.value;if(s&&n){const r=o.substring(0,s)+o.substring(n);i.value=r,e.Cursor.setOffsetForPrimitive(i,s,t.autoScroll)}t.isHighlighted=!1}}return ua.Highlight=i,ua}(),o=na(),r=function(){if(da)return va;da=1,Object.defineProperty(va,"h",{value:!0}),va.Padding=void 0;const t=na(),e=la(),i=zr();class s{static setStateForPrimitiveElement(t,e){if(document.activeElement===e&&null!==e.selectionStart){const s=e.selectionStart,n=e.value[s-1],o=null===e.selectionEnd?s:e.selectionEnd,r=e.value[o];return i.Text.isCharDefined(n)&&(t.startPadding=" ",t.numberOfSpacesBeforeNewText=1),i.Text.isCharDefined(r)&&(t.endPadding=" ",t.numberOfSpacesAfterNewText=1),void(t.isCursorAtEnd=e.value.length===o)}const s=e.value[e.value.length-1];i.Text.isCharDefined(s)&&(t.startPadding=" ",t.numberOfSpacesBeforeNewText=1),t.isCursorAtEnd=!0}static setStateForGenericElement(t,s){var n,o,r;if(document.activeElement===s){const a=window.getSelection();if(null!=a&&a.focusNode){const l=e.Cursor.getGenericElementCursorOffset(s,a,!0),c=null===(n=s.textContent)||void 0===n?void 0:n[l-1],h=e.Cursor.getGenericElementCursorOffset(s,a,!1),u=null===(o=s.textContent)||void 0===o?void 0:o[h];return i.Text.isCharDefined(c)&&(t.startPadding=" "),i.Text.isCharDefined(u)&&(t.endPadding=" "),void(t.isCursorAtEnd=(null===(r=s.textContent)||void 0===r?void 0:r.length)===h)}}const a=s.innerText.charAt(s.innerText.length-1);i.Text.isCharDefined(a)&&(t.startPadding=" "),t.isCursorAtEnd=!0}static setState(e,i){t.Elements.isPrimitiveElement(i)?s.setStateForPrimitiveElement(e,i):s.setStateForGenericElement(e,i)}static adjustStateAfterRecodingPrimitiveElement(t,e){t.primitiveTextRecorded=!0,t.insertInCursorLocation&&document.activeElement===e&&(null!==e.selectionEnd&&(t.endPadding=t.endPadding+e.value.slice(e.selectionEnd)),null!==e.selectionStart)?t.startPadding=e.value.slice(0,e.selectionStart)+t.startPadding:t.startPadding=e.value+t.startPadding}static adjustSateForNoTextPrimitiveElement(t){1===t.numberOfSpacesBeforeNewText&&(t.startPadding=t.startPadding.substring(0,t.startPadding.length-1),t.numberOfSpacesBeforeNewText=0),1===t.numberOfSpacesAfterNewText&&(t.endPadding=t.endPadding.substring(1),t.numberOfSpacesAfterNewText=0)}}return va.Padding=s,va}(),a=Vr(),l=la(),c=zr();return Gr.Speech=class{constructor(){this.finalTranscript="",this.interimSpan=o.Elements.createInterimSpan(),this.finalSpan=o.Elements.createGenericSpan(),this.scrollingSpan=o.Elements.createGenericSpan(),this.isCursorAtEnd=!1,this.spansPopulated=!1,this.startPadding="",this.endPadding="",this.numberOfSpacesBeforeNewText=0,this.numberOfSpacesAfterNewText=0,this.isHighlighted=!1,this.primitiveTextRecorded=!1,this.recognizing=!1,this._displayInterimResults=!0,this.insertInCursorLocation=!0,this.autoScroll=!0,this.isRestarting=!1,this.isPaused=!1,this.isWaitingForCommand=!1,this.isTargetInShadow=!1,this.cannotBeStopped=!1,this.resetState()}prepareBeforeStart(e){var s,n;if(null!=e&&e.element)if(t.EventListeners.add(this,e),Array.isArray(e.element)){const t=e.element.find(t=>t===document.activeElement)||e.element[0];if(!t)return;this.prepare(t)}else this.prepare(e.element);void 0!==(null==e?void 0:e.displayInterimResults)&&(this._displayInterimResults=e.displayInterimResults),null!=e&&e.textColor&&(this._finalTextColor=null===(s=null==e?void 0:e.textColor)||void 0===s?void 0:s.final,o.Elements.applyCustomColors(this,e.textColor)),void 0!==(null==e?void 0:e.insertInCursorLocation)&&(this.insertInCursorLocation=e.insertInCursorLocation),void 0!==(null==e?void 0:e.autoScroll)&&(this.autoScroll=e.autoScroll),this._onResult=null==e?void 0:e.onResult,this._onPreResult=null==e?void 0:e.onPreResult,this._onStart=null==e?void 0:e.onStart,this._onStop=null==e?void 0:e.onStop,this._onError=null==e?void 0:e.onError,this.onCommandModeTrigger=null==e?void 0:e.onCommandModeTrigger,this.onPauseTrigger=null==e?void 0:e.onPauseTrigger,this._options=e,null!==(n=this._options)&&void 0!==n&&n.commands&&(this.commands=i.CommandUtils.process(this._options.commands))}prepare(t){r.Padding.setState(this,t),n.Highlight.setState(this,t),this.isTargetInShadow=o.Elements.isInsideShadowDOM(t),o.Elements.isPrimitiveElement(t)?(this._primitiveElement=t,this._originalText=this._primitiveElement.value):(this._genericElement=t,this._originalText=this._genericElement.textContent)}resetRecording(t){this.isRestarting=!0,this.stop(!0),this.resetState(!0),this.start(t,!0)}updateElements(t,s,n){var o;const r=c.Text.capitalize(s);if(this.finalTranscript===r&&""===t)return;e.PreResultUtils.process(this,n,""===t,this._onPreResult,this._options)&&(t="",n="");const a=this.commands&&i.CommandUtils.execCommand(this,n,this._options,this._primitiveElement||this._genericElement,this._originalText);if(a){if(a.doNotProcessTranscription)return;t="",n=""}if(this.isPaused||this.isWaitingForCommand)return;null===(o=this._onResult)||void 0===o||o.call(this,n,""===t),this.finalTranscript=r,this._displayInterimResults||(t="");const l=""===this.finalTranscript&&""===t;this._primitiveElement?this.updatePrimitiveElement(this._primitiveElement,t,l):this._genericElement&&this.updateGenericElement(this._genericElement,t,l)}updatePrimitiveElement(t,e,i){this.isHighlighted&&n.Highlight.removeForPrimitive(this,t),this.primitiveTextRecorded||r.Padding.adjustStateAfterRecodingPrimitiveElement(this,t),i&&r.Padding.adjustSateForNoTextPrimitiveElement(this);const o=this.startPadding+this.finalTranscript+e;if(t.value=o+this.endPadding,!this.isTargetInShadow){const e=o.length+this.numberOfSpacesAfterNewText;l.Cursor.setOffsetForPrimitive(t,e,this.autoScroll)}this.autoScroll&&a.Browser.IS_SAFARI()&&this.isCursorAtEnd&&s.AutoScroll.scrollSafariPrimitiveToEnd(t)}updateGenericElement(t,e,i){this.isHighlighted&&n.Highlight.removeForGeneric(this,t),this.spansPopulated||o.Elements.appendSpans(this,t);const r=(i?"":this.startPadding)+c.Text.lineBreak(this.finalTranscript);this.finalSpan.innerHTML=r;const h=s.AutoScroll.isRequired(this.autoScroll,t);s.AutoScroll.changeStateIfNeeded(this,h);const u=c.Text.lineBreak(e)+(i?"":this.endPadding);this.interimSpan.innerHTML=u,a.Browser.IS_SAFARI()&&this.insertInCursorLocation&&l.Cursor.setOffsetForSafariGeneric(t,r.length+u.length),h&&s.AutoScroll.scrollGeneric(this,t),i&&(this.scrollingSpan.innerHTML="")}finalise(e){this._genericElement&&(e?(this.finalSpan=o.Elements.createGenericSpan(),this.setInterimColorToFinal(),this.interimSpan=o.Elements.createInterimSpan(),this.scrollingSpan=o.Elements.createGenericSpan()):this._genericElement.textContent=this._genericElement.textContent,this.spansPopulated=!1),t.EventListeners.remove(this)}setInterimColorToFinal(){this.interimSpan.style.color=this._finalTextColor||"black"}resetState(t){this._primitiveElement=void 0,this._genericElement=void 0,this.finalTranscript="",this.finalSpan.innerHTML="",this.interimSpan.innerHTML="",this.scrollingSpan.innerHTML="",this.startPadding="",this.endPadding="",this.isHighlighted=!1,this.primitiveTextRecorded=!1,this.numberOfSpacesBeforeNewText=0,this.numberOfSpacesAfterNewText=0,t||(this.stopTimeout=void 0)}setStateOnStart(){var t;this.recognizing=!0,this.isRestarting?this.isRestarting=!1:null===(t=this._onStart)||void 0===t||t.call(this)}setStateOnStop(){var t;this.recognizing=!1,this.isRestarting||null===(t=this._onStop)||void 0===t||t.call(this)}setStateOnError(t){var e;null===(e=this._onError)||void 0===e||e.call(this,t),this.recognizing=!1}},Gr}function ga(){if(ma)return Jr;ma=1,Object.defineProperty(Jr,"h",{value:!0}),Jr.WebSpeech=void 0;const t=function(){if(Br)return Fr;Br=1,Object.defineProperty(Fr,"h",{value:!0}),Fr.WebSpeechTranscript=void 0;const t=Dr();return Fr.WebSpeechTranscript=class{static extract(e,i,s){let n="";for(let o=e.resultIndex;o<e.results.length;++o){let r=e.results[o][0].transcript;s&&(r=t.Translate.translate(r,s)),e.results[o].isFinal?i+=r:n+=r}return{interimTranscript:n,finalTranscript:i,newText:n||i}}static extractSafari(e,i,s){let n="";for(let i=e.resultIndex;i<e.results.length;++i){let o=e.results[i][0].transcript;s&&(o=t.Translate.translate(o,s)),n+=o}return{interimTranscript:"",finalTranscript:n,newText:n}}},Fr}(),e=Vr(),i=fa();class s extends i.Speech{constructor(){super()}start(i){var s;void 0===this._extractText&&(this._extractText=e.Browser.IS_SAFARI()?t.WebSpeechTranscript.extractSafari:t.WebSpeechTranscript.extract),this.validate()&&(this.prepareBeforeStart(i),this.instantiateService(i),null===(s=this._service)||void 0===s||s.start(),this._translations=null==i?void 0:i.translations)}validate(){return!!s.getAPI()||(this.error("Speech Recognition is unsupported"),!1)}instantiateService(t){var e,i;const n=s.getAPI();this._service=new n,this._service.continuous=!0,this._service.interimResults=null===(e=null==t?void 0:t.displayInterimResults)||void 0===e||e,this._service.lang=(null===(i=null==t?void 0:t.language)||void 0===i?void 0:i.trim())||"en-US",this.setEvents()}setEvents(){this._service&&(this._service.onstart=()=>{this.setStateOnStart()},this._service.onerror=t=>{e.Browser.IS_SAFARI()&&"Another request is started"===t.message||"aborted"===t.error&&this.isRestarting||"no-speech"!==t.error&&this.error(t.message||t.error)},this._service.onaudioend=()=>{this.setStateOnStop()},this._service.onend=()=>{this._stopping=!1},this._service.onresult=t=>{if(typeof t.results>"u"&&this._service)this._service.onend=null,this._service.stop();else if(this._extractText&&!this._stopping){const{interimTranscript:e,finalTranscript:i,newText:s}=this._extractText(t,this.finalTranscript,this._translations);this.updateElements(e,i,s)}})}stop(t){var e;this._stopping=!0,null===(e=this._service)||void 0===e||e.stop(),this.finalise(t)}static getAPI(){return window.webkitSpeechRecognition||window.SpeechRecognition}error(t){console.error(t),this.setStateOnError(t),this.stop()}}return Jr.WebSpeech=s,Jr}var ba,ya={};var wa,xa={},ka={};var Sa,_a,Oa={},Ma={};function Aa(){if(_a)return Oa;_a=1,Object.defineProperty(Oa,"h",{value:!0}),Oa.AzureSpeechConfig=void 0;const t=(Sa||(Sa=1,Object.defineProperty(Ma,"h",{value:!0}),Ma.README_URL=void 0,Ma.README_URL="https://github.com/OvidijusParsiunas/speech-to-element"),Ma);class e{static validateOptions(e,i){return i?i.subscriptionKey||i.token||i.retrieveToken?!!i.region||(e(`Please define a 'region' property - more info: ${t.README_URL}`),!1):(e(`Please define a 'subscriptionKey', 'token' or 'retrieveToken' property - more info: ${t.README_URL}`),!1):(e(`Please provide subscription details - more info: ${t.README_URL}`),!1)}static async getNewSpeechConfig(t,e){if(e.region)return e.subscriptionKey?t.fromSubscription(e.subscriptionKey.trim(),e.region.trim()):e.token?t.fromAuthorizationToken(e.token.trim(),e.region.trim()):e.retrieveToken?e.retrieveToken().then(i=>e.region?t.fromAuthorizationToken((null==i?void 0:i.trim())||"",e.region.trim()):null).catch(t=>(console.error(t),null)):null}static process(t,e){e.endpointId&&(t.endpointId=e.endpointId.trim()),e.language&&(t.speechRecognitionLanguage=e.language.trim())}static async get(t,i){const s=await e.getNewSpeechConfig(t,i);return s&&e.process(s,i),s}}return Oa.AzureSpeechConfig=e,Oa}var Ca,Ta={};var ja,Ea={};var Na,Ia,Pa,$a={};function Ba(){if(Ia)return xa;Ia=1,Object.defineProperty(xa,"h",{value:!0}),xa.Azure=void 0;const t=(wa||(wa=1,Object.defineProperty(ka,"h",{value:!0}),ka.PreventConnectionStop=void 0,ka.PreventConnectionStop=class{static applyPrevention(t){clearTimeout(t._manualConnectionStopPrevention),t.cannotBeStopped=!0,t._manualConnectionStopPrevention=setTimeout(()=>{t.cannotBeStopped=!1},800)}static clearPrevention(t){clearTimeout(t._manualConnectionStopPrevention),t.cannotBeStopped=!1}}),ka),e=Aa(),i=function(){if(Ca)return Ta;Ca=1,Object.defineProperty(Ta,"h",{value:!0}),Ta.StopTimeout=void 0;class t{static set(t){t.stopTimeout=setTimeout(()=>t.stop(),t.stopTimeoutMS)}static reset(e,i){e.stopTimeoutMS=i||t.DEFAULT_MS,t.stop(e),t.set(e)}static stop(t){t.stopTimeout&&clearTimeout(t.stopTimeout)}}return Ta.StopTimeout=t,t.DEFAULT_MS=2e4,Ta}(),s=(ja||(ja=1,Object.defineProperty(Ea,"h",{value:!0}),Ea.AzureAudioConfig=void 0,Ea.AzureAudioConfig=class{static get(t,e){return e?t.fromMicrophoneInput(e):t.fromDefaultMicrophoneInput()}}),Ea),n=function(){if(Na)return $a;Na=1,Object.defineProperty($a,"h",{value:!0}),$a.AzureTranscript=void 0;const t=Dr();return $a.AzureTranscript=class{static extract(e,i,s,n){return n&&(e=t.Translate.translate(e,n)),s?{interimTranscript:"",finalTranscript:i+e,newText:e}:{interimTranscript:e,finalTranscript:i,newText:e}}},$a}(),o=fa();class r extends o.Speech{constructor(){super(...arguments),this._newTextPadding=""}start(e,s){this._newTextPadding="",void 0===this.stopTimeout&&i.StopTimeout.reset(this,null==e?void 0:e.stopAfterSilenceMs),this.prepareBeforeStart(e),this.startAsync(e),s||t.PreventConnectionStop.applyPrevention(this)}async startAsync(t){var e;this.validate(t)&&(await this.instantiateService(t),this._translations=null==t?void 0:t.translations,null===(e=this._service)||void 0===e||e.startContinuousRecognitionAsync(()=>{},this.error))}validate(t){return r.getAPI()?e.AzureSpeechConfig.validateOptions(this.error.bind(this),t):(this.moduleNotFound(),!1)}async instantiateService(t){const i=r.getAPI(),n=s.AzureAudioConfig.get(i.AudioConfig,t.deviceId),o=await e.AzureSpeechConfig.get(i.SpeechConfig,t);if(o){let e;if(t.autoLanguage&&t.autoLanguage.languages.length>0){const{type:s,languages:r}=t.autoLanguage,a=r.slice(0,"Continuous"===s?10:4),l=i.AutoDetectSourceLanguageConfig.fromLanguages(a);"Continuous"===s&&(l.mode=1),e=i.SpeechRecognizer.FromConfig(o,l,n)}else e=new i.SpeechRecognizer(o,n);this.setEvents(e),this._service=e,t.retrieveToken&&this.retrieveTokenInterval(t.retrieveToken)}else this.error("Unable to contact Azure server")}setEvents(t){t.recognizing=this.onRecognizing.bind(this),t.recognized=this.onRecognized.bind(this),t.sessionStarted=this.onSessionStarted.bind(this),t.canceled=this.onCanceled.bind(this),t.sessionStopped=this.onSessionStopped.bind(this)}onRecognizing(t,e){if(this._stopping)return;const{interimTranscript:s,finalTranscript:o,newText:r}=n.AzureTranscript.extract(this._newTextPadding+e.result.text,this.finalTranscript,!1,this._translations);i.StopTimeout.reset(this,this.stopTimeoutMS),this.updateElements(s,o,r)}onRecognized(t,e){const s=e.result;switch(s.reason){case window.SpeechSDK.ResultReason.Canceled:break;case window.SpeechSDK.ResultReason.RecognizedSpeech:if(s.text&&!this._stopping){const{interimTranscript:t,finalTranscript:e,newText:o}=n.AzureTranscript.extract(this._newTextPadding+s.text,this.finalTranscript,!0,this._translations);i.StopTimeout.reset(this,this.stopTimeoutMS),this.updateElements(t,e,o),""!==e&&(this._newTextPadding=" ")}}}onCanceled(t,e){e.reason===window.SpeechSDK.CancellationReason.Error&&this.error(e.errorDetails)}onSessionStarted(){t.PreventConnectionStop.clearPrevention(this),this.setStateOnStart()}onSessionStopped(){this._retrieveTokenInterval||clearInterval(this._retrieveTokenInterval),this._stopping=!1,this.setStateOnStop()}retrieveTokenInterval(t){this._retrieveTokenInterval=setInterval(()=>{null==t||t().then(t=>{this._service&&(this._service.authorizationToken=(null==t?void 0:t.trim())||"")}).catch(t=>{this.error(t)})},1e4)}stop(t){var e;!t&&this._retrieveTokenInterval&&clearInterval(this._retrieveTokenInterval),this._stopping=!0,null===(e=this._service)||void 0===e||e.stopContinuousRecognitionAsync(),i.StopTimeout.stop(this),this.finalise(t)}static getAPI(){return window.SpeechSDK}moduleNotFound(){console.error("speech recognition module not found:"),console.error("please install the 'microsoft-cognitiveservices-speech-sdk' npm package or add a script tag: <script src=\"https://aka.ms/csspeech/jsbrowserpackageraw\"><\/script>"),this.setStateOnError("speech recognition module not found")}error(t){this._retrieveTokenInterval&&clearInterval(this._retrieveTokenInterval),console.error(t),this.setStateOnError(t),this.stop()}}return xa.Azure=r,xa}const Ra=Ir(function(){if(Pa)return Rr;Pa=1,Object.defineProperty(Rr,"h",{value:!0});const t=ga(),e=ca(),i=function(){if(ba)return ya;ba=1,Object.defineProperty(ya,"h",{value:!0}),ya.GlobalState=void 0;class t{static doubleClickDetector(){return!!t.doubleClickPending||(t.doubleClickPending=!0,setTimeout(()=>{t.doubleClickPending=!1},300),!1)}}return ya.GlobalState=t,t.doubleClickPending=!1,ya}(),s=Ba();class n{static toggle(t,e){var s,o;const r=t.toLocaleLowerCase().trim();null!==(s=i.GlobalState.service)&&void 0!==s&&s.recognizing?this.stop():"webspeech"===r?n.startWebSpeech(e):"azure"===r?n.startAzure(e):(console.error("service not found - must be either 'webspeech' or 'azure'"),null===(o=null==e?void 0:e.onError)||void 0===o||o.call(e,"service not found - must be either 'webspeech' or 'azure'"))}static startWebSpeech(e){n.stop()||(i.GlobalState.service=new t.WebSpeech,i.GlobalState.service.start(e))}static isWebSpeechSupported(){return!!t.WebSpeech.getAPI()}static startAzure(t){var e;n.stop()||null!==(e=i.GlobalState.service)&&void 0!==e&&e.cannotBeStopped||(i.GlobalState.service=new s.Azure,i.GlobalState.service.start(t))}static stop(){var t;return!!i.GlobalState.doubleClickDetector()||(!(null===(t=i.GlobalState.service)||void 0===t)&&t.recognizing&&i.GlobalState.service.stop(),!1)}static endCommandMode(){i.GlobalState.service&&e.CommandUtils.toggleCommandModeOff(i.GlobalState.service)}}return Rr.default=n,Rr}());class Ja{constructor(t,e){this._silenceMS=2e3,this._stop=!0,"boolean"==typeof e&&!1===e&&(this._stop=!1),"number"==typeof t&&(this._silenceMS=t)}setSilenceTimeout(t,e){this._silenceTimeout=setTimeout(()=>{var i;null==(i=t.submit)||i.call(t),Ra.stop(),this._stop||setTimeout(e,La.MICROPHONE_RESET_TIMEOUT_MS)},this._silenceMS)}clearSilenceTimeout(){this._silenceTimeout&&clearTimeout(this._silenceTimeout)}resetSilenceTimeout(t,e){this.clearSilenceTimeout(),this.setSilenceTimeout(t,e)}onPause(t,e,i){t?this.resetSilenceTimeout(e,i):this.clearSilenceTimeout()}}const Fa=class t extends Nr{constructor(t,e,i){const s="object"==typeof t.speechToText?t.speechToText:{};super(null==s?void 0:s.button);const{serviceName:n,processedConfig:o}=this.processConfiguration(e,t.speechToText);if(this._addErrorMessage=i,"webspeech"!==n||Ra.isWebSpeechSupported()){const i=!t.textInput||!t.textInput.disabled;this.elementRef.onclick=this.buttonClick.bind(this,e,i,n,o)}else this.changeToUnsupported();setTimeout(()=>{this._validationHandler=t._validationHandler})}processConfiguration(e,i){var s;const n="object"==typeof i?i:{},o="object"==typeof n.webSpeech?n.webSpeech:{},r=n.azure||{},a={displayInterimResults:n.displayInterimResults??void 0,textColor:n.textColor??void 0,translations:n.translations??void 0,commands:n.commands??void 0,events:n.events??void 0,...o,...r},l=null==(s=n.commands)?void 0:s.submit;return l&&(a.onPreResult=t=>t.toLowerCase().includes(l)?(setTimeout(()=>{var t;return null==(t=e.submit)?void 0:t.call(e)}),Ra.endCommandMode(),{restart:!0,removeNewText:!0}):null),n.submitAfterSilence&&(this._silenceSubmit=new Ja(n.submitAfterSilence,n.stopAfterSubmit)),{serviceName:t.getServiceName(n),processedConfig:a}}static getServiceName(t){return t.azure?"azure":"webspeech"}buttonClick(t,e,i,s){const n=null==s?void 0:s.events;t.removePlaceholderStyle(),Ra.toggle(i,{insertInCursorLocation:!1,element:e?t.inputElementRef:void 0,onError:()=>{var t;this.onError(),null==(t=this._silenceSubmit)||t.clearSilenceTimeout()},onStart:()=>{var t;this.changeToActive(),null==(t=null==n?void 0:n.onStart)||t.call(n)},onStop:()=>{var t,e,i;null==(t=this._validationHandler)||t.call(this),null==(e=this._silenceSubmit)||e.clearSilenceTimeout(),this.changeToDefault(),null==(i=null==n?void 0:n.onStop)||i.call(n)},onPauseTrigger:e=>{var i,s;null==(i=this._silenceSubmit)||i.onPause(e,t,this.elementRef.onclick),null==(s=null==n?void 0:n.onPauseTrigger)||s.call(n,e)},onPreResult:(t,e)=>{var i;null==(i=null==n?void 0:n.onPreResult)||i.call(n,t,e)},onResult:(e,i)=>{var s,o,r;i&&(null==(s=this._validationHandler)||s.call(this)),null==(o=this._silenceSubmit)||o.resetSilenceTimeout(t,this.elementRef.onclick),null==(r=null==n?void 0:n.onResult)||r.call(n,e,i)},onCommandModeTrigger:t=>{var e;this.onCommandModeTrigger(t),null==(e=null==n?void 0:n.onCommandModeTrigger)||e.call(n,t)},...s})}onCommandModeTrigger(t){t?this.changeToCommandMode():this.changeToActive()}onError(){this._addErrorMessage("speechToText","speech input error")}static toggleSpeechAfterSubmit(e,i=!0){e[y](),i||setTimeout(()=>e[y](),t.MICROPHONE_RESET_TIMEOUT_MS)}};Fa.MICROPHONE_RESET_TIMEOUT_MS=300;let La=Fa;class qa{constructor(t,e,i,s,n){this._attachments=[],this._fileCountLimit=99,this._acceptedFormat="",this._hiddenAttachments=new Set,i.maxNumberOfFiles&&(this._fileCountLimit=i.maxNumberOfFiles),this._toggleContainerDisplay=s,this._fileAttachmentsContainerRef=n,i.acceptedFormats&&(this._acceptedFormat=i.acceptedFormats),setTimeout(()=>{this._validationHandler=t._validationHandler,this._onInput=e.onInput})}attemptAddFile(t,e){var i;return!!qa.isFileTypeValid(t,this._acceptedFormat)&&(this.addAttachmentBasedOnType(t,e,!0),null==(i=this._onInput)||i.call(this,!0),!0)}static isFileTypeValid(t,e){if(""===e)return!0;const i=e.split(",");for(let e=0;e<i.length;e++){const s=i[e].trim();if(t.type===s)return!0;if(s.startsWith(".")){const e=s.slice(1);if(t.name.endsWith(e))return!0}else{if(t.name.endsWith(s))return!0;if(s.endsWith("/*")&&t.type.startsWith(s.slice(0,-2)))return!0}}return!1}static getTypeFromBlob(t){const{type:e}=t;return e.startsWith(D)?D:e.startsWith(W)?W:K}addAttachmentBasedOnType(t,e,i){const s=qa.getTypeFromBlob(t);if(s===D){const s=qa.createImageAttachment(e);this.addFileAttachment(t,D,s,i)}else if(s===W){const s=Da.createAudioAttachment(e);this.addFileAttachment(t,W,s,i)}else{const e=qa.createAnyFileAttachment(t.name);this.addFileAttachment(t,K,e,i)}}static createImageAttachment(e){const i=new Image;return i.src=e,i[t].add("image-attachment"),i}static createAnyFileAttachment(e){const s=i();s[t].add("border-bound-attachment"),et.IS_SAFARI&&s[t].add("border-bound-attachment-safari");const n=i();n[t].add("any-file-attachment-text");const o=i();return o[t].add("file-attachment-text-container"),o.appendChild(n),n.textContent=e,s.appendChild(o),s}addFileAttachment(t,e,i,s){var n;const o=qa.createContainer(i);if(this._attachments.length>=this._fileCountLimit){const t=this._attachments[this._attachments.length-1].removeButton;null==t||t[y]();const e=this._fileAttachmentsContainerRef.children;this._fileAttachmentsContainerRef.insertBefore(o,e[0])}else this._fileAttachmentsContainerRef.appendChild(o);const r={file:t,attachmentContainerElement:o,fileType:e};return s&&(r.removeButton=this.createRemoveAttachmentButton(r),o.appendChild(r.removeButton)),this._toggleContainerDisplay(!0),this._attachments.push(r),this._fileAttachmentsContainerRef.scrollTop=this._fileAttachmentsContainerRef.scrollHeight,null==(n=this._validationHandler)||n.call(this),r}static createContainer(e){const s=i();return s[t].add("file-attachment"),s.appendChild(e),s}createRemoveAttachmentButton(e){const s=i();s[t].add("remove-file-attachment-button"),s.onclick=this.removeAttachment.bind(this,e);const n=i();return n[t].add("x-icon"),n.innerText="×",s.appendChild(n),s}removeAttachment(t,e){var i,s;null==(i=this._onInput)||i.call(this,!(null==e||!e.isTrusted));const n=this._attachments.findIndex(e=>e===t),o=this._attachments[n].attachmentContainerElement;this._attachments.splice(n,1),Da.stopAttachmentPlayback(o),o.remove(),this._toggleContainerDisplay(!1),null==(s=this._validationHandler)||s.call(this)}getFiles(){return Array.from(this._attachments).map(t=>({[q]:t[q],type:t.fileType}))}hideAttachments(){this._hiddenAttachments.clear(),this._attachments.forEach(t=>{setTimeout(()=>{var e;return null==(e=t.removeButton)?void 0:e[y]()}),this._hiddenAttachments.add(t)})}removeAttachments(){this._attachments.forEach(t=>{setTimeout(()=>{var e;return null==(e=t.removeButton)?void 0:e[y]()})}),this._hiddenAttachments.clear()}readdAttachments(){var t;Array.from(this._hiddenAttachments).forEach(t=>{this._fileAttachmentsContainerRef.appendChild(t.attachmentContainerElement),this._attachments.push(t)}),null==(t=this._onInput)||t.call(this,!1),this._hiddenAttachments.clear()}}const za=class e extends qa{constructor(t,e,i,s,n){super(t,e,i,s,n)}static createAudioContainer(){const e=i();return e[t].add("border-bound-attachment","audio-attachment-icon-container"),et.IS_SAFARI&&e[t].add("border-bound-attachment-safari"),e}static addAudioElements(e,s){const n=e.parentElement?Dt.cloneElement(e):e,o=i(W);o.src=s;const r=xs.createSVGElement(Pn);r[t].add("attachment-icon","play-icon");const a=xs.createSVGElement($n);a[t].add("attachment-icon","stop-icon"),n.replaceChildren(r),o.onplay=()=>{n.replaceChildren(a)},o.onpause=()=>{n.replaceChildren(r),o.currentTime=0},o.onended=()=>{n.replaceChildren(r)},n.onclick=()=>{o.paused?o.play():o.pause()}}static createAudioAttachment(t){const i=e.createAudioContainer();return e.addAudioElements(i,t),i}createTimer(i,s){let n=0;const o=void 0!==s&&s<e.TIMER_LIMIT_S?s:e.TIMER_LIMIT_S;return setInterval(()=>{var e;n+=1,n===o&&(null==(e=this.stopPlaceholderCallback)||e.call(this),this.clearTimer()),600===n&&i[t].add("audio-placeholder-text-4-digits");const s=Math.floor(n/60),r=(n%60).toString().padStart(2,"0");i.textContent=`${s}:${r}`},1e3)}createPlaceholderAudioAttachment(s){const n=e.createAudioContainer(),o=i();o[t].add("audio-placeholder-text-3-digits");const r=i();r[t].add("file-attachment-text-container","audio-placeholder-text-3-digits-container"),r.appendChild(o);const a=xs.createSVGElement($n);return a[t].add("attachment-icon","stop-icon","not-removable-attachment-icon"),o.textContent="0:00",this._activePlaceholderTimer=this.createTimer(o,s),n.appendChild(r),this.addPlaceholderAudioAttachmentEvents(n,a,r),n}addPlaceholderAudioAttachmentEvents(t,e,i){t.addEventListener("mouseenter",()=>t.replaceChildren(e));t.addEventListener("mouseleave",()=>t.replaceChildren(i));t.addEventListener(y,()=>{var t;return null==(t=this.stopPlaceholderCallback)?void 0:t.call(this)})}addPlaceholderAttachment(t,e){const i=this.createPlaceholderAudioAttachment(e);this._activePlaceholderAttachment=this.addFileAttachment(new File([],""),W,i,!1),this.stopPlaceholderCallback=t}completePlaceholderAttachment(t,i){const s=this._activePlaceholderAttachment;s&&(s[q]=t,e.addAudioElements(s.attachmentContainerElement.children[0],i),s.removeButton=this.createRemoveAttachmentButton(s),s.attachmentContainerElement.appendChild(s.removeButton),this._activePlaceholderAttachment=void 0,this.clearTimer())}removePlaceholderAttachment(){this._activePlaceholderAttachment&&(this.removeAttachment(this._activePlaceholderAttachment),this._activePlaceholderAttachment=void 0,this.clearTimer())}clearTimer(){void 0!==this._activePlaceholderTimer&&(clearInterval(this._activePlaceholderTimer),this._activePlaceholderTimer=void 0,this.stopPlaceholderCallback=void 0)}static stopAttachmentPlayback(e){var i,s,n;null!=(n=null==(s=null==(i=e.children[0])?void 0:i.children)?void 0:s[0])&&n[t].contains("stop-icon")&&e.children[0][y]()}};za.TIMER_LIMIT_S=5999;let Da=za;class Ua{static create(t,e,i,s,n,o){return o===W?new Da(t,e,i,s,n):new qa(t,e,i,s,n)}}class Ha{constructor(t,i,s){this._fileAttachmentsTypes=[],this.elementRef=this.createAttachmentContainer();const n="object"==typeof s&&!!s.displayFileAttachmentContainer;this.toggleContainerDisplay(n),t.appendChild(this.elementRef),i&&Object.assign(this.elementRef[e],i)}addType(t,e,i,s){const n=Ua.create(t,e,i,this.toggleContainerDisplay.bind(this),this.elementRef,s);return this._fileAttachmentsTypes.push(n),n}createAttachmentContainer(){const t=i();return t.id="file-attachment-container",t}toggleContainerDisplay(t){t?this.elementRef[e].display="block":0===this.elementRef.children.length&&(this.elementRef[e].display="none")}getAllFileData(){const t=this._fileAttachmentsTypes.map(t=>t.getFiles()).flat();return t.length>0?t:void 0}async completePlaceholders(){await Promise.all(this._fileAttachmentsTypes.map(async t=>{var e;return null==(e=t.stopPlaceholderCallback)?void 0:e.call(t)}))}static addFilesToType(t,e){t.forEach(t=>{const i=new FileReader;i.readAsDataURL(t),i.onload=i=>{for(let s=0;s<e.length&&!e[s].attemptAddFile(t,i.target.result);s+=1);}})}addFilesToAnyType(t){Ha.addFilesToType(t,this._fileAttachmentsTypes)}hideFiles(){this._fileAttachmentsTypes.forEach(t=>t.hideAttachments()),this.elementRef.replaceChildren(),this.toggleContainerDisplay(!1)}removeHiddenFiles(){this._fileAttachmentsTypes.forEach(t=>t.removeAttachments())}readdHiddenFiles(){this._fileAttachmentsTypes.forEach(t=>t.readdAttachments()),this.toggleContainerDisplay(!0)}getNumberOfTypes(){return this._fileAttachmentsTypes.length}}const Va=class s{constructor(t,e,i){this._isOpen=!1,this._contentRef=s.createModalContent(e,null==i?void 0:i.backgroundColor),this._buttonPanel=s.createButtonPanel(null==i?void 0:i.backgroundColor),this._elementRef=s.createContainer(this._contentRef,i),this._elementRef.appendChild(this._buttonPanel),t.appendChild(this._elementRef),this._backgroundPanelRef=s.createDarkBackgroundPanel(),t.appendChild(this._backgroundPanelRef),this.addWindowEvents(t)}isOpen(){return this._isOpen}static createContainer(s,n){const o=i();return o[t].add("modal"),o.appendChild(s),n&&delete n.backgroundColor,Object.assign(o[e],n),o}static createModalContent(s,n){const o=i();return o[t].add(...s),n&&(o[e].backgroundColor=n),i().appendChild(o),o}static createButtonPanel(s){const n=i();return n[t].add("modal-button-panel"),s&&(n[e].backgroundColor=s),n}static createDarkBackgroundPanel(){const t=i();return t.id="modal-background-panel",t}addButtons(...t){t.forEach(t=>{_n.addAttributes(t),this._buttonPanel.appendChild(t)})}static createTextButton(e){const s=i();return s[t].add("modal-button"),s.textContent=e,s}static createSVGButton(e){const s=i();s[t].add("modal-button","modal-svg-button");const n=xs.createSVGElement(e);return n[t].add("modal-svg-button-icon"),s.appendChild(n),s}close(){this._elementRef[t].remove("show-modal"),this._elementRef[t].add("hide-modal"),this._backgroundPanelRef[t].remove("show-modal-background"),this._backgroundPanelRef[t].add("hide-modal-background"),this._isOpen=!1,setTimeout(()=>{this._elementRef[e].display="none",this._backgroundPanelRef[e].display="none"},s.MODAL_CLOSE_TIMEOUT_MS)}displayModalElements(){this._elementRef[e].display="flex",this._elementRef[t].remove("hide-modal"),this._elementRef[t].add("show-modal"),this._backgroundPanelRef[e].display="block",this._backgroundPanelRef[t].remove("hide-modal-background"),this._backgroundPanelRef[t].add("show-modal-background"),this._isOpen=!0}openTextModal(t){this._contentRef.innerHTML=t,this.displayModalElements()}addCloseButton(t,e,i){const n=e?s.createSVGButton(t):s.createTextButton(t);return this.addButtons(n),n.onclick=()=>{this.close(),setTimeout(()=>{null==i||i()},140)},n}static createTextModalFunc(t,e,i){var n;if("object"==typeof e&&null!=(n=e[z])&&n.infoModal){const n=new s(t,["modal-content"],e[z].infoModal.containerStyle);return n.addCloseButton("OK",!1,i),n.openTextModal.bind(n,e.infoModalTextMarkUp||"")}}addWindowEvents(t){this.keyDownEvent=this.windowKeyDown.bind(this,t),window.addEventListener("keydown",this.keyDownEvent)}windowKeyDown(t,e){var i,s;!t.isConnected&&this.keyDownEvent?window.removeEventListener("keydown",this.keyDownEvent):this._isOpen&&(e.key===it.ESCAPE?(this.close(),null==(i=this.extensionCloseCallback)||i.call(this)):e.key===it.ENTER&&(this.close(),null==(s=this.extensionCloseCallback)||s.call(this)))}};Va.MODAL_CLOSE_TIMEOUT_MS=190;let Wa=Va;class Ga extends jn{constructor(t,e,i,s,n,o){var r,a,l,c,h,u,d,p,m,v;const f=null==(r=null==i?void 0:i.button)?void 0:r.position,g=(null==(c=null==(l=null==(a=null==i?void 0:i.button)?void 0:a.styles)?void 0:l[M])?void 0:c.content)||o,b=Y.tryCreateConfig("Upload File",null==(h=null==i?void 0:i.button)?void 0:h.tooltip);super(Ga.createButtonElement(),n,f,b,i.button,g);const y=this.createInnerElementsForStates(s,this.customStyles);this._inputElement=Ga.createInputElement(null==(u=null==i?void 0:i[z])?void 0:u.acceptedFormats),this.addClickEvent(t,i),this.changeElementsByState(y.styles),this.reapplyStateStyle("styles"),this._fileAttachmentsType=e,this._openModalOnce=!1===(null==(p=null==(d=i[z])?void 0:d.infoModal)?void 0:p.openModalOnce)||null==(v=null==(m=i[z])?void 0:m.infoModal)?void 0:v.openModalOnce}createInnerElementsForStates(t,e){return{styles:this.createInnerElements(t,"styles",e)}}triggerImportPrompt(t){t.onchange=this.import.bind(this,t),t[y]()}import(t){Ha.addFilesToType(Array.from(t[z]||[]),[this._fileAttachmentsType]),t.value=""}static createInputElement(t){const e=i("input");return e.type=q,e.accept=t||"",e.hidden=!0,e.multiple=!0,e}static createButtonElement(){const e=i();return e[t].add("input-button"),e}addClickEvent(t,e){const i=this.triggerImportPrompt.bind(this,this._inputElement),s=Wa.createTextModalFunc(t,e,i);this.elementRef.onclick=this[y].bind(this,s)}click(t){!t||void 0!==this._openModalOnce&&!0!==this._openModalOnce?this.triggerImportPrompt(this._inputElement):(t(),!0===this._openModalOnce&&(this._openModalOnce=!1))}}class Za{static create(t,e,i){const s=Za.createElement(i);Za.addEvents(s,t,e),t.appendChild(s)}static createElement(t){const s=i();return s.id="drag-and-drop",typeof t===Bt&&Object.assign(s[e],t),s}static addEvents(t,e,i){e.ondragenter=e=>{e.preventDefault(),Za.display(t)},t.ondragleave=e=>{e.preventDefault(),Za.hide(t)},t.ondragover=t=>{t.preventDefault()},t.ondrop=e=>{e.preventDefault(),Za.uploadFile(i,e),Za.hide(t)}}static uploadFile(t,e){var i;const s=null==(i=e.dataTransfer)?void 0:i[z];s&&t.addFilesToAnyType(Array.from(s))}static display(t){t[e].display="block"}static hide(t){t[e].display="none"}static isEnabled(t,e){return(void 0===e||!1!==e)&&(!!e||t.getNumberOfTypes()>0)}}class Ka{static validate(t,e,i,s,n){const o=t(i,s,n);return o?e.changeToSubmitIcon():e.changeToDisabledIcon(),o}static async useValidationFunc(t,e,i,s){const n=e.isTextInputEmpty()?"":e.inputElementRef.textContent;await i.completePlaceholders();const o=i.getAllFileData(),r=null==o?void 0:o.map(t=>t[q]);return Ka.validate(t,s,n,r)}static async useValidationFuncProgrammatic(t,e,i){var s;const n=null==(s=e[z])?void 0:s.map(t=>t[q]);return Ka.validate(t,i,e[M],n,!0)}static validateWebsocket(t,e){const{websocket:i,connectSettings:s}=t;return!(i&&s.url!==ls.URL&&!cs.canSendMessage(i))||(e.changeToDisabledIcon(),!1)}static attach(t,e,i,s,n){const o=t.validateInput||Gt.processValidateInput(t);t._validationHandler=async t=>{if(n.status.loadingActive||n.status.requestInProgress||!0===e.isSubmitProgrammaticallyDisabled||!Ka.validateWebsocket(e,n))return!1;const r=o||e.canSendMessage;return r?t?Ka.useValidationFuncProgrammatic(r,t,n):Ka.useValidationFunc(r,i,s,n):null}}}class Xa{static getFileName(t,e){const i=new Date;return`${t}-${String(i.getHours()).padStart(2,"0")}-${String(i.getMinutes()).padStart(2,"0")}-${String(i.getSeconds()).padStart(2,"0")}.${e}`}}class Qa extends Nr{constructor(t,e){var i,s;super(e.button),this._waitingForBrowserApproval=!1,this._audioType=t,this._extension=(null==(i=e[z])?void 0:i.format)||"mp3",this._maxDurationSeconds=null==(s=e[z])?void 0:s.maxDurationSeconds,this.elementRef.onclick=this.buttonClick.bind(this)}buttonClick(){this._waitingForBrowserApproval||(this.isActive?this.stop():(this._waitingForBrowserApproval=!0,this.record()))}stop(){return new Promise(t=>{var e,i;this.changeToDefault(),null==(e=this._mediaRecorder)||e.stop(),null==(i=this._mediaStream)||i.getTracks().forEach(t=>t.stop()),setTimeout(()=>{t()},10)})}record(){navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{this.changeToActive(),this._mediaRecorder=new MediaRecorder(t),this._audioType.addPlaceholderAttachment(this.stop.bind(this),this._maxDurationSeconds),this._mediaStream=t,this._mediaRecorder.addEventListener("dataavailable",t=>{this.createFile(t)}),this._mediaRecorder.start()}).catch(t=>{console[C](t),this.stop()}).finally(()=>{this._waitingForBrowserApproval=!1})}createFile(t){const e=new Blob([t.data],{type:`audio/${this._extension}`}),i=Xa.getFileName(this._newFilePrefix||W,this._extension),s=new File([e],i,{type:e.type}),n=new FileReader;n.readAsDataURL(s),n.onload=t=>{this._audioType.completePlaceholderAttachment(s,t.target.result)}}}class Ya{static resetSubmit(t,e){e?t.unsetCustomStateStyles(["loading","submit"]):t.unsetCustomStateStyles(["stop","loading","submit"]),t.reapplyStateStyle("submit")}static overwriteDefaultStyleWithSubmit(t,e){if(!t.submit)return;const i=JSON.parse(JSON.stringify(t[e]||{}));In.overwritePropertyObjectFromAnother(i,t.submit,["container",g]),In.overwritePropertyObjectFromAnother(i,t.submit,[M,"styles",g]),In.overwritePropertyObjectFromAnother(i,t.submit,["svg","styles",g]),t[e]=i}static setUpDisabledButton(t){In.setPropertyValueIfDoesNotExist(t,["submit","container",g,"backgroundColor"],""),In.setPropertyValueIfDoesNotExist(t,["disabled","container",g,"backgroundColor"],"unset"),In.setPropertyValueIfDoesNotExist(t.submit,["svg","styles",g,"filter"],""),In.setPropertyValueIfDoesNotExist(t.disabled,["svg","styles",g,"filter"],"brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(5564%) hue-rotate(207deg) brightness(100%) contrast(97%)"),In.setPropertyValueIfDoesNotExist(t.disabled,[M,"styles",g,"color"],"grey"),Ya.overwriteDefaultStyleWithSubmit(t,"disabled")}static process(t){const e=JSON.parse(JSON.stringify(t||{}));return Ya.overwriteDefaultStyleWithSubmit(e,"loading"),Ya.overwriteDefaultStyleWithSubmit(e,"stop"),null!=t&&t.alwaysEnabled||Ya.setUpDisabledButton(e),e}}class tl extends jn{constructor(t,e,i,s,n,o){const r=Ya.process(t.submitButtonStyles),a=Y.tryCreateConfig("Submit",null==r?void 0:r.tooltip);super(tl.createButtonContainerElement(),'<?xml version="1.0" standalone="no"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" stroke="currentColor" fill="none" stroke-width="1" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">\n  <line x1="22" y1="2" x2="11" y2="14"></line>\n  <polygon points="22 2 15 22 11 14 2 10 22 2"></polygon>\n</svg>\n',null==r?void 0:r.position,a,r),this._isSVGLoadingIconOverriden=!1,this.status={requestInProgress:!1,loadingActive:!1},this._messages=i,this._textInput=e,this._fileAttachments=n,this._innerElements=this.createInnerElementsForStates(),this._stopClicked={listener:()=>{}},this._serviceIO=s,this._alwaysEnabled=!(null==r||!r.alwaysEnabled),t.disableSubmitButton=this.disableSubmitButton.bind(this,s),this.attemptOverwriteLoadingStyle(t),o.microphone&&this.setUpSpeechToText(o.microphone.button,t.speechToText),setTimeout(()=>{var e;this._validationHandler=t._validationHandler,this.assignHandlers(this._validationHandler),null==(e=this._validationHandler)||e.call(this)})}createInnerElementsForStates(){const{submit:t,loading:e,stop:i}=this.createCustomElements();return{submit:t,loading:e||[tl.createLoadingIconElement()],stop:i||[tl.createStopIconElement()],disabled:this.createDisabledIconElement(t)}}createCustomElements(){const t=An.createCustomElements("submit",this.svg,this.customStyles),e={loading:void 0,stop:void 0};return Object.keys(e).forEach(t=>{const i=t,s=An.createCustomElements(i,this.svg,this.customStyles);s&&(e[i]=s)}),e.submit=t||this.buildDefaultIconElement("submit-icon"),e}static createButtonContainerElement(){const e=i();return e[t].add("input-button"),e}static createLoadingIconElement(){const e=i();return e[t].add("loading-submit-button"),e}static createStopIconElement(){const t=i();return t.id="stop-icon",t}createDisabledIconElement(t){return An.createCustomElements("disabled",this.svg,this.customStyles)||[t[0].cloneNode(!0)]}attemptOverwriteLoadingStyle(t){var e,s,n,o,r,a,l,c,h;if(!(null!=(s=null==(e=this.customStyles)?void 0:e.submit)&&s.svg||null!=(r=null==(o=null==(n=this.customStyles)?void 0:n.loading)?void 0:o.svg)&&r.content||null!=(c=null==(l=null==(a=this.customStyles)?void 0:a.loading)?void 0:l[M])&&c.content||void 0!==t.displayLoadingBubble&&!0!==t.displayLoadingBubble)){const e=i("style");e.textContent="\n        .loading-button > * {\n          filter: brightness(0) saturate(100%) invert(72%) sepia(0%) saturate(3044%) hue-rotate(322deg) brightness(100%)\n            contrast(96%) !important;\n        }",null==(h=t.shadowRoot)||h.appendChild(e),this._isSVGLoadingIconOverriden=!0}}assignHandlers(t){this._serviceIO.completionsHandlers={onFinish:this.resetSubmit.bind(this,t)},this._serviceIO.streamHandlers={onOpen:this.changeToStopIcon.bind(this),onClose:this.resetSubmit.bind(this,t),stopClicked:this._stopClicked};const{stream:e}=this._serviceIO;"object"==typeof e&&"number"==typeof e.simulation&&(this._serviceIO.streamHandlers.simulationInterim=e.simulation)}setUpSpeechToText(t,e){this._microphoneButton=t,this._stopSTTAfterSubmit="object"==typeof e&&e.stopAfterSubmit}resetSubmit(t){this.status.requestInProgress=!1,this.status.loadingActive=!1,t()}async submitFromInput(){await this._fileAttachments.completePlaceholders();const t=this._fileAttachments.getAllFileData();if(this._textInput.isTextInputEmpty())this.attemptSubmit({[M]:"",[z]:t});else{const e=this._textInput.inputElementRef.innerText.trim();this.attemptSubmit({[M]:e,[z]:t})}(et.IS_SAFARI||et.IS_MOBILE)&&setTimeout(()=>lt.focusEndOfInput(this._textInput.inputElementRef))}async programmaticSubmit(t){"string"==typeof t&&(t=Gt.processSubmitUserMessage(t));const e={[M]:t[M]};t[z]&&(e[z]=Array.from(t[z]).map(t=>({file:t,type:qa.getTypeFromBlob(t)}))),t.custom&&(e.custom=t.custom),setTimeout(()=>this.attemptSubmit(e,!0))}async attemptSubmit(t,e=!1){var i,s,n,o;if(!1===await(null==(i=this._validationHandler)?void 0:i.call(this,e?t:void 0)))return;this.changeToLoadingIcon(),this._textInput.clear(),et.IS_MOBILE&&setTimeout(()=>this._textInput.inputElementRef.focus()),"boolean"!=typeof this._messages.focusMode&&null!=(s=this._messages.focusMode)&&s.fade&&await Di.fadeAnimation(this._messages.elementRef,this._messages.focusMode.fade),await this.addNewMessage(t),this._serviceIO.isWebModel()||this._messages.addLoadingMessage();const r=null==(n=t[z])?void 0:n.map(t=>t[q]),a={[M]:""===t[M]?void 0:t[M],[z]:r};await this._serviceIO.callAPI(a,this._messages),null==(o=this._fileAttachments)||o.hideFiles()}async addNewMessage({text:t,files:e,custom:i}){const s={role:E,custom:i};t&&(s[M]=t),e&&(s[z]=await this._messages.addMultipleFiles(e,this._fileAttachments)),this._serviceIO.sessionId&&(s._sessionId=this._serviceIO.sessionId),Object.keys(s).length>0&&this._messages.addNewMessage(s)}stopStream(){var t,e,i;null==(e=(t=this._serviceIO.streamHandlers).onAbort)||e.call(t),null==(i=this._stopClicked)||i.listener(),this._validationHandler&&this.resetSubmit(this._validationHandler)}changeToStopIcon(){this._serviceIO.websocket||(this.elementRef[t].remove(o,a,o),_n.removeAriaAttributes(this.elementRef),this.changeElementsByState(this._innerElements.stop),this.reapplyStateStyle("stop",["loading","submit"]),this.elementRef.onclick=this.stopStream.bind(this),this.status.loadingActive=!1)}changeToLoadingIcon(){this._serviceIO.websocket||(this._isSVGLoadingIconOverriden||this.changeElementsByState(this._innerElements.loading),this.elementRef[t].remove(o,a),_n.removeAriaDisabled(this.elementRef),this.elementRef[t].add(r),_n.addAriaBusy(this.elementRef),this.reapplyStateStyle("loading",["submit"]),this.elementRef.onclick=()=>{},this.status.requestInProgress=!0,this.status.loadingActive=!0)}changeToSubmitIcon(){this.elementRef[t].contains(o)||(this.elementRef[t].remove(r,a),_n.removeAriaAttributes(this.elementRef),this.elementRef[t].add(o),this.changeElementsByState(this._innerElements.submit),Ya.resetSubmit(this,this.status.loadingActive),this.elementRef.onclick=()=>{var t;this.submitFromInput(),null!=(t=this._microphoneButton)&&t.isActive&&La.toggleSpeechAfterSubmit(this._microphoneButton.elementRef,!!this._stopSTTAfterSubmit),setTimeout(()=>lt.focusEndOfInput(this._textInput.inputElementRef))})}changeToDisabledIcon(e=!1){this._alwaysEnabled&&!e?this.changeToSubmitIcon():this.elementRef[t].contains(a)||(this.elementRef[t].remove(r,o),_n.removeAriaBusy(this.elementRef),this.elementRef[t].add(a),_n.addAriaDisabled(this.elementRef),this.changeElementsByState(this._innerElements.disabled),this.reapplyStateStyle("disabled",["submit"]),this.elementRef.onclick=()=>{})}disableSubmitButton(t,e){var i;t.isSubmitProgrammaticallyDisabled=!1!==e,!this.status.requestInProgress&&!this.status.loadingActive&&(!1===e?null==(i=this._validationHandler)||i.call(this):this.changeToDisabledIcon(!0))}}class el extends Wa{constructor(e,s,n,o){super(e,["modal-content","modal-camera-content"],n),this._stopped=!1,this._format="image/png",this._canvas=i("canvas"),this._canvas[t].add("camera-modal-canvas");const{captureButton:r,submitButton:a}=this.addButtonsAndTheirEvents(s);this._captureButton=r,this._submitButton=a,this._captureIcon=this._captureButton.children[0],this._refreshIcon=xs.createSVGElement('<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">\n  <path d="M27.1 14.313V5.396L24.158 8.34c-2.33-2.325-5.033-3.503-8.11-3.503C9.902 4.837 4.901 9.847 4.899 16c.001 6.152 5.003 11.158 11.15 11.16 4.276 0 9.369-2.227 10.836-8.478l.028-.122h-3.23l-.022.068c-1.078 3.242-4.138 5.421-7.613 5.421a8 8 0 0 1-5.691-2.359A7.993 7.993 0 0 1 8 16.001c0-4.438 3.611-8.049 8.05-8.049 2.069 0 3.638.58 5.924 2.573l-3.792 3.789H27.1z"/>\n</svg>\n'),this._refreshIcon[t].add("modal-svg-button-icon","modal-svg-refresh-icon"),"jpeg"===(null==o?void 0:o.format)&&(this._format="image/jpeg"),null!=o&&o.dimensions&&(this._dimensions=o.dimensions),this._contentRef.appendChild(this._canvas),this.extensionCloseCallback=this.stop}addButtonsAndTheirEvents(e){const i=Wa.createSVGButton('<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">\n  <path d="M0 16q0 3.264 1.28 6.208t3.392 5.12 5.12 3.424 6.208 1.248 6.208-1.248 5.12-3.424 3.392-5.12 1.28-6.208-1.28-6.208-3.392-5.12-5.088-3.392-6.24-1.28q-3.264 0-6.208 1.28t-5.12 3.392-3.392 5.12-1.28 6.208zM4 16q0-3.264 1.6-6.016t4.384-4.352 6.016-1.632 6.016 1.632 4.384 4.352 1.6 6.016-1.6 6.048-4.384 4.352-6.016 1.6-6.016-1.6-4.384-4.352-1.6-6.048z"></path>\n</svg>\n');i[t].add("modal-svg-camera-button"),i.children[0][t].add("modal-svg-camera-icon");const s=this.addCloseButton('<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">\n  <path d="M195.2 195.2a64 64 0 0 1 90.496 0L512 421.504 738.304 195.2a64 64 0 0 1 90.496 90.496L602.496 512 828.8 738.304a64 64 0 0 1-90.496 90.496L512 602.496 285.696 828.8a64 64 0 0 1-90.496-90.496L421.504 512 195.2 285.696a64 64 0 0 1 0-90.496z"/>\n</svg>',!0);s[t].add("modal-svg-close-button"),s.children[0][t].add("modal-svg-close-icon");const n=Wa.createSVGButton('<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path d="M4.89163 13.2687L9.16582 17.5427L18.7085 8" stroke="#000000" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n</svg>');return n[t].add("modal-svg-submit-button"),this.addButtons(i,n),this.addButtonEvents(i,s,n,e),{captureButton:i,submitButton:n}}addButtonEvents(t,e,i,s){t.onclick=()=>{this.capture()},e.addEventListener(y,this.stop.bind(this)),i.onclick=()=>{const t=this.getFile();t&&Ha.addFilesToType([t],[s]),this.stop(),this.close()}}stop(){this._mediaStream&&this._mediaStream.getTracks().forEach(t=>t.stop()),this._stopped=!0,setTimeout(()=>{this._captureButton.replaceChildren(this._captureIcon),this._captureButton[t].replace("modal-svg-refresh-button","modal-svg-camera-button");const e=this._canvas.getContext("2d");null==e||e.clearRect(0,0,this._canvas.width,this._canvas.height)},Wa.MODAL_CLOSE_TIMEOUT_MS)}start(){this._dataURL=void 0,this._submitButton[t].add("modal-svg-submit-disabled"),this._stopped=!1,navigator.mediaDevices.getUserMedia({video:this._dimensions||!0}).then(t=>{if(this._mediaStream=t,!this.isOpen())return this.stop();const e=i("video");e.srcObject=t,e.play(),requestAnimationFrame(this.updateCanvas.bind(this,e,this._canvas))}).catch(t=>{console[C](t),this.stop(),this.close()})}capture(){this._dataURL?(this._captureButton.replaceChildren(this._captureIcon),this._captureButton[t].replace("modal-svg-refresh-button","modal-svg-camera-button"),this._submitButton[t].add("modal-svg-submit-disabled"),this._dataURL=void 0):(this._captureButton.replaceChildren(this._refreshIcon),this._captureButton[t].replace("modal-svg-camera-button","modal-svg-refresh-button"),this._submitButton[t].remove("modal-svg-submit-disabled"),this._dataURL=this._canvas.toDataURL())}getFile(){if(this._dataURL){const t=atob(this._dataURL.split(",")[1]),e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=t.charCodeAt(i);const i=new Uint8Array(e),s=new Blob([i],{type:this._format}),n="image/jpeg"===this._format?"jpeg":"png",o=Xa.getFileName(this._newFilePrefix||"photo",n);return new File([s],o,{type:s.type})}}updateCanvas(t,e){if(!this._stopped){if(!this._dataURL){e.width=t.videoWidth,e.height=t.videoHeight;const i=e.getContext("2d");null==i||i.drawImage(t,0,0,e.width,e.height)}requestAnimationFrame(this.updateCanvas.bind(this,t,e))}}openCameraModal(t){this.displayModalElements(),t.start()}static createCameraModalFunc(t,e,i,s){const n=new el(t,e,i,s);return n.openCameraModal.bind(n,n)}}class il extends jn{constructor(t,e,i){var s,n,o,r,a,l;const c=null==(s=null==i?void 0:i.button)?void 0:s.position,h=(null==(r=null==(o=null==(n=null==i?void 0:i.button)?void 0:n.styles)?void 0:o[M])?void 0:r.content)||"Photo",u=Y.tryCreateConfig("Camera",null==(a=null==i?void 0:i.button)?void 0:a.tooltip),d=(null==(l=null==i?void 0:i.button)?void 0:l.styles)||{};super(il.createButtonElement(),'<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">\n  <path d="M29 7h-4.599l-2.401-4h-12l-2.4 4h-4.6c-1 0-3 1-3 2.969v16.031c0 1.657 1.5 3 2.792 3h26.271c1.313 0 2.938-1.406 2.938-2.968v-16.032c0-1-1-3-3-3zM30 26.032c0 0.395-0.639 0.947-0.937 0.969h-26.265c-0.232-0.019-0.797-0.47-0.797-1v-16.031c0-0.634 0.851-0.953 1-0.969h5.732l2.4-4h9.802l1.785 3.030 0.55 0.97h5.731c0.705 0 0.99 0.921 1 1v16.032zM16 10c-3.866 0-7 3.134-7 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zM16 22c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z"></path>\n</svg>',c,u,d,h);const p=this.createInnerElementsForStates(this.customStyles);i&&this.addClickEvent(t,e,i.modalContainerStyle,i[z]),this.changeElementsByState(p.styles),this.reapplyStateStyle("styles")}createInnerElementsForStates(t){return{styles:this.createInnerElements("camera-icon","styles",t)}}static createButtonElement(){const e=i();return e[t].add("input-button"),e}addClickEvent(t,e,i,s){const n=el.createCameraModalFunc(t,e,i,s);this.elementRef.onclick=n}}class sl{constructor(t,e,i,s){this.elementRef=sl.createPanelElement(t.inputAreaStyle);const n={},o=this.createFileUploadComponents(t,i,s,n),r=new at(t,i,o);t.speechToText&&!n.microphone&&(n.microphone={button:new La(t,r,e.addNewErrorMessage.bind(e))});const a=new tl(t,r,e,i,o,n);r.submit=a.submitFromInput.bind(a),Ka.attach(t,i,r,o,a),t.submitUserMessage=a.programmaticSubmit.bind(a),n.submit={button:a},t.customButtons&&Or.add(t,n),sl.addElements(this.elementRef,r,n,s,o,t.dropupStyles),sl.assignOnInput(t,i,o,r)}static createPanelElement(t){const s=i();return s.id="input",Object.assign(s[e],t),s}createFileUploadComponents(t,e,i,s){var n,o,r,a;const l=new Ha(this.elementRef,t.attachmentContainerStyle,e.demo);if(sl.createUploadButtons(t,e,e.fileTypes||{},l,i,s),null!=(n=e[H])&&n[z]){const n=(null==(o=s[U])?void 0:o.fileType)||l.addType(t,e,e[H][z],U);s[H]={button:new il(i,n,e[H])}}if(null!=(r=e.recordAudio)&&r[z]){const i=(null==(a=s[W])?void 0:a.fileType)||l.addType(t,e,e.recordAudio[z],W);s.microphone={button:new Qa(i,e.recordAudio)}}return Za.isEnabled(l,t.dragAndDrop)&&Za.create(i,l,t.dragAndDrop),l}static createUploadButtons(t,e,i,s,n,o){Object.keys(i).forEach(r=>{const a=r,l=i[a];if(l[z]){const i=s.addType(t,e,l[z],a),{id:r,svgString:c,dropupText:h}=Er[a],u=new Ga(n,i,l,r,c,h);o[a]={button:u,fileType:i}}})}static addElements(t,e,i,s,n,o){Dt.addElements(t,e.elementRef);const r=wr.create(),a=jr.addButtons(r,i,s,o);yr.set(e.inputElementRef,r,n.elementRef,a),wr.add(t,r)}static assignOnInput(t,e,i,s){e.onInput=e=>{setTimeout(()=>{const n=i.getAllFileData(),o=s.inputElementRef.innerText.trim(),r={[M]:o};n&&(r[z]=n.map(t=>t[q])),Fi.onInput(t,r,e)})}}}class nl{static createElements(t,e,s){const n=i();n.id="chat-view";const o=new br(t,e,s);e.websocket&&cs.createConnection(e,o);const r=new sl(t,o,e,n);return Dt.addElements(n,o.elementRef,r.elementRef),n}static render(t,e,i,s){const n=nl.createElements(t,i,s);e.replaceChildren(n),i.isCustomView()&&i.setUpView(n,e)}}var ol=Object.defineProperty,rl=(t,e,i,s)=>{for(var n,o=void 0,r=t.length-1;r>=0;r--)(n=t[r])&&(o=n(e,i,o)||o);return o&&ol(e,i,o),o};class al extends ws{constructor(){var t;super(),this.getMessages=()=>[],this.submitUserMessage=()=>console.warn("submitUserMessage failed - please wait for chat view to render before calling this property."),this.addMessage=()=>console.warn("addMessage failed - please wait for chat view to render before calling this property."),this.updateMessage=()=>{},this.clearMessages=()=>{},this.focusInput=()=>lt.focusFromParentElement(this._elementRef),this.refreshMessages=()=>{},this.scrollToBottom=()=>{},this.disableSubmitButton=()=>{},this.setPlaceholderText=()=>{},this._hasBeenRendered=!1,this._auxiliaryStyleApplied=!1,this._elementRef=i(),this._elementRef.id="container",this.attachShadow({mode:"open"}).appendChild(this._elementRef),null==(t=this.shadowRoot)||t.appendChild(Y.buildElement()),_.apply('#validate-property-key-view{height:100%;position:relative;display:flex;justify-content:center;align-items:center;padding:8px}#loading-validate-key-property{display:inline-block;width:50px;height:50px}#loading-validate-key-property:after{content:" ";display:block;width:38px;height:38px;margin:1px;border-radius:50%;border:5px solid #5fb2ff;border-color:#5fb2ff transparent #5fb2ff transparent;animation:loading-spinner 1.4s linear infinite}#deep-chat-openai-realtime-container{height:100%;width:100%}#deep-chat-openai-realtime-avatar-container{height:60%;width:100%;display:flex;justify-content:center;align-items:center}#deep-chat-openai-realtime-avatar{border-radius:50%;height:110px;border:1px solid rgb(215,215,215);padding:8px;-webkit-user-select:none;user-select:none;margin-top:20px}#deep-chat-openai-realtime-buttons-container{height:40%;display:flex;position:relative}.deep-chat-openai-realtime-button-container{height:100%;width:50%;display:flex;justify-content:center;align-items:center}.deep-chat-openai-realtime-button{width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer}.deep-chat-openai-realtime-button-default{background-color:#e3e3e3}.deep-chat-openai-realtime-button-default:hover{background-color:#d4d4d4}.deep-chat-openai-realtime-button-default:active{background-color:#c5c5c5}.deep-chat-openai-realtime-button-loading{opacity:.7;pointer-events:none}.deep-chat-openai-realtime-microphone-active{background-color:#ffe7e7}.deep-chat-openai-realtime-microphone-active:hover{background-color:#ffdede}.deep-chat-openai-realtime-microphone-active:active{background-color:#ffd2d2}.deep-chat-openai-realtime-microphone>*{height:30px;width:30px}.deep-chat-openai-realtime-microphone-active>*{filter:brightness(0) saturate(100%) invert(35%) sepia(60%) saturate(1360%) hue-rotate(325deg) brightness(95%) contrast(92%)}.deep-chat-openai-realtime-toggle>*{height:32px;width:32px;padding-left:3px;filter:brightness(0) saturate(100%) invert(22%) sepia(0%) saturate(4537%) hue-rotate(208deg) brightness(105%) contrast(91%)}.deep-chat-openai-realtime-button-unavailable{opacity:.45;pointer-events:none}#deep-chat-openai-realtime-error{color:red;position:absolute;top:calc(50% + 40px);left:50%;transform:translate(-50%,-50%);font-size:17px}#deep-chat-openai-realtime-loading{position:absolute;font-size:15px;top:50%;left:50%;transform:translate(-50%,-50%)}#insert-key-view{height:100%;position:relative}#insert-key-contents{text-align:center;position:absolute;top:44%;left:50%;transform:translate(-50%,-50%);width:82%;display:flex;max-width:700px}#insert-key-title{margin-bottom:15px}#insert-key-input-container{margin-right:2.7em;width:calc(100% - 80px)}#insert-key-input{padding:.3em 1.7em .3em .3em;border-width:1px;border-style:solid;border-radius:3px;width:100%;font-size:inherit}.insert-key-input-valid{border-color:gray}.insert-key-input-invalid{border-color:red}#visibility-icon-container{position:relative;float:right;cursor:pointer;-webkit-user-select:none;user-select:none}.visibility-icon{filter:brightness(0) saturate(100%) invert(63%) sepia(1%) saturate(9%) hue-rotate(43deg) brightness(98%) contrast(92%);position:absolute;right:-1.7em;top:-1.43em}#visible-icon{top:-1.4em}.visibility-icon:hover{filter:unset}.visibility-icon>*{pointer-events:none}#start-button{border:1px solid grey;color:#454545;border-radius:4px;width:3em;display:flex;justify-content:center;align-items:center;cursor:pointer;padding:.28em .3em;-webkit-user-select:none;user-select:none;background-color:#fff}#start-button:hover{background-color:#f2f2f2}#start-button:active{background-color:#d2d2d2}#insert-key-help-text-container{width:100%;position:absolute;margin-top:32px;margin-bottom:20px}#insert-key-help-text-contents{width:100%;position:absolute}#insert-key-input-invalid-text{display:block;margin-top:1em;margin-bottom:.5em;color:red}.insert-key-input-help-text{display:block;margin-top:16px}#loading-key{display:inline-block;width:16px;height:16px}#loading-key:after{content:" ";display:block;width:11px;height:11px;margin:1px;border-radius:50%;border:2px solid #0084ff;border-color:#0084ff transparent #0084ff transparent;animation:loading-spinner 1.2s linear infinite}#error-view{color:red;font-size:1.2em;line-height:1.3em;margin-top:-5px;text-align:center;height:100%;display:flex;justify-content:center;align-items:center;padding-left:8px;padding-right:8px}@keyframes loading-spinner{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.intro-panel{position:absolute;display:flex;justify-content:center;right:0;bottom:0;left:0;margin:auto;height:fit-content;top:-2.5em}pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!\n  Theme: a11y-dark\n  Author: @ericwbailey\n  Maintainer: @ericwbailey\n\n  Based on the Tomorrow Night Eighties theme: https://github.com/isagalaev/highlight.js/blob/master/src/styles/tomorrow-night-eighties.css\n*/.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}#messages{overflow:auto;overflow-anchor:none}.outer-message-container:last-child{margin-bottom:5px}.inner-message-container{display:flex;margin-left:auto;margin-right:auto;width:calc(97.5% - 24px);max-width:100%}.message-bubble{margin-top:10px;word-wrap:break-word;width:fit-content;max-width:60%;border-radius:10px;padding:.42em .55em;height:fit-content;line-height:1.26em}.user-message-text{color:#fff;background-color:#0084ff;margin-right:0;margin-left:auto}.ai-message-text{color:#000;background-color:#e4e6eb;margin-left:0;margin-right:auto}.deep-chat-last-group-messages-active{height:100%}.loading-history-message-full-view{position:absolute;height:70%;width:100%;display:flex;align-items:center}.loading-history-message-small{height:20px;margin-bottom:30px}.loading-history-message-small>div>div{scale:.6}.loading-history-message{margin-top:0;width:100%;max-width:100%;display:flex;justify-content:center;background-color:unset}.loading-history{width:70px}.loading-history div{position:absolute;width:var(--loading-history-width);height:var(--loading-history-height);margin:var(--loading-history-margin);border:var(--loading-history-border);border-radius:50%;animation:loading-spinner 1.2s cubic-bezier(.5,0,.5,1) infinite;border-color:var(--loading-history-color) transparent transparent transparent}.loading-history div:nth-child(1){animation-delay:-.45s}.loading-history div:nth-child(2){animation-delay:-.3s}.loading-history div:nth-child(3){animation-delay:-.15s}.html-message{max-width:unset}.error-message-text{margin:14px auto 10px;background-color:#f4c0c0;color:#474747;text-align:center;max-width:95%}.deep-chat-loading-message-dots-container{width:1em;padding:.6em .75em .6em 1.3em}.loading-message-dots{position:relative;width:.45em;height:.45em;border-radius:5px;background-color:var(--loading-message-color);color:var(--loading-message-color);animation:loading-message-dots 1s infinite linear alternate;animation-delay:.5s}.loading-message-dots:before,.loading-message-dots:after{content:"";display:inline-block;position:absolute;top:0}.loading-message-dots:before{left:-.7em;width:.45em;height:.45em;border-radius:5px;background-color:var(--loading-message-color);color:var(--loading-message-color);animation:loading-message-dots 1s infinite alternate;animation-delay:0s}.loading-message-dots:after{left:.7em;width:.45em;height:.45em;border-radius:5px;background-color:var(--loading-message-color);color:var(--loading-message-color);animation:loading-message-dots 1s infinite alternate;animation-delay:1s}@keyframes loading-message-dots{0%{background-color:var(--loading-message-color)}50%,to{background-color:var(--loading-message-color-fade)}}.message-bubble>p:first-child,.message-bubble>.partial-render-message>p:first-child,.html-wrapper>p:first-child{margin-top:0}.message-bubble>p:last-child,.message-bubble>.partial-render-message:last-child>p,.html-wrapper>p:last-child{margin-bottom:0}pre{overflow:auto;display:block;word-break:break-all;word-wrap:break-word;border-radius:7px;background:#2b2b2b;color:#f8f8f2;margin-top:.8em;margin-bottom:.8em;padding:.6em;font-size:.9em;line-height:1.5em}.image-message{padding:0;display:flex;background-color:#ddd}.image-message>*,.image-message>*>*{width:100%;border-radius:8px;display:flex}.audio-message{width:60%;max-width:300px;height:2.2em;max-height:54px;padding:0;background-color:unset}.audio-player{width:100%;height:100%}.audio-player-safari{height:fit-content;width:40px}.audio-player-safari-left{float:left}.audio-player-safari-right{float:right}.any-file-message{padding:1px}.any-file-message-contents{display:flex}.any-file-message-icon-container{width:1.3em;min-width:1.3em;position:relative;border-radius:4px;margin-left:6px;margin-right:2px}.any-file-message-icon{background-color:#fff;border-radius:4px;position:absolute;width:1em;height:1.25em;padding:1px;margin-top:auto;margin-bottom:auto;top:0;bottom:0}.any-file-message-text{padding-top:5px;overflow-wrap:anywhere;padding-bottom:5px;padding-right:7px}.message-bubble>a{color:inherit}.left-item-position{margin-right:10px}.right-item-position{margin-left:10px}.role-hidden{display:none}.avatar{padding-top:5px;width:1.5em;height:1.5em;border-radius:1px}.avatar-container{margin-top:9px}.name{margin-top:16px;font-size:15px}#drag-and-drop{position:absolute;display:none;z-index:10;height:calc(100% - 10px);width:calc(100% - 10px);background-color:#70c6ff4d;border:5px dashed #6dafff}#file-attachment-container{position:absolute;height:3.6em;width:calc(80% - 4px);top:-2.5em;border-radius:5px;overflow:auto;text-align:left;background-color:#d7d7d73b;padding-left:4px}.file-attachment{width:2.85em;height:2.85em;display:inline-flex;margin-right:.6em;margin-bottom:.44em;margin-top:4px;position:relative;background-color:#fff;border-radius:5px}.image-attachment{width:100%;height:100%;object-fit:cover;border-radius:5px}.border-bound-attachment{width:calc(100% - 2px);height:calc(100% - 2px);border:1px solid #c3c3c3;border-radius:5px;overflow:hidden}.border-bound-attachment-safari{width:calc(100% - 1px);height:calc(100% - 1px)}.audio-attachment-icon-container{cursor:pointer}.audio-attachment-icon-container:hover{background-color:#f8f8f8}.attachment-icon{left:0;right:0;bottom:0;top:2px;margin:auto;position:absolute;width:25px;-webkit-user-select:none;user-select:none}.not-removable-attachment-icon{top:0;right:0;bottom:0;left:0}.play-icon{filter:brightness(0) saturate(100%) invert(17%) sepia(0%) saturate(1392%) hue-rotate(67deg) brightness(98%) contrast(97%)}.stop-icon{filter:brightness(0) saturate(100%) invert(29%) sepia(90%) saturate(1228%) hue-rotate(198deg) brightness(93%) contrast(98%)}.audio-placeholder-text-3-digits{padding-left:.26rem}.audio-placeholder-text-4-digits{padding-left:.1rem}.any-file-attachment{padding:2px 0}.file-attachment-text-container{position:absolute;width:inherit;display:flex;align-items:center;height:100%;top:-1px}.audio-placeholder-text-3-digits-container{padding-top:1px;cursor:default}.any-file-attachment-text{text-overflow:ellipsis;white-space:nowrap;overflow:hidden;padding-left:.13em;margin-left:auto;margin-right:auto}.remove-file-attachment-button{height:1.25em;width:1.25em;border:1px solid #cfcfcf;border-radius:25px;background-color:#fff;top:-4px;right:-5px;position:absolute;display:flex;justify-content:center;cursor:pointer;-webkit-user-select:none;user-select:none}.remove-file-attachment-button:hover{background-color:#e4e4e4}.remove-file-attachment-button:active{background-color:#d7d7d7}.x-icon{color:#4e4e4e;top:-.075em;position:relative;font-size:1.05em}.modal{display:none;flex-direction:column;align-items:center;justify-content:center;position:absolute;width:80%;max-width:420px;max-height:80%;margin:auto;top:0;right:0;bottom:0;left:0;z-index:3}.modal-content{border-top:1px solid rgb(217,217,217);border-left:1px solid rgb(217,217,217);border-right:1px solid rgb(217,217,217);border-top-left-radius:inherit;border-top-right-radius:inherit;background-color:#fff;overflow-y:auto;height:fit-content;max-height:calc(100% - 3.3em);width:100%}.modal-content>p{margin-left:1em;margin-right:1em}.modal-content>ul{margin-right:1em}.modal-button-panel{height:3.3em;border:1px solid;border-color:rgb(223,223,223) rgb(217,217,217) rgb(217,217,217);border-bottom-left-radius:inherit;border-bottom-right-radius:inherit;background-color:#fff;text-align:center;justify-content:center;display:flex;width:100%}.modal-button{min-width:2.5em;text-align:center;color:#fff;border-radius:5px;padding:.4em .4em .3em;height:1.25em;background-color:#3279b2;top:0;bottom:0;cursor:pointer;-webkit-user-select:none;user-select:none;margin:auto .31em}.modal-button:hover{background-color:#276da7}.modal-button:active{background-color:#1b5687}.modal-svg-button{padding:0 0 2px;width:2em;height:1.8em}.modal-svg-button-icon{width:100%;height:100%;filter:brightness(0) saturate(100%) invert(100%) sepia(15%) saturate(4%) hue-rotate(346deg) brightness(101%) contrast(102%)}#modal-background-panel{position:absolute;width:100%;height:100%;background-color:#00000042;z-index:2;display:none}.show-modal-background{animation:fadeInBackground .3s ease-in-out}@keyframes fadeInBackground{0%{opacity:0}to{opacity:1}}.show-modal{animation:fadeInModal .3s ease-in-out}@keyframes fadeInModal{0%{opacity:0;scale:.95}to{opacity:1;scale:1}}.hide-modal-background{animation:fadeOutBackground .2s ease-in-out}@keyframes fadeOutBackground{0%{opacity:1}to{opacity:0}}.hide-modal{animation:fadeOutModal .2s ease-in-out}@keyframes fadeOutModal{0%{opacity:1;scale:1}to{opacity:0;scale:.95}}.modal-camera-content{overflow:hidden;text-align:center;border:unset;height:100%;background-color:#2a2a2a;display:flex;justify-content:center}.camera-modal-canvas{max-width:100%;max-height:100%;margin-top:auto;margin-bottom:auto}.modal-svg-submit-button{background-color:green}.modal-svg-submit-button:hover{background-color:#007500}.modal-svg-submit-button:active{background-color:#006500}.modal-svg-submit-disabled{pointer-events:none;background-color:#747474}.modal-svg-close-button{height:1.56em;padding-top:.37em;padding-bottom:0;background-color:#c13e3e}.modal-svg-close-button:hover{background-color:#b43434}.modal-svg-close-button:active{background-color:#972929}.modal-svg-close-icon{width:80%;height:80%}.modal-svg-camera-button{height:1.6em;padding-top:.38em;padding-bottom:0}.modal-svg-camera-icon{height:76%}.modal-svg-refresh-icon{height:105%}.modal-svg-refresh-button{height:1.66em;padding-top:.11em;padding-bottom:.21em}.input-button-container{position:relative;z-index:1}.inside-right{position:absolute;right:calc(10% + .35em);bottom:.85em}.inside-left{position:absolute;left:calc(10% + .35em);bottom:.85em}.outside-left{position:absolute;right:calc(11px - .55em);bottom:.88em}.outside-right{position:absolute;left:calc(11px - .55em);bottom:.88em}#upload-images-icon{position:absolute;pointer-events:none;width:1.45em;height:1.45em;left:.11em;bottom:.08em;filter:brightness(0) saturate(100%) invert(43%) sepia(0%) saturate(740%) hue-rotate(77deg) brightness(99%) contrast(92%)}#upload-gifs-icon{position:absolute;pointer-events:none;width:1.5em;height:1.48em;left:.07em;bottom:.08em;filter:brightness(0) saturate(100%) invert(49%) sepia(0%) saturate(2586%) hue-rotate(12deg) brightness(93%) contrast(90%)}#upload-audio-icon{position:absolute;pointer-events:none;width:1.21em;height:1.21em;left:.17em;bottom:.2em;filter:brightness(0) saturate(100%) invert(15%) sepia(0%) saturate(337%) hue-rotate(125deg) brightness(91%) contrast(94%);transform:scaleX(.95)}#camera-icon{position:absolute;pointer-events:none;width:1.21em;height:1.21em;left:.23em;bottom:.2em;filter:brightness(0) saturate(100%) invert(52%) sepia(0%) saturate(161%) hue-rotate(164deg) brightness(91%) contrast(92%);transform:scaleX(.95)}#upload-mixed-files-icon{position:absolute;pointer-events:none;width:1.21em;height:1.21em;left:.25em;bottom:.2em;filter:brightness(0) saturate(100%) invert(53%) sepia(0%) saturate(36%) hue-rotate(74deg) brightness(98%) contrast(93%);transform:scaleX(.95)}#interim-text{color:gray}#microphone-button{padding-top:.5px}.outer-button-container>#microphone-button{padding-bottom:1px}#microphone-icon{position:absolute;pointer-events:none;width:1.21em;height:1.21em;left:.25em;bottom:.25em}.default-microphone-icon{filter:brightness(0) saturate(100%) invert(32%) sepia(0%) saturate(924%) hue-rotate(46deg) brightness(95%) contrast(99%)}.active-microphone-icon{filter:brightness(0) saturate(100%) invert(10%) sepia(97%) saturate(7495%) hue-rotate(0deg) brightness(101%) contrast(107%);border-radius:10px}.command-microphone-icon{filter:brightness(0) saturate(100%) invert(42%) sepia(96%) saturate(1067%) hue-rotate(77deg) brightness(99%) contrast(102%)}.unsupported-microphone{display:none}#submit-icon{height:100%;filter:brightness(0) saturate(100%) invert(32%) sepia(0%) saturate(924%) hue-rotate(46deg) brightness(95%) contrast(99%);width:1.21em}#stop-icon{background-color:#acacac;position:absolute;width:.95em;height:.95em;left:.35em;bottom:.35em;border-radius:2px}.submit-button-enlarged{scale:1.1;margin-right:.3em;margin-left:.3em}.loading-submit-button{position:relative;left:calc(-9990px + .275em);width:.22em;height:.22em;border-radius:5px;background-color:#848484;color:#848484;box-shadow:9990px 0 #848484,calc(9990px + .44em) 0 0 0 #848484,calc(9990px + .8em) 0 0 0 #848484;animation:loading-submit-button 1.5s infinite linear;bottom:-.75em}@keyframes loading-submit-button{0%{box-shadow:9990px 0 #848484,calc(9990px + .44em) 0 0 0 #848484,calc(9990px + .8em) 0 0 0 #848484}16.667%{box-shadow:9990px -6px #848484,calc(9990px + .44em) 0 0 0 #848484,calc(9990px + .8em) 0 0 0 #848484}33.333%{box-shadow:9990px 0 #848484,calc(9990px + .44em) 0 0 0 #848484,calc(9990px + .8em) 0 0 0 #848484}50%{box-shadow:9990px 0 #848484,calc(9990px + .44em) -6px 0 0 #848484,calc(9990px + .8em) 0 0 0 #848484}66.667%{box-shadow:9990px 0 #848484,calc(9990px + .44em) 0 0 0 #848484,calc(9990px + .8em) 0 0 0 #848484}83.333%{box-shadow:9990px 0 #848484,calc(9990px + .44em) 0 0 0 #848484,calc(9990px + .8em) -6px 0 0 #848484}to{box-shadow:9990px 0 #848484,calc(9990px + .44em) 0 0 0 #848484,calc(9990px + .8em) 0 0 0 #848484}}.tooltip{position:absolute;visibility:hidden;z-index:1;pointer-events:none;padding:5px 7px;background-color:#333;border-radius:5px;width:max-content}.tooltip-text{color:#fff;font-size:13px}.input-button{border-radius:4px;cursor:pointer;margin-bottom:.2em;-webkit-user-select:none;user-select:none}.input-button-svg{width:1.65em;height:1.65em}.input-button-svg-text{padding:1px;height:1.65em;display:flex}.input-button-svg-text>svg{padding:.22rem}.input-button-svg-text>div{margin-left:2px}.input-button:hover,.input-button:focus-visible{background-color:#9c9c9c2e}.input-button:active{background-color:#9c9c9c5e}.input-button:active:not(:hover){background-color:transparent}.loading-button{cursor:auto}.loading-button:hover{background-color:unset}.text-button{filter:unset!important;display:flex;justify-content:center;align-items:center;margin-left:4px;margin-right:4px;height:1.6em;width:max-content}#custom-icon{height:100%;width:1.2em}.custom-button-container-default{color:#505050}.custom-button-container-default>.dropup-menu-item-icon{color:unset}.custom-button-container-default>svg{filter:brightness(0) saturate(100%) invert(39%) sepia(1%) saturate(0%) hue-rotate(83deg) brightness(93%) contrast(90%)}.custom-button-container-default>.dropup-menu-item-icon>svg{position:absolute;left:.2em}.custom-button-container-active{background-color:#edf7ff;color:#0285ff}.custom-button-container-active:hover,.custom-button-container-active:focus-visible{background-color:#def0ff}.custom-button-container-active:active{background-color:#d2eaff}.custom-button-container-active>svg{filter:brightness(0) saturate(100%) invert(32%) sepia(34%) saturate(4196%) hue-rotate(196deg) brightness(107%) contrast(104%)}.custom-button-container-disabled{color:#aeaeae;cursor:auto}.custom-button-container-disabled>div{pointer-events:none}.custom-button-container-disabled:hover,.custom-button-container-disabled:focus-visible{background-color:transparent}.custom-button-container-disabled:active{background-color:transparent}.custom-button-container-disabled>svg{filter:brightness(0) saturate(100%) invert(67%) sepia(0%) saturate(818%) hue-rotate(28deg) brightness(102%) contrast(100%)}#text-input-container{background-color:#fff;width:80%;display:flex;border:1px solid #0000001a;border-radius:5px;margin-top:.8em;margin-bottom:.8em;box-shadow:#959da533 0 1px 12px;overflow-y:auto;max-height:200px;position:relative}.text-input-container-left-adjustment{margin-left:1.5em}.text-input-container-right-adjustment{margin-right:1.5em}.text-input-container-left-small-adjustment{margin-left:1.1em}.text-input-container-left-small-adjustment>.outside-left{right:calc(14px - .55em)}.text-input-container-right-small-adjustment{margin-right:1.1em}.text-input-container-right-small-adjustment>.outside-right{left:calc(14px - .55em)}#text-input{text-align:left;outline:none;word-wrap:break-word;line-break:auto}.text-input-styling{padding:.4em .5em;overflow:overlay;width:100%}.text-input-inner-left-adjustment{padding-left:2.2em}.text-input-inner-right-adjustment{padding-right:2em}.text-input-disabled{pointer-events:none;-webkit-user-select:none;user-select:none}[contenteditable]:empty:before{content:attr(deep-chat-placeholder-text);pointer-events:none}[contenteditable][textcolor]:empty:before{color:gray}.outside-right>#dropup-menu,.inside-right>#dropup-menu{right:0}#dropup-icon{position:absolute;pointer-events:none;width:1.16em;height:1.2em;left:.265em;bottom:.43em;filter:brightness(0) saturate(100%) invert(54%) sepia(0%) saturate(724%) hue-rotate(6deg) brightness(92%) contrast(90%)}.dropup-button>*{pointer-events:none}#dropup-menu{background-color:#fff;position:absolute;transform:translateY(-100%);border-radius:5px;z-index:1;top:-.49em;box-shadow:#0003 -1px 2px 10px,#0000001a 0 2px 4px;cursor:pointer;-webkit-user-select:none;user-select:none}.dropup-menu-item{height:1.4em;padding:.28em .84em .28em .35em;display:flex;position:relative}.dropup-menu-item:hover,.dropup-menu-item:focus-visible{background-color:#f3f3f3}.dropup-menu-item:active{background-color:#ebebeb}.dropup-menu-item:active:not(:hover){background-color:transparent}.dropup-menu-item:first-child{padding-top:.49em;border-top-left-radius:inherit;border-top-right-radius:inherit}.dropup-menu-item:last-child{padding-bottom:.45em;border-bottom-left-radius:inherit;border-bottom-right-radius:inherit}.dropup-menu-item-icon{width:1.39em;position:relative}.dropup-menu-item-icon>svg{bottom:0!important;top:0!important;margin-bottom:auto;margin-top:auto}#dropup-menu-item-icon-element-custom{position:absolute;pointer-events:none;width:1.21em;height:1.21em;left:.28em;filter:brightness(0) saturate(100%) invert(15%) sepia(0%) saturate(337%) hue-rotate(125deg) brightness(91%) contrast(94%)}.dropup-menu-item-text{margin-left:.56em;margin-top:.08em;width:max-content}#input{width:100%;display:inline-flex;text-align:center;margin-left:auto;margin-right:auto;margin-top:auto;position:relative;justify-content:center}#chat-view{height:100%;display:grid;grid-template-columns:100%}::-webkit-scrollbar{width:9px;height:9px}::-webkit-scrollbar-thumb{background-color:#d0d0d0;border-radius:5px}::-webkit-scrollbar-track{background-color:#f2f2f2}.deep-chat-web-model-button{margin-top:10px;margin-bottom:5px;margin-left:1px}:host{all:initial;display:table-cell}#container{height:inherit;width:inherit;overflow:hidden}',this.shadowRoot),setTimeout(()=>{this._hasBeenRendered||this.onRender()},20)}changeToChatView(){this._activeService&&(this._activeService.validateKeyProperty=!1),this.onRender()}onRender(){k.attemptAppendStyleSheetToHead(this.style),Gt.processConnect(this),(!this._activeService||this._activeService.demo)&&(this._activeService=cr.create(this)),this.auxiliaryStyle&&!this._auxiliaryStyleApplied&&(_.apply(this.auxiliaryStyle,this.shadowRoot),this._auxiliaryStyleApplied=!0),_.applyDefaultStyleToComponent(this.style,this.chatStyle),Gt.checkForContainerStyles(this,this._elementRef),this._activeService.key&&this._activeService.validateKeyProperty?n.render(this._elementRef,this.changeToChatView.bind(this),this._activeService):this._activeService instanceof gs&&!this._activeService.key?this._activeService instanceof gs&&_s.render(this._elementRef,this.changeToChatView.bind(this),this._activeService):(this._childElement??(this._childElement=this.children[0]),nl.render(this,this._elementRef,this._activeService,this._childElement)),this._hasBeenRendered||Fi.onRender(this),this._hasBeenRendered=!0}disconnectedCallback(){Ts.chat=void 0}}rl([dr("object")],al.prototype,"connect"),rl([dr("object")],al.prototype,"directConnection"),rl([dr("object")],al.prototype,"webModel"),rl([dr("object")],al.prototype,"requestBodyLimits"),rl([dr("function")],al.prototype,"requestInterceptor"),rl([dr("function")],al.prototype,"responseInterceptor"),rl([dr("function")],al.prototype,"validateInput"),rl([dr("function")],al.prototype,"loadHistory"),rl([dr("object")],al.prototype,"chatStyle"),rl([dr("object")],al.prototype,"attachmentContainerStyle"),rl([dr("object")],al.prototype,"dropupStyles"),rl([dr("object")],al.prototype,"inputAreaStyle"),rl([dr("object")],al.prototype,"textInput"),rl([dr("object")],al.prototype,"submitButtonStyles"),rl([dr("object")],al.prototype,"customButtons"),rl([dr("string")],al.prototype,"auxiliaryStyle"),rl([dr("array")],al.prototype,"history"),rl([dr("object")],al.prototype,"browserStorage"),rl([dr("object")],al.prototype,"introMessage"),rl([dr("object")],al.prototype,"avatars"),rl([dr("object")],al.prototype,"names"),rl([dr("object")],al.prototype,"displayLoadingBubble"),rl([dr("object")],al.prototype,"errorMessages"),rl([dr("object")],al.prototype,"messageStyles"),rl([dr("object")],al.prototype,"textToSpeech"),rl([dr("object")],al.prototype,"speechToText"),rl([dr("object")],al.prototype,"images"),rl([dr("object")],al.prototype,"gifs"),rl([dr("object")],al.prototype,"camera"),rl([dr("object")],al.prototype,"audio"),rl([dr("object")],al.prototype,"microphone"),rl([dr("object")],al.prototype,"mixedFiles"),rl([dr("object")],al.prototype,"dragAndDrop"),rl([dr("object")],al.prototype,"htmlWrappers"),rl([dr("object")],al.prototype,"htmlClassUtilities"),rl([dr("object")],al.prototype,"remarkable"),rl([dr("object")],al.prototype,"focusMode"),rl([dr("function")],al.prototype,"onMessage"),rl([dr("function")],al.prototype,"onClearMessages"),rl([dr("function")],al.prototype,"onComponentRender"),rl([dr("function")],al.prototype,"onInput"),rl([dr("function")],al.prototype,"onError"),rl([dr("object")],al.prototype,"demo"),rl([dr("object")],al.prototype,"_insertKeyViewStyles"),customElements.define("deep-chat",al);export{al as DeepChat};
